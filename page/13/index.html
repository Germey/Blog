<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
  <meta name="theme-color" content="#222">
  <meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#222">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>
  <script id="hexo-configurations">
    var NexT = window.NexT ||
    {};
    var CONFIG = {
      "hostname": "cuiqingcai.com",
      "root": "/",
      "scheme": "Pisces",
      "version": "7.8.0",
      "exturl": false,
      "sidebar":
      {
        "position": "right",
        "width": 360,
        "display": "post",
        "padding": 18,
        "offset": 12,
        "onmobile": false,
        "widgets": [
          {
            "type": "image",
            "name": "阿布云",
            "enable": false,
            "url": "https://www.abuyun.com/http-proxy/introduce.html",
            "src": "https://cdn.cuiqingcai.com/88au8.jpg",
            "width": "100%"
      },
          {
            "type": "image",
            "name": "爬虫书",
            "url": "https://item.jd.com/13527222.html",
            "src": "https://cdn.cuiqingcai.com/ei5og.jpg",
            "width": "100%",
            "enable": true
      },
          {
            "type": "categories",
            "name": "分类",
            "enable": true
      },
          {
            "type": "image",
            "name": "IPIDEA",
            "url": "http://www.ipidea.net/?utm-source=cqc&utm-keyword=?cqc",
            "src": "https://cdn.cuiqingcai.com/0ywun.png",
            "width": "100%",
            "enable": false
      },
          {
            "type": "image",
            "name": "Storm Proxies",
            "src": "https://cdn.cuiqingcai.com/a2zad8.png",
            "url": "https://www.stormproxies.cn/?keyword=jingmi",
            "width": "100%",
            "enable": false
      },
          {
            "type": "friends",
            "name": "友情链接",
            "enable": true
      },
          {
            "type": "hot",
            "name": "猜你喜欢",
            "enable": true
      },
          {
            "type": "tags",
            "name": "标签云",
            "enable": true
      }]
      },
      "copycode":
      {
        "enable": true,
        "show_result": true,
        "style": "mac"
      },
      "back2top":
      {
        "enable": true,
        "sidebar": false,
        "scrollpercent": true
      },
      "bookmark":
      {
        "enable": false,
        "color": "#222",
        "save": "auto"
      },
      "fancybox": false,
      "mediumzoom": false,
      "lazyload": false,
      "pangu": true,
      "comments":
      {
        "style": "tabs",
        "active": "gitalk",
        "storage": true,
        "lazyload": false,
        "nav": null,
        "activeClass": "gitalk"
      },
      "algolia":
      {
        "hits":
        {
          "per_page": 10
        },
        "labels":
        {
          "input_placeholder": "Search for Posts",
          "hits_empty": "We didn't find any results for the search: ${query}",
          "hits_stats": "${hits} results found in ${time} ms"
        }
      },
      "localsearch":
      {
        "enable": true,
        "trigger": "auto",
        "top_n_per_article": 10,
        "unescape": false,
        "preload": false
      },
      "motion":
      {
        "enable": false,
        "async": false,
        "transition":
        {
          "post_block": "bounceDownIn",
          "post_header": "slideDownIn",
          "post_body": "slideDownIn",
          "coll_header": "slideLeftIn",
          "sidebar": "slideUpIn"
        }
      },
      "path": "search.xml"
    };

  </script>
  <meta name="keywords" content="爬虫教程,爬虫,Python,Python爬虫,Python爬虫教程,爬虫书,静觅,崔庆才">
  <meta name="robots" content="index,follow">
  <meta name="GOOGLEBOT" content="index,follow">
  <meta name="author" content="静觅丨崔庆才的个人站点">
  <meta name="description" content="静觅丨崔庆才的个人站点专业为您提供爬虫教程,爬虫,Python,Python爬虫,Python爬虫教程,爬虫书的相关信息，想要了解更多详情，请联系我们。">
  <meta property="og:type" content="website">
  <meta property="og:title" content="静觅">
  <meta property="og:url" content="https://cuiqingcai.com/page/13/index.html">
  <meta property="og:site_name" content="静觅">
  <meta property="og:description" content="静觅丨崔庆才的个人站点专业为您提供爬虫教程,爬虫,Python,Python爬虫,Python爬虫教程,爬虫书的相关信息，想要了解更多详情，请联系我们。">
  <meta property="og:locale" content="zh_CN">
  <meta property="article:author" content="崔庆才">
  <meta property="article:tag" content="爬虫教程">
  <meta property="article:tag" content="爬虫">
  <meta property="article:tag" content="Python">
  <meta property="article:tag" content="Python爬虫">
  <meta property="article:tag" content="Python爬虫教程">
  <meta property="article:tag" content="爬虫书">
  <meta property="article:tag" content="静觅">
  <meta property="article:tag" content="崔庆才">
  <meta name="twitter:card" content="summary">
  <link rel="canonical" href="https://cuiqingcai.com/page/13/">
  <script id="page-configurations">
    // https://hexo.io/docs/variables.html
    CONFIG.page = {
      sidebar: "",
      isHome: true,
      isPost: false,
      lang: 'zh-CN'
    };

  </script>
  <title>静觅丨崔庆才的个人站点 - Python爬虫教程</title>
  <meta name="google-site-verification" content="p_bIcnvirkFzG2dYKuNDivKD8-STet5W7D-01woA2fc" />
  <meta name="sogou_site_verification" content="kBOV53NQqT" />
  <noscript>
    <style>
      .use-motion .brand,
      .use-motion .menu-item,
      .sidebar-inner,
      .use-motion .post-block,
      .use-motion .pagination,
      .use-motion .comments,
      .use-motion .post-header,
      .use-motion .post-body,
      .use-motion .collection-header
      {
        opacity: initial;
      }

      .use-motion .site-title,
      .use-motion .site-subtitle
      {
        opacity: initial;
        top: initial;
      }

      .use-motion .logo-line-before i
      {
        left: initial;
      }

      .use-motion .logo-line-after i
      {
        right: initial;
      }

    </style>
  </noscript>
  <link rel="alternate" href="/atom.xml" title="静觅" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner">
        <div class="site-brand-container">
          <div class="site-nav-toggle">
            <div class="toggle" aria-label="切换导航栏">
              <span class="toggle-line toggle-line-first"></span>
              <span class="toggle-line toggle-line-middle"></span>
              <span class="toggle-line toggle-line-last"></span>
            </div>
          </div>
          <div class="site-meta">
            <a href="/" class="brand" rel="start">
              <span class="logo-line-before"><i></i></span>
              <h1 class="site-title">静觅 <span class="site-subtitle"> 崔庆才的个人站点 - Python爬虫教程 </span>
              </h1>
              <span class="logo-line-after"><i></i></span>
            </a>
          </div>
          <div class="site-nav-right">
            <div class="toggle popup-trigger">
              <i class="fa fa-search fa-fw fa-lg"></i>
            </div>
          </div>
        </div>
        <nav class="site-nav">
          <ul id="menu" class="main-menu menu">
            <li class="menu-item menu-item-home">
              <a href="/" rel="section">首页</a>
            </li>
            <li class="menu-item menu-item-archives">
              <a href="/archives/" rel="section">文章列表</a>
            </li>
            <li class="menu-item menu-item-tags">
              <a href="/tags/" rel="section">文章标签</a>
            </li>
            <li class="menu-item menu-item-categories">
              <a href="/categories/" rel="section">文章分类</a>
            </li>
            <li class="menu-item menu-item-about">
              <a href="/about/" rel="section">关于博主</a>
            </li>
            <li class="menu-item menu-item-message">
              <a href="/message/" rel="section">给我留言</a>
            </li>
            <li class="menu-item menu-item-search">
              <a role="button" class="popup-trigger">搜索 </a>
            </li>
          </ul>
        </nav>
        <div class="search-pop-overlay">
          <div class="popup search-popup">
            <div class="search-header">
              <span class="search-icon">
                <i class="fa fa-search"></i>
              </span>
              <div class="search-input-container">
                <input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input">
              </div>
              <span class="popup-btn-close">
                <i class="fa fa-times-circle"></i>
              </span>
            </div>
            <div id="search-result">
              <div id="no-result">
                <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>
    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
      <span>0%</span>
    </div>
    <div class="reading-progress-bar"></div>
    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div class="content index posts-expand">
            <div class="carousel">
              <div id="wowslider-container">
                <div class="ws_images">
                  <ul>
                    <li><a target="_blank" href="https://item.jd.com/13527222.html"><img title="Python3网络爬虫开发实战（第二版）上市了！" src="https://cdn.cuiqingcai.com/prwgs.png" /></a></li>
                    <li><a target="_blank" href="https://t.lagou.com/fRCBRsRCSN6FA"><img title="52讲轻松搞定网络爬虫" src="https://cdn.cuiqingcai.com/fqq5e.png" /></a></li>
                    <li><a target="_blank" href="https://cuiqingcai.com/4320.html"><img title="Python3网络爬虫开发视频教程" src="https://cdn.cuiqingcai.com/bjrny.jpg" /></a></li>
                    <li><a target="_blank" href="https://cuiqingcai.com/5094.html"><img title="爬虫代理哪家强？十大付费代理详细对比评测出炉！" src="https://cdn.cuiqingcai.com/nifs6.jpg" /></a></li>
                  </ul>
                </div>
                <div class="ws_thumbs">
                  <div>
                    <a target="_blank" href="#"><img src="https://cdn.cuiqingcai.com/prwgs.png" /></a>
                    <a target="_blank" href="#"><img src="https://cdn.cuiqingcai.com/fqq5e.png" /></a>
                    <a target="_blank" href="#"><img src="https://cdn.cuiqingcai.com/bjrny.jpg" /></a>
                    <a target="_blank" href="#"><img src="https://cdn.cuiqingcai.com/nifs6.jpg" /></a>
                  </div>
                </div>
                <div class="ws_shadow"></div>
              </div>
            </div>
            <link rel="stylesheet" href="/lib/wowslide/slide.css">
            <script src="/lib/wowslide/jquery.min.js"></script>
            <script src="/lib/wowslide/slider.js"></script>
            <script>
              jQuery("#wowslider-container").wowSlider(
              {
                effect: "cube",
                prev: "",
                next: "",
                duration: 20 * 100,
                delay: 100 * 100,
                width: 716,
                height: 297,
                autoPlay: true,
                playPause: true,
                stopOnHover: false,
                loop: false,
                bullets: 0,
                caption: true,
                captionEffect: "slide",
                controls: true,
                onBeforeStep: 0,
                images: 0
              });

            </script>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/4921.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="静觅丨崔庆才的个人站点专业为您提供爬虫教程,爬虫,Python,Python爬虫,Python爬虫教程,爬虫书的相关信息，想要了解更多详情，请联系我们。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/4921.html" class="post-title-link" itemprop="url">TensorFlow MNIST高级学习</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>上一节使用了最简单的网络来处理了 MNIST 数据集，但只有 92% 的正确率，接下来我们使用卷积神经网络来实现更高的正确率。</p>
                  <h2 id="权重初始化"><a href="#权重初始化" class="headerlink" title="权重初始化"></a>权重初始化</h2>
                  <p>在上一节初始化 w 和 b 的时候，我们使用了置零初始化。但在卷积神经网络中，我们需要在初始化的时候权重加入少量噪声来打破对称性和避免零梯度，偏置项直接使用一个较小的正数来避免节点输出恒为零的问题。 所以权重我们可以使用截尾正态分布函数 truncated_normal() 来生成初始化张量，我们可以给它指定均值或标准差，均值默认是 0， 标准差默认是 1，例如我们生成一个 [10] 的张量，代码如下：</p>
                  <figure class="highlight vim">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import tensorflow <span class="keyword">as</span> <span class="keyword">tf</span></span><br><span class="line">initial = <span class="keyword">tf</span>.truncated_normal([<span class="number">10</span>], stddev=<span class="number">0.1</span>)</span><br><span class="line">with <span class="keyword">tf</span>.Session() <span class="keyword">as</span> ses<span class="variable">s:</span></span><br><span class="line">    <span class="keyword">print</span>(sess.run(initial))</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>结果如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">[<span class="number">-0.13058113</span>  <span class="number">0.03201858</span> <span class="number">-0.19349943</span> <span class="number">-0.06061752</span> <span class="number">-0.10267895</span> <span class="number">-0.11079147</span></span><br><span class="line">  <span class="number">0.1881365</span>  <span class="number">-0.01057311</span> <span class="number">-0.02797078</span>  <span class="number">0.01180232</span>]</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>另外 constant() 方法是用于生成常量的方法，例如生成一个 [10] 的常量张量，代码如下：</p>
                  <figure class="highlight vim">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import tensorflow <span class="keyword">as</span> <span class="keyword">tf</span></span><br><span class="line">initial = <span class="keyword">tf</span>.constant(<span class="number">0.2</span>, shape=[<span class="number">10</span>])</span><br><span class="line">with <span class="keyword">tf</span>.Session() <span class="keyword">as</span> ses<span class="variable">s:</span></span><br><span class="line">    <span class="keyword">print</span>(sess.run(initial))</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>结果如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">[ <span class="number">0.2</span>  <span class="number">0.2</span>  <span class="number">0.2</span>  <span class="number">0.2</span>  <span class="number">0.2</span>  <span class="number">0.2</span>  <span class="number">0.2</span>  <span class="number">0.2</span>  <span class="number">0.2</span>  <span class="number">0.2</span>]</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>所以这里我们可以将这两个方法封装成一个函数来尝试：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">def weight(shape, <span class="attribute">stddev</span>=0.1, <span class="attribute">mean</span>=0):</span><br><span class="line">    initial = tf.truncated_normal(<span class="attribute">shape</span>=shape, <span class="attribute">mean</span>=mean, <span class="attribute">stddev</span>=stddev)</span><br><span class="line">    return tf.Variable(initial)</span><br><span class="line"></span><br><span class="line">def bias(shape, value):</span><br><span class="line">    initial = tf.constant(<span class="attribute">value</span>=value, <span class="attribute">shape</span>=shape)</span><br><span class="line">    return tf.Variable(initial)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h2 id="卷积"><a href="#卷积" class="headerlink" title="卷积"></a>卷积</h2>
                  <p>这次我们需要使用卷积神经网络来处理图片，所以这里的核心部分就是卷积和池化了，首先我们来了解一下卷积和池化。 卷积常用的方法为 conv2d() ，它的 API 如下：</p>
                  <figure class="highlight pgsql">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">tf.nn.conv2d(<span class="keyword">input</span>, <span class="keyword">filter</span>, strides, padding, use_cudnn_on_gpu=<span class="keyword">None</span>, <span class="type">name</span>=<span class="keyword">None</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这个方法是 TensorFlow 实现卷积常用的方法，也是搭建卷积神经网络的核心方法，参数介绍如下：</p>
                  <ul>
                    <li>input，指需要做卷积的输入图像，它要求是一个 Tensor，具有 [batch_size, in_height, in_width, in_channels] 这样的 shape，具体含义是 [batch_size 的图片数量, 图片高度, 图片宽度, 输入图像通道数]，注意这是一个 4 维的 Tensor，要求类型为 float32 和 float64 其中之一。</li>
                    <li>filter，相当于 CNN 中的卷积核，它要求是一个 Tensor，具有 [filter_height, filter_width, in_channels, out_channels] 这样的shape，具体含义是 [卷积核的高度，卷积核的宽度，输入图像通道数，输出通道数（即卷积核个数）]，要求类型与参数 input 相同，有一个地方需要注意，第三维 in_channels，就是参数 input 的第四维。</li>
                    <li>strides，卷积时在图像每一维的步长，这是一个一维的向量，长度 4，具有 [stride_batch_size, stride_in_height, stride_in_width, stride_in_channels] 这样的 shape，第一个元素代表在一个样本的特征图上移动，第二三个元素代表在特征图上的高、宽上移动，第四个元素代表在通道上移动。</li>
                    <li>padding，string 类型的量，只能是 SAME、VALID 其中之一，这个值决定了不同的卷积方式。</li>
                    <li>use_cudnn_on_gpu，布尔类型，是否使用 cudnn 加速，默认为true。</li>
                  </ul>
                  <p>返回的结果是 [batch_size, out_height, out_width, out_channels] 维度的结果。 我们这里拿一张 3x3 的图片，单通道（通道为1）的图片，拿一个 1x1 的卷积核进行卷积：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">input = tf.Variable(tf.random_normal([1, 3, 3, 1]))</span><br><span class="line">filter = tf.Variable(tf.random_normal([1, 1, 1, 1]))</span><br><span class="line">op = tf.nn.conv2d(input, filter, strides=[1, 1, 1, 1], <span class="attribute">padding</span>=<span class="string">'VALID'</span>)</span><br><span class="line"><span class="builtin-name">print</span>(op.shape)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>结果如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">(<span class="number">1</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">1</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>很清晰，一张图片，拿一个 1x1 的核去做卷积，得到的结果输出是 3x3 的，输出通道为 1，batch_size 照旧。 再将卷积核扩大，用一个 3x3 的卷积核：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">input = tf.Variable(tf.random_normal([1, 3, 3, 1]))</span><br><span class="line">filter = tf.Variable(tf.random_normal([3, 3, 1, 1]))</span><br><span class="line">op = tf.nn.conv2d(input, filter, strides=[1, 1, 1, 1], <span class="attribute">padding</span>=<span class="string">'VALID'</span>)</span><br><span class="line"><span class="builtin-name">print</span>(op.shape)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>结果如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>最后输出的是一个 1x1 的值。 将图片扩大为 7x7，卷积核仍然使用 3x3：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">input = tf.Variable(tf.random_normal([1, 7, 7, 1]))</span><br><span class="line">filter = tf.Variable(tf.random_normal([3, 3, 1, 1]))</span><br><span class="line">op = tf.nn.conv2d(input, filter, strides=[1, 1, 1, 1], <span class="attribute">padding</span>=<span class="string">'VALID'</span>)</span><br><span class="line"><span class="builtin-name">print</span>(op.shape)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>结果如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">(<span class="number">1</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">1</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>最后输出的是一个 5x5 的值。 这时如果我们把 padding 模式改为 SAME，表示卷积核可以停留在图像边缘：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">input = tf.Variable(tf.random_normal([1, 7, 7, 1]))</span><br><span class="line">filter = tf.Variable(tf.random_normal([3, 3, 1, 1]))</span><br><span class="line">op = tf.nn.conv2d(input, filter, strides=[1, 1, 1, 1], <span class="attribute">padding</span>=<span class="string">'SAME'</span>)</span><br><span class="line"><span class="builtin-name">print</span>(op.shape)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>结果如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">(<span class="number">1</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">1</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>则输出的内容和原图像是相同的。 这时如果更改 batch_size 和 out_channels，比如 batch_size 修改为 3，out_channels 修改为 6：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">input = tf.Variable(tf.random_normal([3, 7, 7, 1]))</span><br><span class="line">filter = tf.Variable(tf.random_normal([3, 3, 1, 6]))</span><br><span class="line">op = tf.nn.conv2d(input, filter, strides=[1, 1, 1, 1], <span class="attribute">padding</span>=<span class="string">'SAME'</span>)</span><br><span class="line"><span class="builtin-name">print</span>(op.shape)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>结果如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">(<span class="number">3</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">6</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>输出结果的 batch_size 和 out_channels 会随之变化。 当 strides 的步长不为 1 的时候，我们将 stride_in_height 和 stride_in_width 修改为 2，相当于每次移动两步：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">input = tf.Variable(tf.random_normal([3, 7, 7, 1]))</span><br><span class="line">filter = tf.Variable(tf.random_normal([3, 3, 1, 6]))</span><br><span class="line">op = tf.nn.conv2d(input, filter, strides=[1, 2, 2, 1], <span class="attribute">padding</span>=<span class="string">'VALID'</span>)</span><br><span class="line"><span class="builtin-name">print</span>(op.shape)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>结果如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">(<span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">6</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>最后我们用一个例子来感受一下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import tensorflow as tf</span><br><span class="line"></span><br><span class="line">input = tf.Variable(tf.random_normal([2, 4, 4, 5]))</span><br><span class="line">filter = tf.Variable(tf.random_normal([2, 2, 5, 2]))</span><br><span class="line">op = tf.nn.conv2d(input, filter, strides=[1, 1, 1, 1], <span class="attribute">padding</span>=<span class="string">'VALID'</span>)</span><br><span class="line">sess = tf.InteractiveSession()</span><br><span class="line">tf.global_variables_initializer().<span class="builtin-name">run</span>()</span><br><span class="line"><span class="builtin-name">print</span>(op.shape)</span><br><span class="line"><span class="builtin-name">print</span>(sess.<span class="builtin-name">run</span>(op))</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里 input、filter 通过指定 shape 的方式调用 random_normal() 方法进行随机初始化，input 的维度为 [2, 4, 4, 5]，即 batch_size 为 2，图片是 4x4，输入通道数为 5，卷积核大小为 2x2，输入通道 5，输出通道 2，步长为 1，padding 方式选用 VALID，最后输出得到输出的 shape 和结果。 结果如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">(<span class="number">2</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">2</span>)</span><br><span class="line">[[[[  <span class="number">2.05039382</span>  <span class="number">-8.82934952</span>]</span><br><span class="line">   [ <span class="number">-9.77668381</span>   <span class="number">3.63882256</span>]</span><br><span class="line">   [ <span class="number">-4.46390772</span>  <span class="number">-5.91670704</span>]]</span><br><span class="line"></span><br><span class="line">  [[  <span class="number">8.41201782</span>  <span class="number">-6.72245312</span>]</span><br><span class="line">   [ <span class="number">-1.47592044</span>  <span class="number">13.03628349</span>]</span><br><span class="line">   [  <span class="number">5.44015312</span>   <span class="number">2.46059227</span>]]</span><br><span class="line"></span><br><span class="line">  [[ <span class="number">-3.18967772</span>   <span class="number">1.24733043</span>]</span><br><span class="line">   [<span class="number">-10.1108532</span>   <span class="number">-6.44734669</span>]</span><br><span class="line">   [  <span class="number">1.99426246</span>   <span class="number">2.91549349</span>]]]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> [[[ <span class="number">-1.66685319</span>   <span class="number">0.32011557</span>]</span><br><span class="line">   [ <span class="number">-5.66163826</span>  <span class="number">-0.37670898</span>]</span><br><span class="line">   [ <span class="number">-0.74658942</span>   <span class="number">1.31723833</span>]]</span><br><span class="line"></span><br><span class="line">  [[ <span class="number">-5.85412216</span>  <span class="number">-0.29930949</span>]</span><br><span class="line">   [ <span class="number">-0.75974303</span>  <span class="number">-1.84006214</span>]</span><br><span class="line">   [ <span class="number">-2.05475235</span>   <span class="number">4.9572196</span> ]]</span><br><span class="line"></span><br><span class="line">  [[ <span class="number">-4.09344864</span>   <span class="number">1.39405775</span>]</span><br><span class="line">   [ <span class="number">-1.28887582</span>  <span class="number">-2.82365012</span>]</span><br><span class="line">   [  <span class="number">4.87360907</span>  <span class="number">10.8071022</span> ]]]]</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可以看到 input 维度为 [2, 4, 4, 5]，filter 维度为 [2, 2, 5, 2] 时，生成的结果维度为 [2, 3, 3, 2]。</p>
                  <h2 id="池化"><a href="#池化" class="headerlink" title="池化"></a>池化</h2>
                  <p>池化层往往在卷积层后面，通过池化来降低卷积层输出的特征向量，同时改善结果。 在这里介绍一个常用的最大值池化 max_pool() 方法，其 API 如下：</p>
                  <figure class="highlight reasonml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">tf.nn.max<span class="constructor">_pool(<span class="params">value</span>, <span class="params">ksize</span>, <span class="params">strides</span>, <span class="params">padding</span>, <span class="params">name</span>=None)</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>是CNN当中的最大值池化操作，其实用法和卷积很类似。 参数介绍如下：</p>
                  <ul>
                    <li>value，需要池化的输入，一般池化层接在卷积层后面，所以输入通常是 feature map，依然是 [batch_size, height, width, channels] 这样的shape。</li>
                    <li>ksize，池化窗口的大小，取一个四维向量，一般是 [batch_size, height, width, channels]，因为我们不想在 batch 和 channels 上做池化，所以这两个维度设为了1。</li>
                    <li>strides，和卷积类似，窗口在每一个维度上滑动的步长，一般也是 [stride_batch_size, stride_height, stride_width, stride_channels]。</li>
                    <li>padding，和卷积类似，可以取 VALID、SAME，返回一个 Tensor，类型不变，shape 仍然是 [batch_size, height, width, channels] 这种形式。</li>
                  </ul>
                  <p>在这里输入为 [3, 7, 7, 2]，池化窗口设置为 [1, 2, 2, 1]，步长为 [1, 1, 1, 1]，padding 模式设置为 VALID。</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">input = tf.Variable(tf.random_normal([<span class="number">3</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">2</span>]))</span><br><span class="line">op = tf.nn.max_pool(input, ksize=[<span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>], strides=[<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>], padding=<span class="string">'VALID'</span>)</span><br><span class="line">print(op.shape)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>结果如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">(<span class="number">3</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">2</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>类似的原理，我们可以得到这样的的结果。</p>
                  <h2 id="卷积和池化"><a href="#卷积和池化" class="headerlink" title="卷积和池化"></a>卷积和池化</h2>
                  <p>所以了解了以上卷积和池化方法的用法，我们可以定义如下两个工具方法：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">def conv2d(input, filter, strides=[1, 1, 1, 1], <span class="attribute">padding</span>=<span class="string">'SAME'</span>):</span><br><span class="line">    return tf.nn.conv2d(input, filter, <span class="attribute">strides</span>=strides, <span class="attribute">padding</span>=padding)</span><br><span class="line"></span><br><span class="line">def max_pool(input, ksize=[1, 2, 2, 1], strides=[1, 2, 2, 1], <span class="attribute">padding</span>=<span class="string">'SAME'</span>):</span><br><span class="line">    return tf.nn.max_pool(input, <span class="attribute">ksize</span>=ksize, <span class="attribute">strides</span>=strides, <span class="attribute">padding</span>=padding)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这两个方法分别实现了卷积和池化，并设置了默认步长和核大小。 接下来就让我们开始神经网络的构建吧。</p>
                  <h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2>
                  <p>首先我们需要初始化一些数据，包括输入的 x 和对一个的标注 y_label：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">x = tf.placeholder(tf.<span class="built_in">float</span>32, shape=[None, <span class="number">784</span>])</span><br><span class="line">y_label = tf.placeholder(tf.<span class="built_in">float</span>32, shape=[None, <span class="number">10</span>])</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h2 id="第一层卷积"><a href="#第一层卷积" class="headerlink" title="第一层卷积"></a>第一层卷积</h2>
                  <p>现在我们可以开始实现第一层了。它由一个卷积接一个 max pooling 完成。卷积在每个 5x5 的 patch 中算出 32 个特征。卷积的权重张量形状是 [5, 5, 1, 32]，前两个维度是 patch 的大小，接着是输入的通道数目，最后是输出的通道数目，而对于每一个输出通道都有一个对应的偏置量，我们首先初始化 w 和 b</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">w_conv1 = weight([<span class="number">5</span>, <span class="number">5</span>, <span class="number">1</span>, <span class="number">32</span>])</span><br><span class="line">b_conv1 = bias([<span class="number">32</span>])</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>为了用这一层，我们把 x 变成一个四维向量，其第 2、3 维对应图片的宽、高，最后一维代表图片的颜色通道数，因为是灰度图所以这里的通道数为 1，如果是彩色图，则为 3。 随后我们需要对图片做 reshape 操作，将其</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">x_reshape = tf.reshape(x, [<span class="number">-1</span>, <span class="number">28</span>, <span class="number">28</span>, <span class="number">1</span>])</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>我们把 x_reshape 和权值向量进行卷积，加上偏置项，然后应用 ReLU 激活函数，最后进行 max pooling：</p>
                  <figure class="highlight smali">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">h_conv1 = tf.nn.relu(conv2d(x_reshape, w_conv1) + b_conv1)</span><br><span class="line">h_pool1 = max_pool(h_conv1)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h2 id="第二层卷积"><a href="#第二层卷积" class="headerlink" title="第二层卷积"></a>第二层卷积</h2>
                  <p>现在我们已经实现了一层卷积，为了构建一个更深的网络，我们再继续增加一层卷积，将通道数变成 64，所以这里的初始化权重和偏置为：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">w_conv2 = weight([<span class="number">5</span>, <span class="number">5</span>, <span class="number">32</span>, <span class="number">64</span>])</span><br><span class="line">b_conv2 = bias([<span class="number">64</span>])</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>随后我们把上一层池化结果 h_pool1 和权值向量进行卷积，加上偏置项，然后应用 ReLU 激活函数，最后进行 max pooling：</p>
                  <figure class="highlight smali">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">h_conv2 = tf.nn.relu(conv2d(h_pool1, w_conv2) + b_conv2)</span><br><span class="line">h_pool2 = max_pool(h_conv2)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h2 id="密集连接层"><a href="#密集连接层" class="headerlink" title="密集连接层"></a>密集连接层</h2>
                  <p>现在，图片尺寸减小到7x7，我们再加入一个有 1024 个神经元的全连接层，用于处理整个图片。我们把池化层输出的张量 reshape 成一些向量，乘上权重矩阵，加上偏置，然后对其使用 ReLU。</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">w_fc1 = weight([<span class="number">7</span> * <span class="number">7</span> * <span class="number">64</span>, <span class="number">1024</span>])</span><br><span class="line">b_fc1 = bias([<span class="number">1024</span>])</span><br><span class="line">h_pool2_flat = tf.reshape(h_pool2, [<span class="number">-1</span>, <span class="number">7</span> * <span class="number">7</span> * <span class="number">64</span>])</span><br><span class="line">h_fc1 = tf.nn.relu(tf.matmul(h_pool2_flat, w_fc1) + b_fc1)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h2 id="Dropout"><a href="#Dropout" class="headerlink" title="Dropout"></a>Dropout</h2>
                  <p>为了减少过拟合，我们在输出层之前加入 dropout。我们用一个 placeholder 来代表一个神经元的输出在 dropout 中保持不变的概率。这样我们可以在训练过程中启用 dropout，在测试过程中关闭 dropout。 TensorFlow 的 tf.nn.dropout 操作除了可以屏蔽神经元的输出外，还会自动处理神经元输出值的 scale，所以用 dropout 的时候可以不用考虑 scale。</p>
                  <figure class="highlight ini">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attr">keep_prob</span> = tf.placeholder(tf.float32)</span><br><span class="line"><span class="attr">h_fc1_dropout</span> = tf.nn.dropout(h_fc1, keep_prob=keep_prob)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h2 id="输出层"><a href="#输出层" class="headerlink" title="输出层"></a>输出层</h2>
                  <p>最后，我们添加一个 Softmax 输出层，这里我们需要将 1024 维转为 10 维，所以需要声明一个 [1024, 10] 的权重和 [10] 的偏置：</p>
                  <figure class="highlight ini">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attr">w_fc2</span> = weight([<span class="number">1024</span>, <span class="number">10</span>])</span><br><span class="line"><span class="attr">b_fc1</span> = bias([<span class="number">10</span>])</span><br><span class="line"><span class="attr">y</span> = tf.nn.softmax(tf.matmul(h_fc1_dropout, w_fc2) + b_fc1)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h2 id="训练和评估模型"><a href="#训练和评估模型" class="headerlink" title="训练和评估模型"></a>训练和评估模型</h2>
                  <p>为了进行训练和评估，我们使用与之前简单的单层 Softmax 神经网络模型几乎相同的一套代码，只是我们会用更加复杂的 Adam 优化器来做梯度最速下降，在 feed_dict 中加入额外的参数 keep_prob 来控制 dropout 比例，然后每 100次 迭代输出一次日志：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment"># Loss</span></span><br><span class="line">cross_entropy = -tf.reduce_sum(y_label * tf.log(y))</span><br><span class="line">train = tf.train.AdamOptimizer(1e-4).minimize(cross_entropy)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Prediction</span></span><br><span class="line">correct_prediction = tf.equal(tf.argmax(y_label, <span class="attribute">axis</span>=1), tf.argmax(y, <span class="attribute">axis</span>=1))</span><br><span class="line">accuracy = tf.reduce_mean(tf.cast(correct_prediction, tf.float32))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Train</span></span><br><span class="line">with tf.Session() as sess:</span><br><span class="line">    sess.<span class="builtin-name">run</span>(tf.global_variables_initializer())</span><br><span class="line">    <span class="keyword">for</span> <span class="keyword">step</span> <span class="keyword">in</span> range(total_steps + 1):</span><br><span class="line">        batch = mnist.train.next_batch(batch_size)</span><br><span class="line">        sess.<span class="builtin-name">run</span>(train, feed_dict=&#123;x: batch[0], y_label: batch[1], keep_prob: dropout_keep_prob&#125;)</span><br><span class="line">        # Train accuracy</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">step</span> % steps_per_test == 0:</span><br><span class="line">            <span class="builtin-name">print</span>(<span class="string">'Training Accuracy'</span>, <span class="keyword">step</span>,</span><br><span class="line">                  sess.<span class="builtin-name">run</span>(accuracy, feed_dict=&#123;x: batch[0], y_label: batch[1], keep_prob: 1&#125;))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Final Test</span></span><br><span class="line"><span class="builtin-name">print</span>(<span class="string">'Test Accuracy'</span>, sess.<span class="builtin-name">run</span>(accuracy, feed_dict=&#123;x: mnist.test.images, y_label: mnist.test.labels, keep_prob: 1&#125;))</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2>
                  <p>以上代码，在最终测试集上的准确率大概是99.2%。 运行结果：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">Training Accuracy <span class="number">0</span> <span class="number">0.05</span></span><br><span class="line">Training Accuracy <span class="number">100</span> <span class="number">0.7</span></span><br><span class="line">Training Accuracy <span class="number">200</span> <span class="number">0.85</span></span><br><span class="line">Training Accuracy <span class="number">300</span> <span class="number">0.9</span></span><br><span class="line">Training Accuracy <span class="number">400</span> <span class="number">0.93</span></span><br><span class="line">Training Accuracy <span class="number">500</span> <span class="number">0.91</span></span><br><span class="line">Training Accuracy <span class="number">600</span> <span class="number">0.94</span></span><br><span class="line">Training Accuracy <span class="number">700</span> <span class="number">0.95</span></span><br><span class="line">Training Accuracy <span class="number">800</span> <span class="number">0.95</span></span><br><span class="line">Training Accuracy <span class="number">900</span> <span class="number">0.95</span></span><br><span class="line">Training Accuracy <span class="number">1000</span> <span class="number">0.97</span></span><br><span class="line">Training Accuracy <span class="number">1100</span> <span class="number">0.95</span></span><br><span class="line">Training Accuracy <span class="number">1200</span> <span class="number">0.96</span></span><br><span class="line">Training Accuracy <span class="number">1300</span> <span class="number">0.99</span></span><br><span class="line">Training Accuracy <span class="number">1400</span> <span class="number">0.98</span></span><br><span class="line">Training Accuracy <span class="number">1500</span> <span class="number">0.95</span></span><br><span class="line">Training Accuracy <span class="number">1600</span> <span class="number">0.97</span></span><br><span class="line">Training Accuracy <span class="number">1700</span> <span class="number">1.0</span></span><br><span class="line">Training Accuracy <span class="number">1800</span> <span class="number">0.95</span></span><br><span class="line">Training Accuracy <span class="number">1900</span> <span class="number">0.95</span></span><br><span class="line">Training Accuracy <span class="number">2000</span> <span class="number">0.95</span></span><br><span class="line">Training Accuracy <span class="number">2100</span> <span class="number">0.96</span></span><br><span class="line">Training Accuracy <span class="number">2200</span> <span class="number">0.96</span></span><br><span class="line">Training Accuracy <span class="number">2300</span> <span class="number">0.98</span></span><br><span class="line">Training Accuracy <span class="number">2400</span> <span class="number">0.97</span></span><br><span class="line">Training Accuracy <span class="number">2500</span> <span class="number">0.96</span></span><br><span class="line">Training Accuracy <span class="number">2600</span> <span class="number">0.99</span></span><br><span class="line">Training Accuracy <span class="number">2700</span> <span class="number">0.96</span></span><br><span class="line">Training Accuracy <span class="number">2800</span> <span class="number">0.98</span></span><br><span class="line">Training Accuracy <span class="number">2900</span> <span class="number">0.95</span></span><br><span class="line">Training Accuracy <span class="number">3000</span> <span class="number">0.99</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2>
                  <p>本节我们实现了卷积神经网络来处理图像相关问题，将准确率大大提高，可见神经网络是非常强大的。</p>
                  <h2 id="本节代码"><a href="#本节代码" class="headerlink" title="本节代码"></a>本节代码</h2>
                  <p>本节代码地址为：<a href="https://github.com/AIDeepLearning/MNIST" target="_blank" rel="noopener">https://github.com/AIDeepLearning/MNIST</a>。</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2017-12-28 01:51:54" itemprop="dateCreated datePublished" datetime="2017-12-28T01:51:54+08:00">2017-12-28</time>
                </span>
                <span id="/4921.html" class="post-meta-item leancloud_visitors" data-flag-title="TensorFlow MNIST高级学习" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>8.9k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>8 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/4898.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="静觅丨崔庆才的个人站点专业为您提供爬虫教程,爬虫,Python,Python爬虫,Python爬虫教程,爬虫书的相关信息，想要了解更多详情，请联系我们。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/4898.html" class="post-title-link" itemprop="url">TensorFlow MNIST初级学习</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>我们本节要用 MNIST 数据集训练一个可以识别数据的深度学习模型来帮助识别手写数字。</p>
                  <h2 id="MNIST"><a href="#MNIST" class="headerlink" title="MNIST"></a>MNIST</h2>
                  <p>MNIST 是一个入门级计算机视觉数据集，包含了很多手写数字图片，如图所示： <img src="https://germey.gitbooks.io/ai/assets/2017-10-25-14-18-39.png" alt=""> 数据集中包含了图片和对应的标注，在 TensorFlow 中提供了这个数据集，我们可以用如下方法进行导入：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> tensorflow.examples.tutorials.mnist import input_data</span><br><span class="line">mnist = input_data.read_data_sets(<span class="string">'MNIST_data/'</span>, <span class="attribute">one_hot</span>=<span class="literal">True</span>)</span><br><span class="line"><span class="builtin-name">print</span>(mnist)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>输出结果如下：</p>
                  <figure class="highlight reasonml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">Extracting MNIST_data/train-images-idx3-ubyte.gz</span><br><span class="line">Extracting MNIST_data/train-labels-idx1-ubyte.gz</span><br><span class="line">Extracting MNIST_data/t10k-images-idx3-ubyte.gz</span><br><span class="line">Extracting MNIST_data/t10k-labels-idx1-ubyte.gz</span><br><span class="line"><span class="constructor">Datasets(<span class="params">train</span>=&lt;<span class="params">tensorflow</span>.<span class="params">contrib</span>.<span class="params">learn</span>.<span class="params">python</span>.<span class="params">learn</span>.<span class="params">datasets</span>.<span class="params">mnist</span>.DataSet <span class="params">object</span> <span class="params">at</span> 0x101707ef0&gt;, <span class="params">validation</span>=&lt;<span class="params">tensorflow</span>.<span class="params">contrib</span>.<span class="params">learn</span>.<span class="params">python</span>.<span class="params">learn</span>.<span class="params">datasets</span>.<span class="params">mnist</span>.DataSet <span class="params">object</span> <span class="params">at</span> 0x1016ae4a8&gt;, <span class="params">test</span>=&lt;<span class="params">tensorflow</span>.<span class="params">contrib</span>.<span class="params">learn</span>.<span class="params">python</span>.<span class="params">learn</span>.<span class="params">datasets</span>.<span class="params">mnist</span>.DataSet <span class="params">object</span> <span class="params">at</span> 0x1016f9358&gt;)</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在这里程序会首先下载 MNIST 数据集，然后解压并保存到刚刚制定好的 MNIST_data 文件夹中，然后输出数据集对象。 数据集中包含了 55000 行的训练数据集（mnist.train）、5000 行验证集（mnist.validation）和 10000 行的测试数据集（mnist.test），文件如下所示： <img src="https://germey.gitbooks.io/ai/assets/2017-10-25-14-26-54.jpg" alt=""> 正如前面提到的一样，每一个 MNIST 数据单元有两部分组成：一张包含手写数字的图片和一个对应的标签。我们把这些图片设为 xs，把这些标签设为 ys。训练数据集和测试数据集都包含 xs 和 ys，比如训练数据集的图片是 mnist.train.images ，训练数据集的标签是 mnist.train.labels，每张图片是 28 x 28 像素，即 784 个像素点，我们可以把它展开形成一个向量，即长度为 784 的向量。 所以训练集我们可以转化为 [55000, 784] 的向量，第一维就是训练集中包含的图片个数，第二维是图片的像素点表示的向量。</p>
                  <h2 id="Softmax"><a href="#Softmax" class="headerlink" title="Softmax"></a>Softmax</h2>
                  <p>Softmax 可以看成是一个激励（activation）函数或者链接（link）函数，把我们定义的线性函数的输出转换成我们想要的格式，也就是关于 10 个数字类的概率分布。因此，给定一张图片，它对于每一个数字的吻合度可以被 Softmax 函数转换成为一个概率值。Softmax 函数可以定义为： <img src="https://germey.gitbooks.io/ai/assets/2017-10-25-15-09-37.jpg" alt=""> 展开等式右边的子式，可以得到： <img src="https://germey.gitbooks.io/ai/assets/2017-10-25-15-10-04.jpg" alt=""> 比如判断一张图片中的动物是什么，可能的结果有三种，猫、狗、鸡，假如我们可以经过计算得出它们分别的得分为 3.2、5.1、-1.7，Softmax 的过程首先会对各个值进行次幂计算，分别为 24.5、164.0、0.18，然后计算各个次幂结果占总次幂结果的比重，这样就可以得到 0.13、0.87、0.00 这三个数值，所以这样我们就可以实现差别的放缩，即好的更好、差的更差。 如果要进一步求损失值可以进一步求对数然后取负值，这样 Softmax 后的值如果值越接近 1，那么得到的值越小，即损失越小，如果越远离 1，那么得到的值越大。</p>
                  <h2 id="实现回归模型"><a href="#实现回归模型" class="headerlink" title="实现回归模型"></a>实现回归模型</h2>
                  <p>首先导入 TensorFlow，命令如下：</p>
                  <figure class="highlight elm">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>接下来我们指定一个输入，在这里输入即为样本数据，如果是训练集那么则是 55000 x 784 的矩阵，如果是验证集则为 5000 x 784 的矩阵，如果是测试集则是 10000 x 784 的矩阵，所以它的行数是不确定的，但是列数是确定的。 所以可以先声明一个 placeholder 对象：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">x = tf.placeholder(tf.<span class="built_in">float</span>32, [None, <span class="number">784</span>])</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里第一个参数指定了矩阵中每个数据的类型，第二个参数指定了数据的维度。 接下来我们需要构建第一层网络，表达式如下： <img src="https://germey.gitbooks.io/ai/assets/2017-10-25-15-27-25.jpg" alt=""> 这里实际上是对输入的 x 乘以 w 权重，然后加上一个偏置项作为输出，而这两个变量实际是在训练的过程中动态调优的，所以我们需要指定它们的类型为 Variable，代码如下：</p>
                  <figure class="highlight reasonml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">w = tf.<span class="constructor">Variable(<span class="params">tf</span>.<span class="params">zeros</span>([784, 10])</span>)</span><br><span class="line">b = tf.<span class="constructor">Variable(<span class="params">tf</span>.<span class="params">zeros</span>([10])</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>接下来需要实现的就是上图所述的公式了，我们再进一步调用 Softmax 进行计算，得到 y：</p>
                  <figure class="highlight vim">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">y</span> = <span class="keyword">tf</span>.<span class="keyword">nn</span>.softmax(<span class="keyword">tf</span>.matmul(<span class="keyword">x</span>, <span class="keyword">w</span>) + <span class="keyword">b</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>通过上面几行代码我们就已经把模型构建完毕了，结构非常简单。</p>
                  <h2 id="损失函数"><a href="#损失函数" class="headerlink" title="损失函数"></a>损失函数</h2>
                  <p>为了训练我们的模型，我们首先需要定义一个指标来评估这个模型是好的。其实，在机器学习，我们通常定义指标来表示一个模型是坏的，这个指标称为成本（cost）或损失（loss），然后尽量最小化这个指标。但是这两种方式是相同的。 一个非常常见的，非常漂亮的成本函数是“交叉熵”（cross-entropy）。交叉熵产生于信息论里面的信息压缩编码技术，但是它后来演变成为从博弈论到机器学习等其他领域里的重要技术手段。它的定义如下： <img src="https://germey.gitbooks.io/ai/assets/2017-10-25-15-45-09.jpg" alt=""> y 是我们预测的概率分布, y_label 是实际的分布，比较粗糙的理解是，交叉熵是用来衡量我们的预测用于描述真相的低效性。 我们可以首先定义 y_label，它的表达式是：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">y_label = tf.placeholder(tf.<span class="built_in">float</span>32, [None, <span class="number">10</span>])</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>接下来我们需要计算它们的交叉熵，代码如下：</p>
                  <figure class="highlight reasonml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">cross_entropy = tf.reduce<span class="constructor">_mean(-<span class="params">tf</span>.<span class="params">reduce_sum</span>(<span class="params">y_label</span> <span class="operator">*</span> <span class="params">tf</span>.<span class="params">log</span>(<span class="params">y</span>)</span>, reduction_indices=<span class="literal">[<span class="number">1</span>]</span>))</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>首先用 reduce_sum() 方法针对每一个维度进行求和，reduction_indices 是指定沿哪些维度进行求和。 然后调用 reduce_mean() 则求平均值，将一个向量中的所有元素求算平均值。 这样我们最后只需要优化这个交叉熵就好了。 所以这样我们再定义一个优化方法：</p>
                  <figure class="highlight ini">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attr">train</span> = tf.train.GradientDescentOptimizer(<span class="number">0.5</span>).minimize(cross_entropy)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里使用了 GradientDescentOptimizer，在这里，我们要求 TensorFlow 用梯度下降算法（gradient descent algorithm）以 0.5 的学习速率最小化交叉熵。梯度下降算法（gradient descent algorithm）是一个简单的学习过程，TensorFlow 只需将每个变量一点点地往使成本不断降低的方向移动即可。</p>
                  <h2 id="运行模型"><a href="#运行模型" class="headerlink" title="运行模型"></a>运行模型</h2>
                  <p>定义好了以上内容之后，相当于我们已经构建好了一个计算图，即设置好了模型，我们把它放到 Session 里面运行即可：</p>
                  <figure class="highlight reasonml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">with</span> tf.<span class="constructor">Session()</span> <span class="keyword">as</span> sess:</span><br><span class="line">    sess.run(tf.global<span class="constructor">_variables_initializer()</span>)</span><br><span class="line">    for step <span class="keyword">in</span> range(total_steps + <span class="number">1</span>):</span><br><span class="line">        batch_x, batch_y = mnist.train.next<span class="constructor">_batch(<span class="params">batch_size</span>)</span></span><br><span class="line">        sess.run(train, feed_dict=&#123;x: batch_x, y_label: batch_y&#125;)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>该循环的每个步骤中，我们都会随机抓取训练数据中的 batch_size 个批处理数据点，然后我们用这些数据点作为参数替换之前的占位符来运行 train。 这里需要一些变量的定义：</p>
                  <figure class="highlight ini">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attr">batch_size</span> = <span class="number">100</span></span><br><span class="line"><span class="attr">total_steps</span> = <span class="number">5000</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h2 id="测试模型"><a href="#测试模型" class="headerlink" title="测试模型"></a>测试模型</h2>
                  <p>那么我们的模型性能如何呢？ 首先让我们找出那些预测正确的标签。tf.argmax() 是一个非常有用的函数，它能给出某个 Tensor 对象在某一维上的其数据最大值所在的索引值。由于标签向量是由 0,1 组成，因此最大值 1 所在的索引位置就是类别标签，比如 tf.argmax(y, 1) 返回的是模型对于任一输入 x 预测到的标签值，而 tf.argmax(y_label, 1) 代表正确的标签，我们可以用 tf.equal() 方法来检测我们的预测是否真实标签匹配（索引位置一样表示匹配）。</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">correct_prediction = tf.equal(tf.argmax(y, <span class="attribute">axis</span>=1), tf.argmax(y_label, <span class="attribute">axis</span>=1))</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这行代码会给我们一组布尔值。为了确定正确预测项的比例，我们可以把布尔值转换成浮点数，然后取平均值。例如，[True, False, True, True] 会变成 [1, 0, 1, 1] ，取平均值后得到 0.75。</p>
                  <figure class="highlight reasonml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">accuracy = tf.reduce<span class="constructor">_mean(<span class="params">tf</span>.<span class="params">cast</span>(<span class="params">correct_prediction</span>, <span class="params">tf</span>.<span class="params">float32</span>)</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>最后，我们计算所学习到的模型在测试数据集上面的正确率，定义如下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">steps_per_test = 100</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">step</span> % steps_per_test == 0:</span><br><span class="line">    <span class="builtin-name">print</span>(<span class="keyword">step</span>, sess.<span class="builtin-name">run</span>(accuracy, feed_dict=&#123;x: mnist.test.images, y_label: mnist.test.labels&#125;))</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这个最终结果值应该大约是92%。 这样我们就通过完成了训练和测试阶段，实现了一个基本的训练模型，后面我们会继续优化模型来达到更好的效果。 运行结果如下：</p>
                  <figure class="highlight basic">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="symbol">0 </span><span class="number">0.453</span></span><br><span class="line"><span class="symbol">100 </span><span class="number">0.8915</span></span><br><span class="line"><span class="symbol">200 </span><span class="number">0.9026</span></span><br><span class="line"><span class="symbol">300 </span><span class="number">0.9081</span></span><br><span class="line"><span class="symbol">400 </span><span class="number">0.9109</span></span><br><span class="line"><span class="symbol">500 </span><span class="number">0.9108</span></span><br><span class="line"><span class="symbol">600 </span><span class="number">0.9175</span></span><br><span class="line"><span class="symbol">700 </span><span class="number">0.9137</span></span><br><span class="line"><span class="symbol">800 </span><span class="number">0.9158</span></span><br><span class="line"><span class="symbol">900 </span><span class="number">0.9176</span></span><br><span class="line"><span class="symbol">1000 </span><span class="number">0.9167</span></span><br><span class="line"><span class="symbol">1100 </span><span class="number">0.9186</span></span><br><span class="line"><span class="symbol">1200 </span><span class="number">0.9206</span></span><br><span class="line"><span class="symbol">1300 </span><span class="number">0.9161</span></span><br><span class="line"><span class="symbol">1400 </span><span class="number">0.9218</span></span><br><span class="line"><span class="symbol">1500 </span><span class="number">0.9179</span></span><br><span class="line"><span class="symbol">1600 </span><span class="number">0.916</span></span><br><span class="line"><span class="symbol">1700 </span><span class="number">0.9196</span></span><br><span class="line"><span class="symbol">1800 </span><span class="number">0.9222</span></span><br><span class="line"><span class="symbol">1900 </span><span class="number">0.921</span></span><br><span class="line"><span class="symbol">2000 </span><span class="number">0.9223</span></span><br><span class="line"><span class="symbol">2100 </span><span class="number">0.9214</span></span><br><span class="line"><span class="symbol">2200 </span><span class="number">0.9191</span></span><br><span class="line"><span class="symbol">2300 </span><span class="number">0.9228</span></span><br><span class="line"><span class="symbol">2400 </span><span class="number">0.9228</span></span><br><span class="line"><span class="symbol">2500 </span><span class="number">0.9218</span></span><br><span class="line"><span class="symbol">2600 </span><span class="number">0.9197</span></span><br><span class="line"><span class="symbol">2700 </span><span class="number">0.9225</span></span><br><span class="line"><span class="symbol">2800 </span><span class="number">0.9238</span></span><br><span class="line"><span class="symbol">2900 </span><span class="number">0.9219</span></span><br><span class="line"><span class="symbol">3000 </span><span class="number">0.9224</span></span><br><span class="line"><span class="symbol">3100 </span><span class="number">0.9184</span></span><br><span class="line"><span class="symbol">3200 </span><span class="number">0.9253</span></span><br><span class="line"><span class="symbol">3300 </span><span class="number">0.9216</span></span><br><span class="line"><span class="symbol">3400 </span><span class="number">0.9218</span></span><br><span class="line"><span class="symbol">3500 </span><span class="number">0.9212</span></span><br><span class="line"><span class="symbol">3600 </span><span class="number">0.9225</span></span><br><span class="line"><span class="symbol">3700 </span><span class="number">0.9224</span></span><br><span class="line"><span class="symbol">3800 </span><span class="number">0.9225</span></span><br><span class="line"><span class="symbol">3900 </span><span class="number">0.9226</span></span><br><span class="line"><span class="symbol">4000 </span><span class="number">0.9201</span></span><br><span class="line"><span class="symbol">4100 </span><span class="number">0.9138</span></span><br><span class="line"><span class="symbol">4200 </span><span class="number">0.9184</span></span><br><span class="line"><span class="symbol">4300 </span><span class="number">0.9222</span></span><br><span class="line"><span class="symbol">4400 </span><span class="number">0.92</span></span><br><span class="line"><span class="symbol">4500 </span><span class="number">0.924</span></span><br><span class="line"><span class="symbol">4600 </span><span class="number">0.9234</span></span><br><span class="line"><span class="symbol">4700 </span><span class="number">0.9219</span></span><br><span class="line"><span class="symbol">4800 </span><span class="number">0.923</span></span><br><span class="line"><span class="symbol">4900 </span><span class="number">0.9254</span></span><br><span class="line"><span class="symbol">5000 </span><span class="number">0.9218</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2>
                  <p>本节通过一个 MNIST 数据集来简单体验了一下真实数据的训练和预测过程，但是准确率还不够高，后面我们会学习用卷积的方式来进行模型训练，准确率会更高。</p>
                  <h2 id="本节代码"><a href="#本节代码" class="headerlink" title="本节代码"></a>本节代码</h2>
                  <p>本节代码地址为：<a href="https://github.com/AIDeepLearning/MNIST" target="_blank" rel="noopener">https://github.com/AIDeepLearning/MNIST</a>。</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2017-12-09 00:36:31" itemprop="dateCreated datePublished" datetime="2017-12-09T00:36:31+08:00">2017-12-09</time>
                </span>
                <span id="/4898.html" class="post-meta-item leancloud_visitors" data-flag-title="TensorFlow MNIST初级学习" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>4.8k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>4 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/4893.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="静觅丨崔庆才的个人站点专业为您提供爬虫教程,爬虫,Python,Python爬虫,Python爬虫教程,爬虫书的相关信息，想要了解更多详情，请联系我们。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/4893.html" class="post-title-link" itemprop="url">TensorFlow基础入门</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>本篇内容基于 Python3 TensorFlow 1.4 版本。</p>
                  <h2 id="本节内容"><a href="#本节内容" class="headerlink" title="本节内容"></a>本节内容</h2>
                  <p>本节通过最简单的示例 —— 平面拟合来说明 TensorFlow 的基本用法。</p>
                  <h2 id="构造数据"><a href="#构造数据" class="headerlink" title="构造数据"></a>构造数据</h2>
                  <p>TensorFlow 的引入方式是：</p>
                  <figure class="highlight elm">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>接下来我们构造一些随机的三维数据，然后用 TensorFlow 找到平面去拟合它，首先我们用 Numpy 生成随机三维点，其中变量 x 代表三维点的 (x, y) 坐标，是一个 2x100 的矩阵，即 100 个 (x, y)，然后变量 y 代表三位点的 z 坐标，我们用 Numpy 来生成这些随机的点：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">import</span> numpy as np</span><br><span class="line">x_data = np.<span class="built_in">float</span>32(np.random.rand(<span class="number">2</span>, <span class="number">100</span>))</span><br><span class="line">y_data = np.dot([<span class="number">0.300</span>, <span class="number">0.200</span>], x_data) + <span class="number">0.400</span></span><br><span class="line"></span><br><span class="line">print(x_data)</span><br><span class="line">print(y_data)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里利用 Numpy 的 random 模块的 rand() 方法生成了 2x100 的随机矩阵，这样就生成了 100 个 (x, y) 坐标，然后用了一个 dot() 方法算了矩阵乘法，用了一个长度为 2 的向量跟此矩阵相乘，得到一个长度为 100 的向量，然后再加上一个常量，得到 z 坐标，输出结果样例如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">[[ <span class="number">0.97232962</span>  <span class="number">0.08897641</span>  <span class="number">0.54844421</span>  <span class="number">0.5877986</span>   <span class="number">0.5121088</span>   <span class="number">0.64716059</span></span><br><span class="line">   <span class="number">0.22353953</span>  <span class="number">0.18406206</span>  <span class="number">0.16782761</span>  <span class="number">0.97569454</span>  <span class="number">0.65686035</span>  <span class="number">0.75569868</span></span><br><span class="line">   <span class="number">0.35698661</span>  <span class="number">0.43332314</span>  <span class="number">0.41185728</span>  <span class="number">0.24801297</span>  <span class="number">0.50098598</span>  <span class="number">0.12025958</span></span><br><span class="line">   <span class="number">0.40650111</span>  <span class="number">0.51486945</span>  <span class="number">0.19292323</span>  <span class="number">0.03679928</span>  <span class="number">0.56501174</span>  <span class="number">0.5321334</span></span><br><span class="line">   <span class="number">0.71044683</span>  <span class="number">0.00318134</span>  <span class="number">0.76611853</span>  <span class="number">0.42602748</span>  <span class="number">0.33002195</span>  <span class="number">0.04414672</span></span><br><span class="line">   <span class="number">0.73208278</span>  <span class="number">0.62182301</span>  <span class="number">0.49471655</span>  <span class="number">0.8116194</span>   <span class="number">0.86148429</span>  <span class="number">0.48835048</span></span><br><span class="line">   <span class="number">0.69902027</span>  <span class="number">0.14901569</span>  <span class="number">0.18737803</span>  <span class="number">0.66826463</span>  <span class="number">0.43462989</span>  <span class="number">0.35768151</span></span><br><span class="line">   <span class="number">0.79315376</span>  <span class="number">0.0400687</span>   <span class="number">0.76952982</span>  <span class="number">0.12236254</span>  <span class="number">0.61519378</span>  <span class="number">0.92795062</span></span><br><span class="line">   <span class="number">0.84952474</span>  <span class="number">0.16663995</span>  <span class="number">0.13729768</span>  <span class="number">0.50603199</span>  <span class="number">0.38752931</span>  <span class="number">0.39529857</span></span><br><span class="line">   <span class="number">0.29228279</span>  <span class="number">0.09773371</span>  <span class="number">0.43220878</span>  <span class="number">0.2603009</span>   <span class="number">0.14576958</span>  <span class="number">0.21881725</span></span><br><span class="line">   <span class="number">0.64888018</span>  <span class="number">0.41048348</span>  <span class="number">0.27641159</span>  <span class="number">0.61700606</span>  <span class="number">0.49728736</span>  <span class="number">0.75936913</span></span><br><span class="line">   <span class="number">0.04028837</span>  <span class="number">0.88986284</span>  <span class="number">0.84112513</span>  <span class="number">0.34227493</span>  <span class="number">0.69162005</span>  <span class="number">0.89058989</span></span><br><span class="line">   <span class="number">0.39744586</span>  <span class="number">0.85080278</span>  <span class="number">0.37685293</span>  <span class="number">0.80529863</span>  <span class="number">0.31220895</span>  <span class="number">0.50500977</span></span><br><span class="line">   <span class="number">0.95800418</span>  <span class="number">0.43696108</span>  <span class="number">0.04143282</span>  <span class="number">0.05169986</span>  <span class="number">0.33503434</span>  <span class="number">0.1671818</span></span><br><span class="line">   <span class="number">0.10234453</span>  <span class="number">0.31241918</span>  <span class="number">0.23630807</span>  <span class="number">0.37890589</span>  <span class="number">0.63020509</span>  <span class="number">0.78184551</span></span><br><span class="line">   <span class="number">0.87924582</span>  <span class="number">0.99288088</span>  <span class="number">0.30762389</span>  <span class="number">0.43499199</span>  <span class="number">0.53140771</span>  <span class="number">0.43461791</span></span><br><span class="line">   <span class="number">0.23833922</span>  <span class="number">0.08681628</span>  <span class="number">0.74615192</span>  <span class="number">0.25835371</span>]</span><br><span class="line"> [ <span class="number">0.8174957</span>   <span class="number">0.26717573</span>  <span class="number">0.23811154</span>  <span class="number">0.02851068</span>  <span class="number">0.9627012</span>   <span class="number">0.36802396</span></span><br><span class="line">   <span class="number">0.50543582</span>  <span class="number">0.29964805</span>  <span class="number">0.44869211</span>  <span class="number">0.23191817</span>  <span class="number">0.77344608</span>  <span class="number">0.36636299</span></span><br><span class="line">   <span class="number">0.56170034</span>  <span class="number">0.37465382</span>  <span class="number">0.00471885</span>  <span class="number">0.19509546</span>  <span class="number">0.49715847</span>  <span class="number">0.15201907</span></span><br><span class="line">   <span class="number">0.5642485</span>   <span class="number">0.70218688</span>  <span class="number">0.6031307</span>   <span class="number">0.4705168</span>   <span class="number">0.98698962</span>  <span class="number">0.865367</span></span><br><span class="line">   <span class="number">0.36558965</span>  <span class="number">0.72073907</span>  <span class="number">0.83386165</span>  <span class="number">0.29963031</span>  <span class="number">0.72276717</span>  <span class="number">0.98171854</span></span><br><span class="line">   <span class="number">0.30932376</span>  <span class="number">0.52615297</span>  <span class="number">0.35522953</span>  <span class="number">0.13186514</span>  <span class="number">0.73437029</span>  <span class="number">0.03887378</span></span><br><span class="line">   <span class="number">0.1208882</span>   <span class="number">0.67004597</span>  <span class="number">0.83422536</span>  <span class="number">0.17487818</span>  <span class="number">0.71460873</span>  <span class="number">0.51926661</span></span><br><span class="line">   <span class="number">0.55297899</span>  <span class="number">0.78169805</span>  <span class="number">0.77547258</span>  <span class="number">0.92139858</span>  <span class="number">0.25020468</span>  <span class="number">0.70916855</span></span><br><span class="line">   <span class="number">0.68722379</span>  <span class="number">0.75378138</span>  <span class="number">0.30182058</span>  <span class="number">0.91982585</span>  <span class="number">0.93160367</span>  <span class="number">0.81539184</span></span><br><span class="line">   <span class="number">0.87977934</span>  <span class="number">0.07394848</span>  <span class="number">0.1004181</span>   <span class="number">0.48765802</span>  <span class="number">0.73601437</span>  <span class="number">0.59894943</span></span><br><span class="line">   <span class="number">0.34601998</span>  <span class="number">0.69065076</span>  <span class="number">0.6768015</span>   <span class="number">0.98533565</span>  <span class="number">0.83803362</span>  <span class="number">0.47194552</span></span><br><span class="line">   <span class="number">0.84103006</span>  <span class="number">0.84892255</span>  <span class="number">0.04474261</span>  <span class="number">0.02038293</span>  <span class="number">0.50802571</span>  <span class="number">0.15178065</span></span><br><span class="line">   <span class="number">0.86116213</span>  <span class="number">0.51097614</span>  <span class="number">0.44155359</span>  <span class="number">0.67713588</span>  <span class="number">0.66439205</span>  <span class="number">0.67885226</span></span><br><span class="line">   <span class="number">0.4243969</span>   <span class="number">0.35731083</span>  <span class="number">0.07878648</span>  <span class="number">0.53950399</span>  <span class="number">0.84162414</span>  <span class="number">0.24412845</span></span><br><span class="line">   <span class="number">0.61285144</span>  <span class="number">0.00316137</span>  <span class="number">0.67407191</span>  <span class="number">0.83218956</span>  <span class="number">0.94473189</span>  <span class="number">0.09813353</span></span><br><span class="line">   <span class="number">0.16728765</span>  <span class="number">0.95433819</span>  <span class="number">0.1416636</span>   <span class="number">0.4220584</span>   <span class="number">0.35413414</span>  <span class="number">0.55999744</span></span><br><span class="line">   <span class="number">0.94829601</span>  <span class="number">0.62568033</span>  <span class="number">0.89808714</span>  <span class="number">0.07021013</span>]]</span><br><span class="line">[ <span class="number">0.85519803</span>  <span class="number">0.48012807</span>  <span class="number">0.61215557</span>  <span class="number">0.58204171</span>  <span class="number">0.74617288</span>  <span class="number">0.66775297</span></span><br><span class="line">  <span class="number">0.56814902</span>  <span class="number">0.51514823</span>  <span class="number">0.5400867</span>   <span class="number">0.739092</span>    <span class="number">0.75174732</span>  <span class="number">0.6999822</span></span><br><span class="line">  <span class="number">0.61943605</span>  <span class="number">0.60492771</span>  <span class="number">0.52450095</span>  <span class="number">0.51342299</span>  <span class="number">0.64972749</span>  <span class="number">0.46648169</span></span><br><span class="line">  <span class="number">0.63480003</span>  <span class="number">0.69489821</span>  <span class="number">0.57850311</span>  <span class="number">0.50514314</span>  <span class="number">0.76690145</span>  <span class="number">0.73271342</span></span><br><span class="line">  <span class="number">0.68625198</span>  <span class="number">0.54510222</span>  <span class="number">0.79660789</span>  <span class="number">0.58773431</span>  <span class="number">0.64356002</span>  <span class="number">0.60958773</span></span><br><span class="line">  <span class="number">0.68148959</span>  <span class="number">0.6917775</span>   <span class="number">0.61946087</span>  <span class="number">0.66985885</span>  <span class="number">0.80531934</span>  <span class="number">0.5542799</span></span><br><span class="line">  <span class="number">0.63388372</span>  <span class="number">0.5787139</span>   <span class="number">0.62305848</span>  <span class="number">0.63545502</span>  <span class="number">0.67331071</span>  <span class="number">0.61115777</span></span><br><span class="line">  <span class="number">0.74854193</span>  <span class="number">0.56836022</span>  <span class="number">0.78595346</span>  <span class="number">0.62098848</span>  <span class="number">0.63459907</span>  <span class="number">0.8202189</span></span><br><span class="line">  <span class="number">0.79230218</span>  <span class="number">0.60074826</span>  <span class="number">0.50155342</span>  <span class="number">0.73577477</span>  <span class="number">0.70257953</span>  <span class="number">0.68166794</span></span><br><span class="line">  <span class="number">0.6636407</span>   <span class="number">0.44410981</span>  <span class="number">0.54974625</span>  <span class="number">0.57562188</span>  <span class="number">0.59093375</span>  <span class="number">0.58543506</span></span><br><span class="line">  <span class="number">0.66386805</span>  <span class="number">0.6612752</span>   <span class="number">0.61828378</span>  <span class="number">0.78216895</span>  <span class="number">0.71679293</span>  <span class="number">0.72219985</span></span><br><span class="line">  <span class="number">0.58029252</span>  <span class="number">0.83674336</span>  <span class="number">0.66128606</span>  <span class="number">0.50675907</span>  <span class="number">0.70909116</span>  <span class="number">0.6975331</span></span><br><span class="line">  <span class="number">0.69146618</span>  <span class="number">0.75743606</span>  <span class="number">0.6013666</span>   <span class="number">0.77701676</span>  <span class="number">0.6265411</span>   <span class="number">0.68727338</span></span><br><span class="line">  <span class="number">0.77228063</span>  <span class="number">0.60255049</span>  <span class="number">0.42818714</span>  <span class="number">0.52341076</span>  <span class="number">0.66883513</span>  <span class="number">0.49898023</span></span><br><span class="line">  <span class="number">0.55327365</span>  <span class="number">0.49435803</span>  <span class="number">0.6057068</span>   <span class="number">0.68010968</span>  <span class="number">0.77800791</span>  <span class="number">0.65418036</span></span><br><span class="line">  <span class="number">0.69723127</span>  <span class="number">0.8887319</span>   <span class="number">0.52061989</span>  <span class="number">0.61490928</span>  <span class="number">0.63024914</span>  <span class="number">0.64238486</span></span><br><span class="line">  <span class="number">0.66116097</span>  <span class="number">0.55118095</span>  <span class="number">0.80346301</span>  <span class="number">0.49154814</span>]</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样我们就得到了一些三维的点。</p>
                  <h2 id="构造模型"><a href="#构造模型" class="headerlink" title="构造模型"></a>构造模型</h2>
                  <p>随后我们用 TensorFlow 来根据这些数据拟合一个平面，拟合的过程实际上就是寻找 (x, y) 和 z 的关系，即变量 x_data 和变量 y_data 的关系，而它们之间的关系刚才我们用了线性变换表示出来了，即 z = w * (x, y) + b，所以拟合的过程实际上就是找 w 和 b 的过程，所以这里我们就首先像设变量一样来设两个变量 w 和 b，代码如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">x = tf.placeholder(tf.<span class="built_in">float</span>32, [<span class="number">2</span>, <span class="number">100</span>])</span><br><span class="line">y_label = tf.placeholder(tf.<span class="built_in">float</span>32, [<span class="number">100</span>])</span><br><span class="line">b = tf.Variable(tf.zeros([<span class="number">1</span>]))</span><br><span class="line">w = tf.Variable(tf.random_uniform([<span class="number">2</span>], <span class="number">-1.0</span>, <span class="number">1.0</span>))</span><br><span class="line">y = tf.matmul(tf.reshape(w, [<span class="number">1</span>, <span class="number">2</span>]), x) + b</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在创建模型的时候，我们首先可以将现有的变量来表示出来，用 placeholder() 方法声明即可，一会我们在运行的时候传递给它真实的数据就好，第一个参数是数据类型，第二个参数是形状，因为 x_data 是 2x100 的矩阵，所以这里形状定义为 [2, 100]，而 y_data 是长度为 100 的向量，所以这里形状定义为 [100]，当然此处使用元组定义也可以，不过要写成 (100, )。 随后我们用 Variable 初始化了 TensorFlow 中的变量，b 初始化为一个常量，w 是一个随机初始化的 1x2 的向量，范围在 -1 和 1 之间，然后 y 再用 w、x、b 表示出来，其中 matmul() 方法就是 TensorFlow 中提供的矩阵乘法，类似 Numpy 的 dot() 方法。不过不同的是 matmul() 不支持向量和矩阵相乘，即不能 BroadCast，所以在这里做乘法前需要先调用 reshape() 一下转成 1x2 的标准矩阵，最后将结果表示为 y。 这样我们就构造出来了一个线性模型。 这里的 y 是我们模型中输出的值，而真实的数据却是我们输入的 y_data，即 y_label。</p>
                  <h2 id="损失函数"><a href="#损失函数" class="headerlink" title="损失函数"></a>损失函数</h2>
                  <p>要拟合这个平面的话，我们需要减小 y_label 和 y 的差距就好了，这个差距越小越好。 所以接下来我们可以定义一个损失函数，来代表模型实际输出值和真实值之间的差距，我们的目的就是来减小这个损失，代码实现如下：</p>
                  <figure class="highlight reasonml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">loss = tf.reduce<span class="constructor">_mean(<span class="params">tf</span>.<span class="params">square</span>(<span class="params">y</span> - <span class="params">y_label</span>)</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里调用了 square() 方法，传入 y_label 和 y 的差来求得平方和，然后使用 reduce_mean() 方法得到这个值的平均值，这就是现在模型的损失值，我们的目的就是减小这个损失值，所以接下来我们使用梯度下降的方法来减小这个损失值即可，定义如下代码：</p>
                  <figure class="highlight ini">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attr">optimizer</span> = tf.train.GradientDescentOptimizer(<span class="number">0.5</span>)</span><br><span class="line"><span class="attr">train</span> = optimizer.minimize(loss)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里定义了 GradientDescentOptimizer 优化，即使用梯度下降的方法来减小这个损失值，我们训练模型就是来模拟这个过程。</p>
                  <h2 id="运行模型"><a href="#运行模型" class="headerlink" title="运行模型"></a>运行模型</h2>
                  <p>最后我们将模型运行起来即可，运行时必须声明一个 Session 对象，然后初始化所有的变量，然后执行一步步的训练即可，实现如下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">with tf.Session() as sess:</span><br><span class="line">    sess.<span class="builtin-name">run</span>(tf.global_variables_initializer())</span><br><span class="line">    <span class="keyword">for</span> <span class="keyword">step</span> <span class="keyword">in</span> range(201):</span><br><span class="line">        sess.<span class="builtin-name">run</span>(train, feed_dict=&#123;x: x_data, y: y_data&#125;)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">step</span> % 10 == 0:</span><br><span class="line">            <span class="builtin-name">print</span>(<span class="keyword">step</span>, sess.<span class="builtin-name">run</span>(w), sess.<span class="builtin-name">run</span>(b))</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里定义了 200 次循环，每一次循环都会执行一次梯度下降优化，每次循环都调用一次 run() 方法，传入的变量就是刚才定义个 train 对象，feed_dict 就把 placeholder 类型的变量赋值即可。随着训练的进行，损失会越来越小，w 和 b 也会被慢慢调整为拟合的值。 在这里每 10 次 循环我们都打印输出一下拟合的 w 和 b 的值，结果如下：</p>
                  <figure class="highlight basic">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="symbol">0 </span>[ <span class="number">0.31494665</span>  <span class="number">0.33602586</span>] [ <span class="number">0.84270978</span>]</span><br><span class="line"><span class="symbol">10 </span>[ <span class="number">0.19601417</span>  <span class="number">0.17301694</span>] [ <span class="number">0.47917289</span>]</span><br><span class="line"><span class="symbol">20 </span>[ <span class="number">0.23550016</span>  <span class="number">0.18053198</span>] [ <span class="number">0.44838765</span>]</span><br><span class="line"><span class="symbol">30 </span>[ <span class="number">0.26029009</span>  <span class="number">0.18700737</span>] [ <span class="number">0.43032286</span>]</span><br><span class="line"><span class="symbol">40 </span>[ <span class="number">0.27547371</span>  <span class="number">0.19152154</span>] [ <span class="number">0.41897511</span>]</span><br><span class="line"><span class="symbol">50 </span>[ <span class="number">0.28481475</span>  <span class="number">0.19454622</span>] [ <span class="number">0.41185945</span>]</span><br><span class="line"><span class="symbol">60 </span>[ <span class="number">0.29058149</span>  <span class="number">0.19652548</span>] [ <span class="number">0.40740564</span>]</span><br><span class="line"><span class="symbol">70 </span>[ <span class="number">0.2941508</span>   <span class="number">0.19780098</span>] [ <span class="number">0.40462157</span>]</span><br><span class="line"><span class="symbol">80 </span>[ <span class="number">0.29636407</span>  <span class="number">0.1986146</span> ] [ <span class="number">0.40288284</span>]</span><br><span class="line"><span class="symbol">90 </span>[ <span class="number">0.29773837</span>  <span class="number">0.19913</span>   ] [ <span class="number">0.40179768</span>]</span><br><span class="line"><span class="symbol">100 </span>[ <span class="number">0.29859257</span>  <span class="number">0.19945487</span>] [ <span class="number">0.40112072</span>]</span><br><span class="line"><span class="symbol">110 </span>[ <span class="number">0.29912385</span>  <span class="number">0.199659</span>  ] [ <span class="number">0.40069857</span>]</span><br><span class="line"><span class="symbol">120 </span>[ <span class="number">0.29945445</span>  <span class="number">0.19978693</span>] [ <span class="number">0.40043539</span>]</span><br><span class="line"><span class="symbol">130 </span>[ <span class="number">0.29966027</span>  <span class="number">0.19986697</span>] [ <span class="number">0.40027133</span>]</span><br><span class="line"><span class="symbol">140 </span>[ <span class="number">0.29978839</span>  <span class="number">0.19991697</span>] [ <span class="number">0.40016907</span>]</span><br><span class="line"><span class="symbol">150 </span>[ <span class="number">0.29986817</span>  <span class="number">0.19994824</span>] [ <span class="number">0.40010536</span>]</span><br><span class="line"><span class="symbol">160 </span>[ <span class="number">0.29991791</span>  <span class="number">0.1999677</span> ] [ <span class="number">0.40006563</span>]</span><br><span class="line"><span class="symbol">170 </span>[ <span class="number">0.29994887</span>  <span class="number">0.19997987</span>] [ <span class="number">0.40004089</span>]</span><br><span class="line"><span class="symbol">180 </span>[ <span class="number">0.29996812</span>  <span class="number">0.19998746</span>] [ <span class="number">0.40002549</span>]</span><br><span class="line"><span class="symbol">190 </span>[ <span class="number">0.29998016</span>  <span class="number">0.19999218</span>] [ <span class="number">0.40001586</span>]</span><br><span class="line"><span class="symbol">200 </span>[ <span class="number">0.29998764</span>  <span class="number">0.19999513</span>] [ <span class="number">0.40000987</span>]</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可以看到，随着训练的进行，w 和 b 也慢慢接近真实的值，拟合越来越精确，接近正确的值。</p>
                  <h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2>
                  <p>以上便是通过一个最简单的平面拟合的案例来说明了一下 TensorFlow 的用法，是不是很简单？</p>
                  <h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2>
                  <p>本节代码地址：<a href="https://github.com/AIDeepLearning/TensorFlowBasis" target="_blank" rel="noopener">https://github.com/AIDeepLearning/TensorFlowBasis</a>。</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2017-12-09 00:24:47" itemprop="dateCreated datePublished" datetime="2017-12-09T00:24:47+08:00">2017-12-09</time>
                </span>
                <span id="/4893.html" class="post-meta-item leancloud_visitors" data-flag-title="TensorFlow基础入门" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>6.2k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>6 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/4889.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="静觅丨崔庆才的个人站点专业为您提供爬虫教程,爬虫,Python,Python爬虫,Python爬虫教程,爬虫书的相关信息，想要了解更多详情，请联系我们。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Linux <i class="label-arrow"></i>
                  </a>
                  <a href="/4889.html" class="post-title-link" itemprop="url">小白学爬虫-批量部署Splash负载集群</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p><a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/QQ图片20161021225948.jpg" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/QQ图片20161021225948.jpg" alt=""></a> 部署公司生产环境的 Splash 集群无奈节点太多 差点被搞死·· 还好我有运维神器 Ansible，一次编撰终生可用啊！而且这玩意儿 等幂特性 扩容回滚 So Easy！！ 闲话少说开搞！</p>
                  <h2 id="安装-Ansible："><a href="#安装-Ansible：" class="headerlink" title="安装 Ansible："></a>安装 Ansible：</h2>
                  <p>看官方文档去：<a href="http://www.ansible.com.cn/index.html" target="_blank" rel="noopener">http://www.ansible.com.cn/index.html</a> 好像这个主控端不支持 Windows？ 大家虚拟机装个 Ubuntu 吧。</p>
                  <h2 id="闲话少扯直接上干货："><a href="#闲话少扯直接上干货：" class="headerlink" title="闲话少扯直接上干货："></a>闲话少扯直接上干货：</h2>
                  <p>整体目录如下：</p>
                  <figure class="highlight stylus">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">study@study:~/文档/ansible-examples$ tree Splash_Load_balancing_cluster</span><br><span class="line">Splash_Load_balancing_cluster</span><br><span class="line">├── group_vars</span><br><span class="line">│   └── all</span><br><span class="line">├── roles</span><br><span class="line">│   ├── common</span><br><span class="line">│   │   ├── files</span><br><span class="line">│   │   │   ├── CentOS-Base.repo</span><br><span class="line">│   │   │   ├── docker-ce.repo</span><br><span class="line">│   │   │   ├── epel.repo</span><br><span class="line">│   │   │   ├── ntp.conf</span><br><span class="line">│   │   │   └── RPM-GPG-KEY-EPEL-<span class="number">7</span></span><br><span class="line">│   │   ├── tasks</span><br><span class="line">│   │   │   └── main.yml</span><br><span class="line">│   │   └── templates</span><br><span class="line">│   ├── docker</span><br><span class="line">│   │   ├── handlers</span><br><span class="line">│   │   │   └── main.yml</span><br><span class="line">│   │   ├── tasks</span><br><span class="line">│   │   │   └── main.yml</span><br><span class="line">│   │   └── templates</span><br><span class="line">│   │       └── daemon<span class="selector-class">.json</span>.j2</span><br><span class="line">│   ├── haproxy</span><br><span class="line">│   │   ├── handlers</span><br><span class="line">│   │   │   └── main.yml</span><br><span class="line">│   │   ├── tasks</span><br><span class="line">│   │   │   └── main.yml</span><br><span class="line">│   │   └── templates</span><br><span class="line">│   │       └── haproxy<span class="selector-class">.cfg</span>.j2</span><br><span class="line">│   └── splash</span><br><span class="line">│       ├── files</span><br><span class="line">│       │   ├── filters</span><br><span class="line">│       │   │   └── default.txt</span><br><span class="line">│       │   ├── js-profiles</span><br><span class="line">│       │   ├── lua_modules</span><br><span class="line">│       │   └── proxy-profiles</span><br><span class="line">│       │       └── proxy.ini</span><br><span class="line">│       └── tasks</span><br><span class="line">│           └── main.yml</span><br><span class="line">├── site.retry</span><br><span class="line">└── site.yml</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>Group_vars： 里面定义全局使用的变量 Roles: 存放所有的规则目录 Roles/common :所有服务器初始化配置部署 Roles/common/filters :需要使用的文件或者文件夹 Roles/common/task：部署任务（main.yml 为入口必须要有） Roles/common/templates :配置模板（jinja2 模板语法 用于可变更的配置文件，可获取定义在 Group_vars 中的变量） Roles/Docker ：Docker 的安装配置 Roles/HAproxy ： HAproxy 的负载均衡配置 Roles/Splash : Splash 的镜像拉取配置部署以及启动 site.yml ： 启动入口</p>
                  <h2 id="使用方法："><a href="#使用方法：" class="headerlink" title="使用方法："></a>使用方法：</h2>
                  <h4 id="在你的-Inventory-文件定义好主机分组："><a href="#在你的-Inventory-文件定义好主机分组：" class="headerlink" title="在你的 Inventory 文件定义好主机分组："></a>在你的 Inventory 文件定义好主机分组：</h4>
                  <p>必须包括 HaProxy、和 Docker 两个分组如下：</p>
                  <figure class="highlight accesslog">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">study@study:~/文档/ansible-examples$ cat /etc/ansible/inventory/splash</span><br><span class="line"><span class="string">[docker]</span></span><br><span class="line"><span class="number">1.1.1.1</span></span><br><span class="line"><span class="string">[haproxy]</span></span><br><span class="line"><span class="number">10.253.20.25</span></span><br><span class="line"></span><br><span class="line"><span class="string">[splash_ports]</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h4 id="主控端新建-SSH-秘钥并发布到你你需要配置的所有主机！！！！（一定要注意如果本机当前工作用户在远程主机不存在额时候，需要指定-remote-user-这个参数）："><a href="#主控端新建-SSH-秘钥并发布到你你需要配置的所有主机！！！！（一定要注意如果本机当前工作用户在远程主机不存在额时候，需要指定-remote-user-这个参数）：" class="headerlink" title="主控端新建 SSH 秘钥并发布到你你需要配置的所有主机！！！！（一定要注意如果本机当前工作用户在远程主机不存在额时候，需要指定 remote_user 这个参数）："></a>主控端新建 SSH 秘钥并发布到你你需要配置的所有主机！！！！（一定要注意如果本机当前工作用户在远程主机不存在额时候，需要指定 remote_user 这个参数）：</h4>
                  <figure class="highlight elixir">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">study<span class="variable">@study</span><span class="symbol">:~/</span>文档/ansible-examples<span class="variable">$ </span>cat /etc/ansible/ansible.cfg</span><br><span class="line">[defaults]</span><br><span class="line">inventory= <span class="regexp">/etc/ansible</span><span class="regexp">/inventory/</span></span><br><span class="line"></span><br><span class="line">remote_user=root</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>好了开始执行：</p>
                  <figure class="highlight elixir">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">study<span class="variable">@study</span><span class="symbol">:~/</span>文档/ansible-examples/Splash_Load_balancing_cluster<span class="variable">$ </span>ansible-playbook site.yml</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>效果就像这样：</p>
                  <figure class="highlight markdown">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">PLAY [all] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span></span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">ok: [10.1.4.101]</span><br><span class="line">ok: [10.1.4.100]</span><br><span class="line"></span><br><span class="line">TASK [common : Copy the CentOS repository definition] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></span><br><span class="line">ok: [10.1.4.100]</span><br><span class="line">ok: [10.1.4.101]</span><br><span class="line"></span><br><span class="line">TASK [common : Copy the Docker repository definition] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></span><br><span class="line">ok: [10.1.4.100]</span><br><span class="line">ok: [10.1.4.101]</span><br><span class="line"></span><br><span class="line">TASK [common : Create the repository for EPEL] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>**</span><br><span class="line">ok: [10.1.4.100]</span><br><span class="line">ok: [10.1.4.101]</span><br><span class="line"></span><br><span class="line">TASK [common : Create the GPG key for EPEL] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></span><br><span class="line">ok: [10.1.4.100]</span><br><span class="line">ok: [10.1.4.101]</span><br><span class="line"></span><br><span class="line">TASK [common : Firewalld service stop] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></span><br><span class="line">ok: [10.1.4.100]</span><br><span class="line">ok: [10.1.4.101]</span><br><span class="line"></span><br><span class="line">TASK [common : Chronyd service stop] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>**</span><br><span class="line">ok: [10.1.4.100]</span><br><span class="line">ok: [10.1.4.101]</span><br><span class="line"></span><br><span class="line">TASK [common : Install Ansible Base package] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span>*</span><br><span class="line">ok: [10.1.4.100] =&gt; (item=['libselinux-python', 'libsemanage-python', 'ntp'])</span><br><span class="line">ok: [10.1.4.101] =&gt; (item=['libselinux-python', 'libsemanage-python', 'ntp'])</span><br><span class="line"></span><br><span class="line">TASK [common : Configure SELinux to disable] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span>*</span><br><span class="line"> [WARNING]: SELinux state change will take effect next reboot</span><br><span class="line"></span><br><span class="line">ok: [10.1.4.100]</span><br><span class="line">ok: [10.1.4.101]</span><br><span class="line"></span><br><span class="line">TASK [common : Change TimeZone] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>**</span><br><span class="line">ok: [10.1.4.100]</span><br><span class="line">ok: [10.1.4.101]</span><br><span class="line"></span><br><span class="line">TASK [common : Copy NTP conf] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span>*</span><br><span class="line">ok: [10.1.4.100]</span><br><span class="line">ok: [10.1.4.101]</span><br><span class="line"></span><br><span class="line">TASK [common : NTP Start] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span></span><br><span class="line">ok: [10.1.4.100]</span><br><span class="line">ok: [10.1.4.101]</span><br><span class="line"></span><br><span class="line">PLAY [docker] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">ok: [10.1.4.101]</span><br><span class="line"></span><br><span class="line">TASK [docker : Install Docker package] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></span><br><span class="line">ok: [10.1.4.101] =&gt; (item=['yum-utils', 'device-mapper-persistent-data', 'lvm2', 'docker-ce'])</span><br><span class="line"></span><br><span class="line">TASK [docker : Start Docker] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></span><br><span class="line">ok: [10.1.4.101]</span><br><span class="line"></span><br><span class="line">TASK [docker : Create Docker Speed Configuration file] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span>*</span><br><span class="line">ok: [10.1.4.101]</span><br><span class="line"></span><br><span class="line">TASK [docker : Restart Docker] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span></span><br><span class="line">changed: [10.1.4.101]</span><br><span class="line"></span><br><span class="line">TASK [splash : pull splash] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">changed: [10.1.4.101]</span><br><span class="line"></span><br><span class="line">TASK [splash : Copy Splash module] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">***</span>*</span><br><span class="line">ok: [10.1.4.101] =&gt; (item=filters)</span><br><span class="line">ok: [10.1.4.101] =&gt; (item=js-profiles)</span><br><span class="line">ok: [10.1.4.101] =&gt; (item=lua_modules)</span><br><span class="line">ok: [10.1.4.101] =&gt; (item=proxy-profiles)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>静静等着跑完 就可以愉快的使用啦 ！ 需要增加节点的话直接把 IP 加载 Docker 分组下 重新执行一遍就可以了！ 需要注意如果 SSH 非默认的 22 端口还需要指定你的端口号！怎么指定 看看文档去 以上完毕！！！ 完整的看这儿：<a href="https://github.com/thsheep/ansible-examples" target="_blank" rel="noopener">https://github.com/thsheep/ansible-examples</a></p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/哎哟卧槽" class="author" itemprop="url" rel="index">哎哟卧槽</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2017-12-02 11:32:07" itemprop="dateCreated datePublished" datetime="2017-12-02T11:32:07+08:00">2017-12-02</time>
                </span>
                <span id="/4889.html" class="post-meta-item leancloud_visitors" data-flag-title="小白学爬虫-批量部署Splash负载集群" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>6.7k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>6 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/4886.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="静觅丨崔庆才的个人站点专业为您提供爬虫教程,爬虫,Python,Python爬虫,Python爬虫教程,爬虫书的相关信息，想要了解更多详情，请联系我们。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/4886.html" class="post-title-link" itemprop="url">小白学爬虫-在无GUI的CentOS上使用Selenium+Chrome</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>2019 年 01 月 04 日 16:32:17 更新了新的 Chrome 镜像 将 Python 版本升级到了 3.7 Note: 推荐使用结尾提供的 Docker 镜像进行二次打包运行代码 各位小伙伴儿的采集日常是不是被 JavaScript 的各种点击事件折腾的欲仙欲死啊？好不容易找到个 Selenium+Chrome 可以解决问题！ 但是另一个 ▄█▀█● 的事实摆在面前，服务器都特么没有 GUI 啊·· <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/11/20160124759183737.gif" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/11/20160124759183737.gif" alt=""></a> 好吧！咱们要知难而上！决不能被这个点小困难打倒······· 然而摆在面前的事实是···· 他丫的各种装不上啊！坑爹啊！ 那么我来拯救你们于水火之间了！ <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/9555112.jpg" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/9555112.jpg" alt=""></a> 服务器如下：</p>
                  <figure class="highlight yaml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="string">[root@spider01</span> <span class="string">~]#</span> <span class="string">hostnamectl</span></span><br><span class="line">   <span class="attr">Static hostname:</span> <span class="string">spider01</span></span><br><span class="line">         <span class="attr">Icon name:</span> <span class="string">computer-vm</span></span><br><span class="line">           <span class="attr">Chassis:</span> <span class="string">vm</span></span><br><span class="line">        <span class="attr">Machine ID:</span> <span class="string">1c4029c4e7fd42498e25bb75101f85b6</span></span><br><span class="line">           <span class="attr">Boot ID:</span> <span class="string">f5a67454b94b454fae3d75ef1ccab69f</span></span><br><span class="line">    <span class="attr">Virtualization:</span> <span class="string">kvm</span></span><br><span class="line">  <span class="attr">Operating System:</span> <span class="string">CentOS</span> <span class="string">Linux</span> <span class="number">7</span> <span class="string">(Core)</span></span><br><span class="line">       <span class="attr">CPE OS Name:</span> <span class="string">cpe:/o:centos:centos:7</span></span><br><span class="line">            <span class="attr">Kernel:</span> <span class="string">Linux</span> <span class="number">3.10</span><span class="number">.0</span><span class="number">-514.6</span><span class="number">.2</span><span class="string">.el7.x86_64</span></span><br><span class="line">      <span class="attr">Architecture:</span> <span class="string">x86-64</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>安装 Chromeium:</p>
                  <figure class="highlight autoit">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="meta">## 安装yum源</span></span><br><span class="line">[root<span class="symbol">@spider01</span> ~]<span class="meta"># sudo yum install -y epel-release</span></span><br><span class="line"><span class="meta">## 安装Chrome</span></span><br><span class="line">[root<span class="symbol">@spider01</span> ~]<span class="meta"># yum install -y chromium</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>去这个地方：<a href="https://sites.google.com/a/chromium.org/chromedriver/downloads" target="_blank" rel="noopener">https://sites.google.com/a/chromium.org/chromedriver/downloads</a> 下载 ChromeDriver 驱动放在/usr/bin/目录下： 完成结果如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">[<span class="symbol">root@</span>spider01 ~]# ll /usr/bin/ | grep chrom</span><br><span class="line">-rwxrwxrwx. <span class="number">1</span> root root   <span class="number">7500280</span> <span class="number">11</span>月 <span class="number">29</span> <span class="number">17</span>:<span class="number">32</span> chromedriver</span><br><span class="line">lrwxrwxrwx. <span class="number">1</span> root root        <span class="number">47</span> <span class="number">11</span>月 <span class="number">30</span> <span class="number">09</span>:<span class="number">35</span> chromium-browser -&gt; /usr/lib64/chromium-browser/chromium-browser.sh</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>安装 XVFB：</p>
                  <figure class="highlight autoit">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">[root<span class="symbol">@spider01</span> ~]<span class="meta"># yum install Xvfb -y</span></span><br><span class="line">[root<span class="symbol">@spider01</span> ~]<span class="meta"># yum install xorg-x11-fonts* -y</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>新建在/usr/bin/ 一个名叫 xvfb-chromium 的文件写入以下内容：</p>
                  <figure class="highlight bash">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">[root@spider01 ~]<span class="comment"># cat /usr/bin/xvfb-chromium</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">_kill_procs</span></span>() &#123;</span><br><span class="line">  <span class="built_in">kill</span> -TERM <span class="variable">$chromium</span></span><br><span class="line">  <span class="built_in">wait</span> <span class="variable">$chromium</span></span><br><span class="line">  <span class="built_in">kill</span> -TERM <span class="variable">$xvfb</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Setup a trap to catch SIGTERM and relay it to child processes</span></span><br><span class="line"><span class="built_in">trap</span> _kill_procs SIGTERM</span><br><span class="line"></span><br><span class="line">XVFB_WHD=<span class="variable">$&#123;XVFB_WHD:-1280x720x16&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Start Xvfb</span></span><br><span class="line">Xvfb :99 -ac -screen 0 <span class="variable">$XVFB_WHD</span> -nolisten tcp &amp;</span><br><span class="line">xvfb=$!</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> DISPLAY=:99</span><br><span class="line"></span><br><span class="line">chromium --no-sandbox --<span class="built_in">disable</span>-gpu<span class="variable">$@</span> &amp;</span><br><span class="line">chromium=$!</span><br><span class="line"></span><br><span class="line"><span class="built_in">wait</span> <span class="variable">$chromium</span></span><br><span class="line"><span class="built_in">wait</span> <span class="variable">$xvfb</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>更改软连接：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">## 更改Chrome启动的软连接</span><br><span class="line">[<span class="symbol">root@</span>spider01 ~]# ln -s /usr/lib64/chromium-browser/chromium-browser.sh /usr/bin/chromium</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[<span class="symbol">root@</span>spider01 ~]# rm -rf /usr/bin/chromium-browser</span><br><span class="line"></span><br><span class="line">[<span class="symbol">root@</span>spider01 ~]# ln -s /usr/bin/xvfb-chromium /usr/bin/chromium-browser</span><br><span class="line"></span><br><span class="line">[<span class="symbol">root@</span>spider01 ~]# ln -s /usr/bin/xvfb-chromium /usr/bin/google-chrome</span><br><span class="line"></span><br><span class="line">[<span class="symbol">root@</span>spider01 ~]# ll /usr/bin/ | grep chrom*</span><br><span class="line">-rwxrwxrwx. <span class="number">1</span> root root   <span class="number">7500280</span> <span class="number">11</span>月 <span class="number">29</span> <span class="number">17</span>:<span class="number">32</span> chromedriver</span><br><span class="line">lrwxrwxrwx. <span class="number">1</span> root root        <span class="number">47</span> <span class="number">11</span>月 <span class="number">30</span> <span class="number">09</span>:<span class="number">47</span> chromium -&gt; /usr/lib64/chromium-browser/chromium-browser.sh</span><br><span class="line">lrwxrwxrwx. <span class="number">1</span> root root        <span class="number">22</span> <span class="number">11</span>月 <span class="number">30</span> <span class="number">09</span>:<span class="number">48</span> chromium-browser -&gt; /usr/bin/xvfb-chromium</span><br><span class="line">-rwxr-xr-x. <span class="number">1</span> root root     <span class="number">73848</span> <span class="number">12</span>月  <span class="number">7</span> <span class="number">2016</span> chronyc</span><br><span class="line">lrwxrwxrwx. <span class="number">1</span> root root        <span class="number">22</span> <span class="number">11</span>月 <span class="number">30</span> <span class="number">09</span>:<span class="number">48</span> google-chrome -&gt; /usr/bin/xvfb-chromium</span><br><span class="line">-rwxrwxrwx. <span class="number">1</span> root root       <span class="number">387</span> <span class="number">11</span>月 <span class="number">29</span> <span class="number">18</span>:<span class="number">16</span> xvfb-chromium</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>来瞅瞅能不能用哦：</p>
                  <figure class="highlight ruby">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; from selenium import webdriver</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; options = webdriver.ChromeOptions()</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; options.add_argument(<span class="string">'--headless'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; options.add_argument(<span class="string">'--no-sandbox'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; options.add_argument(<span class="string">'--disable-extensions'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; options.add_argument(<span class="string">'--disable-gpu'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; driver = webdriver.Chrome(options=options)</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; driver.get(<span class="string">"http://www.baidu.com"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; driver.find_element_by_xpath(<span class="string">"./*//input[@id='kw']"</span>).send_keys(<span class="string">"哎哟卧槽"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; driver.find_element_by_xpath(<span class="string">"./*//input[@id='su']"</span>).click()</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; driver.page_source</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p><a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/QQ图片20161021223818.jpg" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/QQ图片20161021223818.jpg" alt=""></a><strong>No problem！！！！</strong> 好了部署完了！当然 Docker 这么火贼适合懒人了！来来 看这儿 Docker 版的 妥妥滴！</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">docker pull thsheep/python:<span class="number">3.7</span>-debian-chrome</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>做好了 Python3.7 和 Chrome 集成 需要自己使用 Dockerfile 来重新打包安装你需要的 Python 包。</p>
                  <h3 id="Note-请按照以下方式初始化-Webdriver！！！！！！！！"><a href="#Note-请按照以下方式初始化-Webdriver！！！！！！！！" class="headerlink" title="Note: 请按照以下方式初始化 Webdriver！！！！！！！！"></a><strong>Note: 请按照以下方式初始化 Webdriver！！！！！！！！</strong></h3>
                  <figure class="highlight reasonml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">from selenium import webdriver</span><br><span class="line"></span><br><span class="line">options = webdriver.<span class="constructor">ChromeOptions()</span></span><br><span class="line">options.add<span class="constructor">_argument('--<span class="params">headless</span>')</span></span><br><span class="line">options.add<span class="constructor">_argument('--<span class="params">no</span>-<span class="params">sandbox</span>')</span></span><br><span class="line">options.add<span class="constructor">_argument('--<span class="params">disable</span>-<span class="params">extensions</span>')</span></span><br><span class="line">options.add<span class="constructor">_argument('--<span class="params">disable</span>-<span class="params">gpu</span>')</span></span><br><span class="line"></span><br><span class="line">driver = webdriver.<span class="constructor">Chrome(<span class="params">options</span>=<span class="params">options</span>)</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h2 id="否则会出现无法初始化-Webdriver-的情况"><a href="#否则会出现无法初始化-Webdriver-的情况" class="headerlink" title="否则会出现无法初始化 Webdriver 的情况"></a>否则会出现无法初始化 Webdriver 的情况</h2>
                  <h2 id="顺便一提！！！！这个玩意儿从事-Web-测试工作的小伙伴可以用！！！！！！！！"><a href="#顺便一提！！！！这个玩意儿从事-Web-测试工作的小伙伴可以用！！！！！！！！" class="headerlink" title="顺便一提！！！！这个玩意儿从事 Web 测试工作的小伙伴可以用！！！！！！！！"></a>顺便一提！！！！这个玩意儿从事 Web 测试工作的小伙伴可以用！！！！！！！！</h2>
                  <p>下面是 Dockerfile 文件：</p>
                  <figure class="highlight jboss-cli">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">FROM python<span class="function">:3.7-stretch</span></span><br><span class="line"></span><br><span class="line">ENV DBUS_SESSION_BUS_ADDRESS=<span class="string">/dev/null</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#============================================</span></span><br><span class="line"><span class="comment"># Google Chrome</span></span><br><span class="line"><span class="comment">#============================================</span></span><br><span class="line">RUN wget -q -O - https:<span class="string">//dl-ssl.google.com/linux/linux_signing_key.pub</span> | apt-key add - &amp;&amp; \</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"deb http://dl.google.com/linux/chrome/deb/ stable main"</span> &gt;&gt; <span class="string">/etc/apt/sources.list.d/google-chrome.list</span> &amp;&amp; \</span><br><span class="line">apt-get update -qqy &amp;&amp; \</span><br><span class="line">apt-get -qqy install google-chrome-stable unzip&amp;&amp; \</span><br><span class="line">rm <span class="string">/etc/apt/sources.list.d/google-chrome.list</span> &amp;&amp; \</span><br><span class="line">rm -rf <span class="string">/var/lib/apt/lists/</span>* <span class="string">/var/cache/apt/</span>*</span><br><span class="line"></span><br><span class="line"><span class="comment">#==================</span></span><br><span class="line"><span class="comment"># Chrome driver</span></span><br><span class="line"><span class="comment"># CHROME_DRIVER_VERSION 需要根据上面安装的Chrome版本来设置（最好设置成最新版本）</span></span><br><span class="line"><span class="comment"># http://chromedriver.chromium.org/downloads 版本号在这页面上查看</span></span><br><span class="line"><span class="comment">#==================</span></span><br><span class="line">ARG CHROME_DRIVER_VERSION=2.45</span><br><span class="line">RUN wget -O <span class="string">/tmp/chromedriver.zip</span> https:<span class="string">//chromedriver.storage.googleapis.com/</span>$CHROME_DRIVER_VERSION/chromedriver_linux64.zip &amp;&amp; \</span><br><span class="line">rm -rf <span class="string">/opt/selenium/chromedriver</span> &amp;&amp; \</span><br><span class="line">unzip <span class="string">/tmp/chromedriver.zip</span> -d <span class="string">/opt/selenium</span> &amp;&amp; \</span><br><span class="line">rm <span class="string">/tmp/chromedriver.zip</span> &amp;&amp; \</span><br><span class="line">mv <span class="string">/opt/selenium/chromedriver</span> <span class="string">/opt/selenium/chromedriver-</span>$CHROME_DRIVER_VERSION &amp;&amp; \</span><br><span class="line">chmod 755 <span class="string">/opt/selenium/chromedriver-</span>$CHROME_DRIVER_VERSION &amp;&amp; \</span><br><span class="line">ln -fs <span class="string">/opt/selenium/chromedriver-</span>$CHROME_DRIVER_VERSION <span class="string">/usr/bin/chromedriver</span></span><br><span class="line"></span><br><span class="line">RUN google-chrome-stable <span class="params">--version</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/哎哟卧槽" class="author" itemprop="url" rel="index">哎哟卧槽</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2017-11-30 10:32:12" itemprop="dateCreated datePublished" datetime="2017-11-30T10:32:12+08:00">2017-11-30</time>
                </span>
                <span id="/4886.html" class="post-meta-item leancloud_visitors" data-flag-title="小白学爬虫-在无GUI的CentOS上使用Selenium+Chrome" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>4.7k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>4 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/4880.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="静觅丨崔庆才的个人站点专业为您提供爬虫教程,爬虫,Python,Python爬虫,Python爬虫教程,爬虫书的相关信息，想要了解更多详情，请联系我们。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/4880.html" class="post-title-link" itemprop="url">小白学爬虫-设置Selenium+Chrome代理</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p><a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/11/20160124759183737.gif" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/11/20160124759183737.gif" alt=""></a> 微博登录限制了错误次数···加上 Cookie 大批账号被封需要从 Cookie 池中 剔除被封的账号··· 需要使用代理··· 无赖百度了大半天都是特么的啥玩意儿？？？结果换成了 Google 手到擒来 分分钟解决（那么问题来了？百度除了卖假药还会干啥？） <strong>Selenium+Chrome 认证代理不能通过 options 处理。只能换个方法使用扩展解决</strong> 原文地址：<a href="https://stackoverflow.com/questions/29983106/how-can-i-set-proxy-with-authentication-in-selenium-chrome-web-driver-using-pyth#answer-30953780" target="_blank" rel="noopener">https://stackoverflow.com/questions/29983106/how-can-i-set-proxy-with-authentication-in-selenium-chrome-web-driver-using-pyth#answer-30953780</a> （Stack Overflow 这是个好地方啊） <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/9555112.jpg" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/9555112.jpg" alt=""></a> 走你！</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Time    : 2017/11/15 9:50</span></span><br><span class="line"><span class="comment"># @Author  : 哎哟卧槽</span></span><br><span class="line"><span class="comment"># @Site    :</span></span><br><span class="line"><span class="comment"># @File    : pubilc.py</span></span><br><span class="line"><span class="comment"># @Software: PyCharm</span></span><br><span class="line"></span><br><span class="line">import string</span><br><span class="line">import zipfile</span><br><span class="line"></span><br><span class="line">def create_proxyauth_extension(proxy_host, proxy_port,</span><br><span class="line">                               proxy_username, proxy_password,</span><br><span class="line">                               <span class="attribute">scheme</span>=<span class="string">'http'</span>, <span class="attribute">plugin_path</span>=None):</span><br><span class="line">    <span class="string">""</span><span class="string">"代理认证插件</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    args:</span></span><br><span class="line"><span class="string">        proxy_host (str): 你的代理地址或者域名（str类型）</span></span><br><span class="line"><span class="string">        proxy_port (int): 代理端口号（int类型）</span></span><br><span class="line"><span class="string">        proxy_username (str):用户名（字符串）</span></span><br><span class="line"><span class="string">        proxy_password (str): 密码 （字符串）</span></span><br><span class="line"><span class="string">    kwargs:</span></span><br><span class="line"><span class="string">        scheme (str): 代理方式 默认http</span></span><br><span class="line"><span class="string">        plugin_path (str): 扩展的绝对路径</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    return str -&gt; plugin_path</span></span><br><span class="line"><span class="string">    "</span><span class="string">""</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> plugin_path is None:</span><br><span class="line">        plugin_path = <span class="string">'vimm_chrome_proxyauth_plugin.zip'</span></span><br><span class="line"></span><br><span class="line">    manifest_json = <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        "</span>version<span class="string">": "</span>1.0.0<span class="string">",</span></span><br><span class="line"><span class="string">        "</span>manifest_version<span class="string">": 2,</span></span><br><span class="line"><span class="string">        "</span>name<span class="string">": "</span>Chrome Proxy<span class="string">",</span></span><br><span class="line"><span class="string">        "</span>permissions<span class="string">": [</span></span><br><span class="line"><span class="string">            "</span>proxy<span class="string">",</span></span><br><span class="line"><span class="string">            "</span>tabs<span class="string">",</span></span><br><span class="line"><span class="string">            "</span>unlimitedStorage<span class="string">",</span></span><br><span class="line"><span class="string">            "</span>storage<span class="string">",</span></span><br><span class="line"><span class="string">            "</span>&lt;all_urls&gt;<span class="string">",</span></span><br><span class="line"><span class="string">            "</span>webRequest<span class="string">",</span></span><br><span class="line"><span class="string">            "</span>webRequestBlocking<span class="string">"</span></span><br><span class="line"><span class="string">        ],</span></span><br><span class="line"><span class="string">        "</span>background<span class="string">": &#123;</span></span><br><span class="line"><span class="string">            "</span>scripts<span class="string">": ["</span>background.js<span class="string">"]</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        "</span>minimum_chrome_version<span class="string">":"</span>22.0.0<span class="string">"</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    "</span><span class="string">""</span></span><br><span class="line"></span><br><span class="line">    background_js = string.Template(</span><br><span class="line">    <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">    var config = &#123;</span></span><br><span class="line"><span class="string">            mode: "</span>fixed_servers<span class="string">",</span></span><br><span class="line"><span class="string">            rules: &#123;</span></span><br><span class="line"><span class="string">              singleProxy: &#123;</span></span><br><span class="line"><span class="string">                scheme: "</span><span class="variable">$&#123;scheme&#125;</span><span class="string">",</span></span><br><span class="line"><span class="string">                host: "</span><span class="variable">$&#123;host&#125;</span><span class="string">",</span></span><br><span class="line"><span class="string">                port: parseInt(<span class="variable">$&#123;port&#125;</span>)</span></span><br><span class="line"><span class="string">              &#125;,</span></span><br><span class="line"><span class="string">              bypassList: ["</span>foobar.com<span class="string">"]</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">          &#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    chrome.proxy.settings.set(&#123;value: config, scope: "</span>regular<span class="string">"&#125;, function() &#123;&#125;);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    function callbackFn(details) &#123;</span></span><br><span class="line"><span class="string">        return &#123;</span></span><br><span class="line"><span class="string">            authCredentials: &#123;</span></span><br><span class="line"><span class="string">                username: "</span><span class="variable">$&#123;username&#125;</span><span class="string">",</span></span><br><span class="line"><span class="string">                password: "</span><span class="variable">$&#123;password&#125;</span><span class="string">"</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    chrome.webRequest.onAuthRequired.addListener(</span></span><br><span class="line"><span class="string">                callbackFn,</span></span><br><span class="line"><span class="string">                &#123;urls: ["</span>&lt;all_urls&gt;<span class="string">"]&#125;,</span></span><br><span class="line"><span class="string">                ['blocking']</span></span><br><span class="line"><span class="string">    );</span></span><br><span class="line"><span class="string">    "</span><span class="string">""</span></span><br><span class="line">    ).substitute(</span><br><span class="line">        <span class="attribute">host</span>=proxy_host,</span><br><span class="line">        <span class="attribute">port</span>=proxy_port,</span><br><span class="line">        <span class="attribute">username</span>=proxy_username,</span><br><span class="line">        <span class="attribute">password</span>=proxy_password,</span><br><span class="line">        <span class="attribute">scheme</span>=scheme,</span><br><span class="line">    )</span><br><span class="line">    with zipfile.ZipFile(plugin_path, <span class="string">'w'</span>) as zp:</span><br><span class="line">        zp.writestr(<span class="string">"manifest.json"</span>, manifest_json)</span><br><span class="line">        zp.writestr(<span class="string">"background.js"</span>, background_js)</span><br><span class="line"></span><br><span class="line">    return plugin_path</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>使用方法：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> selenium import webdriver</span><br><span class="line"><span class="keyword">from</span> common.pubilc import create_proxyauth_extension</span><br><span class="line"></span><br><span class="line">proxyauth_plugin_path = create_proxyauth_extension(</span><br><span class="line">    <span class="attribute">proxy_host</span>=<span class="string">"XXXXX.com"</span>,</span><br><span class="line">    <span class="attribute">proxy_port</span>=9020,</span><br><span class="line">    <span class="attribute">proxy_username</span>=<span class="string">"XXXXXXX"</span>,</span><br><span class="line">    <span class="attribute">proxy_password</span>=<span class="string">"XXXXXXX"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">co = webdriver.ChromeOptions()</span><br><span class="line"><span class="comment"># co.add_argument("--start-maximized")</span></span><br><span class="line">co.add_extension(proxyauth_plugin_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">driver = webdriver.Chrome(<span class="attribute">executable_path</span>=<span class="string">"C:\chromedriver.exe"</span>, <span class="attribute">chrome_options</span>=co)</span><br><span class="line">driver.<span class="builtin-name">get</span>(<span class="string">"http://ip138.com/"</span>)</span><br><span class="line"><span class="builtin-name">print</span>(driver.page_source)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>无认证代理：</p>
                  <figure class="highlight reasonml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">options = webdriver.<span class="constructor">ChromeOptions()</span></span><br><span class="line">options.add<span class="constructor">_argument('--<span class="params">proxy</span>-<span class="params">server</span>=<span class="params">http</span>:<span class="operator">/</span><span class="operator">/</span><span class="params">ip</span>:<span class="params">port</span>')</span></span><br><span class="line">driver = webdriver.<span class="constructor">Chrome(<span class="params">executable_path</span>=<span class="string">"C:\chromedriver.exe"</span>, <span class="params">chrome_options</span>=0ptions)</span></span><br><span class="line">driver.get(<span class="string">"http://ip138.com/"</span>)</span><br><span class="line">print(driver.page_source)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>以上完毕 So Easy</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/哎哟卧槽" class="author" itemprop="url" rel="index">哎哟卧槽</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2017-11-18 11:13:54" itemprop="dateCreated datePublished" datetime="2017-11-18T11:13:54+08:00">2017-11-18</time>
                </span>
                <span id="/4880.html" class="post-meta-item leancloud_visitors" data-flag-title="小白学爬虫-设置Selenium+Chrome代理" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>2.9k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>3 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/4853.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="静觅丨崔庆才的个人站点专业为您提供爬虫教程,爬虫,Python,Python爬虫,Python爬虫教程,爬虫书的相关信息，想要了解更多详情，请联系我们。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/4853.html" class="post-title-link" itemprop="url">一个采集系统的构建</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>整个系统: <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/10/WX20171017-225541.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/10/WX20171017-225541.png" alt=""></a> 采集系统： <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/10/WX20171017-225831.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/10/WX20171017-225831.png" alt=""></a></p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/哎哟卧槽" class="author" itemprop="url" rel="index">哎哟卧槽</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2017-10-17 23:00:23" itemprop="dateCreated datePublished" datetime="2017-10-17T23:00:23+08:00">2017-10-17</time>
                </span>
                <span id="/4853.html" class="post-meta-item leancloud_visitors" data-flag-title="一个采集系统的构建" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>10</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>1 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/4833.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="静觅丨崔庆才的个人站点专业为您提供爬虫教程,爬虫,Python,Python爬虫,Python爬虫教程,爬虫书的相关信息，想要了解更多详情，请联系我们。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Java <i class="label-arrow"></i>
                  </a>
                  <a href="/4833.html" class="post-title-link" itemprop="url">java基础之数据类型</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p><strong><strong>PS：此文章为小白提供，大佬请绕道！！！！</strong></strong> <strong>首先特别感谢大才哥给我提供这个平台，未来我希望把java这个版块的内容补全。</strong> 今天要讲的是数据类型，最最最基础的内容~ java标识符、数据类型、关键字 开始我们先看下如何注释java代码。 标识符：类名，方法名，变量。 有三种方式分别为 //表示注释一行代码 /<em> 表示注释一行或者多行代码 (从上面到下面都是注释的代码） </em>/ 下面还有一种注释方式叫做文档注释。 /<strong> 通常这样表示 */ 文档注释一般写在代码开头用来简述你所做程序的具体内容，在这之前我们首先看一下javadoc命令，我先编写一个简答的代码： package com.briup.chap02; /</strong> @author Twinkle @version 1.0 It’s a text file <em>/ public class PrimitiveType{ public static void main(String[] args){ byte b = 123; byte b1 = 300; } } 我们javadoc -d 生成目录 编译文件 编译成功后，我们打开刚刚生成doc里打开index.html看一下，大概是这样的： 类概要 类： Student 说明： It’s a text file 这样我们就可以看出文档注释的意义了，他可以显示在你编译出来文档的说明里，但有人会发现为啥我们编写出来的author没有出来呀？ 因为他的最前面有一个@，我们需要编写的时候把它加上去才能显示出来，现在我们来试一下， —javadoc -d bin/doc-author -version src/PrimitiveType.java，这样作者和版本信息就出来了 一.类名 这边我们要记住一些代码的基本格式： 类名的写法：Student（前面首字母要大写） 方法和变量的写法：genderItem（前面单词小写，后面单词开头要大写） 常量写法：MAX_PAGE（常量大写，中间一般加下划线） 二.关键字 关键字其实就是电脑里面已经定义好的有特殊意义的标识符，像int,for，double什么的都是关键字。具体意思请百度一下～ 三.数据类型 数据类型是这篇文章的重点，我们来看下这些基本的数据类型 类型 二进制位 例 范围 byte 8位 11111111～01111111 -2^7~2^7-1 short 16位 16个二进制代码 -2^15~2^15-1 int 32位 32个二进制代码 -2^31~2^31-1 long 64位 64个二进制代码 -2^63~2^63-1 浮点型: float 32位 32个二进制代码 double 64位 64个二进制代码 布尔型： boolean 只有false和true两种类型。 具体解释一下为什么会有这么多类型呢？而且二进制位为什么还不一样？ 类型多的原因是因为有些数值本身就很小，传递给大的数据类型的话，虽然可以进去，但是有些二进制位就空闲了，占用了多余的内存却没有什么作用，所以才会有这么多的类型。 我们知道编程最终的目的是我们把代码传递给硬件，通过硬件来工作，但是呢，硬件只识别二进制代码，所以java会有一个把它的代码转化为二进制代码的过渡，上面的二进制位就是二进制码的数目，我们要想看他的范围有多大，可以这样算，二进制的第一位为标志符，通俗一点讲就是正负号，后面还有n位的话它的范围就是-|2^n|～|2^n-1| 如果我们定义的类型超出这个范围的话(也就是盆子里已经装满了东西如果再加），java就会报错，超出指定的范围，所以当我们定义数据类型的时候要搞清楚各数据类型的范围。 还有一个特殊的数据类型：char (‘字符’) char的具体位数要结合unicode编码。问题又来了,unicode编码又是什么鬼！unicode编码是一个字符集，里面包含了中，日，韩，三种文字，我们可以通过char的方法来打印出字符:char(‘u\unicode编码’)，unicode表具体百度一下哈～ 数据类型转换： 显式转换：也就是强制转换 隐式转换：由JVM虚拟机自行转换 数据类型的强制转换：int a = (强制转换类型)b 转换规则:从存储范围大的类型到存储范围小的类型。 具体规则为：double→float→long→int→short(char)→byte byte b =10; byte a = (int) b; 如果我们把int类型的b转换给byte类型的a的话，会出现溢出现象，所以会报错。 所以正确强制转换的方式为～～： byte b = 10; int（或者更大的类型） a =(int) b; java基本的数据类型就讲到这里啦~ <em>*--可能发布的内容有点混乱，我会尽快把前面的补齐~有疑问的话可以到大才哥的群里找我哈~</em></em></p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/Twinkle" class="author" itemprop="url" rel="index">Twinkle</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2017-09-27 18:17:06" itemprop="dateCreated datePublished" datetime="2017-09-27T18:17:06+08:00">2017-09-27</time>
                </span>
                <span id="/4833.html" class="post-meta-item leancloud_visitors" data-flag-title="java基础之数据类型" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>1.9k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>2 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/4826.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="静觅丨崔庆才的个人站点专业为您提供爬虫教程,爬虫,Python,Python爬虫,Python爬虫教程,爬虫书的相关信息，想要了解更多详情，请联系我们。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> 未分类 <i class="label-arrow"></i>
                  </a>
                  <a href="/4826.html" class="post-title-link" itemprop="url">小白进阶第七篇（Splash负载均衡）</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>对于 Scrapy 处理 Ajax 处理方式当然是同家兄弟 Splash 比较靠谱！ 但是 Splash 有个很坑爹的毛病就是负载承受相对较小·· 一不留神就 GG 了·········· 然后也就没有然后了~~！ 所以准备给 Splash 做一个负载均衡；后端放一大堆的 Splash 这样总不会 GG 了吧。 就算其中一个 GG 了还有其它的可替代不是？ 废话不多少开整·· 环境是基于： CentOS 7.3 Docker 17.06.2-ce Splash 3.0 HAproxy 1.7.9 （CentOS 大家可以将 yum 切换为阿里云的 yum 源 Docker 同理）</p>
                  <h4 id="阿里-yum-源：-http-mirrors-aliyun-com-help-centos-照葫芦画瓢做一遍（你是-CentOS7-啊！！！！不要选成其他版本了）"><a href="#阿里-yum-源：-http-mirrors-aliyun-com-help-centos-照葫芦画瓢做一遍（你是-CentOS7-啊！！！！不要选成其他版本了）" class="headerlink" title="阿里 yum 源： http://mirrors.aliyun.com/help/centos  照葫芦画瓢做一遍（你是 CentOS7 啊！！！！不要选成其他版本了）"></a>阿里 yum 源： <a href="http://mirrors.aliyun.com/help/centos" target="_blank" rel="noopener">http://mirrors.aliyun.com/help/centos</a> 照葫芦画瓢做一遍（你是 CentOS7 啊！！！！不要选成其他版本了）</h4>
                  <h2 id="注意以下只需要在你需要运行-splash-的机器上安装即可"><a href="#注意以下只需要在你需要运行-splash-的机器上安装即可" class="headerlink" title="注意以下只需要在你需要运行 splash 的机器上安装即可"></a><strong>注意以下只需要在你需要运行 splash 的机器上安装即可</strong></h2>
                  <h4 id="阿里-Docker-源："><a href="#阿里-Docker-源：" class="headerlink" title="阿里 Docker 源："></a>阿里 Docker 源：</h4>
                  <figure class="highlight sql">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment"># step 1: 安装必要的一些系统工具</span></span><br><span class="line"></span><br><span class="line">sudo yum <span class="keyword">install</span> -y yum-utils device-mapper-persistent-<span class="keyword">data</span> lvm2</span><br><span class="line"></span><br><span class="line"><span class="comment"># Step 2: 添加软件源信息</span></span><br><span class="line"></span><br><span class="line">sudo yum-config-manager <span class="comment">--add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Step 3: 更新并安装 Docker-CE</span></span><br><span class="line"></span><br><span class="line">sudo yum makecache <span class="keyword">fast</span></span><br><span class="line">sudo yum -y <span class="keyword">install</span> docker-ce</span><br><span class="line"></span><br><span class="line"><span class="comment"># Step 4: 开启Docker服务</span></span><br><span class="line"></span><br><span class="line">sudo service docker <span class="keyword">start</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h4 id="安装-Docker-加速器："><a href="#安装-Docker-加速器：" class="headerlink" title="安装 Docker 加速器："></a>安装 Docker 加速器：</h4>
                  <figure class="highlight vim">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">curl -sSL http<span class="variable">s:</span>//<span class="built_in">get</span>.daocloud.io/daotools/set_mirror.<span class="keyword">sh</span> | <span class="keyword">sh</span> -s http://<span class="number">8050</span>f360.<span class="keyword">m</span>.daocloud.io</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h4 id="重启-Docker："><a href="#重启-Docker：" class="headerlink" title="重启 Docker："></a>重启 Docker：</h4>
                  <figure class="highlight ebnf">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attribute">systemctl restart docker</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样可以极快的速度拉取镜像。 获取 splash 最新的 docker 镜像：</p>
                  <figure class="highlight crmsh">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">docker pull scrapinghub/splash:<span class="literal">master</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h4 id="关闭所有机器防火墙-firewalld-网络安全的环境关闭，不安全的环境请放行端口，自行百度"><a href="#关闭所有机器防火墙-firewalld-网络安全的环境关闭，不安全的环境请放行端口，自行百度" class="headerlink" title="关闭所有机器防火墙 firewalld(网络安全的环境关闭，不安全的环境请放行端口，自行百度):"></a>关闭所有机器防火墙 firewalld(网络安全的环境关闭，不安全的环境请放行端口，自行百度):</h4>
                  <figure class="highlight gauss">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">systemctl <span class="keyword">disable</span> firewalld</span><br><span class="line"></span><br><span class="line">systemctl <span class="keyword">stop</span> firewalld</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h4 id="创建-Splash-配置文件目录："><a href="#创建-Splash-配置文件目录：" class="headerlink" title="创建 Splash 配置文件目录："></a>创建 Splash 配置文件目录：</h4>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"># 存放过滤规则文件的目录</span><br><span class="line"></span><br><span class="line">[<span class="symbol">root@</span>localhost ~]# mkdir filters</span><br><span class="line"></span><br><span class="line"># 存放JavaScript文件目录</span><br><span class="line"></span><br><span class="line">[<span class="symbol">root@</span>localhost ~]# mkdir js-profiles</span><br><span class="line"></span><br><span class="line"># 存放lua模块的目录</span><br><span class="line"></span><br><span class="line">[<span class="symbol">root@</span>localhost ~]# mkdir lua_modules</span><br><span class="line"></span><br><span class="line"># 存放代理文件的目录</span><br><span class="line"></span><br><span class="line">[<span class="symbol">root@</span>localhost ~]# mkdir proxy-profiles</span><br><span class="line"></span><br><span class="line"># 创建完成如下：</span><br><span class="line"></span><br><span class="line">[<span class="symbol">root@</span>localhost ~]# pwd</span><br><span class="line">/root</span><br><span class="line">[<span class="symbol">root@</span>localhost ~]# ll</span><br><span class="line">total <span class="number">4</span></span><br><span class="line">drwxr-xr-x. <span class="number">2</span> root root   <span class="number">25</span> Sep <span class="number">26</span> <span class="number">03</span>:<span class="number">00</span> filters</span><br><span class="line">drwxr-xr-x. <span class="number">2</span> root root    <span class="number">6</span> Sep <span class="number">25</span> <span class="number">21</span>:<span class="number">08</span> js-profiles</span><br><span class="line">drwxr-xr-x. <span class="number">2</span> root root    <span class="number">6</span> Sep <span class="number">25</span> <span class="number">21</span>:<span class="number">08</span> lua_modules</span><br><span class="line">drwxr-xr-x. <span class="number">2</span> root root   <span class="number">32</span> Sep <span class="number">25</span> <span class="number">21</span>:<span class="number">08</span> proxy-profiles</span><br><span class="line">[<span class="symbol">root@</span>localhost ~]#</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h4 id="启动-Splash："><a href="#启动-Splash：" class="headerlink" title="启动 Splash："></a>启动 Splash：</h4>
                  <figure class="highlight groovy">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">docker run -d -p <span class="number">8050</span>:<span class="number">8050</span> --memory=<span class="number">5.0</span>G --restart=always  --name splash       -v <span class="regexp">/root/</span>proxy-<span class="string">profiles:</span><span class="regexp">/etc/</span>splash<span class="regexp">/proxy-profiles       -v /</span>root<span class="regexp">/js-profiles:/</span>etc<span class="regexp">/splash/</span>js-profiles       -v <span class="regexp">/root/</span><span class="string">lua_modules:</span><span class="regexp">/etc/</span>splash<span class="regexp">/lua_modules       -v /</span>root<span class="regexp">/filters:/</span>etc<span class="regexp">/splash/</span>filters       scrapinghub/<span class="string">splash:</span>master --maxrss <span class="number">4500</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>docker run 启动一个容器 -d 后台启动 -p 8050:8050 将容器的 8050 端口和物理机的 8050 端口绑定（可以从 8050 端口访问容器服务应用） —memory=5.0G 容器最大使用内存为 5.0GB，超出这个限制会被主进程杀死（使用 free -mg 查看并酌情设置你的内存使用） —restart=always 容器退出后无条件重启（满了 5GB 被杀死，然后重启 释放内存） —name splash 容器的名字叫 splash（可以忽略） -v <strong>**</strong> 三个-v 参数是将宿主机的目录挂载进容器，便于容器能够直接访问挂载目录中的内容 scrapinghub/splash:master 用于启动容器的镜像 —maxrss 4500 Splash 最大内存使用为 4500MB</p>
                  <h4 id="查看容器是否启动："><a href="#查看容器是否启动：" class="headerlink" title="查看容器是否启动："></a>查看容器是否启动：</h4>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">[<span class="symbol">root@</span>localhost ~]# docker ps -a</span><br><span class="line">CONTAINER ID        IMAGE                       COMMAND                  CREATED             STATUS              PORTS                              NAMES</span><br><span class="line"><span class="number">1</span>b34f7933095        scrapinghub/splash:master   <span class="string">"python3 /app/bin/..."</span>   <span class="number">4</span> hours ago         Up <span class="number">4</span> hours          <span class="number">5023</span>/tcp, <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">8050</span>-&gt;<span class="number">8050</span>/tcp   splash</span><br><span class="line">[<span class="symbol">root@</span>localhost ~]#</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h4 id="访问-Splash-是否正常工作："><a href="#访问-Splash-是否正常工作：" class="headerlink" title="访问 Splash 是否正常工作："></a>访问 Splash 是否正常工作：</h4>
                  <p><a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/09/测试.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/09/测试.png" alt=""></a></p>
                  <h2 id="请注意：以上操作只需要在你需要运行-splash-的机器上安装即可"><a href="#请注意：以上操作只需要在你需要运行-splash-的机器上安装即可" class="headerlink" title="请注意：以上操作只需要在你需要运行 splash 的机器上安装即可"></a><strong>请注意：以上操作只需要在你需要运行 splash 的机器上安装即可</strong></h2>
                  <h1 id="安装-HAproxy-实现负载均衡："><a href="#安装-HAproxy-实现负载均衡：" class="headerlink" title="安装 HAproxy 实现负载均衡："></a>安装 HAproxy 实现负载均衡：</h1>
                  <h4 id="安装-zlib-devel（HAproxy-使用-gzip-功能）："><a href="#安装-zlib-devel（HAproxy-使用-gzip-功能）：" class="headerlink" title="安装 zlib-devel（HAproxy 使用 gzip 功能）："></a>安装 zlib-devel（HAproxy 使用 gzip 功能）：</h4>
                  <figure class="highlight cmake">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">yum <span class="keyword">install</span> zlib-devel -y</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h4 id="安装-HAproxy："><a href="#安装-HAproxy：" class="headerlink" title="安装 HAproxy："></a>安装 HAproxy：</h4>
                  <figure class="highlight autoit">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="meta"># 个人喜好 源码放在这个目录</span></span><br><span class="line">[root<span class="symbol">@localhost</span> examples]<span class="meta"># cd /usr/local/src/</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 安装wget</span></span><br><span class="line">[root<span class="symbol">@localhost</span> src]<span class="meta">#yum install wget -y</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 下载HAproxy安装包</span></span><br><span class="line">[root<span class="symbol">@localhost</span> src]<span class="meta"># wget http://www.haproxy.org/download/1.7/src/haproxy-1.7.9.tar.gz</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 解压</span></span><br><span class="line">[root<span class="symbol">@localhost</span> src]<span class="meta"># tar -zxvf haproxy-1.7.9.tar.gz</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 进入目录</span></span><br><span class="line">[root<span class="symbol">@localhost</span> src]<span class="meta"># cd haproxy-1.7.9</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 编译</span></span><br><span class="line">[root<span class="symbol">@localhost</span> src]<span class="meta"># make TARGET=linux2628 PREFIX=/usr/local/haproxy-1.7.9 USE_ZLIB=yes</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 安装</span></span><br><span class="line">[root<span class="symbol">@localhost</span> src]<span class="meta"># make install</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 拷贝启动文件到目录</span></span><br><span class="line">[root<span class="symbol">@localhost</span> src]<span class="meta"># cp /usr/local/sbin/haproxy /usr/sbin/</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 测试版本</span></span><br><span class="line">[root<span class="symbol">@localhost</span> src]<span class="meta"># haproxy -v</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 拷贝启动文件到启动目录</span></span><br><span class="line">[root<span class="symbol">@localhost</span> src]<span class="meta"># cp examples/haproxy.init /etc/init.d/haproxy</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 赋予可执行权限</span></span><br><span class="line">[root<span class="symbol">@localhost</span> src]<span class="meta"># chmod 755 /etc/init.d/haproxy</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 创建配置文件目录</span></span><br><span class="line">[root<span class="symbol">@localhost</span> src]<span class="meta"># mkdir /etc/haproxy</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 创建数据目录</span></span><br><span class="line">[root<span class="symbol">@localhost</span> src]<span class="meta"># mkdir /var/lib/haproxy</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 创建运行文件目录</span></span><br><span class="line">[root<span class="symbol">@localhost</span> src]<span class="meta"># mkdir /var/run/haproxy</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 设置日志</span></span><br><span class="line">[root<span class="symbol">@localhost</span> src]<span class="meta"># vim /etc/rsyslog.conf</span></span><br><span class="line"><span class="meta"># 第15行  $ModLoad imudp #打开注释</span></span><br><span class="line"><span class="meta"># 第16行  $UDPServerRun 514 #打开注释</span></span><br><span class="line"><span class="meta"># 第74行  local3.* /var/log/haproxy.log #local3的路径</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 创建日志文件</span></span><br><span class="line">[root<span class="symbol">@localhost</span> src]<span class="meta"># touch /var/log/haproxy.log</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 设置权限</span></span><br><span class="line">[root<span class="symbol">@localhost</span> src]<span class="meta">#  chown -R haproxy.haproxy /var/log/haproxy.log</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 启动日志服务</span></span><br><span class="line">[root<span class="symbol">@localhost</span> src]<span class="meta"># systemctl restart rsyslog.service</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h4 id="配置-HAproxy-Conf："><a href="#配置-HAproxy-Conf：" class="headerlink" title="配置 HAproxy Conf："></a>配置 HAproxy Conf：</h4>
                  <figure class="highlight autoit">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">[root<span class="symbol">@localhost</span> src]<span class="meta"># vim /etc/haproxy/haproxy.cfg</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>写入以下内容：</p>
                  <figure class="highlight properties">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment"># HAProxy 1.7 config for Splash. It assumes Splash instances are executed</span></span><br><span class="line"><span class="comment"># on the same machine and connected to HAProxy using Docker links.</span></span><br><span class="line"><span class="attr">global</span></span><br><span class="line"><span class="comment">    # raise it if necessary</span></span><br><span class="line">    <span class="attr">maxconn</span> <span class="string">512</span></span><br><span class="line"><span class="comment">    # required for stats page</span></span><br><span class="line">    <span class="attr">stats</span> <span class="string">socket /tmp/haproxy</span></span><br><span class="line"></span><br><span class="line"><span class="attr">userlist</span> <span class="string">users</span></span><br><span class="line">    <span class="attr">user</span> <span class="string">user insecure-password userpass</span></span><br><span class="line"></span><br><span class="line"><span class="attr">defaults</span></span><br><span class="line">    <span class="attr">log</span> <span class="string">global</span></span><br><span class="line">    <span class="attr">mode</span> <span class="string">http</span></span><br><span class="line"></span><br><span class="line"><span class="comment">    # remove requests from a queue when clients disconnect;</span></span><br><span class="line"><span class="comment">    # see https://cbonte.github.io/haproxy-dconv/1.7/configuration.html#4.2-option%20abortonclose</span></span><br><span class="line">    <span class="attr">option</span> <span class="string">abortonclose</span></span><br><span class="line"></span><br><span class="line"><span class="comment">    # gzip can save quite a lot of traffic with json, html or base64 data</span></span><br><span class="line"><span class="comment">    # compression algo gzip</span></span><br><span class="line">    <span class="attr">compression</span> <span class="string">type text/html text/plain application/json</span></span><br><span class="line"></span><br><span class="line"><span class="comment">    # increase these values if you want to</span></span><br><span class="line"><span class="comment">    # allow longer request queues in HAProxy</span></span><br><span class="line">    <span class="attr">timeout</span> <span class="string">connect 3600s</span></span><br><span class="line">    <span class="attr">timeout</span> <span class="string">client 3600s</span></span><br><span class="line">    <span class="attr">timeout</span> <span class="string">server 3600s</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># visit 0.0.0.0:8036 to see HAProxy stats page</span></span><br><span class="line"><span class="attr">listen</span> <span class="string">stats</span></span><br><span class="line">    <span class="attr">bind</span> <span class="string">*:8036</span></span><br><span class="line">    <span class="attr">mode</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">stats</span> <span class="string">enable</span></span><br><span class="line">    <span class="attr">stats</span> <span class="string">hide-version</span></span><br><span class="line">    <span class="attr">stats</span> <span class="string">show-legends</span></span><br><span class="line">    <span class="attr">stats</span> <span class="string">show-desc Splash Cluster</span></span><br><span class="line">    <span class="attr">stats</span> <span class="string">uri /</span></span><br><span class="line">    <span class="attr">stats</span> <span class="string">refresh 10s</span></span><br><span class="line">    <span class="attr">stats</span> <span class="string">realm Haproxy\ Statistics</span></span><br><span class="line">    <span class="attr">stats</span> <span class="string">auth    admin:adminpass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Splash Cluster configuration</span></span><br><span class="line"><span class="comment"># 代理服务器监听全局的8050端口</span></span><br><span class="line"><span class="attr">frontend</span> <span class="string">http-in</span></span><br><span class="line">    <span class="attr">bind</span> <span class="string">*:8050</span></span><br><span class="line"><span class="comment">    # 如果你需要开启Splash的访问认证</span></span><br><span class="line"><span class="comment">    # 则注释default_backend splash-cluster</span></span><br><span class="line"><span class="comment">    # 并放开其余default_backend splash-cluster 之上的其余注释</span></span><br><span class="line"><span class="comment">    # 账号密码为user  userpass</span></span><br><span class="line"><span class="comment">    # acl auth_ok http_auth(users)</span></span><br><span class="line"><span class="comment">    # http-request auth realm Splash if !auth_ok</span></span><br><span class="line"><span class="comment">    # http-request allow if auth_ok</span></span><br><span class="line"><span class="comment">    # http-request deny</span></span><br><span class="line"></span><br><span class="line"><span class="comment">    # acl staticfiles path_beg /_harviewer/</span></span><br><span class="line"><span class="comment">    # acl misc path / /info /_debug /debug</span></span><br><span class="line"></span><br><span class="line"><span class="comment">    # use_backend splash-cluster if auth_ok !staticfiles !misc</span></span><br><span class="line"><span class="comment">    # use_backend splash-misc if auth_ok staticfiles</span></span><br><span class="line"><span class="comment">    # use_backend splash-misc if auth_ok misc</span></span><br><span class="line">    <span class="attr">default_backend</span> <span class="string">splash-cluster</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">backend</span> <span class="string">splash-cluster</span></span><br><span class="line">    <span class="attr">option</span> <span class="string">httpchk GET /</span></span><br><span class="line">    <span class="attr">balance</span> <span class="string">leastconn</span></span><br><span class="line"></span><br><span class="line"><span class="comment">    # try another instance when connection is dropped</span></span><br><span class="line">    <span class="attr">retries</span> <span class="string">2</span></span><br><span class="line">    <span class="attr">option</span> <span class="string">redispatch</span></span><br><span class="line"><span class="comment">    # 将下面IP地址替换为你自己的Splash服务IP和端口</span></span><br><span class="line"><span class="comment">    # 按照以下格式一次增加其余的Splash服务器</span></span><br><span class="line">    <span class="attr">server</span> <span class="string">splash-0 10.10.1.41:8050 check maxconn 5 inter 2s fall 10 observe layer4</span></span><br><span class="line">    <span class="attr">server</span> <span class="string">splash-1 10.10.1.42:8050 check maxconn 5 inter 2s fall 10 observe layer4</span></span><br><span class="line">    <span class="attr">server</span> <span class="string">splash-2 10.10.1.32:8050 check maxconn 5 inter 2s fall 10 observe layer4</span></span><br><span class="line"></span><br><span class="line"><span class="attr">backend</span> <span class="string">splash-misc</span></span><br><span class="line">    <span class="attr">balance</span> <span class="string">roundrobin</span></span><br><span class="line"><span class="comment">    # 将下面IP地址替换为你自己的Splash服务IP和端口</span></span><br><span class="line"><span class="comment">    # 按照以下格式一次增加其余的Splash服务器</span></span><br><span class="line">    <span class="attr">server</span> <span class="string">splash-0 10.10.1.41:8050 check fall 15</span></span><br><span class="line">    <span class="attr">server</span> <span class="string">splash-1 10.10.1.42:8050 check fall 15</span></span><br><span class="line">    <span class="attr">server</span> <span class="string">splash-2 10.10.1.32:8050 check fall 15</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h4 id="启动-HAproxy："><a href="#启动-HAproxy：" class="headerlink" title="启动 HAproxy："></a>启动 HAproxy：</h4>
                  <figure class="highlight autoit">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="meta"># 启动HAproxy</span></span><br><span class="line">[root<span class="symbol">@localhost</span> src]<span class="meta"># /etc/init.d/haproxy start</span></span><br><span class="line">Restarting haproxy (via systemctl):                        [  OK  ]</span><br><span class="line"></span><br><span class="line"><span class="meta"># 如果出现错误则使用：</span></span><br><span class="line">[root<span class="symbol">@localhost</span> examples]<span class="meta"># systemctl status haproxy.service</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 查看报错</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>查看 HAproxy 状态： <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/09/监控面板.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/09/监控面板.png" alt=""></a> 用户名和密码为： admin adminpass</p>
                  <h4 id="查看-HAproxy-负载是否生效："><a href="#查看-HAproxy-负载是否生效：" class="headerlink" title="查看 HAproxy 负载是否生效："></a>查看 HAproxy 负载是否生效：</h4>
                  <p><a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/09/结果.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/09/结果.png" alt=""></a> 完美！！！收工！！ 注意：HAproxy 这台服务器没有安装 Splash 服务，是负载到其余安装有 Splash 的服务器上提供的服务器哦！</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/哎哟卧槽" class="author" itemprop="url" rel="index">哎哟卧槽</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2017-09-26 16:21:52" itemprop="dateCreated datePublished" datetime="2017-09-26T16:21:52+08:00">2017-09-26</time>
                </span>
                <span id="/4826.html" class="post-meta-item leancloud_visitors" data-flag-title="小白进阶第七篇（Splash负载均衡）" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>6.1k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>6 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/4816.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="静觅丨崔庆才的个人站点专业为您提供爬虫教程,爬虫,Python,Python爬虫,Python爬虫教程,爬虫书的相关信息，想要了解更多详情，请联系我们。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/4816.html" class="post-title-link" itemprop="url">自建免费PYTHON爬虫代理IP池</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>大家好，我还是小四毛，不是崔老师！！！！崔老师在隔壁，哈哈哈。</p>
                  <p><a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/9555112.jpg" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/9555112.jpg" alt=""></a></p>
                  <h2 id="写了一个从网上抓取代理-IP，然后构建代理-IP-池的脚本，放在了这里：https-github-com-xiaosimao-IP-POOL"><a href="#写了一个从网上抓取代理-IP，然后构建代理-IP-池的脚本，放在了这里：https-github-com-xiaosimao-IP-POOL" class="headerlink" title="写了一个从网上抓取代理 IP，然后构建代理 IP 池的脚本，放在了这里：https://github.com/xiaosimao/IP_POOL"></a>写了一个从网上抓取代理 IP，然后构建代理 IP 池的脚本，放在了这里：<a href="https://github.com/xiaosimao/IP_POOL" target="_blank" rel="noopener">https://github.com/xiaosimao/IP_POOL</a></h2>
                  <h2 id="以后应该还会有很多的改动，-欢迎有兴趣的同学-star，以便及时可以收到改动的通知。"><a href="#以后应该还会有很多的改动，-欢迎有兴趣的同学-star，以便及时可以收到改动的通知。" class="headerlink" title="以后应该还会有很多的改动， 欢迎有兴趣的同学 star，以便及时可以收到改动的通知。"></a>以后应该还会有很多的改动， 欢迎有兴趣的同学 star，以便及时可以收到改动的通知。</h2>
                  <h2 id="目前是从以下几个网站获取-IP：66ip，xicidaili，data5u，proxydb。"><a href="#目前是从以下几个网站获取-IP：66ip，xicidaili，data5u，proxydb。" class="headerlink" title="目前是从以下几个网站获取 IP：66ip，xicidaili，data5u，proxydb。"></a>目前是从以下几个网站获取 IP：66ip，xicidaili，data5u，proxydb。</h2>
                  <h2 id="具体的使用方法文档在-readme-md-中，-欢迎交流。"><a href="#具体的使用方法文档在-readme-md-中，-欢迎交流。" class="headerlink" title="具体的使用方法文档在 readme.md 中， 欢迎交流。"></a>具体的使用方法文档在 readme.md 中， 欢迎交流。</h2>
                  <h2 id="如果你需要从别的网站获得，-那么可以在配置文件中进行相关的配置即可，-如果实在不想自己写，也可以提-issue-给我，我会看情况更新到代码中。"><a href="#如果你需要从别的网站获得，-那么可以在配置文件中进行相关的配置即可，-如果实在不想自己写，也可以提-issue-给我，我会看情况更新到代码中。" class="headerlink" title="如果你需要从别的网站获得， 那么可以在配置文件中进行相关的配置即可， 如果实在不想自己写，也可以提 issue 给我，我会看情况更新到代码中。"></a>如果你需要从别的网站获得， 那么可以在配置文件中进行相关的配置即可， 如果实在不想自己写，也可以提 issue 给我，我会看情况更新到代码中。</h2>
                  <h2 id="一般情况下，只要配置一下配置项就可以从新的网站获取-IP，最大限度减少写代码的时间。"><a href="#一般情况下，只要配置一下配置项就可以从新的网站获取-IP，最大限度减少写代码的时间。" class="headerlink" title="一般情况下，只要配置一下配置项就可以从新的网站获取 IP，最大限度减少写代码的时间。"></a>一般情况下，只要配置一下配置项就可以从新的网站获取 IP，最大限度减少写代码的时间。</h2>
                  <h2 id="免费的-ip，质量不敢保证，目前测试的目标网站为百度和https-httpbin-org-get，-还是获得了一些通过测试的-IP，下面是截图。"><a href="#免费的-ip，质量不敢保证，目前测试的目标网站为百度和https-httpbin-org-get，-还是获得了一些通过测试的-IP，下面是截图。" class="headerlink" title="免费的 ip，质量不敢保证，目前测试的目标网站为百度和https://httpbin.org/get， 还是获得了一些通过测试的 IP，下面是截图。"></a>免费的 ip，质量不敢保证，目前测试的目标网站为百度和<a href="https://httpbin.org/get，" target="_blank" rel="noopener">https://httpbin.org/get，</a> 还是获得了一些通过测试的 IP，下面是截图。</h2>
                  <p><a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/09/数据库截图.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/09/数据库截图.png" alt=""></a></p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/四毛" class="author" itemprop="url" rel="index">四毛</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2017-09-22 14:47:08" itemprop="dateCreated datePublished" datetime="2017-09-22T14:47:08+08:00">2017-09-22</time>
                </span>
                <span id="/4816.html" class="post-meta-item leancloud_visitors" data-flag-title="自建免费PYTHON爬虫代理IP池" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>390</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>1 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/4804.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="静觅丨崔庆才的个人站点专业为您提供爬虫教程,爬虫,Python,Python爬虫,Python爬虫教程,爬虫书的相关信息，想要了解更多详情，请联系我们。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Net <i class="label-arrow"></i>
                  </a>
                  <a href="/4804.html" class="post-title-link" itemprop="url">HTTP 206 获取文件部分内容和范围请求</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>HTTP 2xx 范围内的状态码表明了“客户端发送的请求已经被服务器接受并且被成功处理了”。 HTTP/1.1 200 OK 是 HTTP 请求成功后的标准响应，当你在浏览器中打开某个网站后,你通常会得到一个 200 状态码。HTTP/1.1 206 状态码表示的是“客户端通过发送范围请求头Range抓取到了资源的部分数据” 这种请求通常用来:</p>
                  <ul>
                    <li>学习http头和状态</li>
                    <li>解决网路问题</li>
                    <li>解决大文件下载问题</li>
                    <li>解决CDN和原始HTTP服务器问题</li>
                    <li>使用工具例如lftp,wget,telnet测试断电续传</li>
                    <li>测试将一个大文件分割成多个部分同时下载</li>
                  </ul>
                  <h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2>
                  <p>查看服务器是否支持 HTTP 206：</p>
                  <figure class="highlight yaml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="string">curl</span> <span class="string">-I</span> <span class="string">https://raw.githubusercontent.com/Germey/LaravelGeetest/master/README.md</span></span><br><span class="line"><span class="string">HTTP/1.1</span> <span class="number">200</span> <span class="string">OK</span></span><br><span class="line"><span class="attr">Content-Security-Policy:</span> <span class="string">default-src</span> <span class="string">'none'</span><span class="string">;</span> <span class="string">style-src</span> <span class="string">'unsafe-inline'</span></span><br><span class="line"><span class="attr">Strict-Transport-Security:</span> <span class="string">max-age=31536000</span></span><br><span class="line"><span class="attr">X-Content-Type-Options:</span> <span class="string">nosniff</span></span><br><span class="line"><span class="attr">X-Frame-Options:</span> <span class="string">deny</span></span><br><span class="line"><span class="attr">X-XSS-Protection:</span> <span class="number">1</span><span class="string">;</span> <span class="string">mode=block</span></span><br><span class="line"><span class="attr">ETag:</span> <span class="string">"b29f4639b76cd7f94a4b36b05be6c85acfe478f1"</span></span><br><span class="line"><span class="attr">Content-Type:</span> <span class="string">text/plain;</span> <span class="string">charset=utf-8</span></span><br><span class="line"><span class="attr">Cache-Control:</span> <span class="string">max-age=300</span></span><br><span class="line"><span class="attr">X-Geo-Block-List:</span></span><br><span class="line"><span class="attr">X-GitHub-Request-Id:</span> <span class="string">850A:16D2:30128BA:3341504:59BBC946</span></span><br><span class="line"><span class="attr">Content-Length:</span> <span class="number">8709</span></span><br><span class="line"><span class="attr">Accept-Ranges:</span> <span class="string">bytes</span></span><br><span class="line"><span class="attr">Date:</span> <span class="string">Fri,</span> <span class="number">15</span> <span class="string">Sep</span> <span class="number">2017</span> <span class="number">12</span><span class="string">:36:31</span> <span class="string">GMT</span></span><br><span class="line"><span class="attr">Via:</span> <span class="number">1.1</span> <span class="string">varnish</span></span><br><span class="line"><span class="attr">Connection:</span> <span class="string">keep-alive</span></span><br><span class="line"><span class="attr">X-Served-By:</span> <span class="string">cache-nrt6123-NRT</span></span><br><span class="line"><span class="attr">X-Cache:</span> <span class="string">HIT</span></span><br><span class="line"><span class="attr">X-Cache-Hits:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">X-Timer:</span> <span class="string">S1505478991.145862,VS0,VE1</span></span><br><span class="line"><span class="attr">Vary:</span> <span class="string">Authorization,Accept-Encoding</span></span><br><span class="line"><span class="attr">Access-Control-Allow-Origin:</span> <span class="string">*</span></span><br><span class="line"><span class="attr">X-Fastly-Request-ID:</span> <span class="string">ee23d80d2ba507ec0a70c880a075df0d2671aa4d</span></span><br><span class="line"><span class="attr">Expires:</span> <span class="string">Fri,</span> <span class="number">15</span> <span class="string">Sep</span> <span class="number">2017</span> <span class="number">12</span><span class="string">:41:31</span> <span class="string">GMT</span></span><br><span class="line"><span class="attr">Source-Age:</span> <span class="number">8</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>其中有两个我们比较关注的请求头： Accept-Ranges: bytes：该响应头表明服务器支持 Range 请求，以及服务器所支持的单位是字节。同时服务器支持断点续传，以及支持同时下载文件的多个部分，也就是说下载工具可以利用范围请求加速下载该文件。Accept-Ranges: none 响应头表示服务器不支持范围请求。 Content-Length: 8709 ：Content-Length 响应头表明了响应实体的大小,也就是真实的图片文件的大小是 8709 字节 (8.7K)。</p>
                  <h2 id="发送"><a href="#发送" class="headerlink" title="发送"></a>发送</h2>
                  <p>利用 CURL 可以指定请求范围。 获取前 500 字节：</p>
                  <figure class="highlight awk">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">curl --header <span class="string">"Range: bytes=0-500"</span> https:<span class="regexp">//</span>raw.githubusercontent.com<span class="regexp">/Germey/</span>LaravelGeetest<span class="regexp">/master/</span>README.md</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>后 500 字节：</p>
                  <figure class="highlight awk">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">curl --header <span class="string">"Range: bytes=-500"</span> https:<span class="regexp">//</span>raw.githubusercontent.com<span class="regexp">/Germey/</span>LaravelGeetest<span class="regexp">/master/</span>README.md</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>从 500 - 1000 字节：</p>
                  <figure class="highlight awk">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">curl --header <span class="string">"Range: bytes=500-1000"</span> https:<span class="regexp">//</span>raw.githubusercontent.com<span class="regexp">/Germey/</span>LaravelGeetest<span class="regexp">/master/</span>README.md</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>从 500 - 末尾字节：</p>
                  <figure class="highlight awk">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">curl --header <span class="string">"Range: bytes=500-"</span> https:<span class="regexp">//</span>raw.githubusercontent.com<span class="regexp">/Germey/</span>LaravelGeetest<span class="regexp">/master/</span>README.md</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h2 id="开启"><a href="#开启" class="headerlink" title="开启"></a>开启</h2>
                  <p>大部分web服务器都原生支持字节范围请求. Apache 2.x用户可以在httpd.conf中尝试 <a href="http://httpd.apache.org/docs/2.2/mod/mod_headers.html" target="_blank" rel="noopener">mod_headers</a>:</p>
                  <figure class="highlight lasso">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">Header</span> <span class="built_in">set</span> Accept<span class="params">-Ranges</span> <span class="built_in">bytes</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2017-09-15 20:46:16" itemprop="dateCreated datePublished" datetime="2017-09-15T20:46:16+08:00">2017-09-15</time>
                </span>
                <span id="/4804.html" class="post-meta-item leancloud_visitors" data-flag-title="HTTP 206 获取文件部分内容和范围请求" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>1.9k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>2 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/4791.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="静觅丨崔庆才的个人站点专业为您提供爬虫教程,爬虫,Python,Python爬虫,Python爬虫教程,爬虫书的相关信息，想要了解更多详情，请联系我们。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/4791.html" class="post-title-link" itemprop="url">轻型爬虫框架</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <h1 id="大家好，我是四毛-不是崔老师。"><a href="#大家好，我是四毛-不是崔老师。" class="headerlink" title="大家好，我是四毛,   不是崔老师。"></a>大家好，我是四毛, 不是崔老师。</h1>
                  <h1 id="恩，今天的内容很短-主要都写在了-README-md-里面。"><a href="#恩，今天的内容很短-主要都写在了-README-md-里面。" class="headerlink" title="恩，今天的内容很短, 主要都写在了 README.md 里面。"></a>恩，今天的内容很短, 主要都写在了 README.md 里面。</h1>
                  <p><a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/02/QQ图片20170205084843.jpg" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/02/QQ图片20170205084843.jpg" alt=""></a></p>
                  <h3 id="写了一个将爬虫基本步骤都封装起来的小框架，地址在https-github-com-xiaosimao-AiSpider，-欢迎-Star。"><a href="#写了一个将爬虫基本步骤都封装起来的小框架，地址在https-github-com-xiaosimao-AiSpider，-欢迎-Star。" class="headerlink" title="写了一个将爬虫基本步骤都封装起来的小框架，地址在https://github.com/xiaosimao/AiSpider， 欢迎 Star。"></a><strong>写了一个将爬虫基本步骤都封装起来的小框架，地址在<a href="https://github.com/xiaosimao/AiSpider" target="_blank" rel="noopener">https://github.com/xiaosimao/AiSpider</a>， 欢迎 Star。</strong></h3>
                  <h3 id="写的很基础，很简单，大道至简（对，其实就是不会写）。"><a href="#写的很基础，很简单，大道至简（对，其实就是不会写）。" class="headerlink" title="写的很基础，很简单，大道至简（对，其实就是不会写）。"></a><strong>写的很基础，很简单，大道至简（对，其实就是不会写）。</strong></h3>
                  <p><strong>最近也在学一些设计模式的东西。</strong></p>
                  <h3 id="欢迎有兴趣的同学共同研究，readme-md-中有我的微信（加的时候麻烦注明一下来自静觅），提出存在的问题和你的想法，这样大家可以共同讨论，共同进步。"><a href="#欢迎有兴趣的同学共同研究，readme-md-中有我的微信（加的时候麻烦注明一下来自静觅），提出存在的问题和你的想法，这样大家可以共同讨论，共同进步。" class="headerlink" title="欢迎有兴趣的同学共同研究，readme.md 中有我的微信（加的时候麻烦注明一下来自静觅），提出存在的问题和你的想法，这样大家可以共同讨论，共同进步。"></a><strong>欢迎有兴趣的同学共同研究，readme.md 中有我的微信（加的时候麻烦注明一下来自静觅），提出存在的问题和你的想法，这样大家可以共同讨论，共同进步。</strong></h3>
                  <h1 id="BE-A-SPIDERMAN。"><a href="#BE-A-SPIDERMAN。" class="headerlink" title="BE A SPIDERMAN。"></a><em><strong>BE A SPIDERMAN。</strong></em></h1>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/四毛" class="author" itemprop="url" rel="index">四毛</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2017-09-12 17:02:38" itemprop="dateCreated datePublished" datetime="2017-09-12T17:02:38+08:00">2017-09-12</time>
                </span>
                <span id="/4791.html" class="post-meta-item leancloud_visitors" data-flag-title="轻型爬虫框架" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>240</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>1 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/4778.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="静觅丨崔庆才的个人站点专业为您提供爬虫教程,爬虫,Python,Python爬虫,Python爬虫教程,爬虫书的相关信息，想要了解更多详情，请联系我们。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/4778.html" class="post-title-link" itemprop="url">Neo4j简介及Py2Neo的用法</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>Neo4j是一个世界领先的开源图形数据库，由 Java 编写。图形数据库也就意味着它的数据并非保存在表或集合中，而是保存为节点以及节点之间的关系。 Neo4j 的数据由下面几部分构成：</p>
                  <ul>
                    <li>节点</li>
                    <li>边</li>
                    <li>属性</li>
                  </ul>
                  <p>Neo4j 除了顶点（Node）和边（Relationship），还有一种重要的部分——属性。无论是顶点还是边，都可以有任意多的属性。属性的存放类似于一个 HashMap，Key 为一个字符串，而 Value 必须是基本类型或者是基本类型数组。 在Neo4j中，节点以及边都能够包含保存值的属性，此外：</p>
                  <ul>
                    <li>可以为节点设置零或多个标签（例如 Author 或 Book）</li>
                    <li>每个关系都对应一种类型（例如 WROTE 或 FRIEND_OF）</li>
                    <li>关系总是从一个节点指向另一个节点（但可以在不考虑指向性的情况下进行查询）</li>
                  </ul>
                  <p>具体介绍可以参考：<a href="https://www.w3cschool.cn/neo4j" target="_blank" rel="noopener">https://www.w3cschool.cn/neo4j</a>。</p>
                  <h2 id="Neo4j的特点"><a href="#Neo4j的特点" class="headerlink" title="Neo4j的特点"></a>Neo4j的特点</h2>
                  <ul>
                    <li>它拥有简单的查询语言 Neo4j CQL</li>
                    <li>它遵循属性图数据模型</li>
                    <li>它通过使用 Apache Lucence 支持索引</li>
                    <li>它支持 UNIQUE 约束</li>
                    <li>它包含一个用于执行 CQL 命令的 UI：Neo4j 数据浏览器</li>
                    <li>它支持完整的 ACID（原子性，一致性，隔离性和持久性）规则</li>
                    <li>它采用原生图形库与本地 GPE（图形处理引擎）</li>
                    <li>它支持查询的数据导出到 Json 和 XLS 格式</li>
                    <li>它提供了 REST API，可以被任何编程语言（如 Java，Spring，Scala 等）访问</li>
                    <li>它提供了可以通过任何 UI MVC 框架（如 Node JS ）访问的 Java 脚本</li>
                    <li>它支持两种 Java API：Cypher API 和 Native Java API 来开发 Java 应用程序</li>
                  </ul>
                  <h2 id="Neo4j安装"><a href="#Neo4j安装" class="headerlink" title="Neo4j安装"></a>Neo4j安装</h2>
                  <p>可以到官网直接下载安装包安装即可，链接：<a href="https://neo4j.com/download/" target="_blank" rel="noopener">https://neo4j.com/download/</a>。</p>
                  <h2 id="Neo4j-CQL命令"><a href="#Neo4j-CQL命令" class="headerlink" title="Neo4j CQL命令"></a>Neo4j CQL命令</h2>
                  <p>Neo4j 的 CQL 是非常重要的命令，类似于 SQL 语句，具体的用法可以参考：<a href="https://www.w3cschool.cn/neo4j/neo4j_cql_introduction.html" target="_blank" rel="noopener">https://www.w3cschool.cn/neo4j/neo4j_cql_introduction.html</a>。</p>
                  <h2 id="Py2Neo用法"><a href="#Py2Neo用法" class="headerlink" title="Py2Neo用法"></a>Py2Neo用法</h2>
                  <p>Py2Neo 是用来对接 Neo4j 的 Python 库，接下来对其详细介绍。</p>
                  <h3 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h3>
                  <ul>
                    <li>官方文档：<a href="http://py2neo.org/v3/index.html" target="_blank" rel="noopener">http://py2neo.org/v3/index.html</a></li>
                    <li>GitHub：<a href="https://github.com/technige/py2neo" target="_blank" rel="noopener">https://github.com/technige/py2neo</a></li>
                  </ul>
                  <h3 id="安装方法"><a href="#安装方法" class="headerlink" title="安装方法"></a>安装方法</h3>
                  <p>使用 Pip 安装即可：</p>
                  <figure class="highlight cmake">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">pip3 <span class="keyword">install</span> py2neo</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h3 id="Node-amp-Relationship"><a href="#Node-amp-Relationship" class="headerlink" title="Node &amp; Relationship"></a>Node &amp; Relationship</h3>
                  <p>Neo4j 里面最重要的两个数据结构就是节点和关系，即 Node 和 Relationship，可以通过 Node 或 Relationship 对象创建，实例如下：</p>
                  <figure class="highlight crmsh">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">from py2neo import <span class="keyword">Node</span><span class="title">, Relationship</span></span><br><span class="line"></span><br><span class="line">a = <span class="keyword">Node</span><span class="title">('Person</span>', <span class="attr">name=</span>'Alice')</span><br><span class="line">b = <span class="keyword">Node</span><span class="title">('Person</span>', <span class="attr">name=</span>'Bob')</span><br><span class="line">r = Relationship(a, 'KNOWS', b)</span><br><span class="line">print(a, b, r)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果：</p>
                  <figure class="highlight css">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">(<span class="selector-tag">alice</span><span class="selector-pseudo">:Person</span> &#123;<span class="attribute">name</span>:<span class="string">"Alice"</span>&#125;) (<span class="selector-tag">bob</span><span class="selector-pseudo">:Person</span> &#123;<span class="attribute">name</span>:<span class="string">"Bob"</span>&#125;) (<span class="selector-tag">alice</span>)<span class="selector-tag">-</span><span class="selector-attr">[:KNOWS]</span><span class="selector-tag">-</span>&gt;(<span class="selector-tag">bob</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样我们就成功创建了两个 Node 和两个 Node 之间的 Relationship。 Node 和 Relationship 都继承了 PropertyDict 类，它可以赋值很多属性，类似于字典的形式，例如可以通过如下方式对 Node 或 Relationship 进行属性赋值，接着上面的代码，实例如下:</p>
                  <figure class="highlight stylus">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="selector-tag">a</span>[<span class="string">'age'</span>] = <span class="number">20</span></span><br><span class="line"><span class="selector-tag">b</span>[<span class="string">'age'</span>] = <span class="number">21</span></span><br><span class="line">r[<span class="string">'time'</span>] = <span class="string">'2017/08/31'</span></span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(a, b, r)</span></span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果：</p>
                  <figure class="highlight css">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">(<span class="selector-tag">alice</span><span class="selector-pseudo">:Person</span> &#123;<span class="attribute">age</span>:<span class="number">20</span>,name:<span class="string">"Alice"</span>&#125;) (<span class="selector-tag">bob</span><span class="selector-pseudo">:Person</span> &#123;<span class="attribute">age</span>:<span class="number">21</span>,name:<span class="string">"Bob"</span>&#125;) (<span class="selector-tag">alice</span>)<span class="selector-tag">-</span><span class="selector-attr">[:KNOWS &#123;time:<span class="string">"2017/08/31"</span>&#125;]</span><span class="selector-tag">-</span>&gt;(<span class="selector-tag">bob</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可见通过类似字典的操作方法就可以成功实现属性赋值。 另外还可以通过 setdefault() 方法赋值默认属性，例如：</p>
                  <figure class="highlight stylus">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="selector-tag">a</span>.setdefault(<span class="string">'location'</span>, <span class="string">'北京'</span>)</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(a)</span></span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果：</p>
                  <figure class="highlight css">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">(<span class="selector-tag">alice</span><span class="selector-pseudo">:Person</span> &#123;<span class="attribute">age</span>:<span class="number">20</span>,location:<span class="string">"北京"</span>,name:<span class="string">"Alice"</span>&#125;)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可见没有给 a 对象赋值 location 属性，现在就会使用默认属性。 但如果赋值了 location 属性，则它会覆盖默认属性，例如：</p>
                  <figure class="highlight stylus">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="selector-tag">a</span>[<span class="string">'location'</span>] = <span class="string">'上海'</span></span><br><span class="line"><span class="selector-tag">a</span>.setdefault(<span class="string">'location'</span>, <span class="string">'北京'</span>)</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(a)</span></span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果：</p>
                  <figure class="highlight css">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">(<span class="selector-tag">alice</span><span class="selector-pseudo">:Person</span> &#123;<span class="attribute">age</span>:<span class="number">20</span>,location:<span class="string">"上海"</span>,name:<span class="string">"Alice"</span>&#125;)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>另外也可以使用 update() 方法对属性批量更新，接着上面的例子实例如下：</p>
                  <figure class="highlight stylus">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">data = &#123;</span><br><span class="line">    <span class="string">'name'</span>: <span class="string">'Amy'</span>,</span><br><span class="line">    <span class="string">'age'</span>: <span class="number">21</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-tag">a</span>.update(data)</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(a)</span></span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果：</p>
                  <figure class="highlight css">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">(<span class="selector-tag">alice</span><span class="selector-pseudo">:Person</span> &#123;<span class="attribute">age</span>:<span class="number">21</span>,location:<span class="string">"上海"</span>,name:<span class="string">"Amy"</span>&#125;)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可以看到这里更新了 a 对象的 name 和 age 属性，没有更新 location 属性，则 name 和 age 属性会更新，location 属性则会保留。</p>
                  <h3 id="Subgraph"><a href="#Subgraph" class="headerlink" title="Subgraph"></a>Subgraph</h3>
                  <p>Subgraph，子图，是 Node 和 Relationship 的集合，最简单的构造子图的方式是通过关系运算符，实例如下：</p>
                  <figure class="highlight crmsh">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">from py2neo import <span class="keyword">Node</span><span class="title">, Relationship</span></span><br><span class="line"></span><br><span class="line">a = <span class="keyword">Node</span><span class="title">('Person</span>', <span class="attr">name=</span>'Alice')</span><br><span class="line">b = <span class="keyword">Node</span><span class="title">('Person</span>', <span class="attr">name=</span>'Bob')</span><br><span class="line">r = Relationship(a, 'KNOWS', b)</span><br><span class="line">s = a | b | r</span><br><span class="line">print(s)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果：</p>
                  <figure class="highlight clojure">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">(&#123;(<span class="name">alice:Person</span> &#123;name:<span class="string">"Alice"</span>&#125;), (<span class="name">bob:Person</span> &#123;name:<span class="string">"Bob"</span>&#125;)&#125;, &#123;(<span class="name">alice</span>)-[<span class="symbol">:KNOWS</span>]-&gt;(<span class="name">bob</span>)&#125;)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样就组成了一个 Subgraph。 另外还可以通过 nodes() 和 relationships() 方法获取所有的 Node 和 Relationship，实例如下：</p>
                  <figure class="highlight lisp">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">print(<span class="name">s</span>.nodes())</span><br><span class="line">print(<span class="name">s</span>.relationships())</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果：</p>
                  <figure class="highlight lisp">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">frozenset(&#123;(<span class="name">alice</span><span class="symbol">:Person</span> &#123;name:<span class="string">"Alice"</span>&#125;), (<span class="name">bob</span><span class="symbol">:Person</span> &#123;name:<span class="string">"Bob"</span>&#125;)&#125;)</span><br><span class="line">frozenset(&#123;(<span class="name">alice</span>)-[<span class="symbol">:KNOWS</span>]-&gt;(<span class="name">bob</span>)&#125;)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可以看到结果是 frozenset 类型。 另外还可以利用 &amp; 取 Subgraph 的交集，例如：</p>
                  <figure class="highlight 1c">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">s1 = a <span class="string">| b | r</span></span><br><span class="line">s2 = a <span class="string">| b</span></span><br><span class="line">print(s1 <span class="meta">&amp; s2)</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果：</p>
                  <figure class="highlight clojure">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">(&#123;(<span class="name">alice:Person</span> &#123;name:<span class="string">"Alice"</span>&#125;), (<span class="name">bob:Person</span> &#123;name:<span class="string">"Bob"</span>&#125;)&#125;, &#123;&#125;)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可以看到结果是二者的交集。 另外我们还可以分别利用 keys()、labels()、nodes()、relationships()、types() 分别获取 Subgraph 的 Key、Label、Node、Relationship、Relationship Type，实例如下：</p>
                  <figure class="highlight gauss">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">s = a | b | r</span><br><span class="line"><span class="keyword">print</span>(s.<span class="built_in">keys</span>())</span><br><span class="line"><span class="keyword">print</span>(s.<span class="built_in">labels</span>())</span><br><span class="line"><span class="keyword">print</span>(s.<span class="built_in">nodes</span>())</span><br><span class="line"><span class="keyword">print</span>(s.<span class="built_in">relationships</span>())</span><br><span class="line"><span class="keyword">print</span>(s.<span class="built_in">types</span>())</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果：</p>
                  <figure class="highlight lisp">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">frozenset(&#123;'name'&#125;)</span><br><span class="line">frozenset(&#123;'Person'&#125;)</span><br><span class="line">frozenset(&#123;(<span class="name">alice</span><span class="symbol">:Person</span> &#123;name:<span class="string">"Alice"</span>&#125;), (<span class="name">bob</span><span class="symbol">:Person</span> &#123;name:<span class="string">"Bob"</span>&#125;)&#125;)</span><br><span class="line">frozenset(&#123;(<span class="name">alice</span>)-[<span class="symbol">:KNOWS</span>]-&gt;(<span class="name">bob</span>)&#125;)</span><br><span class="line">frozenset(&#123;'KNOWS'&#125;)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>另外还可以用 order() 或 size() 方法来获取 Subgraph 的 Node 数量和 Relationship 数量，实例如下：</p>
                  <figure class="highlight crmsh">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">from py2neo import <span class="keyword">Node</span><span class="title">, Relationship</span>, size, order</span><br><span class="line">s = a | b | r</span><br><span class="line">print(order(s))</span><br><span class="line">print(size(s))</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">1</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h3 id="Walkable"><a href="#Walkable" class="headerlink" title="Walkable"></a>Walkable</h3>
                  <p>Walkable 是增加了遍历信息的 Subgraph，我们通过 + 号便可以构建一个 Walkable 对象，例如：</p>
                  <figure class="highlight crmsh">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">from py2neo import <span class="keyword">Node</span><span class="title">, Relationship</span></span><br><span class="line"></span><br><span class="line">a = <span class="keyword">Node</span><span class="title">('Person</span>', <span class="attr">name=</span>'Alice')</span><br><span class="line">b = <span class="keyword">Node</span><span class="title">('Person</span>', <span class="attr">name=</span>'Bob')</span><br><span class="line">c = <span class="keyword">Node</span><span class="title">('Person</span>', <span class="attr">name=</span>'Mike')</span><br><span class="line">ab = Relationship(a, <span class="string">"KNOWS"</span>, b)</span><br><span class="line">ac = Relationship(a, <span class="string">"KNOWS"</span>, c)</span><br><span class="line">w = ab + Relationship(b, <span class="string">"LIKES"</span>, c) + ac</span><br><span class="line">print(w)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果：</p>
                  <figure class="highlight elixir">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">(alice)-[<span class="symbol">:KNOWS</span>]-&gt;(bob)-[<span class="symbol">:LIKES</span>]-&gt;(mike)&lt;-[<span class="symbol">:KNOWS</span>]-(alice)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样我们就形成了一个 Walkable 对象。 另外我们可以调用 walk() 方法实现遍历，实例如下：</p>
                  <figure class="highlight applescript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> py2neo import walk</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> <span class="built_in">item</span> <span class="keyword">in</span> walk(w):</span><br><span class="line">    print(<span class="built_in">item</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果：</p>
                  <figure class="highlight css">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">(<span class="selector-tag">alice</span><span class="selector-pseudo">:Person</span> &#123;<span class="attribute">name</span>:<span class="string">"Alice"</span>&#125;)</span><br><span class="line">(<span class="selector-tag">alice</span>)<span class="selector-tag">-</span><span class="selector-attr">[:KNOWS]</span><span class="selector-tag">-</span>&gt;(<span class="selector-tag">bob</span>)</span><br><span class="line">(<span class="selector-tag">bob</span><span class="selector-pseudo">:Person</span> &#123;<span class="attribute">name</span>:<span class="string">"Bob"</span>&#125;)</span><br><span class="line">(<span class="selector-tag">bob</span>)<span class="selector-tag">-</span><span class="selector-attr">[:LIKES]</span><span class="selector-tag">-</span>&gt;(<span class="selector-tag">mike</span>)</span><br><span class="line">(<span class="selector-tag">mike</span><span class="selector-pseudo">:Person</span> &#123;<span class="attribute">name</span>:<span class="string">"Mike"</span>&#125;)</span><br><span class="line">(<span class="selector-tag">alice</span>)<span class="selector-tag">-</span><span class="selector-attr">[:KNOWS]</span><span class="selector-tag">-</span>&gt;(<span class="selector-tag">mike</span>)</span><br><span class="line">(<span class="selector-tag">alice</span><span class="selector-pseudo">:Person</span> &#123;<span class="attribute">name</span>:<span class="string">"Alice"</span>&#125;)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可以看到它从 a 这个 Node 开始遍历，然后到 b，再到 c，最后重新回到 a。 另外还可以利用 start_node()、end_node()、nodes()、relationships() 方法来获取起始 Node、终止 Node、所有 Node 和 Relationship，例如：</p>
                  <figure class="highlight lisp">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">print(<span class="name">w</span>.start_node())</span><br><span class="line">print(<span class="name">w</span>.end_node())</span><br><span class="line">print(<span class="name">w</span>.nodes())</span><br><span class="line">print(<span class="name">w</span>.relationships())</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果：</p>
                  <figure class="highlight clojure">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">(<span class="name">alice:Person</span> &#123;name:<span class="string">"Alice"</span>&#125;)</span><br><span class="line">(<span class="name">alice:Person</span> &#123;name:<span class="string">"Alice"</span>&#125;)</span><br><span class="line">((<span class="name">alice:Person</span> &#123;name:<span class="string">"Alice"</span>&#125;), (<span class="name">bob:Person</span> &#123;name:<span class="string">"Bob"</span>&#125;), (<span class="name">mike:Person</span> &#123;name:<span class="string">"Mike"</span>&#125;), (<span class="name">alice:Person</span> &#123;name:<span class="string">"Alice"</span>&#125;))</span><br><span class="line">((<span class="name">alice</span>)-[<span class="symbol">:KNOWS</span>]-&gt;(<span class="name">bob</span>), (<span class="name">bob</span>)-[<span class="symbol">:LIKES</span>]-&gt;(<span class="name">mike</span>), (<span class="name">alice</span>)-[<span class="symbol">:KNOWS</span>]-&gt;(<span class="name">mike</span>))</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可以看到本例中起始和终止 Node 都是同一个，这和 walk() 方法得到的结果是一致的。</p>
                  <h3 id="Graph"><a href="#Graph" class="headerlink" title="Graph"></a>Graph</h3>
                  <p>在 database 模块中包含了和 Neo4j 数据交互的 API，最重要的当属 Graph，它代表了 Neo4j 的图数据库，同时 Graph 也提供了许多方法来操作 Neo4j 数据库。 Graph 在初始化的时候需要传入连接的 URI，初始化参数有 bolt、secure、host、http_port、https_port、bolt_port、user、password，详情说明可以参考：<a href="http://py2neo.org/v3/database.html#py2neo.database.Graph" target="_blank" rel="noopener">http://py2neo.org/v3/database.html#py2neo.database.Graph</a>。 初始化的实例如下：</p>
                  <figure class="highlight isbl">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="variable">from</span> <span class="variable">py2neo</span> <span class="variable">import</span> <span class="variable">Graph</span></span><br><span class="line"><span class="variable">graph_1</span> = <span class="function"><span class="title">Graph</span>()</span></span><br><span class="line"><span class="variable">graph_2</span> = <span class="function"><span class="title">Graph</span>(<span class="variable">host</span>=<span class="string">"localhost"</span>)</span></span><br><span class="line"><span class="variable">graph_3</span> = <span class="function"><span class="title">Graph</span>(<span class="string">"http://localhost:7474/db/data/"</span>)</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>另外我们还可以利用 create() 方法传入 Subgraph 对象来将关系图添加到数据库中，实例如下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> py2neo import Node, Relationship, Graph</span><br><span class="line"></span><br><span class="line">a = Node(<span class="string">'Person'</span>, <span class="attribute">name</span>=<span class="string">'Alice'</span>)</span><br><span class="line">b = Node(<span class="string">'Person'</span>, <span class="attribute">name</span>=<span class="string">'Bob'</span>)</span><br><span class="line">r = Relationship(a, <span class="string">'KNOWS'</span>, b)</span><br><span class="line">s = a | b | r</span><br><span class="line">graph = Graph(<span class="attribute">password</span>=<span class="string">'123456'</span>)</span><br><span class="line">graph.create(s)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里必须确保 Neo4j 正常运行，其密码为 123456，这里调用 create() 方法即可完成图的创建，结果如下： <img src="https://germey.gitbooks.io/ai/content/assets/2017-08-31-21-35-08.jpg" alt=""> 另外我们也可以单独添加单个 Node 或 Relationship，实例如下：</p>
                  <figure class="highlight pgsql">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> py2neo <span class="keyword">import</span> Graph, Node, Relationship</span><br><span class="line"></span><br><span class="line">graph = Graph(<span class="keyword">password</span>=<span class="string">'123456'</span>)</span><br><span class="line">a = Node(<span class="string">'Person'</span>, <span class="type">name</span>=<span class="string">'Alice'</span>)</span><br><span class="line">graph.<span class="keyword">create</span>(a)</span><br><span class="line">b = Node(<span class="string">'Person'</span>, <span class="type">name</span>=<span class="string">'Bob'</span>)</span><br><span class="line">ab = Relationship(a, <span class="string">'KNOWS'</span>, b)</span><br><span class="line">graph.<span class="keyword">create</span>(ab)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果如下： <img src="https://germey.gitbooks.io/ai/content/assets/2017-08-31-22-00-02.jpg" alt=""> 另外还可以利用 data() 方法来获取查询结果：</p>
                  <figure class="highlight haskell">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="title">from</span> py2neo <span class="keyword">import</span> Graph</span><br><span class="line"></span><br><span class="line"><span class="title">graph</span> = <span class="type">Graph</span>(password='<span class="number">123456</span>')</span><br><span class="line"><span class="class"><span class="keyword">data</span> = graph.<span class="keyword">data</span>('<span class="type">MATCH</span> (<span class="title">p</span>:<span class="type">Person</span>) return p')</span></span><br><span class="line"><span class="title">print</span>(<span class="class"><span class="keyword">data</span>)</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果：</p>
                  <figure class="highlight clojure">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">[&#123;'p': (<span class="name">e0d0f96:Person</span> &#123;name:<span class="string">"Alice"</span>&#125;)&#125;, &#123;'p': (<span class="name">cfe57d0:Person</span> &#123;name:<span class="string">"Bob"</span>&#125;)&#125;]</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里是通过 CQL 语句实现的查询，输出结果即 CQL 语句的返回结果，是列表形式。 另外输出结果还可以直接转化为 DataFrame 对象，实例如下：</p>
                  <figure class="highlight haskell">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="title">from</span> py2neo <span class="keyword">import</span> Graph</span><br><span class="line"><span class="title">from</span> pandas <span class="keyword">import</span> DataFrame</span><br><span class="line"><span class="title">graph</span> = <span class="type">Graph</span>(password='<span class="number">123456</span>')</span><br><span class="line"><span class="class"><span class="keyword">data</span> = graph.<span class="keyword">data</span>('<span class="type">MATCH</span> (<span class="title">p</span>:<span class="type">Person</span>) return p')</span></span><br><span class="line"><span class="title">df</span> = <span class="type">DataFrame</span>(<span class="class"><span class="keyword">data</span>)</span></span><br><span class="line"><span class="title">print</span>(df)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果：</p>
                  <figure class="highlight stylus">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">                   p</span><br><span class="line"><span class="number">0</span>  &#123;<span class="string">'name'</span>: <span class="string">'Alice'</span>&#125;</span><br><span class="line"><span class="number">1</span>    &#123;<span class="string">'name'</span>: <span class="string">'Bob'</span>&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>另外可以使用 find_one() 或 find() 方法进行 Node 的查找，可以利用 match() 或 match_one() 方法对 Relationship 进行查找：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> py2neo import Graph</span><br><span class="line"></span><br><span class="line">graph = Graph(<span class="attribute">password</span>=<span class="string">'123456'</span>)</span><br><span class="line">node = graph.find_one(<span class="attribute">label</span>=<span class="string">'Person'</span>)</span><br><span class="line"><span class="builtin-name">print</span>(node)</span><br><span class="line">relationship = graph.match_one(<span class="attribute">rel_type</span>=<span class="string">'KNOWS'</span>)</span><br><span class="line"><span class="builtin-name">print</span>(relationship)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果：</p>
                  <figure class="highlight css">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">(<span class="selector-tag">c7402c7</span><span class="selector-pseudo">:Person</span> &#123;<span class="attribute">age</span>:<span class="number">21</span>,name:<span class="string">"Alice"</span>&#125;)</span><br><span class="line">(<span class="selector-tag">c7402c7</span>)<span class="selector-tag">-</span><span class="selector-attr">[:KNOWS]</span><span class="selector-tag">-</span>&gt;(<span class="selector-tag">e2c42fc</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>如果想要更新 Node 的某个属性可以使用 push() 方法，例如：</p>
                  <figure class="highlight crmsh">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">from py2neo import Graph, <span class="keyword">Node</span><span class="title"></span></span><br><span class="line"><span class="title"></span></span><br><span class="line"><span class="title">graph</span> = Graph(<span class="attr">password=</span>'<span class="number">123456</span>')</span><br><span class="line">a = <span class="keyword">Node</span><span class="title">('Person</span>', <span class="attr">name=</span>'Alice')</span><br><span class="line"><span class="keyword">node</span> <span class="title">= graph</span>.find_one(<span class="attr">label=</span>'Person')</span><br><span class="line"><span class="keyword">node</span><span class="title">['age</span>'] = <span class="number">21</span></span><br><span class="line">graph.push(<span class="keyword">node</span><span class="title">)</span></span><br><span class="line"><span class="title">print</span>(graph.find_one(<span class="attr">label=</span>'Person'))</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果：</p>
                  <figure class="highlight css">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">(<span class="selector-tag">a90a763</span><span class="selector-pseudo">:Person</span> &#123;<span class="attribute">age</span>:<span class="number">21</span>,name:<span class="string">"Alice"</span>&#125;)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>如果想要删除某个 Node 可以使用 delete() 方法，例如：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> py2neo import Graph</span><br><span class="line"></span><br><span class="line">graph = Graph(<span class="attribute">password</span>=<span class="string">'123456'</span>)</span><br><span class="line">node = graph.find_one(<span class="attribute">label</span>=<span class="string">'Person'</span>)</span><br><span class="line">relationship = graph.match_one(<span class="attribute">rel_type</span>=<span class="string">'KNOWS'</span>)</span><br><span class="line">graph.delete(relationship)</span><br><span class="line">graph.delete(node)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在删除 Node 时必须先删除其对应的 Relationship，否则无法删除 Node。 另外我们也可以通过 run() 方法直接执行 CQL 语句，例如：</p>
                  <figure class="highlight haskell">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="title">from</span> py2neo <span class="keyword">import</span> Graph</span><br><span class="line"></span><br><span class="line"><span class="title">graph</span> = <span class="type">Graph</span>(password='<span class="number">123456</span>')</span><br><span class="line"><span class="class"><span class="keyword">data</span> = graph.run('<span class="type">MATCH</span> (<span class="title">p</span>:<span class="type">Person</span>) <span class="type">RETURN</span> p <span class="type">LIMIT</span> 5')</span></span><br><span class="line"><span class="title">print</span>(list(<span class="class"><span class="keyword">data</span>))</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果：</p>
                  <figure class="highlight clojure">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">[(<span class="name">'p':</span> (<span class="name">b6f61ff:Person</span> &#123;age:20,name:<span class="string">"Alice"</span>&#125;)), (<span class="name">'p':</span> (<span class="name">cc238b1:Person</span> &#123;age:20,name:<span class="string">"Alice"</span>&#125;)), (<span class="name">'p':</span> (<span class="name">b09e672:Person</span> &#123;age:20,name:<span class="string">"Alice"</span>&#125;))]</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h3 id="NodeSelector"><a href="#NodeSelector" class="headerlink" title="NodeSelector"></a>NodeSelector</h3>
                  <p>Graph 有时候用起来不太方便，比如如果要根据多个条件进行 Node 的查询是做不到的，在这里更方便的查询方法是利用 NodeSelector，我们首先新建如下的 Node 和 Relationship，实例如下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> py2neo import Graph, Node, Relationship</span><br><span class="line"></span><br><span class="line">graph = Graph(<span class="attribute">password</span>=<span class="string">'123456'</span>)</span><br><span class="line">a = Node(<span class="string">'Person'</span>, <span class="attribute">name</span>=<span class="string">'Alice'</span>, <span class="attribute">age</span>=21, <span class="attribute">location</span>=<span class="string">'广州'</span>)</span><br><span class="line">b = Node(<span class="string">'Person'</span>, <span class="attribute">name</span>=<span class="string">'Bob'</span>, <span class="attribute">age</span>=22, <span class="attribute">location</span>=<span class="string">'上海'</span>)</span><br><span class="line">c = Node(<span class="string">'Person'</span>, <span class="attribute">name</span>=<span class="string">'Mike'</span>, <span class="attribute">age</span>=21, <span class="attribute">location</span>=<span class="string">'北京'</span>)</span><br><span class="line">r1 = Relationship(a, <span class="string">'KNOWS'</span>, b)</span><br><span class="line">r2 = Relationship(b, <span class="string">'KNOWS'</span>, c)</span><br><span class="line">graph.create(a)</span><br><span class="line">graph.create(r1)</span><br><span class="line">graph.create(r2)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果： <img src="https://germey.gitbooks.io/ai/content/assets/2017-08-31-23-38-27.jpg" alt=""> 在这里我们用 NodeSelector 来筛选 age 为 21 的 Person Node，实例如下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> py2neo import Graph, NodeSelector</span><br><span class="line"></span><br><span class="line">graph = Graph(<span class="attribute">password</span>=<span class="string">'123456'</span>)</span><br><span class="line">selector = NodeSelector(graph)</span><br><span class="line">persons = selector.select(<span class="string">'Person'</span>, <span class="attribute">age</span>=21)</span><br><span class="line"><span class="builtin-name">print</span>(list(persons))</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果：</p>
                  <figure class="highlight groovy">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">[(<span class="string">d195b2e:</span>Person &#123;<span class="string">age:</span><span class="number">21</span>,<span class="string">location:</span><span class="string">"广州"</span>,<span class="string">name:</span><span class="string">"Alice"</span>&#125;), (<span class="string">eefe475:</span>Person &#123;<span class="string">age:</span><span class="number">21</span>,<span class="string">location:</span><span class="string">"北京"</span>,<span class="string">name:</span><span class="string">"Mike"</span>&#125;)]</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>另外也可以使用 where() 进行更复杂的查询，例如查找 name 是 A 开头的 Person Node，实例如下：</p>
                  <figure class="highlight pgsql">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> py2neo <span class="keyword">import</span> Graph, NodeSelector</span><br><span class="line"></span><br><span class="line">graph = Graph(<span class="keyword">password</span>=<span class="string">'123456'</span>)</span><br><span class="line">selector = NodeSelector(graph)</span><br><span class="line">persons = selector.<span class="keyword">select</span>(<span class="string">'Person'</span>).<span class="keyword">where</span>(<span class="string">'_.name =~ "A.*"'</span>)</span><br><span class="line">print(list(persons))</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果：</p>
                  <figure class="highlight clojure">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">[(<span class="name">bcd8072:Person</span> &#123;age:21,location:<span class="string">"广州"</span>,name:<span class="string">"Alice"</span>&#125;)]</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在这里用了正则表达式匹配查询。 另外也可以使用 order_by() 进行排序：</p>
                  <figure class="highlight reasonml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">from py2neo import Graph, NodeSelector</span><br><span class="line"></span><br><span class="line">graph = <span class="constructor">Graph(<span class="params">password</span>='123456')</span></span><br><span class="line">selector = <span class="constructor">NodeSelector(<span class="params">graph</span>)</span></span><br><span class="line">persons = selector.select('Person').order<span class="constructor">_by('<span class="params">_</span>.<span class="params">age</span>')</span></span><br><span class="line">print(<span class="built_in">list</span>(persons))</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果：</p>
                  <figure class="highlight groovy">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">[(<span class="string">e3fc3d7:</span>Person &#123;<span class="string">age:</span><span class="number">21</span>,<span class="string">location:</span><span class="string">"广州"</span>,<span class="string">name:</span><span class="string">"Alice"</span>&#125;), (<span class="string">da0179d:</span>Person &#123;<span class="string">age:</span><span class="number">21</span>,<span class="string">location:</span><span class="string">"北京"</span>,<span class="string">name:</span><span class="string">"Mike"</span>&#125;), (<span class="string">cafa16e:</span>Person &#123;<span class="string">age:</span><span class="number">22</span>,<span class="string">location:</span><span class="string">"上海"</span>,<span class="string">name:</span><span class="string">"Bob"</span>&#125;)]</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>前面返回的都是列表，如果要查询单个节点的话，可以使用 first() 方法，实例如下：</p>
                  <figure class="highlight pgsql">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> py2neo <span class="keyword">import</span> Graph, NodeSelector</span><br><span class="line"></span><br><span class="line">graph = Graph(<span class="keyword">password</span>=<span class="string">'123456'</span>)</span><br><span class="line">selector = NodeSelector(graph)</span><br><span class="line">person = selector.<span class="keyword">select</span>(<span class="string">'Person'</span>).<span class="keyword">where</span>(<span class="string">'_.name =~ "A.*"'</span>).first()</span><br><span class="line">print(person)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果：</p>
                  <figure class="highlight css">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">(<span class="selector-tag">ea81c04</span><span class="selector-pseudo">:Person</span> &#123;<span class="attribute">age</span>:<span class="number">21</span>,location:<span class="string">"广州"</span>,name:<span class="string">"Alice"</span>&#125;)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>更详细的内容可以查看：<a href="http://py2neo.org/v3/database.html#cypher-utilities" target="_blank" rel="noopener">http://py2neo.org/v3/database.html#cypher-utilities</a>。</p>
                  <h3 id="OGM"><a href="#OGM" class="headerlink" title="OGM"></a>OGM</h3>
                  <p>OGM 类似于 ORM，意为 Object Graph Mapping，这样可以实现一个对象和 Node 的关联，例如：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> py2neo.ogm <span class="keyword">import</span> GraphObject, Property, RelatedTo, RelatedFrom</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="symbol">Movie</span>(<span class="symbol">GraphObject</span>):</span><br><span class="line">    <span class="symbol">__primarykey__</span> = '<span class="symbol">title</span>'</span><br><span class="line"></span><br><span class="line">    <span class="symbol">title</span> = <span class="symbol">Property</span>()</span><br><span class="line">    <span class="symbol">released</span> = <span class="symbol">Property</span>()</span><br><span class="line">    <span class="symbol">actors</span> = <span class="symbol">RelatedFrom</span>('<span class="symbol">Person</span>', '<span class="symbol">ACTED_IN</span>')</span><br><span class="line">    <span class="symbol">directors</span> = <span class="symbol">RelatedFrom</span>('<span class="symbol">Person</span>', '<span class="symbol">DIRECTED</span>')</span><br><span class="line">    <span class="symbol">producers</span> = <span class="symbol">RelatedFrom</span>('<span class="symbol">Person</span>', '<span class="symbol">PRODUCED</span>')</span><br><span class="line"></span><br><span class="line"><span class="symbol">class</span> <span class="symbol">Person</span>(<span class="symbol">GraphObject</span>):</span><br><span class="line">    <span class="symbol">__primarykey__</span> = '<span class="symbol">name</span>'</span><br><span class="line"></span><br><span class="line">    <span class="symbol">name</span> = <span class="symbol">Property</span>()</span><br><span class="line">    <span class="symbol">born</span> = <span class="symbol">Property</span>()</span><br><span class="line">    <span class="symbol">acted_in</span> = <span class="symbol">RelatedTo</span>('<span class="symbol">Movie</span>')</span><br><span class="line">    <span class="symbol">directed</span> = <span class="symbol">RelatedTo</span>('<span class="symbol">Movie</span>')</span><br><span class="line">    <span class="symbol">produced</span> = <span class="symbol">RelatedTo</span>('<span class="symbol">Movie</span>')</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>我们可以用它来结合 Graph 查询，例如：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> py2neo import Graph</span><br><span class="line"><span class="keyword">from</span> py2neo.ogm import GraphObject, Property</span><br><span class="line"></span><br><span class="line">graph = Graph(<span class="attribute">password</span>=<span class="string">'123456'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Person(GraphObject):</span><br><span class="line">    __primarykey__ = <span class="string">'name'</span></span><br><span class="line"></span><br><span class="line">    name = Property()</span><br><span class="line">    age = Property()</span><br><span class="line">    location = Property()</span><br><span class="line"></span><br><span class="line">person = Person.select(graph).where(<span class="attribute">age</span>=21).first()</span><br><span class="line"><span class="builtin-name">print</span>(person)</span><br><span class="line"><span class="builtin-name">print</span>(person.name)</span><br><span class="line"><span class="builtin-name">print</span>(person.age)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">&lt;Person <span class="attribute">name</span>=<span class="string">'Alice'</span>&gt;</span><br><span class="line">Alice</span><br><span class="line">21</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样我们就成功实现了对象和 Node 的映射。 我们可以用它动态改变 Node 的属性，例如修改某个 Node 的 age 属性，实例如下：</p>
                  <figure class="highlight crmsh">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">person = Person.select(graph).where(<span class="attr">age=</span><span class="number">21</span>).first()</span><br><span class="line">print(person.__ogm__.<span class="keyword">node</span><span class="title">)</span></span><br><span class="line"><span class="title">person</span>.age = <span class="number">22</span></span><br><span class="line">print(person.__ogm__.<span class="keyword">node</span><span class="title">)</span></span><br><span class="line"><span class="title">graph</span>.push(person)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果：</p>
                  <figure class="highlight css">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">(<span class="selector-tag">ccf5640</span><span class="selector-pseudo">:Person</span> &#123;<span class="attribute">age</span>:<span class="number">21</span>,location:<span class="string">"北京"</span>,name:<span class="string">"Mike"</span>&#125;)</span><br><span class="line">(<span class="selector-tag">ccf5640</span><span class="selector-pseudo">:Person</span> &#123;<span class="attribute">age</span>:<span class="number">22</span>,location:<span class="string">"北京"</span>,name:<span class="string">"Mike"</span>&#125;)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>另外我们也可以通过映射关系进行 Relationship 的调整，例如通过 Relationship 添加一个关联 Node，实例如下：</p>
                  <figure class="highlight pgsql">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> py2neo <span class="keyword">import</span> Graph</span><br><span class="line"><span class="keyword">from</span> py2neo.ogm <span class="keyword">import</span> GraphObject, Property, RelatedTo</span><br><span class="line"></span><br><span class="line">graph = Graph(<span class="keyword">password</span>=<span class="string">'123456'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> Person(GraphObject):</span><br><span class="line">    __primarykey__ = <span class="string">'name'</span></span><br><span class="line"></span><br><span class="line">    <span class="type">name</span> = Property()</span><br><span class="line">    age = Property()</span><br><span class="line">    <span class="keyword">location</span> = Property()</span><br><span class="line">    knows = RelatedTo(<span class="string">'Person'</span>, <span class="string">'KNOWS'</span>)</span><br><span class="line"></span><br><span class="line">person = Person.<span class="keyword">select</span>(graph).<span class="keyword">where</span>(age=<span class="number">21</span>).first()</span><br><span class="line">print(list(person.knows))</span><br><span class="line">new_person = Person()</span><br><span class="line">new_person.name = <span class="string">'Durant'</span></span><br><span class="line">new_person.age = <span class="number">28</span></span><br><span class="line">person.knows.<span class="keyword">add</span>(new_person)</span><br><span class="line">print(list(person.knows))</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果：</p>
                  <figure class="highlight fsharp">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="meta">[&lt;Person name='Bob'&gt;]</span></span><br><span class="line"><span class="meta">[&lt;Person name='Bob'&gt;, &lt;Person name='Durant'&gt;]</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样我们就完成了 Node 和 Relationship 的添加，同时由于设置了 primarykey 为 name，所以不会重复添加。 但是注意此时数据库并没有更新，只是对象更新了，如果要更新到数据库中还需要调用 Graph 对象的 push() 或 pull() 方法，添加如下代码即可：</p>
                  <figure class="highlight css">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="selector-tag">graph</span><span class="selector-class">.push</span>(<span class="selector-tag">person</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>也可以通过 remove() 方法移除某个关联 Node，实例如下：</p>
                  <figure class="highlight fortran">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">person = Person.<span class="keyword">select</span>(graph).<span class="keyword">where</span>(<span class="keyword">name</span>=<span class="string">'Alice'</span>).first()</span><br><span class="line"><span class="keyword">target</span> = Person.<span class="keyword">select</span>(graph).<span class="keyword">where</span>(<span class="keyword">name</span>=<span class="string">'Durant'</span>).first()</span><br><span class="line">person.knows.remove(<span class="keyword">target</span>)</span><br><span class="line">graph.push(person)</span><br><span class="line">graph.delete(<span class="keyword">target</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这里 target 是 name 为 Durant 的 Node，代码运行完毕后即可删除关联 Relationship 和删除 Node。 以上便是 OGM 的用法，查询修改非常方便，推荐使用此方法进行 Node 和 Relationship 的修改。 更多内容可以查看：<a href="http://py2neo.org/v3/ogm.html#module-py2neo.ogm" target="_blank" rel="noopener">http://py2neo.org/v3/ogm.html#module-py2neo.ogm</a>。</p>
                  <h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2>
                  <p>以上便是对 Neo4j 的相关介绍。</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2017-09-01 01:29:20" itemprop="dateCreated datePublished" datetime="2017-09-01T01:29:20+08:00">2017-09-01</time>
                </span>
                <span id="/4778.html" class="post-meta-item leancloud_visitors" data-flag-title="Neo4j简介及Py2Neo的用法" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>12k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>11 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/4759.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="静觅丨崔庆才的个人站点专业为您提供爬虫教程,爬虫,Python,Python爬虫,Python爬虫教程,爬虫书的相关信息，想要了解更多详情，请联系我们。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/4759.html" class="post-title-link" itemprop="url">记scikit-learn贝叶斯文本分类的坑（弄了个笨办法解决了，有其它办法的小哥儿请指点）</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>基本步骤： 1、训练素材分类： 我是参考官方的目录结构： <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/08/s01.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/08/s01.png" alt=""></a> 每个目录中放对应的文本，一个 txt 文件一篇对应的文章：就像下面这样 <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/08/s02.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/08/s02.png" alt=""></a> 需要注意的是所有素材比例请保持在相同的比例（根据训练结果酌情调整、不可比例过于悬殊、容易造成过拟合（通俗点就是大部分文章都给你分到素材最多的那个类别去了）） 废话不多说直接上代码吧（测试代码的丑得一逼；将就着看看吧） 需要一个小工具： pip install chinese-tokenizer 这是训练器：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> jieba</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line"><span class="keyword">from</span> chinese_tokenizer.tokenizer <span class="keyword">import</span> Tokenizer</span><br><span class="line"><span class="keyword">from</span> sklearn.datasets <span class="keyword">import</span> load_files</span><br><span class="line"><span class="keyword">from</span> sklearn.feature_extraction.text <span class="keyword">import</span> CountVectorizer, TfidfTransformer</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br><span class="line"><span class="keyword">from</span> sklearn.naive_bayes <span class="keyword">import</span> MultinomialNB</span><br><span class="line"><span class="keyword">from</span> sklearn.externals <span class="keyword">import</span> joblib</span><br><span class="line"></span><br><span class="line">jie_ba_tokenizer = Tokenizer().jie_ba_tokenizer</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载数据集</span></span><br><span class="line">training_data = load_files(<span class="string">'./data'</span>, encoding=<span class="string">'utf-8'</span>)</span><br><span class="line"><span class="comment"># x_train txt内容 y_train 是类别（正 负 中 ）</span></span><br><span class="line">x_train, _, y_train, _ = train_test_split(training_data.data, training_data.target)</span><br><span class="line">print(<span class="string">'开始建模.....'</span>)</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'training_data.target'</span>, <span class="string">'w'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(json.dumps(training_data.target_names))</span><br><span class="line"><span class="comment"># tokenizer参数是用来对文本进行分词的函数（就是上面我们结巴分词）</span></span><br><span class="line">count_vect = CountVectorizer(tokenizer=jieba_tokenizer)</span><br><span class="line"></span><br><span class="line">tfidf_transformer = TfidfTransformer()</span><br><span class="line">X_train_counts = count_vect.fit_transform(x_train)</span><br><span class="line"></span><br><span class="line">X_train_tfidf = tfidf_transformer.fit_transform(X_train_counts)</span><br><span class="line">print(<span class="string">'正在训练分类器.....'</span>)</span><br><span class="line"><span class="comment"># 多项式贝叶斯分类器训练</span></span><br><span class="line">clf = MultinomialNB().fit(X_train_tfidf, y_train)</span><br><span class="line"><span class="comment"># 保存分类器（好在其它程序中使用）</span></span><br><span class="line">joblib.dump(clf, <span class="string">'model.pkl'</span>)</span><br><span class="line"><span class="comment"># 保存矢量化（坑在这儿！！需要使用和训练器相同的 矢量器 不然会报错！！！！！！ 提示 ValueError dimension mismatch··）</span></span><br><span class="line">joblib.dump(count_vect, <span class="string">'count_vect'</span>)</span><br><span class="line">print(<span class="string">"分类器的相关信息："</span>)</span><br><span class="line">print(clf)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>下面是是使用训练好的分类器分类文章： <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/08/s03.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/08/s03.png" alt=""></a> 需要分类的文章放在 predict_data 目录中：照样是一篇文章一个 txt 文件</p>
                  <figure class="highlight pgsql">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"># -*- coding: utf<span class="number">-8</span> -*-</span><br><span class="line"># @<span class="type">Time</span>    : <span class="number">2017</span>/<span class="number">8</span>/<span class="number">23</span> <span class="number">18</span>:<span class="number">02</span></span><br><span class="line"># @Author  : 哎哟卧槽</span><br><span class="line"># @Site    :</span><br><span class="line"># @File    : 贝叶斯分类器.py</span><br><span class="line"># @Software: PyCharm</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> jieba</span><br><span class="line"><span class="keyword">import</span> <span class="type">json</span></span><br><span class="line"><span class="keyword">from</span> sklearn.datasets <span class="keyword">import</span> load_files</span><br><span class="line"><span class="keyword">from</span> sklearn.feature_extraction.text <span class="keyword">import</span> CountVectorizer, TfidfTransformer</span><br><span class="line"><span class="keyword">from</span> sklearn.externals <span class="keyword">import</span> joblib</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 加载分类器</span><br><span class="line">clf = joblib.<span class="keyword">load</span>(<span class="string">'model.pkl'</span>)</span><br><span class="line"></span><br><span class="line">count_vect = joblib.<span class="keyword">load</span>(<span class="string">'count_vect'</span>)</span><br><span class="line">testing_data = load_files(<span class="string">'./predict_data'</span>, encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">target_names = <span class="type">json</span>.loads(<span class="keyword">open</span>(<span class="string">'training_data.target'</span>, <span class="string">'r'</span>, encoding=<span class="string">'utf-8'</span>).<span class="keyword">read</span>())</span><br><span class="line">#     # 字符串处理</span><br><span class="line">tfidf_transformer = TfidfTransformer()</span><br><span class="line"></span><br><span class="line">X_new_counts = count_vect.<span class="keyword">transform</span>(testing_data.data)</span><br><span class="line">X_new_tfidf = tfidf_transformer.fit_transform(X_new_counts)</span><br><span class="line"># 进行预测</span><br><span class="line">predicted = clf.predict(X_new_tfidf)</span><br><span class="line"><span class="keyword">for</span> title, category <span class="keyword">in</span> zip(testing_data.filenames, predicted):</span><br><span class="line">    print(<span class="string">'%r =&gt; %s'</span> % (title, target_names[category]))</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这个样子将训练好的分类器在新的程序中使用时候 就不报错： ValueError dimension mismatch·· 这儿有个 demo 仅供参考：<a href="https://github.com/thsheep/sklearn_naive_bayes_classification" target="_blank" rel="noopener">GitHub 地址</a></p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/哎哟卧槽" class="author" itemprop="url" rel="index">哎哟卧槽</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2017-08-23 18:49:44" itemprop="dateCreated datePublished" datetime="2017-08-23T18:49:44+08:00">2017-08-23</time>
                </span>
                <span id="/4759.html" class="post-meta-item leancloud_visitors" data-flag-title="记scikit-learn贝叶斯文本分类的坑（弄了个笨办法解决了，有其它办法的小哥儿请指点）" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>2.4k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>2 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/4725.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="静觅丨崔庆才的个人站点专业为您提供爬虫教程,爬虫,Python,Python爬虫,Python爬虫教程,爬虫书的相关信息，想要了解更多详情，请联系我们。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/4725.html" class="post-title-link" itemprop="url">小白进阶之Scrapy第五篇（Scrapy-Splash配合CrawlSpider；瞎几把整的）</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>估摸着各位小伙伴儿被想使用 CrawlSpider 的 Rule 来抓取 JS，相当受折磨； CrawlSpider Rule 总是不能和 Splash 结合。 废话不多说，手疼····</p>
                  <h1 id="方法-1："><a href="#方法-1：" class="headerlink" title="方法 1："></a><strong>方法 1：</strong></h1>
                  <p>写一个自定义的函数，使用 Rule 中的 process_request 参数；来替换掉 Rule 本身 Request 的逻辑。 参考官方文档： <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/07/QQ20170712-002911.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/07/QQ20170712-002911.png" alt=""></a> 1、将请求更换为 SplashRequest 请求： 2、每次请求将本次请求的 URL 使用 Meta 参数传递下去； 3、重写 _requests_to_follow 方法：替换响应 Response 的 URL 为我们传递的 URL（否则会格式为 Splash 的地址） 就像下面这样</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MySpider</span><span class="params">(CrawlSpider)</span>:</span></span><br><span class="line"></span><br><span class="line">    name = <span class="string">'innda'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_requests</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">yield</span> SplashRequest(url, dont_process_response=<span class="literal">True</span>, args=&#123;<span class="string">'wait'</span>: <span class="number">0.5</span>&#125;, meta=&#123;<span class="string">'real_url'</span>: url&#125;)</span><br><span class="line"></span><br><span class="line">    rules = (</span><br><span class="line">        Rule(LinkExtractor(allow=(<span class="string">'node_\d+\.htm'</span>,)), process_request=<span class="string">'splash_request'</span>, follow=<span class="literal">True</span>),</span><br><span class="line">        Rule(LinkExtractor(allow=(<span class="string">'content_\d+\.htm'</span>,)), callback=<span class="string">"one_parse"</span>)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">splash_request</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        :param request: Request对象（是一个字典；怎么取值就不说了吧！！）</span></span><br><span class="line"><span class="string">        :return: SplashRequest的请求</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="comment"># dont_process_response=True 参数表示不更改响应对象类型（默认为：HTMLResponse；更改后为：SplashTextResponse）</span></span><br><span class="line">        <span class="comment"># args=&#123;'wait': 0.5&#125; 表示传递等待参数0.5（Splash会渲染0.5s的时间）</span></span><br><span class="line">        <span class="comment"># meta 传递请求的当前请求的URL</span></span><br><span class="line">        <span class="keyword">return</span> SplashRequest(url=request.url, dont_process_response=<span class="literal">True</span>, args=&#123;<span class="string">'wait'</span>: <span class="number">0.5</span>&#125;, meta=&#123;<span class="string">'real_url'</span>: request.url&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_requests_to_follow</span><span class="params">(self, response)</span>:</span></span><br><span class="line">        <span class="string">"""重写的函数哈！这个函数是Rule的一个方法</span></span><br><span class="line"><span class="string">        :param response: 这货是啥看名字都知道了吧（这货也是个字典，然后你懂的ｄ(･∀･*)♪ﾟ）</span></span><br><span class="line"><span class="string">        :return: 追踪的Request</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> isinstance(response, HtmlResponse):</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        seen = set()</span><br><span class="line">        <span class="comment"># 将Response的URL更改为我们传递下来的URL</span></span><br><span class="line">        <span class="comment"># 需要注意哈！ 不能直接直接改！只能通过Response.replace这个魔术方法来改！（当然你改无所谓啦！反正会用报错来报复你 (`皿´) ）并且！！！</span></span><br><span class="line">        <span class="comment"># 敲黑板！！！！划重点！！！！！注意了！！！ 这货只能赋给一个新的对象（你说变量也行，怎么说都行！(*ﾟ∀ﾟ)=3）</span></span><br><span class="line">        newresponse = response.replace(url=response.meta.get(<span class="string">'real_url'</span>))</span><br><span class="line">        <span class="keyword">for</span> n, rule <span class="keyword">in</span> enumerate(self._rules):</span><br><span class="line">            <span class="comment"># 我要长一点不然有人看不见------------------------------------newresponse 看见没！别忘了改！！！</span></span><br><span class="line">            links = [lnk <span class="keyword">for</span> lnk <span class="keyword">in</span> rule.link_extractor.extract_links(newresponse)</span><br><span class="line">                     <span class="keyword">if</span> lnk <span class="keyword">not</span> <span class="keyword">in</span> seen]</span><br><span class="line">            <span class="keyword">if</span> links <span class="keyword">and</span> rule.process_links:</span><br><span class="line">                links = rule.process_links(links)</span><br><span class="line">            <span class="keyword">for</span> link <span class="keyword">in</span> links:</span><br><span class="line">                seen.add(link)</span><br><span class="line">                r = self._build_request(n, link)</span><br><span class="line">                <span class="keyword">yield</span> rule.process_request(r)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">one_parse</span><span class="params">(self, response)</span>:</span></span><br><span class="line">        print(response.url)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h2 id="方法-2"><a href="#方法-2" class="headerlink" title="方法 2:"></a>方法 2:</h2>
                  <p>这就很简单啦！干掉类型检查就是了(/≧▽≦)/ 就像这样：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MySpider</span><span class="params">(CrawlSpider)</span>:</span></span><br><span class="line"></span><br><span class="line">    name = <span class="string">'innda'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_requests</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">yield</span> SplashRequest(url, args=&#123;<span class="string">'wait'</span>: <span class="number">0.5</span>&#125;)</span><br><span class="line"></span><br><span class="line">    rules = (</span><br><span class="line">        Rule(LinkExtractor(allow=(<span class="string">'node_\d+\.htm'</span>,)), process_request=<span class="string">'splash_request'</span>, follow=<span class="literal">True</span>),</span><br><span class="line">        Rule(LinkExtractor(allow=(<span class="string">'content_\d+\.htm'</span>,)), callback=<span class="string">"one_parse"</span>)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">splash_request</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        :param request: Request对象（是一个字典；怎么取值就不说了吧！！）</span></span><br><span class="line"><span class="string">        :return: SplashRequest的请求</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="comment"># dont_process_response=True 参数表示不更改响应对象类型（默认为：HTMLResponse；更改后为：SplashTextResponse）</span></span><br><span class="line">        <span class="comment"># args=&#123;'wait': 0.5&#125; 表示传递等待参数0.5（Splash会渲染0.5s的时间）</span></span><br><span class="line">        <span class="comment"># meta 传递请求的当前请求的URL</span></span><br><span class="line">        <span class="keyword">return</span> SplashRequest(url=request.url, args=&#123;<span class="string">'wait'</span>: <span class="number">0.5</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_requests_to_follow</span><span class="params">(self, response)</span>:</span></span><br><span class="line">        <span class="string">"""重写的函数哈！这个函数是Rule的一个方法</span></span><br><span class="line"><span class="string">        :param response: 这货是啥看名字都知道了吧（这货也是个字典，然后你懂的ｄ(･∀･*)♪ﾟ）</span></span><br><span class="line"><span class="string">        :return: 追踪的Request</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="comment"># *************请注意我就是被注释注释掉的类型检查o(TωT)o </span></span><br><span class="line">        <span class="comment"># if not isinstance(response, HtmlResponse):</span></span><br><span class="line">        <span class="comment">#     return</span></span><br><span class="line">        <span class="comment"># ************************************************</span></span><br><span class="line">        seen = set()</span><br><span class="line">        <span class="comment"># 将Response的URL更改为我们传递下来的URL</span></span><br><span class="line">        <span class="comment"># 需要注意哈！ 不能直接直接改！只能通过Response.replace这个魔术方法来改！并且！！！</span></span><br><span class="line">        <span class="comment"># 敲黑板！！！！划重点！！！！！注意了！！！ 这货只能赋给一个新的对象（你说变量也行，怎么说都行！(*ﾟ∀ﾟ)=3）</span></span><br><span class="line">        <span class="comment"># newresponse = response.replace(url=response.meta.get('real_url'))</span></span><br><span class="line">        <span class="keyword">for</span> n, rule <span class="keyword">in</span> enumerate(self._rules):</span><br><span class="line">            <span class="comment"># 我要长一点不然有人看不见------------------------------------newresponse 看见没！别忘了改！！！</span></span><br><span class="line">            links = [lnk <span class="keyword">for</span> lnk <span class="keyword">in</span> rule.link_extractor.extract_links(response)</span><br><span class="line">                     <span class="keyword">if</span> lnk <span class="keyword">not</span> <span class="keyword">in</span> seen]</span><br><span class="line">            <span class="keyword">if</span> links <span class="keyword">and</span> rule.process_links:</span><br><span class="line">                links = rule.process_links(links)</span><br><span class="line">            <span class="keyword">for</span> link <span class="keyword">in</span> links:</span><br><span class="line">                seen.add(link)</span><br><span class="line">                r = self._build_request(n, link)</span><br><span class="line">                <span class="keyword">yield</span> rule.process_request(r)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>以上完毕@_@!!</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/哎哟卧槽" class="author" itemprop="url" rel="index">哎哟卧槽</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2017-07-12 00:48:25" itemprop="dateCreated datePublished" datetime="2017-07-12T00:48:25+08:00">2017-07-12</time>
                </span>
                <span id="/4725.html" class="post-meta-item leancloud_visitors" data-flag-title="小白进阶之Scrapy第五篇（Scrapy-Splash配合CrawlSpider；瞎几把整的）" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>3.4k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>3 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/4652.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="静觅丨崔庆才的个人站点专业为您提供爬虫教程,爬虫,Python,Python爬虫,Python爬虫教程,爬虫书的相关信息，想要了解更多详情，请联系我们。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/4652.html" class="post-title-link" itemprop="url">利用新接口抓取微信公众号的所有文章</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>各位小伙儿伴儿，一定深受过采集微信公众号之苦吧！特别是！！！！！！公共号历史信息！！！这丫除了通过中间代理采集 APP、还真没什么招数能拿到数据啊！ <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/QQ图片20161022193315.gif" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/QQ图片20161022193315.gif" alt=""></a> 直到············ 前天晚上微信官方发布了一个文章：<a href="http://mp.weixin.qq.com/s/67sk-uKz9Ct4niT-f4u1KA" target="_blank" rel="noopener">点我</a> 大致意思是说以后发布文章的时候可以直接插入其它公众号的文章了。 <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/QQ图片20161021224219.gif" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/QQ图片20161021224219.gif" alt=""></a> 诶妈呀！这不是一直需要的采集接口嘛！啧啧 天助我也啊！来来·········下面大致的说一下方法。</p>
                  <h2 id="1、首先你需要一个订阅号！-公众号、和企业号是否可行我不清楚。因为我木有·····"><a href="#1、首先你需要一个订阅号！-公众号、和企业号是否可行我不清楚。因为我木有·····" class="headerlink" title="1、首先你需要一个订阅号！ 公众号、和企业号是否可行我不清楚。因为我木有·····"></a>1、首先你需要一个订阅号！ 公众号、和企业号是否可行我不清楚。因为我木有·····</h2>
                  <h2 id="2、其次你需要登录！"><a href="#2、其次你需要登录！" class="headerlink" title="2、其次你需要登录！"></a><strong>2、其次你需要登录！</strong></h2>
                  <p>微信公众号登录我没仔细看。 这个暂且不说了，我使用的是 selenium 驱动浏览器获取 Cookie 的方法、来达到登录的效果。</p>
                  <h2 id="3、使用-requests-携带-Cookie、登录获取-URL-的-token（这玩意儿很重要每一次请求都需要带上它）像下面这样："><a href="#3、使用-requests-携带-Cookie、登录获取-URL-的-token（这玩意儿很重要每一次请求都需要带上它）像下面这样：" class="headerlink" title="3、使用 requests 携带 Cookie、登录获取 URL 的 token（这玩意儿很重要每一次请求都需要带上它）像下面这样："></a>3、使用 requests 携带 Cookie、登录获取 URL 的 token（这玩意儿很重要每一次请求都需要带上它）像下面这样：</h2>
                  <p><a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/06/TIM截图20170607085814.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/06/TIM截图20170607085814.png" alt=""></a></p>
                  <h2 id="4、使用获取到的-token、和公众号的微信号（就是数字-字符那种）、获取到公众号的-fakeid（你可以理解公众号的标识）"><a href="#4、使用获取到的-token、和公众号的微信号（就是数字-字符那种）、获取到公众号的-fakeid（你可以理解公众号的标识）" class="headerlink" title="4、使用获取到的 token、和公众号的微信号（就是数字+字符那种）、获取到公众号的 fakeid（你可以理解公众号的标识）"></a>4、使用获取到的 token、和公众号的微信号（就是数字+字符那种）、获取到公众号的 fakeid（你可以理解公众号的标识）</h2>
                  <p><a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/06/2.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/06/2.png" alt=""></a></p>
                  <h3 id="我们在搜索公众号的时候浏览器带着参数以-GET-方法想红框中的-URL-发起了请求。请求参数如下："><a href="#我们在搜索公众号的时候浏览器带着参数以-GET-方法想红框中的-URL-发起了请求。请求参数如下：" class="headerlink" title="我们在搜索公众号的时候浏览器带着参数以 GET 方法想红框中的 URL 发起了请求。请求参数如下："></a>我们在搜索公众号的时候浏览器带着参数以 GET 方法想红框中的 URL 发起了请求。请求参数如下：</h3>
                  <p><a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/06/3.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/06/3.png" alt=""></a></p>
                  <h3 id="请求相应如下："><a href="#请求相应如下：" class="headerlink" title="请求相应如下："></a><strong>请求相应如下：</strong></h3>
                  <p><a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/06/4.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/06/4.png" alt=""></a></p>
                  <h3 id="代码如下："><a href="#代码如下：" class="headerlink" title="代码如下："></a><strong>代码如下：</strong></h3>
                  <p><a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/06/5.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/06/5.png" alt=""></a></p>
                  <h1 id="好了-我们再继续："><a href="#好了-我们再继续：" class="headerlink" title="好了 我们再继续："></a>好了 我们再继续：</h1>
                  <h2 id="5、点击我们搜索到的公众号之后、又发现一个请求："><a href="#5、点击我们搜索到的公众号之后、又发现一个请求：" class="headerlink" title="5、点击我们搜索到的公众号之后、又发现一个请求："></a><strong>5、点击我们搜索到的公众号之后、又发现一个请求：</strong></h2>
                  <p><a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/06/6.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/06/6.png" alt=""></a></p>
                  <h3 id="请求参数如下："><a href="#请求参数如下：" class="headerlink" title="请求参数如下："></a>请求参数如下：</h3>
                  <p><a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/06/7.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/06/7.png" alt=""></a></p>
                  <h3 id="返回如下："><a href="#返回如下：" class="headerlink" title="返回如下："></a>返回如下：</h3>
                  <p><a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/06/8.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/06/8.png" alt=""></a></p>
                  <h3 id="代码如下：-1"><a href="#代码如下：-1" class="headerlink" title="代码如下："></a>代码如下：</h3>
                  <p><a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/06/9.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/06/9.png" alt=""></a></p>
                  <h2 id="好了···最后一步、获取所有文章需要处理一下翻页、翻页请求如下："><a href="#好了···最后一步、获取所有文章需要处理一下翻页、翻页请求如下：" class="headerlink" title="好了···最后一步、获取所有文章需要处理一下翻页、翻页请求如下："></a>好了···最后一步、获取所有文章需要处理一下翻页、翻页请求如下：</h2>
                  <p><a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/06/10.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/06/10.png" alt=""></a></p>
                  <h4 id="我大概看了一下、极客学院每一页大概至少有-5-条信息、也就是总文章数-5-就是有多少页。但是有小数、我们取整，然后加-1-就是总页数了。"><a href="#我大概看了一下、极客学院每一页大概至少有-5-条信息、也就是总文章数-5-就是有多少页。但是有小数、我们取整，然后加-1-就是总页数了。" class="headerlink" title="我大概看了一下、极客学院每一页大概至少有 5 条信息、也就是总文章数/5 就是有多少页。但是有小数、我们取整，然后加 1 就是总页数了。"></a><strong>我大概看了一下、极客学院每一页大概至少有 5 条信息、也就是总文章数/5 就是有多少页。但是有小数、我们取整，然后加 1 就是总页数了。</strong></h4>
                  <h4 id="代码如下：-2"><a href="#代码如下：-2" class="headerlink" title="代码如下："></a><strong>代码如下：</strong></h4>
                  <p><a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/06/11.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/06/11.png" alt=""></a></p>
                  <h2 id="item-get-‘link’-就是我们需要的公众号文章连接啦！继续请求这个-URL-提取里面的内容就是啦！"><a href="#item-get-‘link’-就是我们需要的公众号文章连接啦！继续请求这个-URL-提取里面的内容就是啦！" class="headerlink" title="item.get(‘link’)就是我们需要的公众号文章连接啦！继续请求这个 URL 提取里面的内容就是啦！"></a><strong>item.get(‘link’)就是我们需要的公众号文章连接啦！继续请求这个 URL 提取里面的内容就是啦！</strong></h2>
                  <h1 id="以下是完整的测试代码："><a href="#以下是完整的测试代码：" class="headerlink" title="以下是完整的测试代码："></a><strong>以下是完整的测试代码：</strong></h1>
                  <figure class="highlight xl">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">from selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">import</span> <span class="built_in">time</span></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">from pprint <span class="keyword">import</span> pprint</span><br><span class="line"></span><br><span class="line">post = &#123;&#125;</span><br><span class="line"></span><br><span class="line">driver = webdriver.Chrome(executable_path=<span class="string">'C:\chromedriver.exe'</span>)</span><br><span class="line">driver.get(<span class="string">'https://mp.weixin.qq.com/'</span>)</span><br><span class="line"><span class="built_in">time</span>.sleep(<span class="number">2</span>)</span><br><span class="line">driver.find_element_by_xpath(<span class="string">"./*//input[@id='account']"</span>).clear()</span><br><span class="line">driver.find_element_by_xpath(<span class="string">"./*//input[@id='account']"</span>).send_keys(<span class="string">'你的帐号'</span>)</span><br><span class="line">driver.find_element_by_xpath(<span class="string">"./*//input[@id='pwd']"</span>).clear()</span><br><span class="line">driver.find_element_by_xpath(<span class="string">"./*//input[@id='pwd']"</span>).send_keys(<span class="string">'你的密码'</span>)</span><br><span class="line"># 在自动输完密码之后记得点一下记住我</span><br><span class="line"><span class="built_in">time</span>.sleep(<span class="number">5</span>)</span><br><span class="line">driver.find_element_by_xpath(<span class="string">"./*//a[@id='loginBt']"</span>).click()</span><br><span class="line"># 拿手机扫二维码！</span><br><span class="line"><span class="built_in">time</span>.sleep(<span class="number">15</span>)</span><br><span class="line">driver.get(<span class="string">'https://mp.weixin.qq.com/'</span>)</span><br><span class="line">cookie_items = driver.get_cookies()</span><br><span class="line"><span class="keyword">for</span> cookie_item <span class="built_in">in</span> cookie_items:</span><br><span class="line">    post[cookie_item[<span class="string">'name'</span>]] = cookie_item[<span class="string">'value'</span>]</span><br><span class="line">cookie_str = json.dumps(post)</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'cookie.txt'</span>, <span class="string">'w+'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(cookie_str)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import requests</span><br><span class="line">import redis</span><br><span class="line">import json</span><br><span class="line">import re</span><br><span class="line">import random</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line">gzlist = [<span class="string">'yq_Butler'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">url = <span class="string">'https://mp.weixin.qq.com'</span></span><br><span class="line">header = &#123;</span><br><span class="line">    <span class="string">"HOST"</span>: <span class="string">"mp.weixin.qq.com"</span>,</span><br><span class="line">    <span class="string">"User-Agent"</span>: <span class="string">"Mozilla/5.0 (Windows NT 6.1; WOW64; rv:53.0) Gecko/20100101 Firefox/53.0"</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">with open(<span class="string">'cookie.txt'</span>, <span class="string">'r'</span>, <span class="attribute">encoding</span>=<span class="string">'utf-8'</span>) as f:</span><br><span class="line">    cookie = f.read()</span><br><span class="line">cookies = json.loads(cookie)</span><br><span class="line">response = requests.<span class="builtin-name">get</span>(<span class="attribute">url</span>=url, <span class="attribute">cookies</span>=cookies)</span><br><span class="line">token = re.findall(r<span class="string">'token=(\d+)'</span>, str(response.url))[0]</span><br><span class="line"><span class="keyword">for</span> query <span class="keyword">in</span> gzlist:</span><br><span class="line">    query_id = &#123;</span><br><span class="line">        <span class="string">'action'</span>: <span class="string">'search_biz'</span>,</span><br><span class="line">        <span class="string">'token'</span> : token,</span><br><span class="line">        <span class="string">'lang'</span>: <span class="string">'zh_CN'</span>,</span><br><span class="line">        <span class="string">'f'</span>: <span class="string">'json'</span>,</span><br><span class="line">        <span class="string">'ajax'</span>: <span class="string">'1'</span>,</span><br><span class="line">        <span class="string">'random'</span>: random.random(),</span><br><span class="line">        <span class="string">'query'</span>: query,</span><br><span class="line">        <span class="string">'begin'</span>: <span class="string">'0'</span>,</span><br><span class="line">        <span class="string">'count'</span>: <span class="string">'5'</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    search_url = <span class="string">'https://mp.weixin.qq.com/cgi-bin/searchbiz?'</span></span><br><span class="line">    search_response = requests.<span class="builtin-name">get</span>(search_url, <span class="attribute">cookies</span>=cookies, <span class="attribute">headers</span>=header, <span class="attribute">params</span>=query_id)</span><br><span class="line">    lists = search_response.json().<span class="builtin-name">get</span>(<span class="string">'list'</span>)[0]</span><br><span class="line">    fakeid = lists.<span class="builtin-name">get</span>(<span class="string">'fakeid'</span>)</span><br><span class="line">    query_id_data = &#123;</span><br><span class="line">        <span class="string">'token'</span>: token,</span><br><span class="line">        <span class="string">'lang'</span>: <span class="string">'zh_CN'</span>,</span><br><span class="line">        <span class="string">'f'</span>: <span class="string">'json'</span>,</span><br><span class="line">        <span class="string">'ajax'</span>: <span class="string">'1'</span>,</span><br><span class="line">        <span class="string">'random'</span>: random.random(),</span><br><span class="line">        <span class="string">'action'</span>: <span class="string">'list_ex'</span>,</span><br><span class="line">        <span class="string">'begin'</span>: <span class="string">'0'</span>,</span><br><span class="line">        <span class="string">'count'</span>: <span class="string">'5'</span>,</span><br><span class="line">        <span class="string">'query'</span>: <span class="string">''</span>,</span><br><span class="line">        <span class="string">'fakeid'</span>: fakeid,</span><br><span class="line">        <span class="string">'type'</span>: <span class="string">'9'</span></span><br><span class="line">    &#125;</span><br><span class="line">    appmsg_url = <span class="string">'https://mp.weixin.qq.com/cgi-bin/appmsg?'</span></span><br><span class="line">    appmsg_response = requests.<span class="builtin-name">get</span>(appmsg_url, <span class="attribute">cookies</span>=cookies, <span class="attribute">headers</span>=header, <span class="attribute">params</span>=query_id_data)</span><br><span class="line">    max_num = appmsg_response.json().<span class="builtin-name">get</span>(<span class="string">'app_msg_cnt'</span>)</span><br><span class="line">    num = int(int(max_num) / 5)</span><br><span class="line">    begin = 0</span><br><span class="line">    <span class="keyword">while</span> num + 1 &gt; 0 :</span><br><span class="line">        query_id_data = &#123;</span><br><span class="line">            <span class="string">'token'</span>: token,</span><br><span class="line">            <span class="string">'lang'</span>: <span class="string">'zh_CN'</span>,</span><br><span class="line">            <span class="string">'f'</span>: <span class="string">'json'</span>,</span><br><span class="line">            <span class="string">'ajax'</span>: <span class="string">'1'</span>,</span><br><span class="line">            <span class="string">'random'</span>: random.random(),</span><br><span class="line">            <span class="string">'action'</span>: <span class="string">'list_ex'</span>,</span><br><span class="line">            <span class="string">'begin'</span>: <span class="string">'&#123;&#125;'</span>.format(str(begin)),</span><br><span class="line">            <span class="string">'count'</span>: <span class="string">'5'</span>,</span><br><span class="line">            <span class="string">'query'</span>: <span class="string">''</span>,</span><br><span class="line">            <span class="string">'fakeid'</span>: fakeid,</span><br><span class="line">            <span class="string">'type'</span>: <span class="string">'9'</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="builtin-name">print</span>(<span class="string">'翻页###################'</span>,begin)</span><br><span class="line">        query_fakeid_response = requests.<span class="builtin-name">get</span>(appmsg_url, <span class="attribute">cookies</span>=cookies, <span class="attribute">headers</span>=header, <span class="attribute">params</span>=query_id_data)</span><br><span class="line">        fakeid_list = query_fakeid_response.json().<span class="builtin-name">get</span>(<span class="string">'app_msg_list'</span>)</span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> fakeid_list:</span><br><span class="line">            <span class="builtin-name">print</span>(item.<span class="builtin-name">get</span>(<span class="string">'link'</span>))</span><br><span class="line">        num -= 1</span><br><span class="line">        begin = int(begin)</span><br><span class="line">        begin+=5</span><br><span class="line">        time.sleep(2)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h1 id="以上完毕！这就是个测试、代码写得奇丑、各位将就着看啊！看不明白？没关系！看这儿：点我看视频"><a href="#以上完毕！这就是个测试、代码写得奇丑、各位将就着看啊！看不明白？没关系！看这儿：点我看视频" class="headerlink" title="以上完毕！这就是个测试、代码写得奇丑、各位将就着看啊！看不明白？没关系！看这儿：点我看视频"></a><strong>以上完毕！这就是个测试、代码写得奇丑、各位将就着看啊！看不明白？没关系！看这儿：<a href="http://www.bilibili.com/video/av11127609/" target="_blank" rel="noopener">点我看视频</a></strong></h1>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/哎哟卧槽" class="author" itemprop="url" rel="index">哎哟卧槽</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2017-06-07 09:44:51" itemprop="dateCreated datePublished" datetime="2017-06-07T09:44:51+08:00">2017-06-07</time>
                </span>
                <span id="/4652.html" class="post-meta-item leancloud_visitors" data-flag-title="利用新接口抓取微信公众号的所有文章" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>3.5k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>3 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/4607.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="静觅丨崔庆才的个人站点专业为您提供爬虫教程,爬虫,Python,Python爬虫,Python爬虫教程,爬虫书的相关信息，想要了解更多详情，请联系我们。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/4607.html" class="post-title-link" itemprop="url">获取知乎问题答案并转换为MarkDown文件</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <blockquote>
                    <h2 id="20170609-更新"><a href="#20170609-更新" class="headerlink" title="20170609 更新:"></a>20170609 更新:</h2>
                    <p><strong>感谢一介草民与 ftzz 的反馈</strong></p>
                    <h3 id="1-修复中文路径保存问题"><a href="#1-修复中文路径保存问题" class="headerlink" title="(1) 修复中文路径保存问题"></a>(1) 修复中文路径保存问题</h3>
                    <h3 id="2-修复-offset-问题"><a href="#2-修复-offset-问题" class="headerlink" title="(2) 修复 offset 问题"></a>(2) 修复 offset 问题</h3>
                    <h3 id="3-修复第一个问题"><a href="#3-修复第一个问题" class="headerlink" title="(3) 修复第一个问题"></a>(3) 修复第一个问题</h3>
                    <h2 id="来个好玩的东西"><a href="#来个好玩的东西" class="headerlink" title="来个好玩的东西"></a>来个好玩的东西</h2>
                    <h2 id=""><a href="#" class="headerlink" title="     "></a><a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/06/6f19c6ad326822c9e267d2d961cf1fec_r.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/06/6f19c6ad326822c9e267d2d961cf1fec_r.png" alt=""></a> <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/06/154e026013e7ec53e8ce94c8b4417973_r.jpeg" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/06/154e026013e7ec53e8ce94c8b4417973_r.jpeg" alt=""></a> <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/06/0838fb7d2c9d61070605148ab57f90cb_r.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/06/0838fb7d2c9d61070605148ab57f90cb_r.png" alt=""></a> <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/06/a1e43e58c01f1e36630f4a1394811b67_r.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/06/a1e43e58c01f1e36630f4a1394811b67_r.png" alt=""></a> <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/06/d851605dddb3e14ad9946a3eccc0ae05_r.jpeg" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/06/d851605dddb3e14ad9946a3eccc0ae05_r.jpeg" alt=""></a> <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/06/f8acc0c27d15fcfd8b2c9682aabe6633_r.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/06/f8acc0c27d15fcfd8b2c9682aabe6633_r.png" alt=""></a></h2>
                    <h2 id="20170607-更新"><a href="#20170607-更新" class="headerlink" title="20170607 更新:"></a>20170607 更新:</h2>
                    <h3 id="1-感谢-Ftzz-提醒-将图片替换为原图"><a href="#1-感谢-Ftzz-提醒-将图片替换为原图" class="headerlink" title="(1) 感谢 Ftzz 提醒, 将图片替换为原图"></a>(1) 感谢 Ftzz 提醒, 将图片替换为原图</h3>
                    <h3 id="2-将文件保存到本地-解决了最大的缺点问题-不用联网也可以看了"><a href="#2-将文件保存到本地-解决了最大的缺点问题-不用联网也可以看了" class="headerlink" title="(2) 将文件保存到本地,解决了最大的缺点问题,不用联网也可以看了"></a>(2) 将文件保存到本地,解决了最大的缺点问题,不用联网也可以看了</h3>
                  </blockquote>
                  <p>大家好，我是四毛。 <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/02/QQ图片20170205084843.jpg" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/02/QQ图片20170205084843.jpg" alt=""></a> <strong>写在前面的话</strong> 在开始前，给大家分享一个前段时间逛 Github 时看到的某个爬虫脚本中的内容： <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/06/lvshi.jpg" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/06/lvshi.jpg" alt=""></a> 所以，大家爬网站的时候，还是友善一点为好，且爬且珍惜啊。 好了，言归正传。 今天主要讲一下如何将某一个知乎问题的所有答案转换为本地 MarkDown 文件。</p>
                  <h2 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h2>
                  <blockquote>
                    <p>python2.7 html2text markdownpad(这里随意，只要可以支持 md 就行) 会抓包。。。。。 最重要的是你要有代理，因为知乎开始封 IP 了</p>
                  </blockquote>
                  <h2 id="1-什么是-MarkDown-文件"><a href="#1-什么是-MarkDown-文件" class="headerlink" title="1.什么是 MarkDown 文件"></a><strong>1.什么是 MarkDown 文件</strong></h2>
                  <p>Markdown 是一种用来写作的轻量级<strong>「标记语言」</strong>，它用简洁的语法代替排版，而不像一般我们用的字处理软件 <em>Word</em> 或 <em>Pages</em> 有大量的排版、字体设置。它使我们专心于码字，用「标记」语法，来代替常见的排版格式。例如此文从内容到格式，甚至插图，键盘就可以通通搞定了。 恩，上面是我抄的，哈哈。想多了解的可以看看<a href="http://www.jianshu.com/p/1e402922ee32/" target="_blank" rel="noopener">这里</a>。</p>
                  <h2 id="2-为什么要将答案转为-MarkDwon"><a href="#2-为什么要将答案转为-MarkDwon" class="headerlink" title="2.为什么要将答案转为 MarkDwon"></a><strong>2.为什么要将答案转为 MarkDwon</strong></h2>
                  <p>因为。。。。。。懒，哈哈，开个玩笑。最重要的原因还是 markdown 看着比较舒服。平时写脚本的时候，也一直在思考一个问题，如何将一个文字与图片穿插的网页原始的保存下来呢。如果借助工具的话，那就很多了，CTRL+P 打印的时候，选择另存为 PDF，或者搞个印象笔记，直接保存整个网页。那么，我们如何用爬虫实现呢？正好前几天看到了<a href="https://github.com/egrcc/zhihu-python" target="_blank" rel="noopener">这个项目</a>，仔细研究了一下，大受启发。</p>
                  <h2 id="3-原理"><a href="#3-原理" class="headerlink" title="3.原理"></a><strong>3.原理</strong></h2>
                  <p>原理说起来很简单：获取请求到的内容的 BODY 部分，然后重新构建一个 HTML 文件，接着利用 html2text 这个模块将其转换为 markdown 文件，最后对图片及标题按照 markdown 的格式做一些处理就好了。目前应用的场景主要是在知乎。</p>
                  <h2 id="4-Show-Code"><a href="#4-Show-Code" class="headerlink" title="4.Show Code"></a><strong>4.Show Code</strong></h2>
                  <h3 id="4-1-获取知乎答案"><a href="#4-1-获取知乎答案" class="headerlink" title="4.1 获取知乎答案"></a>4.1 获取知乎答案</h3>
                  <p>写代码的时候，主要考虑了两种使用场景。第一，获取某一特定答案的数据然后进行转换；第二，获取某一个问题的所有答案进行然后挨个进行转换，在这里可以 通过赞同数来对要获取的答案进行质量控制。 <strong> 4.1.1、某一个特定答案的数据获取</strong></p>
                  <blockquote>
                    <p>url：<a href="https://www.zhihu.com/question/27621722/answer/48658220（前面那个是问题ID，后边的是答案ID）" target="_blank" rel="noopener">https://www.zhihu.com/question/27621722/answer/48658220（前面那个是问题ID，后边的是答案ID）</a></p>
                  </blockquote>
                  <p>这一数据的获取我这里分为了两个部分，第一部分请求上述网址，拿到答案主体数据以及赞同数，第二部分请求下面这个接口：</p>
                  <blockquote>
                    <p><a href="https://www.zhihu.com/api/v4/answers/48658220" target="_blank" rel="noopener">https://www.zhihu.com/api/v4/answers/48658220</a></p>
                  </blockquote>
                  <p>为什么会这样？因为这个接口得到的答案正文数据不是完整数据，所以只能分两步了。 <strong> 4.1.2、某一个特定答案的数据获取</strong> 这一个数据就可以通过很简单的方式得到了，接口如下：</p>
                  <blockquote>
                    <p><a href="https://www.zhihu.com/api/v4/questions/27621722/answers?sort_by=default&amp;include=data%5B%2A%5D.is_normal%2Cis_collapsed%2Ccollapse_reason%2Cis_sticky%2Ccollapsed_by%2Csuggest_edit%2Ccomment_count%2Ccan_comment%2Ccontent%2Ceditable_content%2Cvoteup_count%2Creshipment_settings%2Ccomment_permission%2Cmark_infos%2Ccreated_time%2Cupdated_time%2Crelationship.is_authorized%2Cis_author%2Cvoting%2Cis_thanked%2Cis_nothelp%2Cupvoted_followees%3Bdata%5B%2A%5D.author.follower_count%2Cbadge%5B%3F%28type%3Dbest_answerer%29%5D.topics&amp;limit=20&amp;offset=3" target="_blank" rel="noopener">https://www.zhihu.com/api/v4/questions/27621722/answers?sort_by=default&amp;include=data%5B%2A%5D.is_normal%2Cis_collapsed%2Ccollapse_reason%2Cis_sticky%2Ccollapsed_by%2Csuggest_edit%2Ccomment_count%2Ccan_comment%2Ccontent%2Ceditable_content%2Cvoteup_count%2Creshipment_settings%2Ccomment_permission%2Cmark_infos%2Ccreated_time%2Cupdated_time%2Crelationship.is_authorized%2Cis_author%2Cvoting%2Cis_thanked%2Cis_nothelp%2Cupvoted_followees%3Bdata%5B%2A%5D.author.follower_count%2Cbadge%5B%3F%28type%3Dbest_answerer%29%5D.topics&amp;limit=20&amp;offset=3</a></p>
                  </blockquote>
                  <p>返回的都是 JSON 数据，很方便获取。但是这里有一个地方需要注意，从这里面取的答案正文数据就是文本数据，不是一个完整的 html 文件，所以需要在构造一下。 <strong> 4.1.2、保存的字段</strong></p>
                  <blockquote>
                    <p>author_name 回答用户名 answer_id 答案 ID question_id 问题 ID question_title 问题 vote_up_count 赞同数 create_time 创建时间 答案主体</p>
                  </blockquote>
                  <h3 id="4-2-Code"><a href="#4-2-Code" class="headerlink" title="4.2 Code"></a>4.2 Code</h3>
                  <p>主脚本：zhihu.py</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># Created by shimeng on 17-6-5</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> html2text</span><br><span class="line"><span class="keyword">from</span> parse_content <span class="keyword">import</span> parse</span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">just for study and fun</span></span><br><span class="line"><span class="string">Talk is cheap</span></span><br><span class="line"><span class="string">show me your code</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ZhiHu</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">         self.request_content = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">request</span><span class="params">(self, url, retry_times=<span class="number">10</span>)</span>:</span></span><br><span class="line">        header = &#123;</span><br><span class="line">            <span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/57.0.2987.133 Safari/537.36'</span>,</span><br><span class="line">            <span class="string">'authorization'</span>: <span class="string">'oauth c3cef7c66a1843f8b3a9e6a1e3160e20'</span>,</span><br><span class="line">            <span class="string">'Host'</span>: <span class="string">'www.zhihu.com'</span></span><br><span class="line">        &#125;</span><br><span class="line">        times = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> retry_times&gt;<span class="number">0</span>:</span><br><span class="line">            times += <span class="number">1</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">'request %s, times: %d'</span> %(url, times)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                ip = <span class="string">'your proxy ip'</span></span><br><span class="line">                <span class="keyword">if</span> ip:</span><br><span class="line">                    proxy = &#123;</span><br><span class="line">                        <span class="string">'http'</span>: <span class="string">'http://%s'</span> % ip,</span><br><span class="line">                        <span class="string">'https'</span>: <span class="string">'http://%s'</span> % ip</span><br><span class="line">                    &#125;</span><br><span class="line">                    self.request_content = requests.get(url, headers=header, proxies=proxy, timeout=<span class="number">10</span>).content</span><br><span class="line">            <span class="keyword">except</span> Exception, e:</span><br><span class="line">                <span class="keyword">print</span> e</span><br><span class="line">                retry_times -= <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> self.request_content</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_all_answer_content</span><span class="params">(self, question_id, flag=<span class="number">2</span>)</span>:</span></span><br><span class="line">        first_url_format = <span class="string">'https://www.zhihu.com/api/v4/questions/&#123;&#125;/answers?sort_by=default&amp;include=data%5B%2A%5D.is_normal%2Cis_collapsed%2Ccollapse_reason%2Cis_sticky%2Ccollapsed_by%2Csuggest_edit%2Ccomment_count%2Ccan_comment%2Ccontent%2Ceditable_content%2Cvoteup_count%2Creshipment_settings%2Ccomment_permission%2Cmark_infos%2Ccreated_time%2Cupdated_time%2Crelationship.is_authorized%2Cis_author%2Cvoting%2Cis_thanked%2Cis_nothelp%2Cupvoted_followees%3Bdata%5B%2A%5D.author.follower_count%2Cbadge%5B%3F%28type%3Dbest_answerer%29%5D.topics&amp;limit=20&amp;offset=3'</span></span><br><span class="line">        first_url = first_url_format.format(question_id)</span><br><span class="line">        response = self.request(first_url)</span><br><span class="line">        <span class="keyword">if</span> response:</span><br><span class="line">            contents = json.loads(response)</span><br><span class="line">            <span class="keyword">print</span> contents.get(<span class="string">'paging'</span>).get(<span class="string">'is_end'</span>)</span><br><span class="line">            <span class="keyword">while</span> <span class="keyword">not</span> contents.get(<span class="string">'paging'</span>).get(<span class="string">'is_end'</span>):</span><br><span class="line">                <span class="keyword">for</span> content <span class="keyword">in</span> contents.get(<span class="string">'data'</span>):</span><br><span class="line">                    self.parse_content(content, flag)</span><br><span class="line">                next_page_url = contents.get(<span class="string">'paging'</span>).get(<span class="string">'next'</span>).replace(<span class="string">'http'</span>, <span class="string">'https'</span>)</span><br><span class="line">                contents = json.loads(self.request(next_page_url))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">'request failed, quit......'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_single_answer_content</span><span class="params">(self, answer_url, flag=<span class="number">1</span>)</span>:</span></span><br><span class="line">        all_content = &#123;&#125;</span><br><span class="line">        question_id, answer_id = re.findall(<span class="string">'https://www.zhihu.com/question/(\d+)/answer/(\d+)'</span>, answer_url)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        html_content = self.request(answer_url)</span><br><span class="line">        <span class="keyword">if</span> html_content:</span><br><span class="line">            all_content[<span class="string">'main_content'</span>] = html_content</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span>  ValueError(<span class="string">'request failed, quit......'</span>)</span><br><span class="line"></span><br><span class="line">        ajax_answer_url = <span class="string">'https://www.zhihu.com/api/v4/answers/&#123;&#125;'</span>.format(answer_id)</span><br><span class="line">        ajax_content = self.request(ajax_answer_url)</span><br><span class="line">        <span class="keyword">if</span> ajax_content:</span><br><span class="line">            all_content[<span class="string">'ajax_content'</span>] = json.loads(ajax_content)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span>  ValueError(<span class="string">'request failed, quit......'</span>)</span><br><span class="line"></span><br><span class="line">        self.parse_content(all_content, flag, )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse_content</span><span class="params">(self, content, flag=None)</span>:</span></span><br><span class="line">        data = parse(content, flag)</span><br><span class="line">        self.transform_to_markdown(data)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">transform_to_markdown</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        content = data[<span class="string">'content'</span>]</span><br><span class="line">        author_name = data[<span class="string">'author_name'</span>]</span><br><span class="line">        answer_id = data[<span class="string">'answer_id'</span>]</span><br><span class="line">        question_id = data[<span class="string">'question_id'</span>]</span><br><span class="line">        question_title = data[<span class="string">'question_title'</span>]</span><br><span class="line">        vote_up_count = data[<span class="string">'vote_up_count'</span>]</span><br><span class="line">        create_time = data[<span class="string">'create_time'</span>]</span><br><span class="line"></span><br><span class="line">        file_name = <span class="string">u'%s--%s的回答[%d].md'</span> % (question_title, author_name,answer_id)</span><br><span class="line">        folder_name = <span class="string">u'%s'</span> % (question_title)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(os.path.join(os.getcwd(),folder_name)):</span><br><span class="line">            os.mkdir(folder_name)</span><br><span class="line">        os.chdir(folder_name)</span><br><span class="line"></span><br><span class="line">        f = open(file_name, <span class="string">"wt"</span>)</span><br><span class="line">        f.write(<span class="string">"-"</span> * <span class="number">40</span> + <span class="string">"\n"</span>)</span><br><span class="line">        origin_url = <span class="string">'https://www.zhihu.com/question/&#123;&#125;/answer/&#123;&#125;'</span>.format(question_id, answer_id)</span><br><span class="line">        f.write(<span class="string">"## 本答案原始链接: "</span> + origin_url + <span class="string">"\n"</span>)</span><br><span class="line">        f.write(<span class="string">"### question_title: "</span> + question_title.encode(<span class="string">'utf-8'</span>) + <span class="string">"\n"</span>)</span><br><span class="line">        f.write(<span class="string">"### Author_Name: "</span> + author_name.encode(<span class="string">'utf-8'</span>) + <span class="string">"\n"</span>)</span><br><span class="line">        f.write(<span class="string">"### Answer_ID: %d"</span> % answer_id + <span class="string">"\n"</span>)</span><br><span class="line">        f.write(<span class="string">"### Question_ID %d: "</span> % question_id + <span class="string">"\n"</span>)</span><br><span class="line">        f.write(<span class="string">"### VoteCount: %s"</span> % vote_up_count + <span class="string">"\n"</span>)</span><br><span class="line">        f.write(<span class="string">"### Create_Time: "</span> + create_time + <span class="string">"\n"</span>)</span><br><span class="line">        f.write(<span class="string">"-"</span> * <span class="number">40</span> + <span class="string">"\n"</span>)</span><br><span class="line"></span><br><span class="line">        text = html2text.html2text(content.decode(<span class="string">'utf-8'</span>)).encode(<span class="string">"utf-8"</span>)</span><br><span class="line">        <span class="comment"># 标题</span></span><br><span class="line">        r = re.findall(<span class="string">r'**(.*?)**'</span>, text, re.S)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> r:</span><br><span class="line">            <span class="keyword">if</span> i != <span class="string">" "</span>:</span><br><span class="line">                text = text.replace(i, i.strip())</span><br><span class="line"></span><br><span class="line">        r = re.findall(<span class="string">r'_(.*)_'</span>, text)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> r:</span><br><span class="line">            <span class="keyword">if</span> i != <span class="string">" "</span>:</span><br><span class="line">                text = text.replace(i, i.strip())</span><br><span class="line">        text = text.replace(<span class="string">'_ _'</span>, <span class="string">''</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 图片</span></span><br><span class="line">        r = re.findall(<span class="string">r'![]\((?:.*?)\)'</span>, text)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> r:</span><br><span class="line">            text = text.replace(i, i + <span class="string">"\n\n"</span>)</span><br><span class="line"></span><br><span class="line">        f.write(text)</span><br><span class="line"></span><br><span class="line">        f.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    zhihu = ZhiHu()</span><br><span class="line">    url = <span class="string">'https://www.zhihu.com/question/27621722/answer/105331078'</span></span><br><span class="line">    zhihu.get_single_answer_content(url)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># question_id = '27621722'</span></span><br><span class="line">    <span class="comment"># zhihu.get_all_answer_content(question_id)</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>zhihu.py 为主脚本，内容很简单，发起请求，调用解析函数进行解析，最后再进行保存。 解析函数脚本：parse_content.py</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># Created by shimeng on 17-6-5</span></span><br><span class="line">import time</span><br><span class="line"><span class="keyword">from</span> bs4 import BeautifulSoup</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def html_template(data):</span><br><span class="line">    # api content</span><br><span class="line">    html = <span class="string">''</span><span class="string">'</span></span><br><span class="line"><span class="string">        &lt;html&gt;</span></span><br><span class="line"><span class="string">        &lt;head&gt;</span></span><br><span class="line"><span class="string">        &lt;body&gt;</span></span><br><span class="line"><span class="string">        %s</span></span><br><span class="line"><span class="string">        &lt;/body&gt;</span></span><br><span class="line"><span class="string">        &lt;/head&gt;</span></span><br><span class="line"><span class="string">        &lt;/html&gt;</span></span><br><span class="line"><span class="string">        '</span><span class="string">''</span> % data</span><br><span class="line">    return html</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def parse(content, <span class="attribute">flag</span>=None):</span><br><span class="line">    data = &#123;&#125;</span><br><span class="line">    <span class="keyword">if</span> flag == 1:</span><br><span class="line">        # single</span><br><span class="line">        main_content = content.<span class="builtin-name">get</span>(<span class="string">'main_content'</span>)</span><br><span class="line">        ajax_content = content.<span class="builtin-name">get</span>(<span class="string">'ajax_content'</span>)</span><br><span class="line"></span><br><span class="line">        soup = BeautifulSoup(main_content.decode(<span class="string">"utf-8"</span>), <span class="string">"lxml"</span>)</span><br><span class="line">        answer = soup.<span class="builtin-name">find</span>(<span class="string">"span"</span>, <span class="attribute">class_</span>=<span class="string">"RichText CopyrightRichText-richText"</span>)</span><br><span class="line"></span><br><span class="line">        author_name = ajax_content.<span class="builtin-name">get</span>(<span class="string">'author'</span>).<span class="builtin-name">get</span>(<span class="string">'name'</span>)</span><br><span class="line">        answer_id = ajax_content.<span class="builtin-name">get</span>(<span class="string">'id'</span>)</span><br><span class="line">        question_id = ajax_content.<span class="builtin-name">get</span>(<span class="string">'question'</span>).<span class="builtin-name">get</span>(<span class="string">'id'</span>)</span><br><span class="line">        question_title = ajax_content.<span class="builtin-name">get</span>(<span class="string">'question'</span>).<span class="builtin-name">get</span>(<span class="string">'title'</span>)</span><br><span class="line">        vote_up_count = soup.<span class="builtin-name">find</span>(<span class="string">"meta"</span>, <span class="attribute">itemprop</span>=<span class="string">"upvoteCount"</span>)[<span class="string">"content"</span>]</span><br><span class="line">        create_time = time.strftime(<span class="string">"%Y-%m-%d %H:%M:%S"</span>, time.localtime(ajax_content.<span class="builtin-name">get</span>(<span class="string">'created_time'</span>)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        # all</span><br><span class="line">        answer_content = content.<span class="builtin-name">get</span>(<span class="string">'content'</span>)</span><br><span class="line"></span><br><span class="line">        author_name = content.<span class="builtin-name">get</span>(<span class="string">'author'</span>).<span class="builtin-name">get</span>(<span class="string">'name'</span>)</span><br><span class="line">        answer_id = content.<span class="builtin-name">get</span>(<span class="string">'id'</span>)</span><br><span class="line">        question_id = content.<span class="builtin-name">get</span>(<span class="string">'question'</span>).<span class="builtin-name">get</span>(<span class="string">'id'</span>)</span><br><span class="line">        question_title = content.<span class="builtin-name">get</span>(<span class="string">'question'</span>).<span class="builtin-name">get</span>(<span class="string">'title'</span>)</span><br><span class="line">        vote_up_count = content.<span class="builtin-name">get</span>(<span class="string">'voteup_count'</span>)</span><br><span class="line">        create_time = time.strftime(<span class="string">"%Y-%m-%d %H:%M:%S"</span>, time.localtime(content.<span class="builtin-name">get</span>(<span class="string">'created_time'</span>)))</span><br><span class="line"></span><br><span class="line">        content = html_template(answer_content)</span><br><span class="line">        soup = BeautifulSoup(content, <span class="string">'lxml'</span>)</span><br><span class="line">        answer = soup.<span class="builtin-name">find</span>(<span class="string">"body"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="builtin-name">print</span> author_name,answer_id,question_id,question_title,vote_up_count,create_time</span><br><span class="line">    # 这里非原创，看了别人的代码，修改了一下</span><br><span class="line">    soup.body.extract()</span><br><span class="line">    soup.head.insert_after(soup.new_tag(<span class="string">"body"</span>, **&#123;<span class="string">'class'</span>: <span class="string">'zhi'</span>&#125;))</span><br><span class="line"></span><br><span class="line">    soup.body.append(answer)</span><br><span class="line"></span><br><span class="line">    img_list = soup.find_all(<span class="string">"img"</span>, <span class="attribute">class_</span>=<span class="string">"content_image lazy"</span>)</span><br><span class="line">    <span class="keyword">for</span> img <span class="keyword">in</span> img_list:</span><br><span class="line">        img[<span class="string">"src"</span>] = img[<span class="string">"data-actualsrc"</span>]</span><br><span class="line">    img_list = soup.find_all(<span class="string">"img"</span>, <span class="attribute">class_</span>=<span class="string">"origin_image zh-lightbox-thumb lazy"</span>)</span><br><span class="line">    <span class="keyword">for</span> img <span class="keyword">in</span> img_list:</span><br><span class="line">        img[<span class="string">"src"</span>] = img[<span class="string">"data-actualsrc"</span>]</span><br><span class="line">    noscript_list = soup.find_all(<span class="string">"noscript"</span>)</span><br><span class="line">    <span class="keyword">for</span> noscript <span class="keyword">in</span> noscript_list:</span><br><span class="line">        noscript.extract()</span><br><span class="line"></span><br><span class="line">    data[<span class="string">'content'</span>] = soup</span><br><span class="line">    data[<span class="string">'author_name'</span>] = author_name</span><br><span class="line">    data[<span class="string">'answer_id'</span>] = answer_id</span><br><span class="line">    data[<span class="string">'question_id'</span>] = question_id</span><br><span class="line">    data[<span class="string">'question_title'</span>] = question_title</span><br><span class="line">    data[<span class="string">'vote_up_count'</span>] = vote_up_count</span><br><span class="line">    data[<span class="string">'create_time'</span>] = create_time</span><br><span class="line"></span><br><span class="line">    return data</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>parse_content.py 主要负责构造新的 html，然后对其进行解析，获取数据。</p>
                  <h2 id="5-测试结果展示"><a href="#5-测试结果展示" class="headerlink" title="5.测试结果展示"></a><strong>5.测试结果展示</strong></h2>
                  <p><a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/06/result.jpg" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/06/result.jpg" alt=""></a> <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/06/result_2.jpg" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/06/result_2.jpg" alt=""></a> 恩，下面还有，就不截图了。</p>
                  <h2 id="6-缺点与不足"><a href="#6-缺点与不足" class="headerlink" title="6.缺点与不足"></a><strong>6.缺点与不足</strong></h2>
                  <p>下面聊一聊这种方法的缺点： 这种方法的最大缺点就是：</p>
                  <h1 id="一定要联网！"><a href="#一定要联网！" class="headerlink" title="一定要联网！"></a>一定要联网！</h1>
                  <h1 id="一定要联网！-1"><a href="#一定要联网！-1" class="headerlink" title="一定要联网！"></a>一定要联网！</h1>
                  <h1 id="一定要联网！-2"><a href="#一定要联网！-2" class="headerlink" title="一定要联网！"></a>一定要联网！</h1>
                  <p>因为。。。。。。 在 md 文件中我们只是写了个图片的网址，这就意味着 markdown 的编辑器帮我们去存放图片的服务器上对这个图片进行了获取，所以断网也就意味着你看不到图片了；同时也意味着如果用户删除了这张图片，你也就看不到了。 但是，后来我又发现在 markdownpad 中将文件导出为 html 时，即使是断网了，依然可以看到全部的内容，包括图片，所以如果你真的喜欢某一个答案，保存到印象笔记肯定是不错的选择，PDF 直接保存也不错，如果是使用了这个方法，记得转为 html 最好。 还有一个缺点就是 html2text 转换过后的效果其实并不是特别好，还是需要后期在进行处理的。</p>
                  <h2 id="7-总结"><a href="#7-总结" class="headerlink" title="7.总结"></a><strong>7.总结</strong></h2>
                  <p>代码还有很多可以改进之处，欢迎大家与我交流：QQ:549411552 （注明来自静觅） 国际惯例：<a href="https://github.com/xiaosimao/transfrom_zhihu_answer_to_md" target="_blank" rel="noopener">代码在这</a> 收工。</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/四毛" class="author" itemprop="url" rel="index">四毛</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2017-06-05 23:50:07" itemprop="dateCreated datePublished" datetime="2017-06-05T23:50:07+08:00">2017-06-05</time>
                </span>
                <span id="/4607.html" class="post-meta-item leancloud_visitors" data-flag-title="获取知乎问题答案并转换为MarkDown文件" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>9.1k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>8 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/4596.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="静觅丨崔庆才的个人站点专业为您提供爬虫教程,爬虫,Python,Python爬虫,Python爬虫教程,爬虫书的相关信息，想要了解更多详情，请联系我们。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/4596.html" class="post-title-link" itemprop="url">使用Tornado+Redis维护ADSL拨号服务器代理池</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>我们尝试维护过一个免费的代理池，但是代理池效果用过就知道了，毕竟里面有大量免费代理，虽然这些代理是可用的，但是既然我们能刷到这个免费代理，别人也能呀，所以就导致这个代理同时被很多人使用来抓取网站，所以当我们兴致勃勃地拿他来抓取某个网站的时候，会发现它还是被网站封禁的状态，所以在某些情况下免费代理池的成功率还是比较低的。 当然我们也可以去购买一些代理，比如几块钱提取几百几千个的代理，然而经过测试后质量也是很一般，也可以去购买专线代理，不过价格也是不菲的。那么目前最稳定而且又保证可用的代理方法就是设置ADSL拨号代理了。 本篇来讲解一下ADSL拨号代理服务器的相关设置。</p>
                  <h2 id="什么是ADSL"><a href="#什么是ADSL" class="headerlink" title="什么是ADSL"></a>什么是ADSL</h2>
                  <p>大家可能对ADSL比较陌生，ADSL全称叫做Asymmetric Digital Subscriber Line，非对称数字用户环路，因为它的上行和下行带宽不对称。它采用频分复用技术把普通的电话线分成了电话、上行和下行三个相对独立的信道，从而避免了相互之间的干扰。 有种主机叫做动态拨号VPS主机，这种主机在连接上网的时候是需要拨号的，只有拨号成功后才可以上网，每拨一次号，主机就会获取一个新的IP，也就是它的IP并不是固定的，而且IP量特别大，几乎不会拨到相同的IP，如果我们用它来搭建代理，既能保证高度可用，又可以自由控制拨号切换。 经测试发现这也是最稳定最有效的代理方式，本节详细介绍一下ADSL拨号代理服务器的搭建方法。</p>
                  <h2 id="购买动态拨号VPS主机"><a href="#购买动态拨号VPS主机" class="headerlink" title="购买动态拨号VPS主机"></a>购买动态拨号VPS主机</h2>
                  <p>所以在开始之前，我们需要先购买一台动态拨号VPS主机，这样的主机在百度搜索一下，服务商还是相当多的，在这里推荐一家<a href="http://www.yunlifang.cn/dynamicvps.asp" target="_blank" rel="noopener">云立方</a>，感觉还是比较良心的，非广告。 配置的话可以自行选择，看下带宽是否可以满足需求就好了。 购买完成之后，就需要安装操作系统了，进入拨号主机的后台，首先预装一个操作系统。 <img src="https://blog-10039692.file.myqcloud.com/1495175818199_5646_1495175827700.jpg" alt=""> 在这里推荐安装CentOS7系统。 然后找到远程管理面板找到远程连接的用户名和密码，也就是SSH远程连接服务器的信息。 比如我这边的IP端口分别是 153.36.65.214:20063，用户名是root。 命令行下输入：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">ssh <span class="symbol">root@</span><span class="number">153.36</span><span class="number">.65</span><span class="number">.214</span> -p <span class="number">20063</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p> 然后输入管理密码，就可以连接上远程服务器了。 进入之后，可以发现有一个可用的脚本文件，叫做ppp.sh，这是拨号初始化的脚本，运行它会让我们输入拨号的用户名和密码，然后它就会开始各种拨号配置，一次配置成功，后面的拨号就不需要重复输入用户名和密码了。 运行ppp.sh脚本，输入用户名密码等待它的配置完成。 <img src="https://blog-10039692.file.myqcloud.com/1495175987975_6876_1495175998841.jpg" alt=""> 都提示成功之后就可以进行拨号了。 在拨号之前如果我们测试ping任何网站都是不通的，因为当前网络还没联通，输入拨号命令：</p>
                  <figure class="highlight crmsh">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">adsl-<span class="literal">start</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可以发现拨号命令成功运行，没有任何报错信息，这就证明拨号成功完成了，耗时约几秒钟。接下来如果再去ping外网就可以通了。 如果要停止拨号可以输入：</p>
                  <figure class="highlight arduino">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">adsl-<span class="built_in">stop</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>停止之后，可以发现又连不通网络了。</p>
                  <p>所以只有拨号之后才可以建立网络连接。 <img src="https://blog-10039692.file.myqcloud.com/1495176020258_290_1495176022867.jpg" alt=""> 所以断线重播的命令就是二者组合起来，先执行<code>adsl-stop</code>再执行<code>adsl-start</code>，每拨一次号，<code>ifocnfig</code>命令观察一下主机的IP，发现主机的IP一直是在变化的，网卡名称叫做ppp0。 <img src="https://blog-10039692.file.myqcloud.com/1495176189060_6947_1495176191282.jpg" alt=""> 所以，到这里我们就可以知道它作为代理服务器的巨大优势了，如果将这台主机作为代理服务器，如果我们一直拨号换IP，就不怕遇到IP被封的情况了，即使某个IP被封了，重新拨一次号就好了。 所以接下来我们要做的就有两件事，一是怎样将主机设置为代理服务器，二是怎样实时获取拨号主机的IP。</p>
                  <h2 id="设置代理服务器"><a href="#设置代理服务器" class="headerlink" title="设置代理服务器"></a>设置代理服务器</h2>
                  <p>之前我们经常听说代理服务器，也设置过不少代理了，但是可能没有自己设置吧，自己有一台主机怎样设置为代理服务器呢？接下来我们就亲自试验下怎样搭建HTTP代理服务器。 在Linux下搭建HTTP代理服务器，推荐TinyProxy和Squid，配置都非常简单，在这里我们以TinyProxy为例来讲解一下怎样搭建代理服务器。</p>
                  <h3 id="安装TinyProxy"><a href="#安装TinyProxy" class="headerlink" title="安装TinyProxy"></a>安装TinyProxy</h3>
                  <p>当然第一步就是安装TinyProxy这个软件了，在这里我使用的系统是CentOS，所以使用yum来安装，如果是其他系统如Ubuntu可以选择apt-get等命令安装，都是类似的。 命令行执行yum安装指令：</p>
                  <figure class="highlight sql">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">yum <span class="keyword">install</span> -y epel-<span class="keyword">release</span></span><br><span class="line">yum <span class="keyword">update</span> -y</span><br><span class="line">yum <span class="keyword">install</span> -y tinyproxy</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行完成之后就可以完成tinyproxy的安装了。</p>
                  <h3 id="配置TinyProxy"><a href="#配置TinyProxy" class="headerlink" title="配置TinyProxy"></a>配置TinyProxy</h3>
                  <p>安装完成之后还需要配置一下TinyProxy才可以用作代理服务器，需要编辑配置文件，它一般的路径是<code>/etc/tinyproxy/tinyproxy.conf</code>。 可以看到有一行</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">Port <span class="number">8888</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在这里可以设置代理的端口，默认是8888。 然后继续向下找，有这么一行</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">Allow <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这是被允许连接的主机的IP，如果想任何主机都可以连接，那就直接将它注释即可，所以在这里我们选择直接注释，也就是任何主机都可以使用这台主机作为代理服务器了。 修改为</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"># Allow <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>设置完成之后重启TinyProxy即可。</p>
                  <figure class="highlight crmsh">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">service tinyproxy <span class="literal">start</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>验证TinyProxy 好了，这样我们就成功搭建好代理服务器了，首先<code>ifconfig</code>查看下当前主机的IP，比如当前我的主机拨号IP为<code>112.84.118.216</code>，在其他的主机运行测试一下。 比如用curl命令设置代理请求一下httpbin，检测下代理是否生效。</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">curl -x <span class="number">112.84</span><span class="number">.118</span><span class="number">.216</span>:<span class="number">8888</span> httpbin.org/<span class="keyword">get</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p><img src="https://blog-10039692.file.myqcloud.com/1495176207822_2326_1495176209195.jpg" alt=""> 如果有正常的结果输出并且origin的值为代理IP的地址，就证明TinyProxy配置成功了。 好，那到现在，我们接下来要做的就是需要动态实时获取主机的IP了。</p>
                  <h2 id="动态获取IP"><a href="#动态获取IP" class="headerlink" title="动态获取IP"></a>动态获取IP</h2>
                  <p>真正的好戏才开始呢，我们怎样动态获取主机的IP呢？可能你首先想到的是DDNS也就是动态域名解析服务，我们需要使用一个域名来解析，也就是虽然IP是变的，但域名解析的地址可以随着IP的变化而变化。 它的原理其实是拨号主机向固定的服务器发出请求，服务器获取客户端的IP，然后再将域名解析到这个IP上就可以了。 国内比较有名的服务就是<a href="http://hsk.oray.com/" target="_blank" rel="noopener">花生壳</a>了，也提供了免费版的动态域名解析，另外DNSPOD也提供了解析接口来动态修改域名解析设置，<a href="https://www.dnspod.cn/docs/records.html#dns" target="_blank" rel="noopener">DNSPOD</a>，但是这样的方式都有一个通病，那就是慢！ 原因在于DNS修改后到完全生效是需要一定时间的，所以如果在前一秒拨号了，这一秒的域名解析的可能还是原来的IP，时间长的话可能需要几分钟，也就是说这段时间内，服务器IP已经变了，但是域名还是上一次拨号的IP，所以代理是不能用的，对于爬虫这种秒级响应的需求，是完全不能接受的。 所以根据花生壳的原理，可以完全自己实现一下动态获取IP的方法。 所以本节重点介绍的就是怎样来实现实时获取拨号主机IP的方法。 要实现这个需要两台主机，一台主机就是这台动态拨号VPS主机，另一台是具有固定公网IP的主机。动态VPS主机拨号成功之后就请求远程的固定主机，远程主机获取动态VPS主机的IP，就可以得到这个代理，将代理保存下来，这样拨号主机每拨号一次，远程主机就会及时得到拨号主机的IP，如果有多台拨号VPS，也统一发送到远程主机，这样我们只需要从远程主机取下代理就好了，保准是实时可用，稳定高效的。 整体思路大体是这样子，当然为了更完善一下，我们要做到如下功能： 远程主机：</p>
                  <ul>
                    <li>监听主机请求，获取动态VPS主机IP</li>
                    <li>将VPS主机IP记录下来存入数据库，支持多个客户端</li>
                    <li>检测当前接收到的IP可用情况，如果不可用则删除</li>
                    <li>提供API接口，通过API接口可获取当前可用代理IP</li>
                  </ul>
                  <p>拨号VPS：</p>
                  <ul>
                    <li>定时执行拨号脚本换IP</li>
                    <li>换IP后立即请求远程主机</li>
                    <li>拨号后检测是否拨号成功，如果失败立即重新拨号</li>
                  </ul>
                  <h3 id="远程主机实现"><a href="#远程主机实现" class="headerlink" title="远程主机实现"></a>远程主机实现</h3>
                  <p>说了这么多，那么我们就梳理一下具体的实现吧，整个项目我们用Python3实现。</p>
                  <h4 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h4>
                  <p>远程主机作为一台服务器，动态拨号VPS会定时请求远程主机，远程主机接收到请求后将IP记录下来存入数据库。 因为IP是一直在变化的，IP更新了之后，原来的IP就不能用了，所以对于一个主机来说我们可能需要多次更新一条数据。另外我们不能仅限于维护一台拨号VPS主机，当然是需要支持多台维护的。在这里我们直接选用Key-Value形式的非关系型数据库存储更加方便，所以在此选用Redis数据库。 既然是Key-Value，Key是什么?Value是什么?首先我们能确定Value就是代理的值，比如112.84.119.67:8888，那么Key是什么？我们知道，这个IP是针对一台动态拨号VPS的，而且这个值会不断地变，所以我们需要有一个不变量Key来唯一标识这台主机，所以在这里我们可以把Key当做主机名称。名称怎么来？自己取就好了，只要每台主机的名字不重复，我们就可以区分出是哪台主机了，这个名字可以在拨号主机那边指定，然后传给远程主机就好了。 所以，在这里数据库我们选用Redis，Key就是拨号主机的名称，可以自己指定，Value就是代理的值。 所以可以写一个操作Redis数据库的类，参考如下：</p>
                  <figure class="highlight ruby">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RedisClient</span>(<span class="title">object</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(<span class="keyword">self</span>, host=REDIS_HOST, port=REDIS_PORT)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">self</span>.db = redis.Redis(host=host, port=port, password=REDIS_PASSWORD)</span><br><span class="line">        <span class="keyword">self</span>.proxy_key = PROXY_KEY</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">key</span><span class="params">(<span class="keyword">self</span>, name)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&#123;key&#125;:&#123;name&#125;'</span>.format(key=<span class="keyword">self</span>.proxy_key, name=name)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set</span><span class="params">(<span class="keyword">self</span>, name, proxy)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.db.set(<span class="keyword">self</span>.key(name), proxy)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(<span class="keyword">self</span>, name)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.db.get(<span class="keyword">self</span>.key(name)).decode(<span class="string">'utf-8'</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>首先初始化Redis连接，我们可以将Key设计成<code>adsl:vm1</code>这种形式，冒号前面是总的key，冒号后面是主机名称name，这样显得结构更加清晰。 然后指定set()和get()方法，用来存储代理和获取代理。</p>
                  <h4 id="请求处理"><a href="#请求处理" class="headerlink" title="请求处理"></a>请求处理</h4>
                  <p>拨号主机会一直向远程主机发送请求，远程主机当然可以获取拨号主机的IP，但是代理端口是无法获得的，我们在拨号主机上设置了TinyProxy或者Squid，但是服务器不知道是在哪个端口开的，所以端口也是需要客户端传给远程主机的。远程主机接收到请求后，将解析得到的IP和端口合并就可以作为完整的代理保存了。 所以现在我们知道拨号主机需要传送给远程主机的信息已经有两个了，一是拨号主机本身的名称，二是代理的端口。</p>
                  <h4 id="通信秘钥"><a href="#通信秘钥" class="headerlink" title="通信秘钥"></a>通信秘钥</h4>
                  <p>为了保证远程主机不被恶意的请求干扰，可以设置一个传输秘钥，最简单的方式可以二者共同规定一个秘钥字符串，拨号主机在传送这个字符串，远程主机匹配一下，如果能正确匹配，那就进行下一步的处理，如果不能匹配，那么可能是恶意请求，就忽略这个请求。 当然肯定有更好的加密传输方式，但为了方便起见可以用如上来做。 所以客户机还需要传送一个数据，那就是通信秘钥，一共需要传送三个数据。 所以我们需要架设一个服务器，一直监听客户端的请求，在这里我们用tornado实现。 tornado的安装也非常简单，利用pip安装即可：</p>
                  <figure class="highlight cmake">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">pip3 <span class="keyword">install</span> tornado</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>定义一个处理拨号主机请求的方法，在这里我们使用post请求，参考如下。</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">def post(self):</span><br><span class="line">        token = self.get_body_argument(<span class="string">'token'</span>, <span class="attribute">default</span>=None, <span class="attribute">strip</span>=<span class="literal">False</span>)</span><br><span class="line">       <span class="built_in"> port </span>= self.get_body_argument(<span class="string">'port'</span>, <span class="attribute">default</span>=None, <span class="attribute">strip</span>=<span class="literal">False</span>)</span><br><span class="line">        name = self.get_body_argument(<span class="string">'name'</span>, <span class="attribute">default</span>=None, <span class="attribute">strip</span>=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">if</span> token == TOKEN <span class="keyword">and</span> port:</span><br><span class="line">           <span class="built_in"> ip </span>= self.request.remote_ip</span><br><span class="line">           <span class="built_in"> proxy </span>=<span class="built_in"> ip </span>+ <span class="string">':'</span> + port</span><br><span class="line">            <span class="builtin-name">print</span>(<span class="string">'Receive proxy'</span>, proxy)</span><br><span class="line">            self.redis.<span class="builtin-name">set</span>(name, proxy)</span><br><span class="line">            self.test_proxies()</span><br><span class="line">        elif token != TOKEN:</span><br><span class="line">            self.write(<span class="string">'Wrong Token'</span>)</span><br><span class="line">        elif <span class="keyword">not</span> port:</span><br><span class="line">            self.write(<span class="string">'No Client Port'</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>远程主机获取请求的token，也就是上面我们所说的通信密钥，保证安全。port是拨号机的代理端口，name是拨号主机的名称。然后我们再获取请求的remote_ip，也就是拨号主机的IP。然后将IP和端口拼合就可以得到拨号主机的完整代理信息了，将其存入数据库即可。</p>
                  <h4 id="代理检测"><a href="#代理检测" class="headerlink" title="代理检测"></a>代理检测</h4>
                  <p>在远程主机端我们需要做一下代理检测，如果某个代理不可用了，会及时将其去除，以免出现获取到代理后不可用的情况。</p>
                  <blockquote>
                    <p>注意：在这里在拨号主机端验证是不够的，因为可能突然遇到某个拨号主机宕机的情况，这样拨号主机就不会再向远程主机发送请求，而最后一次得到的代理还会存在于数据库中，所以在远程主机端统一验证比较科学。</p>
                  </blockquote>
                  <p>验证方式可以定时检测，也可以每收到一次请求检测一次，用获取到的代理来请求某个网站，检测一下是否能访问即可。如果不能，将其从数据库中删除。</p>
                  <h4 id="API"><a href="#API" class="headerlink" title="API"></a>API</h4>
                  <p>远程主机已经将拨号主机的IP和端口保存下来了，那也就是说，所有的可用的代理已经在远程主机保存了，我们需要提供一个接口来将代理获取下来。 比如我们可以提供这么几个方法，获取所有代理，获取最新代理，获取随机代理等等。</p>
                  <figure class="highlight ruby">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">all</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">    keys = <span class="keyword">self</span>.keys()</span><br><span class="line">    proxies = [&#123;<span class="string">'name'</span>: key, <span class="string">'proxy'</span>: <span class="keyword">self</span>.get(key)&#125; <span class="keyword">for</span> key <span class="keyword">in</span> keys]</span><br><span class="line">    <span class="keyword">return</span> proxies</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">random</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">    items = <span class="keyword">self</span>.all()</span><br><span class="line">    <span class="keyword">return</span> random.choice(items).get(<span class="string">'proxy'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">list</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">    keys = <span class="keyword">self</span>.keys()</span><br><span class="line">    proxies = [<span class="keyword">self</span>.get(key) <span class="keyword">for</span> key <span class="keyword">in</span> keys]</span><br><span class="line">    <span class="keyword">return</span> proxies</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">first</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.get(<span class="keyword">self</span>.keys()[<span class="number">0</span>])</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>然后用tornado搭建API服务，如果可以的话还可以绑定一个域名，更加便捷，举例如下： 获取随机代理： <img src="https://blog-10039692.file.myqcloud.com/1495176234257_8333_1495176237128.jpg" alt=""> 获取最新代理： <img src="https://blog-10039692.file.myqcloud.com/1495176256328_2908_1495176259312.jpg" alt=""> 获取所有代理： <img src="https://blog-10039692.file.myqcloud.com/1495176279029_802_1495176279909.jpg" alt=""> 请求接口获取可用代理即可，比如获取一个随机代理：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_random_proxy</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 远程主机的服务地址</span></span><br><span class="line">        url = <span class="string">'http://xxx.xxx.xxx.xxx:8000/random'</span></span><br><span class="line">        <span class="keyword">return</span> requests.get(url).text</span><br><span class="line">    <span class="keyword">except</span> requests.exceptions.ConnectionError:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样我们拿到的IP都是稳定可用的，而且过段时间重新请求取到的IP就会变化，是一直动态变化的高可用代理。</p>
                  <h3 id="拨号VPS实现"><a href="#拨号VPS实现" class="headerlink" title="拨号VPS实现"></a>拨号VPS实现</h3>
                  <h4 id="定时拨号"><a href="#定时拨号" class="headerlink" title="定时拨号"></a>定时拨号</h4>
                  <p>拨号VPS需要每隔一段时间就拨号一次，我们可以直接执行命令行来拨号，那在Python里我们只需要调用一下这个拨号命令就好了。利用subprocess模块调用脚本即可，在这里定义一个变量ADSL_BASH为<code>adsl-stop;adsl-start</code>，这就是拨号的脚本。</p>
                  <figure class="highlight cpp">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line">(status, output) = subprocess.getstatusoutput(ADSL_BASH)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>通过getstatusoutput方法可以获取脚本的执行状态和输出结果，如果status为0，则证明拨号成功，然后检测一下拨号接口是否获取了IP地址。 执行<code>ifconfig</code>命令可以获取当前的IP，我这台主机接口名称叫做ppp0，当然网卡名称可以自己指定，所以将ppp0接口的IP提取出来即可。</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">def get_ip(self, <span class="attribute">ifname</span>=ADSL_IFNAME):</span><br><span class="line">    (status, output) = subprocess.getstatusoutput(<span class="string">'ifconfig'</span>)</span><br><span class="line">    <span class="keyword">if</span> status == 0:</span><br><span class="line">        pattern = re.compile(ifname + <span class="string">'.*?inet.*?(\d+\.\d+\.\d+\.\d+).*?netmask'</span>, re.S)</span><br><span class="line">        result = re.search(pattern, output)</span><br><span class="line">        <span class="keyword">if</span> result:</span><br><span class="line">           <span class="built_in"> ip </span>= result.group(1)</span><br><span class="line">            return ip</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>如果方法正常返回IP，则证明IP存在，拨号成功，接下来向远程主机发送请求即可，然后sleep一段时间重新再次拨号。 如果方法返回的值为空，那证明IP不存在，我们需要重新拨号。</p>
                  <h4 id="请求远程主机"><a href="#请求远程主机" class="headerlink" title="请求远程主机"></a>请求远程主机</h4>
                  <p>发送的时候需要携带这么几个信息，一个是通信秘钥，一个是代理端口，另一个是主机的标识符，用requests发送即可。</p>
                  <figure class="highlight haskell">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="title">requests</span>.post(<span class="type">SERVER_URL</span>, <span class="class"><span class="keyword">data</span>=&#123;'<span class="title">token'</span>: <span class="type">TOKEN</span>, '<span class="title">port'</span>: <span class="type">PROXY_PORT</span>, '<span class="title">name'</span>: <span class="type">CLIENT_NAME</span>&#125;)</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>所以整体的思路实现可以写成这样子：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">def adsl(self):</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="builtin-name">print</span>(<span class="string">'ADSL Start, Please wait'</span>)</span><br><span class="line">            (status, output) = subprocess.getstatusoutput(ADSL_BASH)</span><br><span class="line">            <span class="keyword">if</span> status == 0:</span><br><span class="line">                <span class="builtin-name">print</span>(<span class="string">'ADSL Successfully'</span>)</span><br><span class="line">               <span class="built_in"> ip </span>= self.get_ip()</span><br><span class="line">                <span class="keyword">if</span> ip:</span><br><span class="line">                    <span class="builtin-name">print</span>(<span class="string">'New IP'</span>, ip)</span><br><span class="line">                    try:</span><br><span class="line">                        requests.post(SERVER_URL, data=&#123;<span class="string">'token'</span>: TOKEN, <span class="string">'port'</span>: PROXY_PORT, <span class="string">'name'</span>: CLIENT_NAME&#125;)</span><br><span class="line">                        <span class="builtin-name">print</span>(<span class="string">'Successfully Sent to Server'</span>, SERVER_URL)</span><br><span class="line">                    except ConnectionError:</span><br><span class="line">                        <span class="builtin-name">print</span>(<span class="string">'Failed to Connect Server'</span>, SERVER_URL)</span><br><span class="line">                    time.sleep(ADSL_CYCLE)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="builtin-name">print</span>(<span class="string">'Get IP Failed'</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="builtin-name">print</span>(<span class="string">'ADSL Failed, Please Check'</span>)</span><br><span class="line">            time.sleep(1)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样我们就可以做到定时拨号并向远程主机发送请求了。</p>
                  <h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2>
                  <p>Talk is cheap, show me the code! 在这里提供一份完整代码实现，其中client模块是在动态VPS主机运行，server模块在远程主机运行，具体的操作使用可以参考README。 <a href="https://github.com/Germey/ADSLProxyPool" target="_blank" rel="noopener">ADSLProxyPool</a></p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2017-05-19 14:50:15" itemprop="dateCreated datePublished" datetime="2017-05-19T14:50:15+08:00">2017-05-19</time>
                </span>
                <span id="/4596.html" class="post-meta-item leancloud_visitors" data-flag-title="使用Tornado+Redis维护ADSL拨号服务器代理池" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>7.8k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>7 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/4534.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="静觅丨崔庆才的个人站点专业为您提供爬虫教程,爬虫,Python,Python爬虫,Python爬虫教程,爬虫书的相关信息，想要了解更多详情，请联系我们。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/4534.html" class="post-title-link" itemprop="url">Scrapyd日志输出优化</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>现在维护着一个新浪微博爬虫，爬取量已经5亿+，使用了Scrapyd部署分布式。 Scrapyd运行时会输出日志到本地，导致日志文件会越来越大，这个其实就是Scrapy控制台的输出。但是这个日志其实有用的部分也就是最后那几百行而已，如果出错，去日志查看下出错信息就好了。 所以现在可以写一个脚本，来定时更新日志文件，将最后的100行保存下来就好了。 Scrapyd默认的日志目录是在用户文件夹下的logs目录。 所以在这里我们指定dir=~/logs 新建bash脚本，内容如下：</p>
                  <figure class="highlight bash">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">clean</span></span>() &#123;</span><br><span class="line">  <span class="keyword">for</span> file <span class="keyword">in</span> <span class="variable">$1</span>/*</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> [ -d <span class="variable">$file</span> ]</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">      clean <span class="variable">$file</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="variable">$file</span></span><br><span class="line">      temp=$(tail -100 <span class="variable">$file</span>)</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"<span class="variable">$temp</span>"</span> &gt; <span class="variable">$file</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dir=~/logs</span><br><span class="line">clean <span class="variable">$dir</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>新建这样的一个脚本，然后命名为 clean.sh，我的直接放在了用户文件夹下。 然后crontab创建定时任务。 执行</p>
                  <figure class="highlight ebnf">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attribute">crontab -e</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>我们想要一分钟清理一次日志文件。 输入</p>
                  <figure class="highlight jboss-cli">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">*<span class="string">/1</span> * * * * <span class="string">/bin/sh</span> ~<span class="string">/clean.sh</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>然后退出之后，crontab就可以每隔一分钟执行一次clean.sh，清理日志了。 这样我们就不怕日志文件大量占用主机空间啦~</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2017-05-17 14:49:03" itemprop="dateCreated datePublished" datetime="2017-05-17T14:49:03+08:00">2017-05-17</time>
                </span>
                <span id="/4534.html" class="post-meta-item leancloud_visitors" data-flag-title="Scrapyd日志输出优化" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>579</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>1 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/4465.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="静觅丨崔庆才的个人站点专业为您提供爬虫教程,爬虫,Python,Python爬虫,Python爬虫教程,爬虫书的相关信息，想要了解更多详情，请联系我们。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/4465.html" class="post-title-link" itemprop="url">免登录新浪微博爬虫系列之第一篇 单博主微博及评论数据</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <blockquote>
                    <p>我的 GITHUB 地址：<a href="https://github.com/xiaosimao/weibo_spider" target="_blank" rel="noopener">https://github.com/xiaosimao/weibo_spider</a> 2017.05.04 更新： 感谢哥本哈根小树对于获取 containnerid 的指教，多谢。</p>
                    <p><em><strong>大家好，我是新人四毛，大家可以叫我小四毛，至于为什么，在家排行老四，农村人，就是那么任性。</strong></em></p>
                  </blockquote>
                  <p>好，自我介绍完毕，开始今天的学（zhuang）习（bi）之路。</p>
                  <blockquote>
                    <p><strong>说明：本文针对的是有一些爬虫基础的同学，所以看不太懂的同学先补一下基础。</strong></p>
                    <p><strong>本文的全部代码并没有上传到 GITHUB 中，而且本文的 code 部分给出的代码也是指导性的，大部分还是要靠大家自己动手完成。待后几篇博客出来以后，代码会放到上面。</strong></p>
                    <p><strong>大家如果有问题交流的话，欢迎在下面进行评论，或者可以加我 QQ:549411552(加的话麻烦注明来自静觅)，欢迎大佬拍砖指错，大家共同进步。</strong></p>
                  </blockquote>
                  <p>前几天，大才发布了一个视频，主要讲的是通过维护一个新浪微博 Cookies 池，抓取新浪微博的相关数据，爬取的站点是 weibo.cn。相关的代码在大才的 Github 里【大才的视频教程真的很用心，视频高清无码，希望大家可以支持大才，毕竟写了那么多精彩的教程真心不易】。</p>
                  <p>然而，如果你只是想简单的搞点数据，对技术一点兴趣都没有，又或者某宝搜来搜去都没有买到账号，又或者装个模拟登陆需要的模块都想跳楼，有没有除此之外其他的办法呢？你有没有想过在免登陆的情况下就可以获得你想要的数据呢？如果你这么想过而又没有做出来，那么接下来，让我们一起搞（qi）事（fei）吧。</p>
                  <p><a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/02/QQ图片20170205084843.jpg" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/02/QQ图片20170205084843.jpg" alt=""></a></p>
                  <p>本文重点提供解决问题的思路，会把最关键的点标示出来，代码基本没有。有什么不对或不足之处，还望大家指出，共同进步。</p>
                  <h3 id="1-前期准备"><a href="#1-前期准备" class="headerlink" title="1.前期准备"></a>1.前期准备</h3>
                  <p>代理 IP。虽说本文介绍的方法不需要 Cookies，但是代理 IP 还是需要的，要不然也是被新浪分分钟的 403（我测试的时候会出现）。如果你连 403 都不知道是什么，那么还是去看看大才的爬虫基础课程，或者不想看文字的话直接来报大才的视频课程课，哈哈（大才，今晚得加两个菜啊，我这吆喝的）。</p>
                  <p><a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/兔子.gif" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/兔子.gif" alt=""></a></p>
                  <h3 id="2-思路分析"><a href="#2-思路分析" class="headerlink" title="2.思路分析"></a>2.思路分析</h3>
                  <p>一般做爬虫爬取网站，首选的都是 m 站，其次是 wap 站，最后考虑 PC 站。当然，这不是绝对的，有的时候 PC 站的信息最全，而你又恰好需要全部的信息，那么 PC 站是你的首选。一般 m 站都以 m 开头后接域名，试一下 就好了，实在找不到，上网搜。</p>
                  <p>所以本文开搞的网址就是 m.weibo.cn。但是当你在浏览器中输入这个网址时，你得到的应该是下面这个页面，如果不是，说明你的浏览器保留了你最近登录微博的 cookie，这个时候，清空浏览器保存的数据，再次打开这个网页，就应该也是这个界面了：</p>
                  <p><a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/05/login-1.jpg" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/05/login-1.jpg" alt=""></a> <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/05/login.jpg" target="_blank" rel="noopener"></a> 我滴天，是的，你没看错，就是这个登录界面。你不是说不需要登录吗？怎么 TM 的还是这个万恶的界面？怎么破？WTF?</p>
                  <p><a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/表情2.jpg" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/表情2.jpg" alt=""></a></p>
                  <p>哈哈，其实一开始我也不知道，后来经人指点，才发现只要在后面加入一些东西之后就不会看到这个界面了。那么是什么呢？</p>
                  <p><em><strong>当当当当！！！！！！！！！！</strong></em></p>
                  <blockquote>
                    <p><strong><a href="http://m.weibo.cn/u/1713926427" target="_blank" rel="noopener">http://m.weibo.cn/u/1713926427</a></strong></p>
                  </blockquote>
                  <p><a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/表情1.jpg" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/表情1-300x300.jpg" alt=""></a></p>
                  <p>当你看到这个网址的时候，憋说话，一定要用心去感受，这个时候说话你的嘴都是咧着的，别问我为什么知道，我就是知道。</p>
                  <p><strong>用心去感受，真的。</strong></p>
                  <p>对了，上面网址最后的数字是博主的数字 ID，在 weibo.com 的源码里可以找到，这里不做说明了。</p>
                  <p>打开上述网址， 界面变成这个样子，是不是很厉害的样子（大手勿喷），拨云见日，对于老手来说，下面的他们就可以不看了，可以去抓包写代码了，但是对于一头雾水的小伙伴请接着往下看：</p>
                  <p><a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/05/home_page-1.jpg" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/05/home_page-1.jpg" alt=""></a></p>
                  <p>这就是本文爬虫的入口，没错，就说牛逼的榜姐，入口选一些质量高的，比如你想爬新闻方面信息，那么你就去找澎湃新闻，新浪新闻之类的。</p>
                  <p>通过该入口，我们可以抓取该博主的所有微博及评论信息，以及该博主关注的人的微博及评论信息，依次往后，循环不断。</p>
                  <p>在这里谈一点经验：</p>
                  <p><strong>其实做爬虫，最基础的当然是写代码的能力，抓包什么的都不是什么困难的事，抓包很简单很简单。我觉得最难的是找到入口，找到一个最适合的入口。怎么定义这个最适合呢？就是要去尝试，依照一般的顺序，先找找 M 站，再找找 wap 站，最后再去看 PC 站，找到一个合适的入口，往往会事半功倍。前几天抓取途牛网的相关游记信息，爬 PC 站分分钟的 302，但是爬 M 站，全是接口，全程无阻。</strong></p>
                  <p>因大多数人都是采集微博信息以及评论信息，所以下面将以这两方面为主。</p>
                  <p>剧透一下，在这里可以抓到的信息：</p>
                  <p>(1) <strong>博主信息 （没发现有价值的信息，下面抓包过程不讲）</strong></p>
                  <p>(2) <strong>博主微博信息（下文抓包讲解）</strong></p>
                  <p>(3) <strong>微博评论信息（下文抓包讲解）</strong></p>
                  <p>(4) <strong>热门微博信息（小时榜，日榜，周榜，月榜）（下文抓包未讲解，大家可以摸索一下）</strong></p>
                  <p>。。。。。。还有很多我没有细看，等待各位细细研究吧。</p>
                  <h3 id="3-抓包分析"><a href="#3-抓包分析" class="headerlink" title="3. 抓包分析"></a>3. 抓包分析</h3>
                  <p>首先，得会抓包，一般的浏览器的 Network 够用了。</p>
                  <p><strong>(1) 微博正文抓包</strong></p>
                  <p>点击 上图中的微博然后往下拉，抓包出现下图：</p>
                  <p><a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/05/post_content_zhuabao-1.jpg" target="_blank" rel="noopener"></a><a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/05/post_content_zhuabao-1-1.jpg" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/05/post_content_zhuabao-1-1.jpg" alt=""></a></p>
                  <p><strong>分析：</strong></p>
                  <blockquote>
                    <p>可以看到，服务器返回的数据为 json 格式，这个是做爬虫的最喜欢的了。返回的数据包括很多的字段，图中也以及做了标示，相信大家都能看的懂，看不懂那也没办法了。</p>
                  </blockquote>
                  <p>最后放上抓包的数据：</p>
                  <blockquote>
                    <ol>
                      <li>
                        <p><strong>Request URL</strong>:</p>
                        <p><a href="http://m.weibo.cn/api/container/getIndex?type=uid&amp;value=1713926427&amp;containerid=1076031713926427&amp;page=2" target="_blank" rel="noopener">http://m.weibo.cn/api/container/getIndex?type=uid&amp;value=1713926427&amp;containerid=1076031713926427&amp;page=2</a></p>
                      </li>
                      <li>
                        <p><strong>Request Method</strong>:</p>
                        <p>GET</p>
                      </li>
                      <li>
                        <p><strong>Query String Parameters</strong></p>
                        <p>type: uid</p>
                        <p>value: 1713926427</p>
                        <p>containerid: 1076031713926427</p>
                        <p>page: 2</p>
                      </li>
                    </ol>
                  </blockquote>
                  <p><strong>(2) 微博评论抓包</strong></p>
                  <p>单击微博内容，就可以抓包成功，如下图：</p>
                  <p><a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/05/comment_zhuabao.jpg" target="_blank" rel="noopener"></a><a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/05/comment_zhuabao-1.jpg" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/05/comment_zhuabao-1.jpg" alt=""></a> <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/05/comment_zhuabao.jpg" target="_blank" rel="noopener"></a> <strong> 分析：</strong></p>
                  <blockquote>
                    <p>从上面可以看出，这里的数据依然还是很好获取的。</p>
                  </blockquote>
                  <p>最后放上抓包的数据：</p>
                  <blockquote>
                    <ol>
                      <li>
                        <p><strong>Request URL</strong>:</p>
                        <p><a href="http://m.weibo.cn/api/comments/show?id=4103388327019042&amp;page=1" target="_blank" rel="noopener">http://m.weibo.cn/api/comments/show?id=4103388327019042&amp;page=1</a></p>
                      </li>
                      <li>
                        <p><strong>Request Method</strong>:</p>
                        <p>GET</p>
                      </li>
                      <li>
                        <p><strong>Query String Parameters</strong></p>
                        <p>id: 4103388327019042</p>
                        <p>page: 1</p>
                      </li>
                    </ol>
                  </blockquote>
                  <p><strong>再次分析：</strong></p>
                  <blockquote>
                    <p>通过抓包的数据可以发现，获取微博评论必须首先获得这条微博的 ID。所以，目前还是要对微博正文的抓包过程进行分析。</p>
                  </blockquote>
                  <h3 id="4-思路解析"><a href="#4-思路解析" class="headerlink" title="4. 思路解析"></a>4. 思路解析</h3>
                  <p>在上面的微博正文中发现需要提交以下数据：</p>
                  <blockquote>
                    <p>type: uid</p>
                    <p>value: 1713926427</p>
                    <p>containerid: 1076031713926427</p>
                    <p>page: 2</p>
                  </blockquote>
                  <p>其中：<strong>type</strong>(固定值)、<strong>value</strong>(博主微博 ID)、<strong>containerid</strong>(意义不明确，但是带了个 id 在里面，应该代表的是一个唯一性的一个标识)、<strong>page</strong>(页码)。页码在返回的数据中可以获得。</p>
                  <p>那么分析到这里，containerid 就是我们要找的最重要的信息。这个字段信息是不会凭空出现的，肯定产生于某一个请求之中，所以这时候，我们再回到开头，回到我们的初始。刷新入口网址，抓包发现了下面 3 个网址，见下图：</p>
                  <p><a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/05/home_zhuabao.jpg" target="_blank" rel="noopener"></a><a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/05/home_zhuabao-1.jpg" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/05/home_zhuabao-1.jpg" alt=""></a> <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/05/home_zhuabao.jpg" target="_blank" rel="noopener"></a> <strong> 分析：</strong></p>
                  <blockquote>
                    <p>这 3 个网址的格式一模一样，所以点进去看一下里面到底什么情况。</p>
                  </blockquote>
                  <p>下面的先点开<strong>网址 1</strong>看看：</p>
                  <p><a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/05/user_infojpg.jpg" target="_blank" rel="noopener"></a><a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/05/user_infojpg-1.jpg" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/05/user_infojpg-1.jpg" alt=""></a> <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/05/user_infojpg.jpg" target="_blank" rel="noopener"></a> <strong> 分析：</strong></p>
                  <blockquote>
                    <p>从返回的数据中，可以看到第 1 个网址的主要内容为 user_Info，即博主的个人信息，相关的字段在图中已经标示出来。最令人惊喜的是查找我们需要的 containerid 时，发现数据竟然就在其中，那么可以肯定我们需要的 containerid 就是在这个请求的返回值中，那么问题再次出现，这个请求的网址中又出现了一个 containerid，我们似乎又回到了原点，而且在用户的首页抓包中，在这个请求之前，也没有什么有意义的请求了，到这里是不是就进入死胡同了呢？其实不然，在这里我们就要进行多方面的尝试了，当我们将第一个网址中的 containerid 删掉以后，重新请求一次，发现返回的依然是这些数据，具体见下图：</p>
                  </blockquote>
                  <p><a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/05/no_containid-1.jpg" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/05/no_containid-1.jpg" alt=""></a></p>
                  <p><strong>分析：</strong></p>
                  <blockquote>
                    <p>而当我将第三个网址，也就是微博正文的网址中的 containerid 去掉后，返回的数据就是博主的个人信息了，而不是我们需要的微博正文，所以可以肯定第一个网址中的 containerid 并不是必须的，而对于网址 3，这个字段则是必须的。</p>
                  </blockquote>
                  <p>为了让这个爬虫可以顺着一个初始用户爬取到其他用户的相关信息，甚至全网的信息，那么我们就需要让爬虫自己去添加待爬任务。本文选择的初始用户有 3000 多万的粉丝数，就是人们常说的微博大 V。在做这一类的信息爬取时，我们往往关注的是数据的质量，所以我们选择初始用户的关注用户作为下一级的用户。在下一级中，这些用户将被作为初始用户。这样周而复始，最理想的情况当然就是可以把微博全站的质量还不错的博主的微博以及下面的评论都抓取了。但是在实际的操作过程中会发现微博的用户质量真的是参差不齐，所以我们在筛选后面的用户时，可以加一些限制条件，如用户的粉丝数等等。在这里找寻初始用户关注用户信息的这一过程就省略了，留给大家探索一下，很简单。</p>
                  <p>所以到这里，我们的整个流程就理清了（单个博主，如需循环，则只需要找到下一级用户的 ID 即可，相信这对于聪明的大家肯定不难的）：</p>
                  <blockquote>
                    <p>请求用户主页网址—&gt;得到 containerid，请求微博正文网址—&gt;保存博文相关信息，取出博文 ID，请求评论网址—&gt;得到评论信息</p>
                  </blockquote>
                  <h3 id="5-CODE-TIME"><a href="#5-CODE-TIME" class="headerlink" title="5. CODE TIME"></a>5. CODE TIME</h3>
                  <p>思路已经理清了，那么下面就是 CODE TIME 了，毕竟:</p>
                  <blockquote>
                    <p>TALK IS CHEAP,SHOW ME YOUR CODE</p>
                  </blockquote>
                  <p>本文采用 scrapy 编写，重写个 proxy 中间件，即可实现每一个 request 带一个随机 IP，减少被封禁的概率，同时尽量把重试的次数设置大一些。</p>
                  <p>想要保存哪些信息，根据自身的业务需求而定，具体的信息，能找到的都可以在每一个请求返回的内容中找到，都是 json 格式的，所以这里的代码只是将上面讲的流程实现了一遍，其他的都没有实现。</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line">import scrapy</span><br><span class="line">import json</span><br><span class="line"></span><br><span class="line">class SinaSpider(scrapy.Spider):</span><br><span class="line">    name = <span class="string">"sina"</span></span><br><span class="line">    allowed_domains = [<span class="string">"m.weibo.cn"</span>]</span><br><span class="line">    # root id</span><br><span class="line">    first_id = <span class="string">'1713926427'</span></span><br><span class="line"></span><br><span class="line">    def start_requests(self):</span><br><span class="line">        # <span class="keyword">to</span> <span class="builtin-name">get</span> containerid</span><br><span class="line">        url = <span class="string">'http://m.weibo.cn/api/container/getIndex?type=uid&amp;value=&#123;&#125;'</span>.format(self.first_id)</span><br><span class="line">        yield scrapy.Request(<span class="attribute">url</span>=url, <span class="attribute">callback</span>=self.get_containerid)</span><br><span class="line"></span><br><span class="line">    def get_containerid(self,response):</span><br><span class="line">        content = json.loads(response.body)</span><br><span class="line">        # here, we can <span class="builtin-name">get</span> containerid</span><br><span class="line">        containerid = None</span><br><span class="line">        <span class="keyword">for</span> data <span class="keyword">in</span>  content.<span class="builtin-name">get</span>(<span class="string">'tabsInfo'</span>).<span class="builtin-name">get</span>(<span class="string">'tabs'</span>):</span><br><span class="line">            <span class="keyword">if</span> data.<span class="builtin-name">get</span>(<span class="string">'tab_type'</span>) == <span class="string">'weibo'</span>:</span><br><span class="line">                containerid = data.<span class="builtin-name">get</span>(<span class="string">'containerid'</span>)</span><br><span class="line">                <span class="builtin-name">print</span> <span class="string">'weibo request url containerid is %s'</span> % containerid</span><br><span class="line"></span><br><span class="line">        # construct the wei bo request url</span><br><span class="line">        <span class="keyword">if</span> containerid:</span><br><span class="line">            weibo_url = response.url + <span class="string">'&amp;containerid=%s'</span>%containerid</span><br><span class="line">            yield scrapy.Request(<span class="attribute">url</span>=weibo_url, <span class="attribute">callback</span>=self.get_weibo_id)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="builtin-name">print</span> <span class="string">'sorry, do not get containerid'</span></span><br><span class="line"></span><br><span class="line">    def get_weibo_id(self, response):</span><br><span class="line">        content = json.loads(response.body)</span><br><span class="line">        # <span class="builtin-name">get</span> weibo id ,you can also save some other data <span class="keyword">if</span> you need</span><br><span class="line">        <span class="keyword">for</span> data <span class="keyword">in</span> content.<span class="builtin-name">get</span>(<span class="string">'cards'</span>):</span><br><span class="line">            <span class="keyword">if</span> data.<span class="builtin-name">get</span>(<span class="string">'card_type'</span>) == 9:</span><br><span class="line">                single_weibo_id = data.<span class="builtin-name">get</span>(<span class="string">'mblog'</span>).<span class="builtin-name">get</span>(<span class="string">'id'</span>)</span><br><span class="line">                <span class="builtin-name">print</span> single_weibo_id</span><br><span class="line">                # here ,<span class="keyword">if</span> you want <span class="keyword">to</span> <span class="builtin-name">get</span> comment <span class="builtin-name">info</span> ,you can construct the comment url just the same as wei bo url</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h3 id="6-总结"><a href="#6-总结" class="headerlink" title="6.总结"></a>6.总结</h3>
                  <p>本文写到这里就算结束了，我一直信奉授人以鱼不如授人以渔，在这篇文章中，我并没有把全部的代码展示出来，而是通过分析的过程来让大家知道怎么去处理这类问题，在文中也留了好几个可以让大家发挥的地方，如用户关注用户怎么获取？按照关键词搜索的信息怎么抓取？等等。我相信大家通过一步步的抓包以及分析一定可以解决这些问题的。这些问题，在以后的博客中我也会继续更新的。</p>
                  <p>第一次写这样的博客，感觉还是驾驭不了，还是得多多练习。写博客真的很累，向大才致敬，感谢他无私的为我们奉献了这么多精彩的教程。</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/四毛" class="author" itemprop="url" rel="index">四毛</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2017-05-04 12:56:51" itemprop="dateCreated datePublished" datetime="2017-05-04T12:56:51+08:00">2017-05-04</time>
                </span>
                <span id="/4465.html" class="post-meta-item leancloud_visitors" data-flag-title="免登录新浪微博爬虫系列之第一篇  单博主微博及评论数据" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>5.4k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>5 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/4421.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="静觅丨崔庆才的个人站点专业为您提供爬虫教程,爬虫,Python,Python爬虫,Python爬虫教程,爬虫书的相关信息，想要了解更多详情，请联系我们。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/4421.html" class="post-title-link" itemprop="url">小白进阶之Scrapy第四篇（图片下载管道篇）</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p><strong>PS： 爬虫不进入 img_url 函数的小伙伴儿 请尝试将将代码复制到你新建的 py 文件中。</strong> 2017/8/30 更新解决了网站防盗链导致下载图片失败的问题 <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/QQ图片20161021225948.jpg" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/QQ图片20161021225948.jpg" alt=""></a> 这几天一直有小伙伴而给我吐槽说，由于妹子图站长把www.mzitu.com/all这个地址取消了。导致原来的那个采集爬虫不能用啦。 正好也有小伙伴儿问 Scrapy 中的图片下载管道是怎么用的。 就凑合在一起把 mzitu.com 给重新写了一下。 <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/9555112.jpg" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/9555112.jpg" alt=""></a> 首先确保你的 Python 环境已安装 Scrapy!!!!!!!! 命令行下进入你需要存放项目的目录并创建项目： 比如我放在了 D:\PycharmProjects</p>
                  <figure class="highlight properties">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attr">D</span>:<span class="string"></span></span><br><span class="line"><span class="attr">cd</span> <span class="string">PycharmProjects</span></span><br><span class="line"><span class="attr">scrapy</span> <span class="string">startproject mzitu_scrapy</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>我是 Windows！其余系统的伙伴儿自己看着办哈。 这都不会的小伙伴儿，快去洗洗睡吧。养足了精神从头看一遍教程哈！ 在 PyCharm 中打开我们的项目目录。 在 mzitu_scrapy 目录创建 run.py。写入以下内容：</p>
                  <figure class="highlight smali">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">from scrapy.cmdline import execute</span><br><span class="line">execute(['scrapy', 'crawl', 'mzitu'])</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>其中的 mzitu 就为待会儿 spider.py 文件中的 name 属性。这点请务必记住哦！不然是跑不起来的。 在 mzitu_scrapy\spider 目录中创建 spider.py。文件作为爬虫文件。 好了！现在我们来想想，怎么来抓 mzitu.com 了。 首先我们的目标是当然是全站的妹子图片！！！ 但是问题来了，站长把之前那个 mzitu.com\all 这个 URL 地址给取消了，我们没办法弄到全部的套图地址了！ 我们可以去仔细观察一下站点所有套图的地址都是：<a href="http://www.mzitu.com/几位数字结尾的。" target="_blank" rel="noopener">http://www.mzitu.com/几位数字结尾的。</a> 这种格式地址。 有木有小伙伴儿想到了啥？ <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/QQ图片20161022193315.gif" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/QQ图片20161022193315.gif" alt=""></a> CrawlSpider ！！！就是这玩儿！！ 有了它我们就能追踪“<a href="http://www.mzitu.com/几位数字结尾的”这种格式的URL了。" target="_blank" rel="noopener">http://www.mzitu.com/几位数字结尾的”这种格式的URL了。</a> Go Go Go Go！开始搞事。 <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/02/QQ图片20170205084843.jpg" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/02/QQ图片20170205084843.jpg" alt=""></a> 首先在 item.py 中新建我们需要的字段。我们需要啥？我们需要套图的名字和图片地址！！ 那我们新建三个字段：</p>
                  <figure class="highlight mipsasm">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import <span class="keyword">scrapy</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword">class </span>MzituScrapyItem(<span class="keyword">scrapy.Item):</span></span><br><span class="line"><span class="keyword"> </span>   <span class="comment"># define the fields for your item here like:</span></span><br><span class="line">    <span class="comment"># name = scrapy.Field()</span></span><br><span class="line">    name = <span class="keyword">scrapy.Field()</span></span><br><span class="line"><span class="keyword"> </span>   image_urls = <span class="keyword">scrapy.Field()</span></span><br><span class="line"><span class="keyword"> </span>   url = <span class="keyword">scrapy.Field()</span></span><br><span class="line"><span class="keyword"> </span>   pass</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>第一步完成啦！开始写 spider.py 啦！ 首先导入我们需要的包：</p>
                  <figure class="highlight pgsql">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> scrapy <span class="keyword">import</span> Request</span><br><span class="line"><span class="keyword">from</span> scrapy.spider <span class="keyword">import</span> CrawlSpider, <span class="keyword">Rule</span></span><br><span class="line"><span class="keyword">from</span> scrapy.linkextractors <span class="keyword">import</span> LinkExtractor</span><br><span class="line"><span class="keyword">from</span> mzitu_scrapy.items <span class="keyword">import</span> MzituScrapyItem</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>都是干啥的我不说了哈！不知道的小伙伴儿自己去翻翻官方文档。 接下来是：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">class Spider(CrawlSpider):</span><br><span class="line">    name = <span class="string">'mzitu'</span></span><br><span class="line">    allowed_domains = [<span class="string">'mzitu.com'</span>]</span><br><span class="line">    start_urls = [<span class="string">'http://www.mzitu.com/'</span>]</span><br><span class="line">    img_urls = []</span><br><span class="line">    rules = (</span><br><span class="line">        Rule(LinkExtractor(allow=(<span class="string">'http://www.mzitu.com/\d&#123;1,6&#125;'</span>,), deny=(<span class="string">'http://www.mzitu.com/\d&#123;1,6&#125;/\d&#123;1,6&#125;'</span>)), <span class="attribute">callback</span>=<span class="string">'parse_item'</span>, <span class="attribute">follow</span>=<span class="literal">True</span>),</span><br><span class="line">    )</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>第五行的 img_urls=[] 这个列表是我们之后用来存储每个套图的全部图片的 URL 地址的。 rules 中的语句是：匹配<a href="http://www.mzitu.com/1至6位数的的URL（\\d：数字；{1,6}匹配1至6次。就能匹配出1到6位数）" target="_blank" rel="noopener">http://www.mzitu.com/1至6位数的的URL（\\d：数字；{1,6}匹配1至6次。就能匹配出1到6位数）</a> 但是我们会发现网页中除了<a href="http://www.mzitu.com/XXXXXXX" target="_blank" rel="noopener">http://www.mzitu.com/XXXXXXX</a> 这种格式的 URL 之外；还有 <a href="http://www.mzitu.com/XXXX/XXXX" target="_blank" rel="noopener">http://www.mzitu.com/XXXX/XXXX</a> 这个格式的 URL。所以我们需要设置 deny 来不匹配<a href="http://www.mzitu.com/XXXX/XXXX这种格式的URL。" target="_blank" rel="noopener">http://www.mzitu.com/XXXX/XXXX这种格式的URL。</a> 然后将匹配到的网页交给 parse_item 来处理。并且持续追踪 <strong>看这儿敲黑板！！划重点！！：：：</strong></p>
                  <h2 id="重点说明！！！！不能-parse-函数！！这是-CrawlSpider-进行匹配调用的函数，你要是使用了！rules-就没法进行匹配啦！！！"><a href="#重点说明！！！！不能-parse-函数！！这是-CrawlSpider-进行匹配调用的函数，你要是使用了！rules-就没法进行匹配啦！！！" class="headerlink" title="重点说明！！！！不能 parse 函数！！这是 CrawlSpider 进行匹配调用的函数，你要是使用了！rules 就没法进行匹配啦！！！"></a><strong>重点说明！！！！不能 parse 函数！！这是 CrawlSpider 进行匹配调用的函数，你要是使用了！rules 就没法进行匹配啦！！！</strong></h2>
                  <p>现在 spider.py 是这样的：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> scrapy <span class="keyword">import</span> Request</span><br><span class="line"><span class="keyword">from</span> scrapy.spider <span class="keyword">import</span> CrawlSpider, Rule</span><br><span class="line"><span class="keyword">from</span> scrapy.linkextractors <span class="keyword">import</span> LinkExtractor</span><br><span class="line"><span class="keyword">from</span> mzitu_scrapy.items <span class="keyword">import</span> MzituScrapyItem</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Spider</span><span class="params">(CrawlSpider)</span>:</span></span><br><span class="line">    name = <span class="string">'mzitu'</span></span><br><span class="line">    allowed_domains = [<span class="string">'mzitu.com'</span>]</span><br><span class="line">    start_urls = [<span class="string">'http://www.mzitu.com/'</span>]</span><br><span class="line">    img_urls = []</span><br><span class="line">    rules = (</span><br><span class="line">        Rule(LinkExtractor(allow=(<span class="string">'http://www.mzitu.com/\d&#123;1,6&#125;'</span>,), deny=(<span class="string">'http://www.mzitu.com/\d&#123;1,6&#125;/\d&#123;1,6&#125;'</span>)), callback=<span class="string">'parse_item'</span>, follow=<span class="literal">True</span>),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse_item</span><span class="params">(self, response)</span>:</span></span><br><span class="line">        print(response.url)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>来跑一下试试 别忘了怎么测试的哈！！上面新建的那个 run.py！ <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/04/mzitu01.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/04/mzitu01.png" alt=""></a> Good！！真棒！全是我们想要的！！！ 现在干啥？啥？你不知道？EXM 你没逗我吧！ <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/04/e6a6e85d131a484b8034606c0f6a504a_th.gif" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/04/e6a6e85d131a484b8034606c0f6a504a_th.gif" alt=""></a> 当然是解析我们拿到的 response 了！从里面找我们要的套图名称和所有的图片地址了！ 我们随便打开一个 URL。 首先用 xpath 取套图名称： 啥？你不知道怎么用 xpath？？少年少女 你走吧。出去别说看过我的博文。 ./*//div[@class=’main’]/div[1]/h2/text() 这段 xpath 就是套图名称的 xpath 了！看不懂的少年少女赶快去<a href="http://www.w3school.com.cn/看看xpath的教程！" target="_blank" rel="noopener">http://www.w3school.com.cn/看看xpath的教程！</a> 当然你直接用 Chrome 拷贝出来的那个 xpath 也行。（有一定的概率不能使） 现在来找图片地址了，怎么找我在 小白爬虫第一弹中已经写过了哈！这就不详细赘述了！ 首先找到每套图有多少张图片： <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/04/mzitu02.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/04/mzitu02.png" alt=""></a> 就是红框中的那个东东。 Xpath 这样写：</p>
                  <figure class="highlight delphi">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">descendant::<span class="keyword">div</span>[@<span class="keyword">class</span>=<span class="string">'main'</span>]/<span class="keyword">div</span>[@<span class="keyword">class</span>=<span class="string">'content'</span>]/<span class="keyword">div</span>[@<span class="keyword">class</span>=<span class="string">'pagenavi'</span>]/a[last()-<span class="number">1</span>]/span/text()</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>意思是选取根节点下面所有后代标签，在其中选取出 div[@class=’main’]下面的 div[@class=’content’]下面的/div[@class=’pagenavi’]下面的倒数第二个 a 标签 下面的 span 标签中的文本。（有点长哈哈哈哈哈！其实还可以短一些，我懒就不改了） 然后循环拼接处每张图片的的网页地址，现在 spider.py 是这样：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> scrapy <span class="keyword">import</span> Request</span><br><span class="line"><span class="keyword">from</span> scrapy.spider <span class="keyword">import</span> CrawlSpider, Rule</span><br><span class="line"><span class="keyword">from</span> scrapy.linkextractors <span class="keyword">import</span> LinkExtractor</span><br><span class="line"><span class="keyword">from</span> mzitu_scrapy.items <span class="keyword">import</span> MzituScrapyItem</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Spider</span><span class="params">(CrawlSpider)</span>:</span></span><br><span class="line">    name = <span class="string">'mzitu'</span></span><br><span class="line">    allowed_domains = [<span class="string">'mzitu.com'</span>]</span><br><span class="line">    start_urls = [<span class="string">'http://www.mzitu.com/'</span>]</span><br><span class="line">    img_urls = []</span><br><span class="line">    rules = (</span><br><span class="line">        Rule(LinkExtractor(allow=(<span class="string">'http://www.mzitu.com/\d&#123;1,6&#125;'</span>,), deny=(<span class="string">'http://www.mzitu.com/\d&#123;1,6&#125;/\d&#123;1,6&#125;'</span>)), callback=<span class="string">'parse_item'</span>, follow=<span class="literal">True</span>),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse_item</span><span class="params">(self, response)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        :param response: 下载器返回的response</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        item = MzituScrapyItem()</span><br><span class="line">        <span class="comment"># max_num为页面最后一张图片的位置</span></span><br><span class="line">        max_num = response.xpath(<span class="string">"descendant::div[@class='main']/div[@class='content']/div[@class='pagenavi']/a[last()-1]/span/text()"</span>).extract_first(default=<span class="string">"N/A"</span>)</span><br><span class="line">        item[<span class="string">'name'</span>] = response.xpath(<span class="string">"./*//div[@class='main']/div[1]/h2/text()"</span>).extract_first(default=<span class="string">"N/A"</span>)</span><br><span class="line">        <span class="keyword">for</span> num <span class="keyword">in</span> range(<span class="number">1</span>, int(max_num)):</span><br><span class="line">            <span class="comment"># page_url 为每张图片所在的页面地址</span></span><br><span class="line">            page_url = response.url + <span class="string">'/'</span> + str(num)</span><br><span class="line">            <span class="keyword">yield</span> Request(page_url, callback=self.img_url)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>extract_first(default=”N/A”)的意思是：取 xpath 返回值的第一个元素。如果 xpath 没有取到值，则返回 N/A 然后调用函数 img_url 来提取每个网页中的图片地址。img_url 长这样：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">img_url</span><span class="params">(self, response,)</span>:</span></span><br><span class="line">    <span class="string">"""取出图片URL 并添加进self.img_urls列表中</span></span><br><span class="line"><span class="string">    :param response:</span></span><br><span class="line"><span class="string">    :param img_url 为每张图片的真实地址</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    img_urls = response.xpath(<span class="string">"descendant::div[@class='main-image']/descendant::img/@src"</span>).extract()</span><br><span class="line">    <span class="keyword">for</span> img_url <span class="keyword">in</span> img_urls:</span><br><span class="line">        self.img_urls.append(img_url)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>descendant::div[@class=’main-image’]/descendant::img/@src 这段 xpath 取出 div[@class=’main-image’]下面所有的 img 标签的 src 属性（有的套图一个页面有好几张图） .extract()不跟上[0]返回的是列表 完整的 spider.py 如下：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> scrapy <span class="keyword">import</span> Request</span><br><span class="line"><span class="keyword">from</span> scrapy.spider <span class="keyword">import</span> CrawlSpider, Rule</span><br><span class="line"><span class="keyword">from</span> scrapy.linkextractors <span class="keyword">import</span> LinkExtractor</span><br><span class="line"><span class="keyword">from</span> mzitu_scrapy.items <span class="keyword">import</span> MzituScrapyItem</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Spider</span><span class="params">(CrawlSpider)</span>:</span></span><br><span class="line">    name = <span class="string">'mzitu'</span></span><br><span class="line">    allowed_domains = [<span class="string">'mzitu.com'</span>]</span><br><span class="line">    start_urls = [<span class="string">'http://www.mzitu.com/'</span>]</span><br><span class="line">    img_urls = []</span><br><span class="line">    rules = (</span><br><span class="line">        Rule(LinkExtractor(allow=(<span class="string">'http://www.mzitu.com/\d&#123;1,6&#125;'</span>,), deny=(<span class="string">'http://www.mzitu.com/\d&#123;1,6&#125;/\d&#123;1,6&#125;'</span>)), callback=<span class="string">'parse_item'</span>, follow=<span class="literal">True</span>),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse_item</span><span class="params">(self, response)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        :param response: 下载器返回的response</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        item = MzituScrapyItem()</span><br><span class="line">        <span class="comment"># max_num为页面最后一张图片的位置</span></span><br><span class="line">        max_num = response.xpath(<span class="string">"descendant::div[@class='main']/div[@class='content']/div[@class='pagenavi']/a[last()-1]/span/text()"</span>).extract_first(default=<span class="string">"N/A"</span>)</span><br><span class="line">        item[<span class="string">'name'</span>] = response.xpath(<span class="string">"./*//div[@class='main']/div[1]/h2/text()"</span>).extract_first(default=<span class="string">"N/A"</span>)</span><br><span class="line">        item[<span class="string">'url'</span>] = response.url</span><br><span class="line">        <span class="keyword">for</span> num <span class="keyword">in</span> range(<span class="number">1</span>, int(max_num)):</span><br><span class="line">            <span class="comment"># page_url 为每张图片所在的页面地址</span></span><br><span class="line">            page_url = response.url + <span class="string">'/'</span> + str(num)</span><br><span class="line">            <span class="keyword">yield</span> Request(page_url, callback=self.img_url)</span><br><span class="line">        item[<span class="string">'image_urls'</span>] = self.img_urls</span><br><span class="line">        <span class="keyword">yield</span> item</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">img_url</span><span class="params">(self, response,)</span>:</span></span><br><span class="line">        <span class="string">"""取出图片URL 并添加进self.img_urls列表中</span></span><br><span class="line"><span class="string">        :param response:</span></span><br><span class="line"><span class="string">        :param img_url 为每张图片的真实地址</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        img_urls = response.xpath(<span class="string">"descendant::div[@class='main-image']/descendant::img/@src"</span>).extract()</span><br><span class="line">        <span class="keyword">for</span> img_url <span class="keyword">in</span> img_urls:</span><br><span class="line">            self.img_urls.append(img_url)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>下面开始把图片弄回本地啦！！ 开写我们的 pipelines.py 首先根据官方文档说明我们如果需要使用图片管道 则需要使用 ImagesPipeline： <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/04/mzitu03.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/04/mzitu03.png" alt=""></a> 我们可以依葫芦画瓢写一个。但是这样有一个很麻烦的问题就是，这样下载下来的图片没有分类，很是难看啊！ 所以 我们需要重写一下 ImagesPipeline 中的 file_path 方法！ 具体如下：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Define your item pipelines here</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Don't forget to add your pipeline to the ITEM_PIPELINES setting</span></span><br><span class="line"><span class="comment"># See: http://doc.scrapy.org/en/latest/topics/item-pipeline.html</span></span><br><span class="line"><span class="keyword">from</span> scrapy <span class="keyword">import</span> Request</span><br><span class="line"><span class="keyword">from</span> scrapy.pipelines.images <span class="keyword">import</span> ImagesPipeline</span><br><span class="line"><span class="keyword">from</span> scrapy.exceptions <span class="keyword">import</span> DropItem</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MzituScrapyPipeline</span><span class="params">(ImagesPipeline)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">file_path</span><span class="params">(self, request, response=None, info=None)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        :param request: 每一个图片下载管道请求</span></span><br><span class="line"><span class="string">        :param response:</span></span><br><span class="line"><span class="string">        :param info:</span></span><br><span class="line"><span class="string">        :param strip :清洗Windows系统的文件夹非法字符，避免无法创建目录</span></span><br><span class="line"><span class="string">        :return: 每套图的分类目录</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        item = request.meta[<span class="string">'item'</span>]</span><br><span class="line">        folder = item[<span class="string">'name'</span>]</span><br><span class="line">        folder_strip = strip(folder)</span><br><span class="line">        image_guid = request.url.split(<span class="string">'/'</span>)[<span class="number">-1</span>]</span><br><span class="line">        filename = <span class="string">u'full/&#123;0&#125;/&#123;1&#125;'</span>.format(folder_strip, image_guid)</span><br><span class="line">        <span class="keyword">return</span> filename</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_media_requests</span><span class="params">(self, item, info)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        :param item: spider.py中返回的item</span></span><br><span class="line"><span class="string">        :param info:</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">for</span> img_url <span class="keyword">in</span> item[<span class="string">'image_urls'</span>]:</span><br><span class="line">            referer = item[<span class="string">'url'</span>]</span><br><span class="line">            <span class="keyword">yield</span> Request(img_url, meta=&#123;<span class="string">'item'</span>: item,</span><br><span class="line">                                         <span class="string">'referer'</span>: referer&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">item_completed</span><span class="params">(self, results, item, info)</span>:</span></span><br><span class="line">        image_paths = [x[<span class="string">'path'</span>] <span class="keyword">for</span> ok, x <span class="keyword">in</span> results <span class="keyword">if</span> ok]</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> image_paths:</span><br><span class="line">            <span class="keyword">raise</span> DropItem(<span class="string">"Item contains no images"</span>)</span><br><span class="line">        <span class="keyword">return</span> item</span><br><span class="line"></span><br><span class="line">    <span class="comment"># def process_item(self, item, spider):</span></span><br><span class="line">    <span class="comment">#     return item</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">strip</span><span class="params">(path)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    :param path: 需要清洗的文件夹名字</span></span><br><span class="line"><span class="string">    :return: 清洗掉Windows系统非法文件夹名字的字符串</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    path = re.sub(<span class="string">r'[？\*|“&lt;&gt;:/]'</span>, <span class="string">''</span>, str(path))</span><br><span class="line">    <span class="keyword">return</span> path</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    a = <span class="string">'我是一个？*|“&lt;&gt;:/错误的字符串'</span></span><br><span class="line">    print(strip(a))</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>写一个中间件来处理图片下载的防盗链：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MeiZiTu</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_request</span><span class="params">(self, request, spider)</span>:</span></span><br><span class="line">        <span class="string">'''设置headers和切换请求头</span></span><br><span class="line"><span class="string">        :param request: 请求体</span></span><br><span class="line"><span class="string">        :param spider: spider对象</span></span><br><span class="line"><span class="string">        :return: None</span></span><br><span class="line"><span class="string">        '''</span></span><br><span class="line">        referer = request.meta.get(<span class="string">'referer'</span>, <span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">if</span> referer:</span><br><span class="line">            request.headers[<span class="string">'referer'</span>] = referer</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>最后一步设置 ImagesPipeline 的存储目录！ 在 settings.py 中写入：</p>
                  <figure class="highlight ini">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attr">IMAGES_STORE</span> = <span class="string">'F:\mzitu\\'</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>则 ImagesPipeline 将所有下载的图片放置在此目录下！ 设置图片实效性： 图像管道避免下载最近已经下载的图片。使用 <a href="http://scrapy-chs.readthedocs.io/zh_CN/1.0/topics/media-pipeline.html#std:setting-FILES_EXPIRES" target="_blank" rel="noopener"><code>FILES_EXPIRES</code></a> (或 <a href="http://scrapy-chs.readthedocs.io/zh_CN/1.0/topics/media-pipeline.html#std:setting-IMAGES_EXPIRES" target="_blank" rel="noopener"><code>IMAGES_EXPIRES</code></a>) 设置可以调整失效期限，可以用天数来指定: 在 settings.py 中写入以下配置。</p>
                  <figure class="highlight ini">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment"># 30 days of delay for images expiration</span></span><br><span class="line"><span class="attr">IMAGES_EXPIRES</span> = <span class="number">30</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>settings.py 中开启 item_pipelines:</p>
                  <figure class="highlight ebnf">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attribute">ITEM_PIPELINES</span> = &#123;</span><br><span class="line">   <span class="string">'mzitu_scrapy.pipelines.MzituScrapyPipeline'</span>: 300,</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>settings.py 中开启 DOWNLOADER_MIDDLEWARES</p>
                  <figure class="highlight ebnf">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attribute">DOWNLOADER_MIDDLEWARES</span> = &#123;</span><br><span class="line">   <span class="string">'mzitu_scrapy.middlewares.MeiZiTu'</span>: 543,</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>如果你需要缩略图之类的请参考官方文档： <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/04/mzitu05.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/04/mzitu05.png" alt=""></a> 将其写入 settings.py 文件中。 至此完毕！！！ 来看看效果： <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/04/mzitu04.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/04/mzitu04.png" alt=""></a> 下载速度简直飞起！！友情提示：请务必配置代理哦！ 可以参考大才哥的<a href="http://cuiqingcai.com/3443.html做一个代理，就不需要重写Scrapy中间件啦！更能避免费代理总是不能用的坑爹行为。">http://cuiqingcai.com/3443.html做一个代理，就不需要重写Scrapy中间件啦！更能避免费代理总是不能用的坑爹行为。</a> 总之省事省时又省心啊！ github 地址：<a href="https://github.com/thsheep/mzitu_scrapy" target="_blank" rel="noopener">https://github.com/thsheep/mzitu_scrapy</a></p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/哎哟卧槽" class="author" itemprop="url" rel="index">哎哟卧槽</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2017-04-24 00:37:29" itemprop="dateCreated datePublished" datetime="2017-04-24T00:37:29+08:00">2017-04-24</time>
                </span>
                <span id="/4421.html" class="post-meta-item leancloud_visitors" data-flag-title="小白进阶之Scrapy第四篇（图片下载管道篇）" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>8.5k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>8 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/4380.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="静觅丨崔庆才的个人站点专业为您提供爬虫教程,爬虫,Python,Python爬虫,Python爬虫教程,爬虫书的相关信息，想要了解更多详情，请联系我们。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/4380.html" class="post-title-link" itemprop="url">利用Scrapy爬取知乎用户详细信息并存至MongoDB</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>本节分享一下爬取知乎用户信息的Scrapy爬虫实战。</p>
                  <h2 id="本节目标"><a href="#本节目标" class="headerlink" title="本节目标"></a>本节目标</h2>
                  <p>本节要实现的内容有：</p>
                  <ul>
                    <li>从一个大V用户开始，通过递归抓取粉丝列表和关注列表，实现知乎所有用户的详细信息的抓取。</li>
                    <li>将抓取到的结果存储到MongoDB，并进行去重操作。</li>
                  </ul>
                  <h2 id="思路分析"><a href="#思路分析" class="headerlink" title="思路分析"></a>思路分析</h2>
                  <p>我们都知道每个人都有关注列表和粉丝列表，尤其对于大V来说，粉丝和关注尤其更多。 如果我们从一个大V开始，首先可以获取他的个人信息，然后我们获取他的粉丝列表和关注列表，然后遍历列表中的每一个用户，进一步抓取每一个用户的信息还有他们各自的粉丝列表和关注列表，然后再进一步遍历获取到的列表中的每一个用户，进一步抓取他们的信息和关注粉丝列表，循环往复，不断递归，这样就可以做到一爬百，百爬万，万爬百万，通过社交关系自然形成了一个爬取网，这样就可以爬到所有的用户信息了。当然零粉丝零关注的用户就忽略他们吧～ 爬取的信息怎样来获得呢？不用担心，通过分析知乎的请求就可以得到相关接口，通过请求接口就可以拿到用户详细信息和粉丝、关注列表了。 接下来我们开始实战爬取。</p>
                  <h2 id="环境需求"><a href="#环境需求" class="headerlink" title="环境需求"></a>环境需求</h2>
                  <h3 id="Python3"><a href="#Python3" class="headerlink" title="Python3"></a>Python3</h3>
                  <p>本项目使用的Python版本是Python3，项目开始之前请确保你已经安装了Python3。</p>
                  <h3 id="Scrapy"><a href="#Scrapy" class="headerlink" title="Scrapy"></a>Scrapy</h3>
                  <p>Scrapy是一个强大的爬虫框架，安装方式如下：</p>
                  <figure class="highlight cmake">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">pip3 <span class="keyword">install</span> scrapy</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h3 id="MongoDB"><a href="#MongoDB" class="headerlink" title="MongoDB"></a>MongoDB</h3>
                  <p>非关系型数据库，项目开始之前请先安装好MongoDB并启动服务。</p>
                  <h3 id="PyMongo"><a href="#PyMongo" class="headerlink" title="PyMongo"></a>PyMongo</h3>
                  <p>Python的MongoDB连接库，安装方式如下：</p>
                  <figure class="highlight cmake">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">pip3 <span class="keyword">install</span> pymongo</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h2 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h2>
                  <p>安装好以上环境之后，我们便可以开始我们的项目了。 在项目开始之首先我们用命令行创建一个项目：</p>
                  <figure class="highlight ebnf">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attribute">scrapy startproject zhihuuser</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h2 id="创建爬虫"><a href="#创建爬虫" class="headerlink" title="创建爬虫"></a>创建爬虫</h2>
                  <p>接下来我们需要创建一个spider，同样利用命令行，不过这次命令行需要进入到项目里运行。</p>
                  <figure class="highlight css">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="selector-tag">cd</span> <span class="selector-tag">zhihuuser</span></span><br><span class="line"><span class="selector-tag">scrapy</span> <span class="selector-tag">genspider</span> <span class="selector-tag">zhihu</span> <span class="selector-tag">www</span><span class="selector-class">.zhihu</span><span class="selector-class">.com</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h2 id="禁止ROBOTSTXT-OBEY"><a href="#禁止ROBOTSTXT-OBEY" class="headerlink" title="禁止ROBOTSTXT_OBEY"></a>禁止ROBOTSTXT_OBEY</h2>
                  <p>接下来你需要打开settings.py文件，将ROBOTSTXT_OBEY修改为False。</p>
                  <figure class="highlight ini">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attr">ROBOTSTXT_OBEY</span> = <span class="literal">False</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>它默认为True，就是要遵守robots.txt 的规则，那么 robots.txt 是个什么东西呢？ 通俗来说， robots.txt 是遵循 Robot 协议的一个文件，它保存在网站的服务器中，它的作用是，告诉搜索引擎爬虫，本网站哪些目录下的网页 不希望 你进行爬取收录。在Scrapy启动后，会在第一时间访问网站的 robots.txt 文件，然后决定该网站的爬取范围。 当然，我们并不是在做搜索引擎，而且在某些情况下我们想要获取的内容恰恰是被 robots.txt 所禁止访问的。所以，某些时候，我们就要将此配置项设置为 False ，拒绝遵守 Robot协议 ！ 所以在这里设置为False。当然可能本次爬取不一定会被它限制，但是我们一般来说会首先选择禁止它。</p>
                  <h2 id="尝试最初的爬取"><a href="#尝试最初的爬取" class="headerlink" title="尝试最初的爬取"></a>尝试最初的爬取</h2>
                  <p>接下来我们什么代码也不修改，执行爬取，运行如下命令：</p>
                  <figure class="highlight ebnf">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attribute">scrapy crawl zhihu</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>你会发现爬取结果会出现这样的一个错误：</p>
                  <figure class="highlight basic">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="symbol">500 </span>Internal Server <span class="keyword">Error</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>访问知乎得到的状态码是500，这说明爬取并没有成功，其实这是因为我们没有加入请求头，知乎识别User-Agent发现不是浏览器，就返回错误的响应了。 所以接下来的一步我们需要加入请求headers信息，你可以在Request的参数里加，也可以在spider里面的custom_settings里面加，当然最简单的方法莫过于在全局settings里面加了。 我们打开settings.py文件，取消DEFAULT_REQUEST_HEADERS的注释，加入如下的内容：</p>
                  <figure class="highlight 1c">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">DEFAULT_REQUEST_HEADERS = &#123;</span><br><span class="line">    'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/56.0.<span class="number">2924.87</span> Safari/537.36'</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这个是为你的请求添加请求头，如果你没有设置headers的话，它就会使用这个请求头请求，添加了User-Agent信息，所以这样我们的爬虫就可以伪装浏览器了。 接下来重新运行爬虫。</p>
                  <figure class="highlight ebnf">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attribute">scrapy crawl zhihu</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这时你就会发现得到的返回状态码就正常了。 解决了这个问题，我们接下来就可以分析页面逻辑来正式实现爬虫了。</p>
                  <h2 id="爬取流程"><a href="#爬取流程" class="headerlink" title="爬取流程"></a>爬取流程</h2>
                  <p>接下来我们需要先探寻获取用户详细信息和获取关注列表的接口。 回到网页，打开浏览器的控制台，切换到Network监听模式。 我们首先要做的是寻找一个大V，以轮子哥为例吧，它的个人信息页面网址是：<a href="https://www.zhihu.com/people/excited-vczh" target="_blank" rel="noopener">https://www.zhihu.com/people/excited-vczh</a> 首先打开轮子哥的首页 <img src="https://ww4.sinaimg.cn/large/006tKfTcly1femrd0w9qwj31kw145n1v.jpg" alt=""> 我们可以看到这里就是他的一些基本信息，我们需要抓取的就是这些，比如名字、签名、职业、关注数、赞同数等等。 接下来我们需要探索一下关注列表接口在哪里，我们点击关注选项卡，然后下拉，点击翻页，我们会在下面的请求中发现出现了 followees开头的Ajax请求。这个就是获取关注列表的接口。 <img src="https://ww1.sinaimg.cn/large/006tKfTcly1femrhdtpkoj31kw0y7jw5.jpg" alt=""> 我们观察一下这个请求结构 <img src="https://ww3.sinaimg.cn/large/006tKfTcly1femrk47kt9j31ho0sejwx.jpg" alt=""> 首先它是一个Get类型的请求，请求的URL是<a href="https://www.zhihu.com/api/v4/members/excited-vczh/followees" target="_blank" rel="noopener">https://www.zhihu.com/api/v4/members/excited-vczh/followees</a>，后面跟了三个参数，一个是include，一个是offset，一个是limit。 观察后可以发现，include是一些获取关注的人的基本信息的查询参数，包括回答数、文章数等等。 offset是偏移量，我们现在分析的是第3页的关注列表内容，offset当前为40。 limit为每一页的数量，这里是20，所以结合上面的offset可以推断，当offset为0时，获取到的是第一页关注列表，当offset为20时，获取到的是第二页关注列表，依次类推。 然后接下来看下返回结果： <img src="https://ww3.sinaimg.cn/large/006tKfTcly1femrpgchhpj31ec0ss0wb.jpg" alt=""> 可以看到有data和paging两个字段，data就是数据，包含20个内容，这些就是用户的基本信息，也就是关注列表的用户信息。 paging里面又有几个字段，is_end表示当前翻页是否结束，next是下一页的链接，所以在判读分页的时候，我们可以先利用is_end判断翻页是否结束，然后再获取next链接，请求下一页。 这样我们的关注列表就可以通过接口获取到了。 接下来我们再看下用户详情接口在哪里，我们将鼠标放到关注列表任意一个头像上面，观察下网络请求，可以发现又会出现一个Ajax请求。 <img src="https://ww3.sinaimg.cn/large/006tKfTcly1femrumazrij31kw0zjk1e.jpg" alt=""> 可以看到这次的请求链接为<a href="https://www.zhihu.com/api/v4/members/lu-jun-ya-1" target="_blank" rel="noopener">https://www.zhihu.com/api/v4/members/lu-jun-ya-1</a> 后面又一个参数include，include是一些查询参数，与刚才的接口类似，不过这次参数非常全，几乎可以把所有详情获取下来，另外接口的最后是加了用户的用户名，这个其实是url_token，上面的那个接口其实也是，在返回数据中是可以获得的。 <img src="https://ww4.sinaimg.cn/large/006tKfTcly1femrxhb8ptj313w0qy76m.jpg" alt=""> 所以综上所述：</p>
                  <ul>
                    <li>要获取用户的关注列表，我们需要请求类似 <a href="https://www.zhihu.com/api/v4/members/%7Buser%7D/followees?include={include}&amp;offset={offset}&amp;limit={limit}" target="_blank" rel="noopener">https://www.zhihu.com/api/v4/members/{user}/followees?include={include}&amp;offset={offset}&amp;limit={limit}</a> 这样的接口，其中user就是该用户的url_token，include是固定的查询参数，offset是分页偏移量，limit是一页取多少个。</li>
                    <li>要获取用户的详细信息，我们需要请求类似 <a href="https://www.zhihu.com/api/v4/members/%7Buser%7D?include={include}" target="_blank" rel="noopener">https://www.zhihu.com/api/v4/members/{user}?include={include}</a> 这样的接口，其中user就是该用户的url_token，include是查询参数。</li>
                  </ul>
                  <p>理清了如上接口逻辑后，我们就可以开始构造请求了。</p>
                  <h2 id="生成第一步请求"><a href="#生成第一步请求" class="headerlink" title="生成第一步请求"></a>生成第一步请求</h2>
                  <p>接下来我们要做的第一步当然是请求轮子哥的基本信息，然后获取轮子哥的关注列表了，我们首先构造一个格式化的url，将一些可变参数提取出来，然后需要重写start_requests方法，生成第一步的请求，接下来我们还需要根据获取到到关注列表做进一步的分析。</p>
                  <figure class="highlight reasonml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import json</span><br><span class="line">from scrapy import Spider, Request</span><br><span class="line">from zhihuuser.items import UserItem</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="constructor">ZhihuSpider(Spider)</span>:</span><br><span class="line">    name = <span class="string">"zhihu"</span></span><br><span class="line">    allowed_domains = <span class="literal">["<span class="identifier">www</span>.<span class="identifier">zhihu</span>.<span class="identifier">com</span>"]</span></span><br><span class="line">    user_url = 'https:<span class="comment">//www.zhihu.com/api/v4/members/&#123;user&#125;?include=&#123;include&#125;'</span></span><br><span class="line">    follows_url = 'https:<span class="comment">//www.zhihu.com/api/v4/members/&#123;user&#125;/followees?include=&#123;include&#125;&amp;amp;offset=&#123;offset&#125;&amp;amp;limit=&#123;limit&#125;'</span></span><br><span class="line">    start_user = 'excited-vczh'</span><br><span class="line">    user_query = 'locations,employments,gender,educations,business,voteup_count,thanked_Count,follower_count,following_count,cover_url,following_topic_count,following_question_count,following_favlists_count,following_columns_count,answer_count,articles_count,pins_count,question_count,commercial_question_count,favorite_count,favorited_count,logs_count,marked_answers_count,marked_answers_text,message_thread_token,account_status,is_active,is_force_renamed,is_bind_sina,sina_weibo_url,sina_weibo_name,show_sina_weibo,is_blocking,is_blocked,is_following,is_followed,mutual_followees_count,vote_to_count,vote_from_count,thank_to_count,thank_from_count,thanked_count,description,hosted_live_count,participated_live_count,allow_message,industry_category,org_name,org_homepage,badge<span class="literal">[?(<span class="identifier">type</span>=<span class="identifier">best_answerer</span>)]</span>.topics'</span><br><span class="line">    follows_query = 'data<span class="literal">[<span class="operator">*</span>]</span>.answer_count,articles_count,gender,follower_count,is_followed,is_following,badge<span class="literal">[?(<span class="identifier">type</span>=<span class="identifier">best_answerer</span>)]</span>.topics'</span><br><span class="line"></span><br><span class="line">    def start<span class="constructor">_requests(<span class="params">self</span>)</span>:</span><br><span class="line">        yield <span class="constructor">Request(<span class="params">self</span>.<span class="params">user_url</span>.<span class="params">format</span>(<span class="params">user</span>=<span class="params">self</span>.<span class="params">start_user</span>, <span class="params">include</span>=<span class="params">self</span>.<span class="params">user_query</span>)</span>, self.parse_user)</span><br><span class="line">        yield <span class="constructor">Request(<span class="params">self</span>.<span class="params">follows_url</span>.<span class="params">format</span>(<span class="params">user</span>=<span class="params">self</span>.<span class="params">start_user</span>, <span class="params">include</span>=<span class="params">self</span>.<span class="params">follows_query</span>, <span class="params">limit</span>=20, <span class="params">offset</span>=0)</span>,</span><br><span class="line">                      self.parse_follows)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>然后我们实现一下两个解析方法parse_user和parse_follows。</p>
                  <figure class="highlight ruby">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_user</span><span class="params">(<span class="keyword">self</span>, response)</span></span><span class="symbol">:</span></span><br><span class="line">    print(response.text)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_follows</span><span class="params">(<span class="keyword">self</span>, response)</span></span><span class="symbol">:</span></span><br><span class="line">    print(response.text)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>最简单的实现他们的结果输出即可，然后运行观察结果。</p>
                  <figure class="highlight ebnf">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attribute">scrapy crawl zhihu</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这时你会发现出现了</p>
                  <figure class="highlight basic">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="symbol">401 </span>HTTP status code is <span class="keyword">not</span> handled <span class="keyword">or</span> <span class="keyword">not</span> allowed</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>访问被禁止了，这时我们观察下浏览器请求，发现它相比之前的请求多了一个OAuth请求头。 <img src="https://ww3.sinaimg.cn/large/006tKfTcly1femsckhmbxj30zy0qsaem.jpg" alt=""></p>
                  <h2 id="OAuth"><a href="#OAuth" class="headerlink" title="OAuth"></a>OAuth</h2>
                  <p>它是Open Authorization的缩写。 OAUTH_token:OAUTH进行到最后一步得到的一个“令牌”，通过此“令牌”请求，就可以去拥有资源的网站抓取任意有权限可以被抓取的资源。 在这里我知乎并没有登陆，这里的OAuth值是</p>
                  <figure class="highlight llvm">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">oauth <span class="keyword">c</span><span class="number">3</span>cef<span class="number">7</span><span class="keyword">c</span><span class="number">66</span>a<span class="number">1843</span>f<span class="number">8</span>b<span class="number">3</span>a<span class="number">9e6</span>a<span class="number">1e3160</span>e<span class="number">20</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>经过我长久的观察，这个一直不会改变，所以可以长久使用，我们将它配置到DEFAULT_REQUEST_HEADERS里，这样它就变成了：</p>
                  <figure class="highlight 1c">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">DEFAULT_REQUEST_HEADERS = &#123;</span><br><span class="line">    'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/56.0.<span class="number">2924.87</span> Safari/537.36',</span><br><span class="line">    'authorization': 'oauth c3cef7c66a<span class="number">1843</span>f8b3a9e6a1e<span class="number">3160</span>e20',</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>接下来如果我们重新运行爬虫，就可以发现可以正常爬取了。</p>
                  <h2 id="parse-user"><a href="#parse-user" class="headerlink" title="parse_user"></a>parse_user</h2>
                  <p>接下来我们处理一下用户基本信息，首先我们查看一下接口信息会返回一些什么数据。 <img src="https://ww3.sinaimg.cn/large/006tKfTcly1femsgc32lzj31900r241a.jpg" alt=""> 可以看到返回的结果非常全，在这里我们直接声明一个Item全保存下就好了。 在items里新声明一个UserItem</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> scrapy <span class="keyword">import</span> Item, Field</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="symbol">UserItem</span>(<span class="symbol">Item</span>):</span><br><span class="line">    # <span class="symbol">define</span> <span class="symbol">the</span> <span class="symbol">fields</span> <span class="symbol">for</span> <span class="symbol">your</span> <span class="symbol">item</span> <span class="symbol">here</span> <span class="symbol">like:</span></span><br><span class="line">    <span class="symbol">id</span> = <span class="symbol">Field</span>()</span><br><span class="line">    <span class="symbol">name</span> = <span class="symbol">Field</span>()</span><br><span class="line">    <span class="symbol">avatar_url</span> = <span class="symbol">Field</span>()</span><br><span class="line">    <span class="symbol">headline</span> = <span class="symbol">Field</span>()</span><br><span class="line">    <span class="symbol">description</span> = <span class="symbol">Field</span>()</span><br><span class="line">    <span class="symbol">url</span> = <span class="symbol">Field</span>()</span><br><span class="line">    <span class="symbol">url_token</span> = <span class="symbol">Field</span>()</span><br><span class="line">    <span class="symbol">gender</span> = <span class="symbol">Field</span>()</span><br><span class="line">    <span class="symbol">cover_url</span> = <span class="symbol">Field</span>()</span><br><span class="line">    <span class="symbol">type</span> = <span class="symbol">Field</span>()</span><br><span class="line">    <span class="symbol">badge</span> = <span class="symbol">Field</span>()</span><br><span class="line"></span><br><span class="line">    <span class="symbol">answer_count</span> = <span class="symbol">Field</span>()</span><br><span class="line">    <span class="symbol">articles_count</span> = <span class="symbol">Field</span>()</span><br><span class="line">    <span class="symbol">commercial_question_count</span> = <span class="symbol">Field</span>()</span><br><span class="line">    <span class="symbol">favorite_count</span> = <span class="symbol">Field</span>()</span><br><span class="line">    <span class="symbol">favorited_count</span> = <span class="symbol">Field</span>()</span><br><span class="line">    <span class="symbol">follower_count</span> = <span class="symbol">Field</span>()</span><br><span class="line">    <span class="symbol">following_columns_count</span> = <span class="symbol">Field</span>()</span><br><span class="line">    <span class="symbol">following_count</span> = <span class="symbol">Field</span>()</span><br><span class="line">    <span class="symbol">pins_count</span> = <span class="symbol">Field</span>()</span><br><span class="line">    <span class="symbol">question_count</span> = <span class="symbol">Field</span>()</span><br><span class="line">    <span class="symbol">thank_from_count</span> = <span class="symbol">Field</span>()</span><br><span class="line">    <span class="symbol">thank_to_count</span> = <span class="symbol">Field</span>()</span><br><span class="line">    <span class="symbol">thanked_count</span> = <span class="symbol">Field</span>()</span><br><span class="line">    <span class="symbol">vote_from_count</span> = <span class="symbol">Field</span>()</span><br><span class="line">    <span class="symbol">vote_to_count</span> = <span class="symbol">Field</span>()</span><br><span class="line">    <span class="symbol">voteup_count</span> = <span class="symbol">Field</span>()</span><br><span class="line">    <span class="symbol">following_favlists_count</span> = <span class="symbol">Field</span>()</span><br><span class="line">    <span class="symbol">following_question_count</span> = <span class="symbol">Field</span>()</span><br><span class="line">    <span class="symbol">following_topic_count</span> = <span class="symbol">Field</span>()</span><br><span class="line">    <span class="symbol">marked_answers_count</span> = <span class="symbol">Field</span>()</span><br><span class="line">    <span class="symbol">mutual_followees_count</span> = <span class="symbol">Field</span>()</span><br><span class="line">    <span class="symbol">hosted_live_count</span> = <span class="symbol">Field</span>()</span><br><span class="line">    <span class="symbol">participated_live_count</span> = <span class="symbol">Field</span>()</span><br><span class="line"></span><br><span class="line">    <span class="symbol">locations</span> = <span class="symbol">Field</span>()</span><br><span class="line">    <span class="symbol">educations</span> = <span class="symbol">Field</span>()</span><br><span class="line">    <span class="symbol">employments</span> = <span class="symbol">Field</span>()</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>所以在解析方法里面我们解析得到的response内容，然后转为json对象，然后依次判断字段是否存在，赋值就好了。</p>
                  <figure class="highlight livecodeserver">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="built_in">result</span> = json.loads(response.<span class="keyword">text</span>)</span><br><span class="line"><span class="keyword">item</span> = UserItem()</span><br><span class="line"><span class="keyword">for</span> field <span class="keyword">in</span> <span class="keyword">item</span>.fields:</span><br><span class="line">    <span class="keyword">if</span> field <span class="keyword">in</span> <span class="built_in">result</span>.<span class="built_in">keys</span>():</span><br><span class="line">        <span class="keyword">item</span>[field] = <span class="built_in">result</span>.<span class="built_in">get</span>(field)</span><br><span class="line">yield <span class="keyword">item</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>得到item后通过yield返回就好了。 这样保存用户基本信息就完成了。 接下来我们还需要在这里获取这个用户的关注列表，所以我们需要再重新发起一个获取关注列表的request 在parse_user后面再添加如下代码：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">yield Request(</span><br><span class="line">            self.follows_url.format(<span class="attribute">user</span>=result.get('url_token'), <span class="attribute">include</span>=self.follows_query, <span class="attribute">limit</span>=20, <span class="attribute">offset</span>=0),</span><br><span class="line">            self.parse_follows)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样我们又生成了获取该用户关注列表的请求。</p>
                  <h2 id="parse-follows"><a href="#parse-follows" class="headerlink" title="parse_follows"></a>parse_follows</h2>
                  <p>接下来我们处理一下关注列表，首先也是解析response的文本，然后要做两件事：</p>
                  <ul>
                    <li>通过关注列表的每一个用户，对每一个用户发起请求，获取其详细信息。</li>
                    <li>处理分页，判断paging内容，获取下一页关注列表。</li>
                  </ul>
                  <p>所以在这里将parse_follows改写如下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">results = json.loads(response.text)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">'data'</span> <span class="keyword">in</span> results.keys():</span><br><span class="line">    <span class="keyword">for</span> result <span class="keyword">in</span> results.<span class="builtin-name">get</span>(<span class="string">'data'</span>):</span><br><span class="line">        yield Request(self.user_url.format(<span class="attribute">user</span>=result.get('url_token'), <span class="attribute">include</span>=self.user_query),</span><br><span class="line">                      self.parse_user)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">'paging'</span> <span class="keyword">in</span> results.keys() <span class="keyword">and</span> results.<span class="builtin-name">get</span>(<span class="string">'paging'</span>).<span class="builtin-name">get</span>(<span class="string">'is_end'</span>) == <span class="literal">False</span>:</span><br><span class="line">    next_page = results.<span class="builtin-name">get</span>(<span class="string">'paging'</span>).<span class="builtin-name">get</span>(<span class="string">'next'</span>)</span><br><span class="line">    yield Request(next_page,</span><br><span class="line">                  self.parse_follows)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样，整体代码如下：</p>
                  <figure class="highlight ruby">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line">import json</span><br><span class="line"></span><br><span class="line">from scrapy import Spider, Request</span><br><span class="line">from zhihuuser.items import UserItem</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ZhihuSpider</span>(<span class="title">Spider</span>):</span></span><br><span class="line">    name = <span class="string">"zhihu"</span></span><br><span class="line">    allowed_domains = [<span class="string">"www.zhihu.com"</span>]</span><br><span class="line">    user_url = <span class="string">'https://www.zhihu.com/api/v4/members/&#123;user&#125;?include=&#123;include&#125;'</span></span><br><span class="line">    follows_url = <span class="string">'https://www.zhihu.com/api/v4/members/&#123;user&#125;/followees?include=&#123;include&#125;&amp;amp;offset=&#123;offset&#125;&amp;amp;limit=&#123;limit&#125;'</span></span><br><span class="line">    start_user = <span class="string">'excited-vczh'</span></span><br><span class="line">    user_query = <span class="string">'locations,employments,gender,educations,business,voteup_count,thanked_Count,follower_count,following_count,cover_url,following_topic_count,following_question_count,following_favlists_count,following_columns_count,answer_count,articles_count,pins_count,question_count,commercial_question_count,favorite_count,favorited_count,logs_count,marked_answers_count,marked_answers_text,message_thread_token,account_status,is_active,is_force_renamed,is_bind_sina,sina_weibo_url,sina_weibo_name,show_sina_weibo,is_blocking,is_blocked,is_following,is_followed,mutual_followees_count,vote_to_count,vote_from_count,thank_to_count,thank_from_count,thanked_count,description,hosted_live_count,participated_live_count,allow_message,industry_category,org_name,org_homepage,badge[?(type=best_answerer)].topics'</span></span><br><span class="line">    follows_query = <span class="string">'data[*].answer_count,articles_count,gender,follower_count,is_followed,is_following,badge[?(type=best_answerer)].topics'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_requests</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">yield</span> Request(<span class="keyword">self</span>.user_url.format(user=<span class="keyword">self</span>.start_user, <span class="keyword">include</span>=<span class="keyword">self</span>.user_query), <span class="keyword">self</span>.parse_user)</span><br><span class="line">        <span class="keyword">yield</span> Request(<span class="keyword">self</span>.follows_url.format(user=<span class="keyword">self</span>.start_user, <span class="keyword">include</span>=<span class="keyword">self</span>.follows_query, limit=<span class="number">20</span>, offset=<span class="number">0</span>),</span><br><span class="line">                      <span class="keyword">self</span>.parse_follows)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse_user</span><span class="params">(<span class="keyword">self</span>, response)</span></span><span class="symbol">:</span></span><br><span class="line">        result = json.loads(response.text)</span><br><span class="line">        item = UserItem()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> field <span class="keyword">in</span> item.<span class="symbol">fields:</span></span><br><span class="line">            <span class="keyword">if</span> field <span class="keyword">in</span> result.keys()<span class="symbol">:</span></span><br><span class="line">                item[field] = result.get(field)</span><br><span class="line">        <span class="keyword">yield</span> item</span><br><span class="line"></span><br><span class="line">        <span class="keyword">yield</span> Request(</span><br><span class="line">            <span class="keyword">self</span>.follows_url.format(user=result.get(<span class="string">'url_token'</span>), <span class="keyword">include</span>=<span class="keyword">self</span>.follows_query, limit=<span class="number">20</span>, offset=<span class="number">0</span>),</span><br><span class="line">            <span class="keyword">self</span>.parse_follows)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse_follows</span><span class="params">(<span class="keyword">self</span>, response)</span></span><span class="symbol">:</span></span><br><span class="line">        results = json.loads(response.text)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'data'</span> <span class="keyword">in</span> results.keys()<span class="symbol">:</span></span><br><span class="line">            <span class="keyword">for</span> result <span class="keyword">in</span> results.get(<span class="string">'data'</span>)<span class="symbol">:</span></span><br><span class="line">                <span class="keyword">yield</span> Request(<span class="keyword">self</span>.user_url.format(user=result.get(<span class="string">'url_token'</span>), <span class="keyword">include</span>=<span class="keyword">self</span>.user_query),</span><br><span class="line">                              <span class="keyword">self</span>.parse_user)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'paging'</span> <span class="keyword">in</span> results.keys() <span class="keyword">and</span> results.get(<span class="string">'paging'</span>).get(<span class="string">'is_end'</span>) == <span class="symbol">False:</span></span><br><span class="line">            next_page = results.get(<span class="string">'paging'</span>).get(<span class="string">'next'</span>)</span><br><span class="line">            <span class="keyword">yield</span> Request(next_page,</span><br><span class="line">                          <span class="keyword">self</span>.parse_follows)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样我们就完成了获取用户基本信息，然后递归获取关注列表进一步请求了。 重新运行爬虫，可以发现当前已经可以实现循环递归爬取了。</p>
                  <h2 id="followers"><a href="#followers" class="headerlink" title="followers"></a>followers</h2>
                  <p>上面我们实现了通过获取关注列表实现爬取循环，那这里少不了的还有粉丝列表，经过分析后发现粉丝列表的api也类似，只不过把followee换成了follower，其他的完全相同，所以我们按照同样的逻辑添加followers相关信息， 最终spider代码如下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line">import json</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> scrapy import Spider, Request</span><br><span class="line"><span class="keyword">from</span> zhihuuser.items import UserItem</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class ZhihuSpider(Spider):</span><br><span class="line">    name = <span class="string">"zhihu"</span></span><br><span class="line">    allowed_domains = [<span class="string">"www.zhihu.com"</span>]</span><br><span class="line">    user_url = <span class="string">'https://www.zhihu.com/api/v4/members/&#123;user&#125;?include=&#123;include&#125;'</span></span><br><span class="line">    follows_url = <span class="string">'https://www.zhihu.com/api/v4/members/&#123;user&#125;/followees?include=&#123;include&#125;&amp;offset=&#123;offset&#125;&amp;limit=&#123;limit&#125;'</span></span><br><span class="line">    followers_url = <span class="string">'https://www.zhihu.com/api/v4/members/&#123;user&#125;/followers?include=&#123;include&#125;&amp;offset=&#123;offset&#125;&amp;limit=&#123;limit&#125;'</span></span><br><span class="line">    start_user = <span class="string">'tianshansoft'</span></span><br><span class="line">    user_query = <span class="string">'locations,employments,gender,educations,business,voteup_count,thanked_Count,follower_count,following_count,cover_url,following_topic_count,following_question_count,following_favlists_count,following_columns_count,answer_count,articles_count,pins_count,question_count,commercial_question_count,favorite_count,favorited_count,logs_count,marked_answers_count,marked_answers_text,message_thread_token,account_status,is_active,is_force_renamed,is_bind_sina,sina_weibo_url,sina_weibo_name,show_sina_weibo,is_blocking,is_blocked,is_following,is_followed,mutual_followees_count,vote_to_count,vote_from_count,thank_to_count,thank_from_count,thanked_count,description,hosted_live_count,participated_live_count,allow_message,industry_category,org_name,org_homepage,badge[?(type=best_answerer)].topics'</span></span><br><span class="line">    follows_query = <span class="string">'data[*].answer_count,articles_count,gender,follower_count,is_followed,is_following,badge[?(type=best_answerer)].topics'</span></span><br><span class="line">    followers_query = <span class="string">'data[*].answer_count,articles_count,gender,follower_count,is_followed,is_following,badge[?(type=best_answerer)].topics'</span></span><br><span class="line"></span><br><span class="line">    def start_requests(self):</span><br><span class="line">        yield Request(self.user_url.format(<span class="attribute">user</span>=self.start_user, <span class="attribute">include</span>=self.user_query), self.parse_user)</span><br><span class="line">        yield Request(self.follows_url.format(<span class="attribute">user</span>=self.start_user, <span class="attribute">include</span>=self.follows_query, <span class="attribute">limit</span>=20, <span class="attribute">offset</span>=0),</span><br><span class="line">                      self.parse_follows)</span><br><span class="line">        yield Request(self.followers_url.format(<span class="attribute">user</span>=self.start_user, <span class="attribute">include</span>=self.followers_query, <span class="attribute">limit</span>=20, <span class="attribute">offset</span>=0),</span><br><span class="line">                      self.parse_followers)</span><br><span class="line"></span><br><span class="line">    def parse_user(self, response):</span><br><span class="line">        result = json.loads(response.text)</span><br><span class="line">        item = UserItem()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> field <span class="keyword">in</span> item.fields:</span><br><span class="line">            <span class="keyword">if</span> field <span class="keyword">in</span> result.keys():</span><br><span class="line">                item[field] = result.<span class="builtin-name">get</span>(field)</span><br><span class="line">        yield item</span><br><span class="line"></span><br><span class="line">        yield Request(</span><br><span class="line">            self.follows_url.format(<span class="attribute">user</span>=result.get('url_token'), <span class="attribute">include</span>=self.follows_query, <span class="attribute">limit</span>=20, <span class="attribute">offset</span>=0),</span><br><span class="line">            self.parse_follows)</span><br><span class="line"></span><br><span class="line">        yield Request(</span><br><span class="line">            self.followers_url.format(<span class="attribute">user</span>=result.get('url_token'), <span class="attribute">include</span>=self.followers_query, <span class="attribute">limit</span>=20, <span class="attribute">offset</span>=0),</span><br><span class="line">            self.parse_followers)</span><br><span class="line"></span><br><span class="line">    def parse_follows(self, response):</span><br><span class="line">        results = json.loads(response.text)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'data'</span> <span class="keyword">in</span> results.keys():</span><br><span class="line">            <span class="keyword">for</span> result <span class="keyword">in</span> results.<span class="builtin-name">get</span>(<span class="string">'data'</span>):</span><br><span class="line">                yield Request(self.user_url.format(<span class="attribute">user</span>=result.get('url_token'), <span class="attribute">include</span>=self.user_query),</span><br><span class="line">                              self.parse_user)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'paging'</span> <span class="keyword">in</span> results.keys() <span class="keyword">and</span> results.<span class="builtin-name">get</span>(<span class="string">'paging'</span>).<span class="builtin-name">get</span>(<span class="string">'is_end'</span>) == <span class="literal">False</span>:</span><br><span class="line">            next_page = results.<span class="builtin-name">get</span>(<span class="string">'paging'</span>).<span class="builtin-name">get</span>(<span class="string">'next'</span>)</span><br><span class="line">            yield Request(next_page,</span><br><span class="line">                          self.parse_follows)</span><br><span class="line"></span><br><span class="line">    def parse_followers(self, response):</span><br><span class="line">        results = json.loads(response.text)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'data'</span> <span class="keyword">in</span> results.keys():</span><br><span class="line">            <span class="keyword">for</span> result <span class="keyword">in</span> results.<span class="builtin-name">get</span>(<span class="string">'data'</span>):</span><br><span class="line">                yield Request(self.user_url.format(<span class="attribute">user</span>=result.get('url_token'), <span class="attribute">include</span>=self.user_query),</span><br><span class="line">                              self.parse_user)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'paging'</span> <span class="keyword">in</span> results.keys() <span class="keyword">and</span> results.<span class="builtin-name">get</span>(<span class="string">'paging'</span>).<span class="builtin-name">get</span>(<span class="string">'is_end'</span>) == <span class="literal">False</span>:</span><br><span class="line">            next_page = results.<span class="builtin-name">get</span>(<span class="string">'paging'</span>).<span class="builtin-name">get</span>(<span class="string">'next'</span>)</span><br><span class="line">            yield Request(next_page,</span><br><span class="line">                          self.parse_followers)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>需要改变的位置有</p>
                  <ul>
                    <li>start_requests里面添加yield followers信息</li>
                    <li>parse_user里面里面添加yield followers信息</li>
                    <li>parse_followers做相应的的抓取详情请求和翻页。</li>
                  </ul>
                  <p>如此一来，spider就完成了，这样我们就可以实现通过社交网络递归的爬取，把用户详情都爬下来。</p>
                  <h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2>
                  <p>通过以上的spider，我们实现了如上逻辑：</p>
                  <ul>
                    <li>start_requests方法，实现了第一个大V用户的详细信息请求还有他的粉丝和关注列表请求。</li>
                    <li>parse_user方法，实现了详细信息的提取和粉丝关注列表的获取。</li>
                    <li>paese_follows，实现了通过关注列表重新请求用户并进行翻页的功能。</li>
                    <li>paese_followers，实现了通过粉丝列表重新请求用户并进行翻页的功能。</li>
                  </ul>
                  <h2 id="加入pipeline"><a href="#加入pipeline" class="headerlink" title="加入pipeline"></a>加入pipeline</h2>
                  <p>在这里数据库存储使用MongoDB，所以在这里我们需要借助于Item Pipeline，实现如下：</p>
                  <figure class="highlight ruby">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MongoPipeline</span>(<span class="title">object</span>):</span></span><br><span class="line">    collection_name = <span class="string">'users'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(<span class="keyword">self</span>, mongo_uri, mongo_db)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">self</span>.mongo_uri = mongo_uri</span><br><span class="line">        <span class="keyword">self</span>.mongo_db = mongo_db</span><br><span class="line"></span><br><span class="line">    @classmethod</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">from_crawler</span><span class="params">(cls, crawler)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">return</span> cls(</span><br><span class="line">            mongo_uri=crawler.settings.get(<span class="string">'MONGO_URI'</span>),</span><br><span class="line">            mongo_db=crawler.settings.get(<span class="string">'MONGO_DATABASE'</span>)</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">open_spider</span><span class="params">(<span class="keyword">self</span>, spider)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">self</span>.client = pymongo.MongoClient(<span class="keyword">self</span>.mongo_uri)</span><br><span class="line">        <span class="keyword">self</span>.db = <span class="keyword">self</span>.client[<span class="keyword">self</span>.mongo_db]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close_spider</span><span class="params">(<span class="keyword">self</span>, spider)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">self</span>.client.close()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_item</span><span class="params">(<span class="keyword">self</span>, item, spider)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">self</span>.db[<span class="keyword">self</span>.collection_name].update(&#123;<span class="string">'url_token'</span>: item[<span class="string">'url_token'</span>]&#125;, &#123;<span class="string">'$set'</span>: dict(item)&#125;, True)</span><br><span class="line">        <span class="keyword">return</span> item</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>比较重要的一点就在于process_item，在这里使用了update方法，第一个参数传入查询条件，这里使用的是url_token，第二个参数传入字典类型的对象，就是我们的item，第三个参数传入True，这样就可以保证，如果查询数据存在的话就更新，不存在的话就插入。这样就可以保证去重了。 另外记得开启一下Item Pileline</p>
                  <figure class="highlight ebnf">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attribute">ITEM_PIPELINES</span> = &#123;</span><br><span class="line">    <span class="string">'zhihuuser.pipelines.MongoPipeline'</span>: 300,</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>然后重新运行爬虫</p>
                  <figure class="highlight ebnf">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attribute">scrapy crawl zhihu</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样就可以发现正常的输出了，会一直不停地运行，用户也一个个被保存到数据库。 <img src="https://ww3.sinaimg.cn/large/006tKfTcly1femt2bisibj31kw0qa7fr.jpg" alt=""> 看下MongoDB，里面我们爬取的用户详情结果。 <img src="https://ww4.sinaimg.cn/large/006tKfTcgy1femtnv605cj31kw134guj.jpg" alt=""> 到现在为止，整个爬虫就基本完结了，我们主要通过递归的方式实现了这个逻辑。存储结果也通过适当的方法实现了去重。</p>
                  <h2 id="更高效率"><a href="#更高效率" class="headerlink" title="更高效率"></a>更高效率</h2>
                  <p>当然我们现在运行的是单机爬虫，只在一台电脑上运行速度是有限的，所以后面我们要想提高抓取效率，需要用到分布式爬虫，在这里需要用到Redis来维护一个公共的爬取队列。 更多的分布式爬虫的实现可以查看<a href="https://edu.hellobi.com/course/157" target="_blank" rel="noopener">自己动手，丰衣足食！Python3网络爬虫实战案例</a></p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2017-04-15 03:36:48" itemprop="dateCreated datePublished" datetime="2017-04-15T03:36:48+08:00">2017-04-15</time>
                </span>
                <span id="/4380.html" class="post-meta-item leancloud_visitors" data-flag-title="利用Scrapy爬取知乎用户详细信息并存至MongoDB" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>15k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>14 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/4352.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="静觅丨崔庆才的个人站点专业为您提供爬虫教程,爬虫,Python,Python爬虫,Python爬虫教程,爬虫书的相关信息，想要了解更多详情，请联系我们。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/4352.html" class="post-title-link" itemprop="url">小白学爬虫系列教程</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p><a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/QQ图片20161021225948.jpg" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/QQ图片20161021225948.jpg" alt="QQ图片20161021225948"></a> 听大才哥说好像我的文章挺难找的，这整理一下。</p>
                  <h2 id="基础知识篇："><a href="#基础知识篇：" class="headerlink" title="基础知识篇："></a>基础知识篇：</h2>
                  <p>这玩意儿我没写，各位参考大才哥的： <a href="http://cuiqingcai.com/1052.html">Python 爬虫学习系列教程</a> <a href="http://cuiqingcai.com/4320.html">Python3 爬虫学习视频教程</a></p>
                  <h2 id="小白系列教程"><a href="#小白系列教程" class="headerlink" title="小白系列教程"></a>小白系列教程</h2>
                  <p><a href="http://cuiqingcai.com/3179.html">小白爬虫第一弹之抓取妹子图</a> <a href="http://cuiqingcai.com/3256.html">小白爬虫第二弹之健壮的小爬虫</a> <a href="http://cuiqingcai.com/3314.html">小白爬虫第三弹之去重去重</a> <a href="http://cuiqingcai.com/3363.html">小白爬虫第四弹之爬虫快跑（多进程+多线程）</a> <a href="http://cuiqingcai.com/3472.html">小白进阶之 Scrapy 第一篇</a> <a href="http://cuiqingcai.com/3952.html">小白进阶之 Scrapy 第二篇（登录篇）</a> <a href="http://cuiqingcai.com/4048.html">小白进阶之</a><a href="http://cuiqingcai.com/4020.html">Scrapy 分布式的前篇—让 redis 和 MongoDB 安全点</a> <a href="http://cuiqingcai.com/4048.html">小白进阶之 Scrapy 第三篇（基于 Scrapy-Redis 的分布式以及 cookies 池）</a> <a href="http://cuiqingcai.com/4421.html">小白进阶之 Scrapy 第四篇（图片下载管道篇）</a> <a href="http://cuiqingcai.com/4725.html">小白进阶之 Scrapy 第五篇（Scrapy-Splash 配合 CrawlSpider；瞎几把整的）</a> <a href="http://cuiqingcai.com/4652.html">利用新接口抓取微信公众号的所有文章</a> <a href="https://cuiqingcai.com/6058.html">小白进阶之</a><a href="http://cuiqingcai.com/4725.html">Scrapy 第六篇</a><a href="https://cuiqingcai.com/6058.html">Scrapy-Redis 详解</a> <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/QQ图片20161021225948.jpg" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/QQ图片20161021225948.jpg" alt="QQ图片20161021225948"></a> 暂时就这些了、最近工作刚入职。上了个新项目，没时间更新文章了（主要是我懒、挤点时间都用来打 LOL 了···············尴尬脸） 等项目第一期结束了，我会把以前许诺的 ：JS 异步加载 | 动态爬虫 更新出来。 感谢大才哥的平台（有兴趣的小伙伴一起来更新文章啊！ 才不会告诉你们：我扯着大才哥的大旗找了个不错的工作。手动笑哭······） <strong>如果以上网站有更改无法正常采集，请 PM 我一下，我尽量保证 demo 的可用性</strong></p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/哎哟卧槽" class="author" itemprop="url" rel="index">哎哟卧槽</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2017-04-11 20:31:03" itemprop="dateCreated datePublished" datetime="2017-04-11T20:31:03+08:00">2017-04-11</time>
                </span>
                <span id="/4352.html" class="post-meta-item leancloud_visitors" data-flag-title="小白学爬虫系列教程" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>569</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>1 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/4347.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="静觅丨崔庆才的个人站点专业为您提供爬虫教程,爬虫,Python,Python爬虫,Python爬虫教程,爬虫书的相关信息，想要了解更多详情，请联系我们。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Other <i class="label-arrow"></i>
                  </a>
                  <a href="/4347.html" class="post-title-link" itemprop="url">本站投稿功能已关闭</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <h2 id="公告"><a href="#公告" class="headerlink" title="公告"></a>公告</h2>
                  <p>大家好，本站于今日（2017.4.11）关闭投稿功能。</p>
                  <h2 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h2>
                  <p>由于之前本站开放了投稿注册接口，该接口现在被人利用，每天都会发送垃圾邮件，经常导致邮箱发信过多而被冻结，而WordPress本身没有提供验证码验证，所以自己也不想再去修改，当然最主要的是能发优质文章的又是少之又少，经常会出现一些垃圾草稿，所以博主决定直接将投稿功能关闭，希望大家可以理解。</p>
                  <h2 id="投稿"><a href="#投稿" class="headerlink" title="投稿"></a>投稿</h2>
                  <p>如果您有在本站投稿意向，请直接联系我邮件cqc@cuiqingcai.com，我为您注册账号并开通写作权限。</p>
                  <h2 id="鸣谢"><a href="#鸣谢" class="headerlink" title="鸣谢"></a>鸣谢</h2>
                  <p>非常感谢在本站投稿的童鞋，尤其是卧槽哥，发表了很多篇高质量爬虫文章。另外还有戴笠兄也是，不过后来戴笠兄的文章因为开车过猛而下架了哈哈，不过还是非常感谢。另外也非常感谢其他在本站投稿的小伙伴，在这不一一点名啦！</p>
                  <h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2>
                  <p>最后希望大家可以理解，也非常感谢大家的支持！前一段时间忙着在录制爬虫视频，今天刚刚收尾，现在已经更新完毕，后面我将学习一些数据分析、自然语言处理、Web安全方面的知识分享给大家，希望大家多多支持！感谢！</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2017-04-11 20:03:03" itemprop="dateCreated datePublished" datetime="2017-04-11T20:03:03+08:00">2017-04-11</time>
                </span>
                <span id="/4347.html" class="post-meta-item leancloud_visitors" data-flag-title="本站投稿功能已关闭" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>440</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>1 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/4320.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="静觅丨崔庆才的个人站点专业为您提供爬虫教程,爬虫,Python,Python爬虫,Python爬虫教程,爬虫书的相关信息，想要了解更多详情，请联系我们。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/4320.html" class="post-title-link" itemprop="url">Python3爬虫视频学习教程</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <h2 id="2022-年-Python3-网络爬虫教程"><a href="#2022-年-Python3-网络爬虫教程" class="headerlink" title="2022 年 Python3 网络爬虫教程"></a>2022 年 Python3 网络爬虫教程</h2>
                  <p>大家好，我是崔庆才，由于爬虫技术不断迭代升级，一些旧的教程已经过时、案例已经过期，最前沿的爬虫技术比如异步、JavaScript 逆向、安卓逆向、智能解析、WebAssembly、大规模分布式、Kubernetes 等技术层出不穷，我最近新出了一套最新最全面的 Python3 网络爬虫系列教程。</p>
                  <blockquote>
                    <p>博主自荐：截止 2022 年，可以将最前沿最全面的爬虫技术都涵盖的教程，如异步、JavaScript 逆向、安卓逆向、智能解析、WebAssembly、大规模分布式、Kubernetes 等，市面上目前就这一套了。</p>
                  </blockquote>
                  <p>最新教程对旧的爬虫技术文章进行了全面更新，搭建了全新的案例平台进行全面讲解，保证案例稳定有效不过期。</p>
                  <p>教程请移步：</p>
                  <p><a href="https://cuiqingcai.com/17777.html">【2022 版】Python3 网络爬虫学习教程</a></p>
                  <h2 id="2018-年-Python3-网络爬虫视频课程链接"><a href="#2018-年-Python3-网络爬虫视频课程链接" class="headerlink" title="2018 年 Python3 网络爬虫视频课程链接"></a>2018 年 Python3 网络爬虫视频课程链接</h2>
                  <p>以下为 2018 年 Python3 网络爬虫视频课程</p>
                  <p><strong>天善智能：<a href="https://edu.hellobi.com/course/157" target="_blank" rel="noopener">自己动手，丰衣足食！Python3 网络爬虫实战案例</a></strong> <strong>网易云课堂：<a href="http://study.163.com/course/courseMain.htm?courseId=1003827039&amp;utm_campaign=commission&amp;utm_source=cp-1018878377&amp;utm_medium=share" target="_blank" rel="noopener">自己动手，丰衣足食！Python3 网络爬虫实战案例</a></strong></p>
                  <h2 id="课程简介"><a href="#课程简介" class="headerlink" title="课程简介"></a>课程简介</h2>
                  <p>大家好哈，现在呢静觅博客已经两年多啦，可能大家过来更多看到的是爬虫方面的博文，首先非常感谢大家的支持，希望我的博文对大家有帮助！ 之前我写了一些 Python 爬虫方面的文章，<a href="http://cuiqingcai.com/1052.html">Python 爬虫学习系列教程</a>，涉及到了基础和进阶的一些内容，当时更多用到的是 Urllib 还有正则，后来又陆续增加了一些文章，在学习过程中慢慢积累慢慢成型了一套算不上教程的教程，后来有越来越多的小伙伴学习和支持我感到非常开心，再次感谢大家！ 不过其实这些教程总的来说有一些问题：</p>
                  <ol>
                    <li>当时用的 Python2 写的，刚写的时候 Scrapy 这个框架也没有支持 Python3，一些 Python3 爬虫库也不怎么成熟，所以当时选择了 Python2。但到现在，Python3 发展迅速，爬虫库也越来越成熟，而且 Python2 在不久的将来就会停止维护了，所以慢慢地，我的语言重心也慢慢转向了 Python3，我也相信 Python3 会成为主流。所以说之前的一套课程算是有点过时了，相信大家肯定还在寻找 Python3 的一些教程。</li>
                    <li>当时学习的时候主要用的 urllib，正则，所以这些文章的较大篇幅也都是 urllib 和正则的一些东西，后来的一些高级库都是在后面慢慢加的，而且一些高级的框架用法也没有做深入讲解，所以感觉整个内容有点头重脚轻，安排不合理。而且现在分布式越来越火，那么分布式爬虫的应用相必也是越来越广泛，之前的课程也没有做系统讲解。</li>
                    <li>在介绍一些操作的时候可能介绍不全面，环境的配置也没有兼顾各个平台，所以可能有些小伙伴摸不着头脑，可能卡在某一步不知道接下来是怎么做的了。</li>
                  </ol>
                  <p>那么综合上面的问题呢，最近我花了前前后后将近一个月的时间录制了一套新的 Pyhthon3 爬虫视频教程，将我之前做爬虫的一些经验重新梳理和整合，利用 Python3 编写，从环境配置、基础库讲解到案例实战、框架使用，最后再到分布式爬虫进行了比较系统的讲解。 课程内容是这个样子的：</p>
                  <h3 id="一、环境篇"><a href="#一、环境篇" class="headerlink" title="一、环境篇"></a><strong>一、环境篇</strong></h3>
                  <ul>
                    <li>Python3+Pip 环境配置</li>
                    <li>MongoDB 环境配置</li>
                    <li>Redis 环境配置</li>
                    <li>MySQL 环境配置</li>
                    <li>Python 多版本共存配置</li>
                    <li>Python 爬虫常用库的安装</li>
                  </ul>
                  <h3 id="二、基础篇"><a href="#二、基础篇" class="headerlink" title="二、基础篇"></a><strong>二、基础篇</strong></h3>
                  <ul>
                    <li>爬虫基本原理</li>
                    <li>Urllib 库基本使用</li>
                    <li>Requests 库基本使用</li>
                    <li>正则表达式基础</li>
                    <li>BeautifulSoup 详解</li>
                    <li>PyQuery 详解</li>
                    <li>Selenium 详解</li>
                  </ul>
                  <h3 id="三、实战篇"><a href="#三、实战篇" class="headerlink" title="三、实战篇"></a><strong>三、实战篇</strong></h3>
                  <ul>
                    <li>使用 Requests+正则表达式爬取猫眼电影</li>
                    <li>分析 Ajax 请求并抓取今日头条街拍美图</li>
                    <li>使用 Selenium 模拟浏览器抓取淘宝商品美食信息</li>
                    <li>使用 Redis+Flask 维护动态代理池</li>
                    <li>使用代理处理反爬抓取微信文章</li>
                    <li>使用 Redis+Flask 维护动态 Cookies 池</li>
                  </ul>
                  <h3 id="四、框架篇"><a href="#四、框架篇" class="headerlink" title="四、框架篇"></a><strong>四、框架篇</strong></h3>
                  <ul>
                    <li>PySpider 框架基本使用及抓取 TripAdvisor 实战</li>
                    <li>PySpider 架构概述及用法详解</li>
                    <li>Scrapy 框架的安装</li>
                    <li>Scrapy 框架基本使用</li>
                    <li>Scrapy 命令行详解</li>
                    <li>Scrapy 中选择器的用法</li>
                    <li>Scrapy 中 Spiders 的用法</li>
                    <li>Scrapy 中 Item Pipeline 的用法</li>
                    <li>Scrapy 中 Download Middleware 的用法</li>
                    <li>Scrapy 爬取知乎用户信息实战</li>
                    <li>Scrapy+Cookies 池抓取新浪微博</li>
                    <li>Scrapy+Tushare 爬取微博股票数据</li>
                  </ul>
                  <h3 id="五、分布式篇"><a href="#五、分布式篇" class="headerlink" title="五、分布式篇"></a><strong>五、分布式篇</strong></h3>
                  <ul>
                    <li>Scrapy 分布式原理及 Scrapy-Redis 源码解析</li>
                    <li>Scrapy 分布式架构搭建抓取知乎</li>
                    <li>Scrapy 分布式的部署详解</li>
                  </ul>
                  <p>整个课程是从小白起点的，从环境配置和基础开始讲起，环境安装部分三大平台都有介绍，实战的部分我是一边写一边讲解，还有一些分布式爬虫的搭建流程也做了介绍。 不过这个课程是收费的，其实里面也包含了我学习爬虫以来的经验和汗水，我在做讲解的时候也会把我学习爬虫的一些思路和想法讲解出来，避免大家走一些弯路，希望大家可以支持一下！ 不过在这里有免费的视频，是属于整个课程的一部分，大家可以直接观看 <strong><a href="https://edu.hellobi.com/course/156" target="_blank" rel="noopener">Python3 爬虫三大案例实战分享</a></strong> 整套视频课程放在天善智能这边了，大家如果感兴趣的话可以直接在这里购买，499 元。 课程链接如下： <strong>天善智能：<a href="https://edu.hellobi.com/course/157" target="_blank" rel="noopener">自己动手，丰衣足食！Python3 网络爬虫实战案例</a></strong> <strong>网易云课堂：<a href="http://study.163.com/course/courseMain.htm?courseId=1003827039&amp;utm_campaign=commission&amp;utm_source=cp-1018878377&amp;utm_medium=share" target="_blank" rel="noopener">自己动手，丰衣足食！Python3 网络爬虫实战案例</a></strong> <a href="https://edu.hellobi.com/course/157" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/04/WechatIMG257-1.jpeg" alt=""></a> 最后的最后希望大家可以多多支持！非常感谢！知识就是力量！也希望我的课程能为您创造更大的财富！</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2017-04-11 00:38:31" itemprop="dateCreated datePublished" datetime="2017-04-11T00:38:31+08:00">2017-04-11</time>
                </span>
                <span id="/4320.html" class="post-meta-item leancloud_visitors" data-flag-title="Python3爬虫视频学习教程" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>2.2k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>2 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/4244.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="静觅丨崔庆才的个人站点专业为您提供爬虫教程,爬虫,Python,Python爬虫,Python爬虫教程,爬虫书的相关信息，想要了解更多详情，请联系我们。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/4244.html" class="post-title-link" itemprop="url">Scrapy小技巧-MySQL存储</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p><a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/吃惊表情1.jpg" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/吃惊表情1.jpg" alt="吃惊表情1"></a> 这两天上班接手，别人留下来的爬虫发现一个很好玩的 SQL 脚本拼接。 只要你的 Scrapy Field 字段名字和 数据库字段的名字 一样。那么恭喜你你就可以拷贝这段 SQL 拼接脚本。进行 MySQL 入库处理。 具体拼接代码如下：</p>
                  <figure class="highlight livecodeserver">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">def process_item(self, <span class="keyword">item</span>, spider):</span><br><span class="line">    <span class="keyword">if</span> isinstance(<span class="keyword">item</span>, WhoscoredNewItem):</span><br><span class="line">        table_name = <span class="keyword">item</span>.pop(<span class="string">'table_name'</span>)</span><br><span class="line">        col_str = <span class="string">''</span></span><br><span class="line">        row_str = <span class="string">''</span></span><br><span class="line">        <span class="keyword">for</span> key <span class="keyword">in</span> <span class="keyword">item</span>.<span class="built_in">keys</span>():</span><br><span class="line">            col_str = col_str + <span class="string">" "</span> + key + <span class="string">","</span></span><br><span class="line">            row_str = <span class="string">"&#123;&#125;'&#123;&#125;',"</span>.<span class="built_in">format</span>(row_str, <span class="keyword">item</span>[key] <span class="keyword">if</span> <span class="string">"'"</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="keyword">item</span>[key] <span class="keyword">else</span> <span class="keyword">item</span>[key].<span class="built_in">replace</span>(<span class="string">"'"</span>, <span class="string">"\\'"</span>))</span><br><span class="line">            sql = <span class="string">"insert INTO &#123;&#125; (&#123;&#125;) VALUES (&#123;&#125;) ON DUPLICATE KEY UPDATE "</span>.<span class="built_in">format</span>(table_name, col_str[<span class="number">1</span>:<span class="number">-1</span>], row_str[:<span class="number">-1</span>])</span><br><span class="line">        <span class="keyword">for</span> (key, <span class="built_in">value</span>) <span class="keyword">in</span> <span class="literal">six</span>.iteritems(<span class="keyword">item</span>):</span><br><span class="line">            sql += <span class="string">"&#123;&#125; = '&#123;&#125;', "</span>.<span class="built_in">format</span>(key, <span class="built_in">value</span> <span class="keyword">if</span> <span class="string">"'"</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="built_in">value</span> <span class="keyword">else</span> <span class="built_in">value</span>.<span class="built_in">replace</span>(<span class="string">"'"</span>, <span class="string">"\\'"</span>))</span><br><span class="line">        sql = sql[:<span class="number">-2</span>]</span><br><span class="line">        self.cursor.execute(sql) <span class="comment">#执行SQL</span></span><br><span class="line">        self.cnx.commit()<span class="comment"># 写入操作</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这个 SQL 拼接实现了，如果数据库存在相同数据则 更新，不存在则插入 的 SQL 语句 具体实现就是第一个 for 循环，获取 key 作为 MySQL 字段名字、VALUES 做为 SQL 的 VALUES（拼接成一个插入的 SQL 语句） 第二个 for 循环，实现了 字段名 = VALUES 的拼接。 和第一个 for 循环的中的 sql 就组成了 insert into XXXXX on duplicate key update 这个。存在则更新 不存在则插入的 SQL 语句。 <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/QQ图片20161021225948.jpg" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/QQ图片20161021225948.jpg" alt="QQ图片20161021225948"></a> 我只能所 6666666666 写这个拼接的小哥儿有想法。还挺通用。 不知道你们有没有想到这种方法 反正我是没想到。</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/哎哟卧槽" class="author" itemprop="url" rel="index">哎哟卧槽</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2017-03-19 17:05:09" itemprop="dateCreated datePublished" datetime="2017-03-19T17:05:09+08:00">2017-03-19</time>
                </span>
                <span id="/4244.html" class="post-meta-item leancloud_visitors" data-flag-title="Scrapy小技巧-MySQL存储" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>989</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>1 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/4197.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="静觅丨崔庆才的个人站点专业为您提供爬虫教程,爬虫,Python,Python爬虫,Python爬虫教程,爬虫书的相关信息，想要了解更多详情，请联系我们。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> PHP <i class="label-arrow"></i>
                  </a>
                  <a href="/4197.html" class="post-title-link" itemprop="url">WordPress 远程附件上传插件 For 又拍云【升级版】</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>今天给大家介绍 WordPress Plugin for UPYUN 插件，专为<a href="https://www.upyun.com/index.html" target="_blank" rel="noopener">又拍云</a>和 WordPress 用户准备，主要功能如下：</p>
                  <ol>
                    <li>可以与 WordPress 无缝结合，通过 WordPress 上传图片和文件到又拍云, 支持大文件上传（需要开启表单 API) 和防盗链功能</li>
                    <li>支持同步删除（在 WordPress 后台媒体管理 “删除” 附件后，又拍云服务器中的文件也随之删除)</li>
                    <li>增加图片编辑功能</li>
                    <li>优化防盗链功能</li>
                    <li>增加与水印插件的兼容性，使上传到远程服务器的图片同样可以加上水印等</li>
                  </ol>
                  <p>PS：修复了很多之前版本存在的 bug，具体可访问：<a href="https://github.com/ihacklog/hacklog-remote-attachment-upyun" target="_blank" rel="noopener">github</a> 又拍云是以 CDN 为核心业务，另外提供云存储、云处理、云安全、流量营销等的云服务商，有开放且可扩展的API，以及开放的SDK和第三方插件，还针对开发者启动了 <a href="https://www.upyun.com/league.html" target="_blank" rel="noopener">又拍云联盟</a> 活动，可以每月获取免费空间和流量。更多介绍，请访问<a href="https://www.upyun.com/index.html" target="_blank" rel="noopener">又拍云</a>。 <strong>安装插件：</strong> 进入到你的 WordPress 的 wp-content/plugins 目录下</p>
                  <figure class="highlight vim">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">` # <span class="keyword">pwd</span>/home/wwwroot/blog.v5linux.<span class="keyword">com</span>/<span class="keyword">wp</span>-content/plugins`</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>克隆插件</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">` # git clone https:<span class="comment">//github.com/ihacklog/hacklog-remote-attachment-upyun.</span></span><br><span class="line">gitInitialized empty Git repository <span class="keyword">in</span> /home/wwwroot/blog.v5linux.com/wp-</span><br><span class="line">content/plugins/hacklog-remote-attachment-upyun/.git/remote: Counting </span><br><span class="line">objects: <span class="number">387</span>, done.remote: Compressing objects: <span class="number">100</span>% (<span class="number">31</span>/<span class="number">31</span>), done.</span><br><span class="line">remote: Total <span class="number">387</span> (delta <span class="number">16</span>), reused <span class="number">0</span> (delta <span class="number">0</span>), pack-reused <span class="number">356</span>Receiving </span><br><span class="line">objects: <span class="number">100</span>% (<span class="number">387</span>/<span class="number">387</span>), <span class="number">399.17</span> KiB | <span class="number">106</span> KiB/s, done.Resolving deltas:</span><br><span class="line"> <span class="number">100</span>% (<span class="number">223</span>/<span class="number">223</span>), done.`</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>设置权限</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">` # ll总用量 <span class="number">16</span>drwxr-xr-x <span class="number">4</span> www  www  <span class="number">4096</span> <span class="number">1</span>月  <span class="number">12</span> <span class="number">13</span>:<span class="number">20</span> akismetdrwxr-xr-x </span><br><span class="line"><span class="number">8</span> root root <span class="number">4096</span> <span class="number">1</span>月  <span class="number">16</span> <span class="number">11</span>:<span class="number">34</span> hacklog-remote-attachment-upyun-rw-r--r-- <span class="number">1</span> </span><br><span class="line">www  www  <span class="number">2255</span> <span class="number">5</span>月  <span class="number">23</span> <span class="number">2013</span> hello.php-rw-r--r-- <span class="number">1</span> www  www    <span class="number">28</span> <span class="number">6</span>月   </span><br><span class="line"><span class="number">5</span> <span class="number">2014</span> index.php# chown -R www:www hacklog-remote-attachment-upyun/`</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>注意，如果你是虚拟主机，请下载后打包成 zip 文件上传到 plugins 目录下插件配置 <strong>插件设置</strong></p>
                  <p><a href="https://img.wpdaxue.com/2017/03/screenshot-1.png" target="_blank" rel="noopener"><img src="https://static.oschina.net/uploads/img/201703/06153426_bm5y.png" alt=""></a> 主要配置 空间名：后台创建的存储类型服务的名称 操作员和操作员密码：后台获取 表单密钥：<a href="https://console.upyun.com/login/" target="_blank" rel="noopener">又拍云控制台</a> 找到对应的服务 — 高级选项 - 开启表单密钥远程基本 URL：填写你的绑定域名或默认域名（强烈建议使用绑定域名） REST 远程路径和 HTTP 路径：根据需求填写 插件启用和配置详情，请参考：<a href="http://support.upyun.com/hc/kb/article/1025121/" target="_blank" rel="noopener">WordPress 远程附件上传插件</a></p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/yvette_" class="author" itemprop="url" rel="index">yvette_</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2017-03-12 08:46:01" itemprop="dateCreated datePublished" datetime="2017-03-12T08:46:01+08:00">2017-03-12</time>
                </span>
                <span id="/4197.html" class="post-meta-item leancloud_visitors" data-flag-title="WordPress 远程附件上传插件 For 又拍云【升级版】" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>1.3k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>1 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/4048.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="静觅丨崔庆才的个人站点专业为您提供爬虫教程,爬虫,Python,Python爬虫,Python爬虫教程,爬虫书的相关信息，想要了解更多详情，请联系我们。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/4048.html" class="post-title-link" itemprop="url">小白进阶之Scrapy第三篇（基于Scrapy-Redis的分布式以及cookies池）</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>啥话都不说了、进入正题。 <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/02/QQ图片20170205084843.jpg" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/02/QQ图片20170205084843.jpg" alt="QQ图片20170205084843"></a> 首先我们更新一下 scrapy 版本。最新版为 1.3 再说一遍 Windows 的小伙伴儿 pip 是装不上 Scrapy 的。推荐使用 anaconda 、不然还是老老实实用 Linux 吧</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">conda install <span class="attribute">scrapy</span>==1.3</span><br><span class="line">或者</span><br><span class="line">pip install <span class="attribute">scrapy</span>==1.3</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>安装 Scrapy-Redis</p>
                  <figure class="highlight mipsasm">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">conda <span class="keyword">install </span><span class="keyword">scrapy-redis</span></span><br><span class="line"><span class="keyword">或者</span></span><br><span class="line"><span class="keyword">pip </span><span class="keyword">install </span><span class="keyword">scrapy-redis</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>需要注意： Python 版本为 2.7，3.4 或者 3.5 。个人使用 3.6 版本也没有问题 Redis&gt;=2.8 Scrapy&gt;=1.0 Redis-py&gt;=2.1 。 3.X 版本的 Python 都是自带 Redis-py 其余小伙伴如果没有的话、自己 pip 安装一下。 开始搞事！ 开始之前我们得知道 scrapy-redis 的一些配置：PS 这些配置是写在 Scrapy 项目的 settings.py 中的！</p>
                  <figure class="highlight vala">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="meta">#启用Redis调度存储请求队列</span></span><br><span class="line">SCHEDULER = <span class="string">"scrapy_redis.scheduler.Scheduler"</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#确保所有的爬虫通过Redis去重</span></span><br><span class="line">DUPEFILTER_CLASS = <span class="string">"scrapy_redis.dupefilter.RFPDupeFilter"</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#默认请求序列化使用的是pickle 但是我们可以更改为其他类似的。PS：这玩意儿2.X的可以用。3.X的不能用</span></span><br><span class="line"><span class="meta">#SCHEDULER_SERIALIZER = "scrapy_redis.picklecompat"</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#不清除Redis队列、这样可以暂停/恢复 爬取</span></span><br><span class="line"><span class="meta">#SCHEDULER_PERSIST = True</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#使用优先级调度请求队列 （默认使用）</span></span><br><span class="line"><span class="meta">#SCHEDULER_QUEUE_CLASS = 'scrapy_redis.queue.PriorityQueue'</span></span><br><span class="line"><span class="meta">#可选用的其它队列</span></span><br><span class="line"><span class="meta">#SCHEDULER_QUEUE_CLASS = 'scrapy_redis.queue.FifoQueue'</span></span><br><span class="line"><span class="meta">#SCHEDULER_QUEUE_CLASS = 'scrapy_redis.queue.LifoQueue'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#最大空闲时间防止分布式爬虫因为等待而关闭</span></span><br><span class="line"><span class="meta">#这只有当上面设置的队列类是SpiderQueue或SpiderStack时才有效</span></span><br><span class="line"><span class="meta">#并且当您的蜘蛛首次启动时，也可能会阻止同一时间启动（由于队列为空）</span></span><br><span class="line"><span class="meta">#SCHEDULER_IDLE_BEFORE_CLOSE = 10</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#将清除的项目在redis进行处理</span></span><br><span class="line">ITEM_PIPELINES = &#123;</span><br><span class="line">    <span class="string">'scrapy_redis.pipelines.RedisPipeline'</span>: <span class="number">300</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#序列化项目管道作为redis Key存储</span></span><br><span class="line"><span class="meta">#REDIS_ITEMS_KEY = '%(spider)s:items'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#默认使用ScrapyJSONEncoder进行项目序列化</span></span><br><span class="line"><span class="meta">#You can use any importable path to a callable object.</span></span><br><span class="line"><span class="meta">#REDIS_ITEMS_SERIALIZER = 'json.dumps'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#指定连接到redis时使用的端口和地址（可选）</span></span><br><span class="line"><span class="meta">#REDIS_HOST = 'localhost'</span></span><br><span class="line"><span class="meta">#REDIS_PORT = 6379</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#指定用于连接redis的URL（可选）</span></span><br><span class="line"><span class="meta">#如果设置此项，则此项优先级高于设置的REDIS_HOST 和 REDIS_PORT</span></span><br><span class="line"><span class="meta">#REDIS_URL = 'redis://user:pass@hostname:9001'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#自定义的redis参数（连接超时之类的）</span></span><br><span class="line"><span class="meta">#REDIS_PARAMS  = &#123;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#自定义redis客户端类</span></span><br><span class="line"><span class="meta">#REDIS_PARAMS['redis_cls'] = 'myproject.RedisClient'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#如果为True，则使用redis的'spop'进行操作。</span></span><br><span class="line"><span class="meta">#如果需要避免起始网址列表出现重复，这个选项非常有用。开启此选项urls必须通过sadd添加，否则会出现类型错误。</span></span><br><span class="line"><span class="meta">#REDIS_START_URLS_AS_SET = False</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#RedisSpider和RedisCrawlSpider默认 start_usls 键</span></span><br><span class="line"><span class="meta">#REDIS_START_URLS_KEY = '%(name)s:start_urls'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#设置redis使用utf-8之外的编码</span></span><br><span class="line"><span class="meta">#REDIS_ENCODING = 'latin1'</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>请各位小伙伴儿自行挑选需要的配置写到项目的 settings.py 文件中 英语渣靠 Google、看不下去的小伙伴儿看这儿：<a href="http://scrapy-redis.readthedocs.io/en/stable/readme.html" target="_blank" rel="noopener">http://scrapy-redis.readthedocs.io/en/stable/readme.html</a> 继续在我们上一篇博文中的爬虫程序修改： 首先把我们需要的 redis 配置文件写入 settings.py 中： 如果你的 redis 数据库按照前一片博文配置过则需要以下至少三项</p>
                  <figure class="highlight ini">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attr">SCHEDULER</span> = <span class="string">"scrapy_redis.scheduler.Scheduler"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">DUPEFILTER_CLASS</span> = <span class="string">"scrapy_redis.dupefilter.RFPDupeFilter"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">REDIS_URL</span> = <span class="string">'redis://root:密码@主机ＩＰ:端口'</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>第三项请按照你的实际情况配置。 Nice 配置文件写到这儿。我们来做一些基本的反爬虫设置 最基本的一个切换 UserAgent！ 首先在项目文件中新建一个 useragent.py 用来写一堆 User-Agent（可以去网上找更多，也可以用下面这些现成的）</p>
                  <figure class="highlight smalltalk">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">agents = [</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Linux; U; Android 2.3.6; en-us; Nexus S Build/GRK39F) AppleWebKit/533.1 (KHTML, like Gecko) Version/4.0 Mobile Safari/533.1"</span>,</span><br><span class="line">    <span class="comment">"Avant Browser/1.2.789rel1 (http://www.avantbrowser.com)"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Windows; U; Windows NT 6.1; en-US) AppleWebKit/532.5 (KHTML, like Gecko) Chrome/4.0.249.0 Safari/532.5"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Windows; U; Windows NT 5.2; en-US) AppleWebKit/532.9 (KHTML, like Gecko) Chrome/5.0.310.0 Safari/532.9"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US) AppleWebKit/534.7 (KHTML, like Gecko) Chrome/7.0.514.0 Safari/534.7"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Windows; U; Windows NT 6.0; en-US) AppleWebKit/534.14 (KHTML, like Gecko) Chrome/9.0.601.0 Safari/534.14"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Windows; U; Windows NT 6.1; en-US) AppleWebKit/534.14 (KHTML, like Gecko) Chrome/10.0.601.0 Safari/534.14"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Windows; U; Windows NT 6.1; en-US) AppleWebKit/534.20 (KHTML, like Gecko) Chrome/11.0.672.2 Safari/534.20"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/534.27 (KHTML, like Gecko) Chrome/12.0.712.0 Safari/534.27"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/535.1 (KHTML, like Gecko) Chrome/13.0.782.24 Safari/535.1"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Windows NT 6.0) AppleWebKit/535.2 (KHTML, like Gecko) Chrome/15.0.874.120 Safari/535.2"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/535.7 (KHTML, like Gecko) Chrome/16.0.912.36 Safari/535.7"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Windows; U; Windows NT 6.0 x64; en-US; rv:1.9pre) Gecko/2008072421 Minefield/3.0.2pre"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.9.0.10) Gecko/2009042316 Firefox/3.0.10"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Windows; U; Windows NT 6.0; en-GB; rv:1.9.0.11) Gecko/2009060215 Firefox/3.0.11 (.NET CLR 3.5.30729)"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Windows; U; Windows NT 6.0; en-US; rv:1.9.1.6) Gecko/20091201 Firefox/3.5.6 GTB5"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Windows; U; Windows NT 5.1; tr; rv:1.9.2.8) Gecko/20100722 Firefox/3.6.8 ( .NET CLR 3.5.30729; .NET4.0E)"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Windows NT 6.1; rv:2.0.1) Gecko/20100101 Firefox/4.0.1"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:2.0.1) Gecko/20100101 Firefox/4.0.1"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Windows NT 5.1; rv:5.0) Gecko/20100101 Firefox/5.0"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Windows NT 6.1; WOW64; rv:6.0a2) Gecko/20110622 Firefox/6.0a2"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Windows NT 6.1; WOW64; rv:7.0.1) Gecko/20100101 Firefox/7.0.1"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Windows NT 6.1; WOW64; rv:2.0b4pre) Gecko/20100815 Minefield/4.0b4pre"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/4.0 (compatible; MSIE 5.5; Windows NT 5.0 )"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/4.0 (compatible; MSIE 5.5; Windows 98; Win 9x 4.90)"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Windows; U; Windows XP) Gecko MultiZilla/1.6.1.0a"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/2.02E (Win95; U)"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/3.01Gold (Win95; I)"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/4.8 [en] (Windows NT 5.1; U)"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Windows; U; Win98; en-US; rv:1.4) Gecko Netscape/7.1 (ax)"</span>,</span><br><span class="line">    <span class="comment">"HTC_Dream Mozilla/5.0 (Linux; U; Android 1.5; en-ca; Build/CUPCAKE) AppleWebKit/528.5  (KHTML, like Gecko) Version/3.1.2 Mobile Safari/525.20.1"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (hp-tablet; Linux; hpwOS/3.0.2; U; de-DE) AppleWebKit/534.6 (KHTML, like Gecko) wOSBrowser/234.40.1 Safari/534.6 TouchPad/1.0"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Linux; U; Android 1.5; en-us; sdk Build/CUPCAKE) AppleWebkit/528.5  (KHTML, like Gecko) Version/3.1.2 Mobile Safari/525.20.1"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Linux; U; Android 2.1; en-us; Nexus One Build/ERD62) AppleWebKit/530.17 (KHTML, like Gecko) Version/4.0 Mobile Safari/530.17"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Linux; U; Android 2.2; en-us; Nexus One Build/FRF91) AppleWebKit/533.1 (KHTML, like Gecko) Version/4.0 Mobile Safari/533.1"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Linux; U; Android 1.5; en-us; htc_bahamas Build/CRB17) AppleWebKit/528.5  (KHTML, like Gecko) Version/3.1.2 Mobile Safari/525.20.1"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Linux; U; Android 2.1-update1; de-de; HTC Desire 1.19.161.5 Build/ERE27) AppleWebKit/530.17 (KHTML, like Gecko) Version/4.0 Mobile Safari/530.17"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Linux; U; Android 2.2; en-us; Sprint APA9292KT Build/FRF91) AppleWebKit/533.1 (KHTML, like Gecko) Version/4.0 Mobile Safari/533.1"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Linux; U; Android 1.5; de-ch; HTC Hero Build/CUPCAKE) AppleWebKit/528.5  (KHTML, like Gecko) Version/3.1.2 Mobile Safari/525.20.1"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Linux; U; Android 2.2; en-us; ADR6300 Build/FRF91) AppleWebKit/533.1 (KHTML, like Gecko) Version/4.0 Mobile Safari/533.1"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Linux; U; Android 2.1; en-us; HTC Legend Build/cupcake) AppleWebKit/530.17 (KHTML, like Gecko) Version/4.0 Mobile Safari/530.17"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Linux; U; Android 1.5; de-de; HTC Magic Build/PLAT-RC33) AppleWebKit/528.5  (KHTML, like Gecko) Version/3.1.2 Mobile Safari/525.20.1 FirePHP/0.3"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Linux; U; Android 1.6; en-us; HTC_TATTOO_A3288 Build/DRC79) AppleWebKit/528.5  (KHTML, like Gecko) Version/3.1.2 Mobile Safari/525.20.1"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Linux; U; Android 1.0; en-us; dream) AppleWebKit/525.10  (KHTML, like Gecko) Version/3.0.4 Mobile Safari/523.12.2"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Linux; U; Android 1.5; en-us; T-Mobile G1 Build/CRB43) AppleWebKit/528.5  (KHTML, like Gecko) Version/3.1.2 Mobile Safari 525.20.1"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Linux; U; Android 1.5; en-gb; T-Mobile_G2_Touch Build/CUPCAKE) AppleWebKit/528.5  (KHTML, like Gecko) Version/3.1.2 Mobile Safari/525.20.1"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Linux; U; Android 2.0; en-us; Droid Build/ESD20) AppleWebKit/530.17 (KHTML, like Gecko) Version/4.0 Mobile Safari/530.17"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Linux; U; Android 2.2; en-us; Droid Build/FRG22D) AppleWebKit/533.1 (KHTML, like Gecko) Version/4.0 Mobile Safari/533.1"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Linux; U; Android 2.0; en-us; Milestone Build/ SHOLS_U2_01.03.1) AppleWebKit/530.17 (KHTML, like Gecko) Version/4.0 Mobile Safari/530.17"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Linux; U; Android 2.0.1; de-de; Milestone Build/SHOLS_U2_01.14.0) AppleWebKit/530.17 (KHTML, like Gecko) Version/4.0 Mobile Safari/530.17"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Linux; U; Android 3.0; en-us; Xoom Build/HRI39) AppleWebKit/525.10  (KHTML, like Gecko) Version/3.0.4 Mobile Safari/523.12.2"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Linux; U; Android 0.5; en-us) AppleWebKit/522  (KHTML, like Gecko) Safari/419.3"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Linux; U; Android 1.1; en-gb; dream) AppleWebKit/525.10  (KHTML, like Gecko) Version/3.0.4 Mobile Safari/523.12.2"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Linux; U; Android 2.0; en-us; Droid Build/ESD20) AppleWebKit/530.17 (KHTML, like Gecko) Version/4.0 Mobile Safari/530.17"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Linux; U; Android 2.1; en-us; Nexus One Build/ERD62) AppleWebKit/530.17 (KHTML, like Gecko) Version/4.0 Mobile Safari/530.17"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Linux; U; Android 2.2; en-us; Sprint APA9292KT Build/FRF91) AppleWebKit/533.1 (KHTML, like Gecko) Version/4.0 Mobile Safari/533.1"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Linux; U; Android 2.2; en-us; ADR6300 Build/FRF91) AppleWebKit/533.1 (KHTML, like Gecko) Version/4.0 Mobile Safari/533.1"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Linux; U; Android 2.2; en-ca; GT-P1000M Build/FROYO) AppleWebKit/533.1 (KHTML, like Gecko) Version/4.0 Mobile Safari/533.1"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Linux; U; Android 3.0.1; fr-fr; A500 Build/HRI66) AppleWebKit/534.13 (KHTML, like Gecko) Version/4.0 Safari/534.13"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Linux; U; Android 3.0; en-us; Xoom Build/HRI39) AppleWebKit/525.10  (KHTML, like Gecko) Version/3.0.4 Mobile Safari/523.12.2"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Linux; U; Android 1.6; es-es; SonyEricssonX10i Build/R1FA016) AppleWebKit/528.5  (KHTML, like Gecko) Version/3.1.2 Mobile Safari/525.20.1"</span>,</span><br><span class="line">    <span class="comment">"Mozilla/5.0 (Linux; U; Android 1.6; en-us; SonyEricssonX10i Build/R1AA056) AppleWebKit/528.5  (KHTML, like Gecko) Version/3.1.2 Mobile Safari/525.20.1"</span>,</span><br><span class="line">]</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>现在我们来重写一下 Scrapy 的下载中间件（哇靠！！重写中间件 好高端啊！！会不会好难!!!放心！！！So Easy！！跟我做！包教包会，毕竟不会你也不能顺着网线来打我啊）： 关于重写中间件的详细情况 请参考 官方文档：<a href="http://scrapy-chs.readthedocs.io/zh_CN/latest/topics/downloader-middleware.html#scrapy.contrib.downloadermiddleware.DownloaderMiddleware" target="_blank" rel="noopener">http://scrapy-chs.readthedocs.io/zh_CN/latest/topics/downloader-middleware.html#scrapy.contrib.downloadermiddleware.DownloaderMiddleware</a> 在项目中新建一个 middlewares.py 的文件（如果你使用的新版本的 Scrapy，在新建的时候会有这么一个文件，直接用就好了） 首先导入 UserAgentMiddleware 毕竟我们要重写它啊！</p>
                  <figure class="highlight clean">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">import</span> json ##处理json的包</span><br><span class="line"><span class="keyword">import</span> redis #Python操作redis的包</span><br><span class="line"><span class="keyword">import</span> random #随机选择</span><br><span class="line"><span class="keyword">from</span> .useragent <span class="keyword">import</span> agents #导入前面的</span><br><span class="line"><span class="keyword">from</span> scrapy.downloadermiddlewares.useragent <span class="keyword">import</span> UserAgentMiddleware #UserAegent中间件</span><br><span class="line"><span class="keyword">from</span> scrapy.downloadermiddlewares.retry <span class="keyword">import</span> RetryMiddleware #重试中间件</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>开写：</p>
                  <figure class="highlight ruby">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserAgentmiddleware</span>(<span class="title">UserAgentMiddleware</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_request</span><span class="params">(<span class="keyword">self</span>, request, spider)</span></span><span class="symbol">:</span></span><br><span class="line">        agent = random.choice(agents)</span><br><span class="line">        request.headers[<span class="string">"User-Agent"</span>] = agent</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>第一行：定义了一个类 UserAgentmiddleware 继承自 UserAgentMiddleware 第二行：定义了函数<code>process_request</code>(<em>request</em>, <em>spider</em>)为什么定义这个函数，因为 Scrapy 每一个 request 通过中间 件都会调用这个方法。 <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/02/QQ20170206-223156.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/02/QQ20170206-223156.png" alt="QQ20170206-223156"></a> 第三行：随机选择一个 User-Agent 第四行：设置 request 的 User-Agent 为我们随机的 User-Agent ^_^Y(^o^)Y 一个中间件写完了！哈哈 是不是 So easy！ 下面就需要登陆了。这次我们不用上一篇博文的 FromRequest 来实现登陆了。我们来使用 Cookie 登陆。这样的话我们需要重写 Cookie 中间件！分布式爬虫啊！你不能手动的给每个 Spider 写一个 Cookie 吧。而且你还不会知道这个 Cookie 到底有没有失效。所以我们需要维护一个 Cookie 池(这个 cookie 池用 redis)。 好！来理一理思路，维护一个 Cookie 池最基本需要具备些什么功能呢？</p>
                  <ol>
                    <li>获取 Cookie</li>
                    <li>更新 Cookie</li>
                    <li>删除 Cookie</li>
                    <li>判断 Cookie 是否可用进行相对应的操作（比如重试）</li>
                  </ol>
                  <p>好，我们先做前三个对 Cookie 进行操作。 首先我们在项目中新建一个 cookies.py 的文件用来写我们需要对 Cookie 进行的操作。 haoduofuli/haoduofuli/cookies.py: 首先日常导入我们需要的文件：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import requests</span><br><span class="line">import json</span><br><span class="line">import redis</span><br><span class="line">import logging</span><br><span class="line"><span class="keyword">from</span> .settings import REDIS_URL ##获取settings.py中的REDIS_URL</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>首先我们把登陆用的账号密码 以 Key:value 的形式存入 redis 数据库。不推荐使用 db0（这是 Scrapy-redis 默认使用的，账号密码单独使用一个 db 进行存储。） <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/02/QQ20170207-221128@2x.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/02/QQ20170207-221128@2x.png" alt="QQ20170207-221128@2x"></a> 就像这个样子。 解决第一个问题：获取 Cookie：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import requests</span><br><span class="line">import json</span><br><span class="line">import redis</span><br><span class="line">import logging</span><br><span class="line"><span class="keyword">from</span> .settings import REDIS_URL</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"><span class="comment">##使用REDIS_URL链接Redis数据库, deconde_responses=True这个参数必须要，数据会变成byte形式 完全没法用</span></span><br><span class="line">reds = redis.Redis.from_url(REDIS_URL, <span class="attribute">db</span>=2, <span class="attribute">decode_responses</span>=<span class="literal">True</span>)</span><br><span class="line">login_url = <span class="string">'http://haoduofuli.pw/wp-login.php'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##获取Cookie</span></span><br><span class="line">def get_cookie(account, password):</span><br><span class="line">    s = requests.Session()</span><br><span class="line">    payload = &#123;</span><br><span class="line">        <span class="string">'log'</span>: account,</span><br><span class="line">        <span class="string">'pwd'</span>: password,</span><br><span class="line">        <span class="string">'rememberme'</span>: <span class="string">"forever"</span>,</span><br><span class="line">        <span class="string">'wp-submit'</span>: <span class="string">"登录"</span>,</span><br><span class="line">        <span class="string">'redirect_to'</span>: <span class="string">"http://http://www.haoduofuli.pw/wp-admin/"</span>,</span><br><span class="line">        <span class="string">'testcookie'</span>: <span class="string">"1"</span></span><br><span class="line">    &#125;</span><br><span class="line">    response = s.post(login_url, <span class="attribute">data</span>=payload)</span><br><span class="line">    cookies = response.cookies.get_dict()</span><br><span class="line">    logger.<span class="builtin-name">warning</span>(<span class="string">"获取Cookie成功！（账号为:%s）"</span> % account)</span><br><span class="line">    return json.dumps(cookies)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这段很好懂吧。 使用 requests 模块提交表单登陆获得 Cookie，返回一个通过 Json 序列化后的 Cookie（如果不序列化，存入 Redis 后会变成 Plain Text 格式的，后面取出来 Cookie 就没法用啦。） 第二个问题：将 Cookie 写入 Redis 数据库（分布式呀，当然得要其它其它 Spider 也能使用这个 Cookie 了）</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">def init_cookie(red, spidername):</span><br><span class="line">    redkeys = reds.keys()</span><br><span class="line">    <span class="keyword">for</span><span class="built_in"> user </span><span class="keyword">in</span> redkeys:</span><br><span class="line">        password = reds.<span class="builtin-name">get</span>(user)</span><br><span class="line">        <span class="keyword">if</span> red.<span class="builtin-name">get</span>(<span class="string">"%s:Cookies:%s--%s"</span> % (spidername, user, password)) is None:</span><br><span class="line">            cookie = get_cookie(user, password)</span><br><span class="line">            red.<span class="builtin-name">set</span>(<span class="string">"%s:Cookies:%s--%s"</span>% (spidername, user, password), cookie)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>使用我们上面建立的 redis 链接获取 redis db2 中的所有 Key(我们设置为账号的哦！)，再从 redis 中获取所有的 Value(我设成了密码哦！) 判断这个 spider 和账号的 Cookie 是否存在，不存在 则调用 get_cookie 函数传入从 redis 中获取到的账号密码的 cookie； 保存进 redis，Key 为 spider 名字和账号密码，value 为 cookie。 这儿操作 redis 的不是上面建立的那个 reds 链接哦！而是 red;后面会传进来的(因为要操作两个不同的 db,我在文档中没有看到切换 db 的方法，只好这么用了，知道的小伙伴儿留言一下)。 spidername 获取方式后面也会说的。 还有剩余的更新 Cookie 删除无法使用的账号等，大家伙可以自己试着写写（写不出来也没关系 不影响正常使用） 好啦！搞定！简直 So Easy!!!! 现在开始大业了！重写 cookie 中间件；估摸着吧！聪明的小伙儿看了上面重写 User-Agent 的方法，十之八九也知道怎么重写 Cookie 中间件了。 好啦，现在继续写 middlewares.py 啦！</p>
                  <figure class="highlight reasonml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">class</span> <span class="constructor">CookieMiddleware(RetryMiddleware)</span>:</span><br><span class="line"></span><br><span class="line">    def <span class="constructor">__init__(<span class="params">self</span>, <span class="params">settings</span>, <span class="params">crawler</span>)</span>:</span><br><span class="line">        <span class="module-access"><span class="module"><span class="identifier">RetryMiddleware</span>.</span><span class="module"><span class="identifier">__init__</span>(</span></span>self, settings)</span><br><span class="line">        self.rconn = redis.from<span class="constructor">_url(<span class="params">settings</span>['REDIS_URL'], <span class="params">db</span>=1, <span class="params">decode_responses</span>=True)</span>##decode_responses设置取出的编码为str</span><br><span class="line">        init<span class="constructor">_cookie(<span class="params">self</span>.<span class="params">rconn</span>, <span class="params">crawler</span>.<span class="params">spider</span>.<span class="params">name</span>)</span></span><br><span class="line"></span><br><span class="line">    @classmethod</span><br><span class="line">    def from<span class="constructor">_crawler(<span class="params">cls</span>, <span class="params">crawler</span>)</span>:</span><br><span class="line">        return cls(crawler.settings, crawler)</span><br><span class="line"></span><br><span class="line">    def process<span class="constructor">_request(<span class="params">self</span>, <span class="params">request</span>, <span class="params">spider</span>)</span>:</span><br><span class="line">        redisKeys = self.rconn.keys<span class="literal">()</span></span><br><span class="line">        <span class="keyword">while</span> len(redisKeys) &gt; <span class="number">0</span>:</span><br><span class="line">            elem = random.choice(redisKeys)</span><br><span class="line">            <span class="keyword">if</span> spider.name + ':Cookies' <span class="keyword">in</span> elem:</span><br><span class="line">                cookie = json.loads(self.rconn.get(elem))</span><br><span class="line">                request.cookies = cookie</span><br><span class="line">                request.meta<span class="literal">["<span class="identifier">accountText</span>"]</span> = elem.split(<span class="string">"Cookies:"</span>)<span class="literal">[-<span class="number">1</span>]</span></span><br><span class="line">                break</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>第一行：不说 第二行第三行得说一下 这玩意儿叫重载（我想了大半天都没想起来叫啥，还是问了大才。尴尬）有啥用呢： 也不扯啥子高深问题了，小伙伴儿可能发现，当你继承父类之后；子类是不能用 def <strong>init</strong>()方法的，不过重载父类之后就能用啦！ 第四行：settings[‘REDIS_URL’]是个什么鬼？这是访问 scrapy 的 settings。怎么访问的？下面说 第五行：往 redis 中添加 cookie。第二个参数就是 spidername 的获取方法（其实就是字典啦！）</p>
                  <figure class="highlight ruby">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">@classmethod</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">from_crawler</span><span class="params">(cls, crawler)</span></span><span class="symbol">:</span></span><br><span class="line">    <span class="keyword">return</span> cls(crawler.settings, crawler)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这个貌似不好理解，作用看下面： <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/02/D9DF3655-F28A-482C-8B02-C53B152958A0.jpg" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/02/D9DF3655-F28A-482C-8B02-C53B152958A0.jpg" alt="D9DF3655-F28A-482C-8B02-C53B152958A0"></a> 这样是不是一下就知道了？? 至于访问 settings 的方法官方文档给出了详细的方法： <a href="http://scrapy-chs.readthedocs.io/zh_CN/latest/topics/settings.html#how-to-access-settings" target="_blank" rel="noopener">http://scrapy-chs.readthedocs.io/zh_CN/latest/topics/settings.html#how-to-access-settings</a> <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/02/QQ20170207-233701@2x.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/02/QQ20170207-233701@2x.png" alt="QQ20170207-233701@2x"></a> 下面就是完整的 middlewares.py 文件：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Define here the models for your spider middleware</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># See documentation in:</span></span><br><span class="line"><span class="comment"># http://doc.scrapy.org/en/latest/topics/spider-middleware.html</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> scrapy <span class="keyword">import</span> signals</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> .useragent <span class="keyword">import</span> agents</span><br><span class="line"><span class="keyword">from</span> .cookies <span class="keyword">import</span> init_cookie, remove_cookie, update_cookie</span><br><span class="line"><span class="keyword">from</span> scrapy.downloadermiddlewares.useragent <span class="keyword">import</span> UserAgentMiddleware</span><br><span class="line"><span class="keyword">from</span> scrapy.downloadermiddlewares.retry <span class="keyword">import</span> RetryMiddleware</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserAgentmiddleware</span><span class="params">(UserAgentMiddleware)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_request</span><span class="params">(self, request, spider)</span>:</span></span><br><span class="line">        agent = random.choice(agents)</span><br><span class="line">        request.headers[<span class="string">"User-Agent"</span>] = agent</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CookieMiddleware</span><span class="params">(RetryMiddleware)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, settings, crawler)</span>:</span></span><br><span class="line">        RetryMiddleware.__init__(self, settings)</span><br><span class="line">        self.rconn = redis.from_url(settings[<span class="string">'REDIS_URL'</span>], db=<span class="number">1</span>, decode_responses=<span class="literal">True</span>)<span class="comment">##decode_responses设置取出的编码为str</span></span><br><span class="line">        init_cookie(self.rconn, crawler.spider.name)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">from_crawler</span><span class="params">(cls, crawler)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> cls(crawler.settings, crawler)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_request</span><span class="params">(self, request, spider)</span>:</span></span><br><span class="line">        redisKeys = self.rconn.keys()</span><br><span class="line">        <span class="keyword">while</span> len(redisKeys) &gt; <span class="number">0</span>:</span><br><span class="line">            elem = random.choice(redisKeys)</span><br><span class="line">            <span class="keyword">if</span> spider.name + <span class="string">':Cookies'</span> <span class="keyword">in</span> elem:</span><br><span class="line">                cookie = json.loads(self.rconn.get(elem))</span><br><span class="line">                request.cookies = cookie</span><br><span class="line">                request.meta[<span class="string">"accountText"</span>] = elem.split(<span class="string">"Cookies:"</span>)[<span class="number">-1</span>]</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="comment">#else:</span></span><br><span class="line">                <span class="comment">#redisKeys.remove(elem)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#def process_response(self, request, response, spider):</span></span><br><span class="line"></span><br><span class="line">         <span class="comment">#"""</span></span><br><span class="line">         <span class="comment">#下面的我删了，各位小伙伴可以尝试以下完成后面的工作</span></span><br><span class="line"></span><br><span class="line">         <span class="comment">#你需要在这个位置判断cookie是否失效</span></span><br><span class="line"></span><br><span class="line">         <span class="comment">#然后进行相应的操作，比如更新cookie  删除不能用的账号</span></span><br><span class="line"></span><br><span class="line">         <span class="comment">#写不出也没关系，不影响程序正常使用，</span></span><br><span class="line"></span><br><span class="line">         <span class="comment">#"""</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>存储我也不写啦！就是这么简单一个分布式的 scrapy 就这么完成啦！！！ 我试了下 三台机器 两个小时 就把整个站点全部爬完了。 弄好你的存储 放在不同的机器上就可以跑啦！ 完整的代码在 GitHub 上： GitHub：<a href="https://github.com/thsheep/haoduofuli" target="_blank" rel="noopener">https://github.com/thsheep/haoduofuli</a> Y(^o^)Y 完工 下篇博文来对付爬虫的大敌：Ajax 以后的教程用微博做靶子，那些数据比较有用，可以玩玩分析什么的。</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/哎哟卧槽" class="author" itemprop="url" rel="index">哎哟卧槽</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2017-02-07 23:53:44" itemprop="dateCreated datePublished" datetime="2017-02-07T23:53:44+08:00">2017-02-07</time>
                </span>
                <span id="/4048.html" class="post-meta-item leancloud_visitors" data-flag-title="小白进阶之Scrapy第三篇（基于Scrapy-Redis的分布式以及cookies池）" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>15k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>14 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/4020.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="静觅丨崔庆才的个人站点专业为您提供爬虫教程,爬虫,Python,Python爬虫,Python爬虫教程,爬虫书的相关信息，想要了解更多详情，请联系我们。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> 技术杂谈 <i class="label-arrow"></i>
                  </a>
                  <a href="/4020.html" class="post-title-link" itemprop="url">Scrapy分布式的前篇--让redis和MongoDB安全点</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>各位小伙伴 大家好啊！年假结束了··· 也该开始继续我的装逼之旅了。 年前博文的结尾说了 还有一个基于 Scrapy 的分布式版本、 今天这博文就先给大家做些前期工作，其实吧、最主要的是防止你的服务器因为这篇博文被轮········· 博文开始之前 我们先来看篇文章： <a href="http://www.youxia.org/daily-news-attack-extortion-does-not-delay-a-week-had-27000-mongodb-database.html" target="_blank" rel="noopener">http://www.youxia.org/daily-news-attack-extortion-does-not-delay-a-week-had-27000-mongodb-database.html</a> 关于年前 MongoDB 由于<strong>默认可匿名访问</strong> 而导致了一大堆的管理员掉坑里 预估中国有十万数据库被坑。 这是继 Redis 之后又一个小白式的错误······（Redis 也是默认匿名访问） 所以在下一篇博文开始之前，先给一些新手小伙伴做一些准备工作。 因为篇幅较少 先写写 Redis 的一些安全设置： 安装 Redis: 请参考这儿;<a href="https://redis.io/download" target="_blank" rel="noopener">https://redis.io/download</a></p>
                  <figure class="highlight gams">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="symbol">$</span> wget http:<span class="comment">//download.redis.io/releases/redis-3.2.7.tar.gz</span></span><br><span class="line"><span class="symbol">$</span> tar xzf redis<span class="number">-3.2</span><span class="number">.7</span>.tar.gz</span><br><span class="line"><span class="symbol">$</span> cd redis<span class="number">-3.2</span><span class="number">.7</span></span><br><span class="line"><span class="symbol">$</span> make</span><br><span class="line"></span><br><span class="line"><span class="symbol">$</span> src/redis-server</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>ps :如果以上有报错，可能是你的服务器没有安装依赖： CentOS7：</p>
                  <figure class="highlight brainfuck">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment">yum</span> <span class="comment">install</span> <span class="literal">-</span><span class="comment">y</span> <span class="comment">gcc</span><span class="literal">-</span><span class="comment">c</span>++ <span class="comment">tcl</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>只写关于 Linux 的、Windows 的很简单，配置文件通用： 安装完成后 在目录 redis-3.2.7 中有一个 redis.conf 的配置文件，按照默认习惯我们将其复制到/etc 目录下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">[<span class="symbol">root@</span>MyCloudServer ~]# cp redis<span class="number">-3.2</span><span class="number">.7</span>/redis.conf /etc</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>PS：请使用复制（cp）而不要使用移动（mv）；毕竟你要弄错了还可以再拷贝一份儿过去用不是？ 使用 vim 编辑刚刚拷贝的 redis.conf</p>
                  <figure class="highlight vim">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">vim</span> /etc/redis.<span class="keyword">conf</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>PS:使用 vim 需要先安装： CentOS7：</p>
                  <figure class="highlight cmake">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">yum  <span class="keyword">install</span> vim</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>我们需要注意以下几项： 1、注释掉 47 行的 bind 127.0.0.1（这个意思是限制为只能 127.0.0.1 也就是本机登录）PS：个人更建议 将你需要连接 Redis 数据库的 IP 地址填写在此处，而不是注释掉。这样做会比直接注释掉更加安全。 2、更改第 84 行 port 6379 为你需要的端口号（这是 Redis 的默认监听端口）PS：个人建议务必更改 3、更改第 128 行 daemonize no 为 daemonize yes（这是让 Redis 后台运行） PS:个人建议更改 4、取消第 480 # requirepass foobared 的#注释符（这是 redis 的访问密码） 并更改 foobared 为你需要的密码 比如 我需们需要密码为 123456 则改为 requirepass 123456。PS：密码不可过长否则 Python 的 redis 客户端无法连接 以上配置文件更改完毕，需要在防火墙放行：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">firewall-cmd <span class="attribute">--zone</span>=public <span class="attribute">--add-port</span>=xxxx/tcp --permanent</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>请将 xxxx 更改为你自己的 redis 端口。 重启防火墙生效：</p>
                  <figure class="highlight css">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="selector-tag">systemctl</span> <span class="selector-tag">restart</span> <span class="selector-tag">firewalld</span><span class="selector-class">.service</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>指定配置文件启动 redis:</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">[<span class="symbol">root@</span>MyCloudServer ~]# redis<span class="number">-3.2</span><span class="number">.7</span>/src/redis-server /etc/redis.conf</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>加入到开机启动:</p>
                  <figure class="highlight jboss-cli">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">echo</span> <span class="string">"/root/redis-3.2.6/src/redis-server /etc/redis.conf"</span> &gt;&gt; <span class="string">/etc/rc.local</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>一个较为安全的 redis 配置完毕。 redis 的桌面客户端我推荐：RedisDesktopManager 去下面这个地址下载就不需要捐助啦！ <a href="https://github.com/uglide/RedisDesktopManager/releases" target="_blank" rel="noopener">https://github.com/uglide/RedisDesktopManager/releases</a> 当然还有一些其他配置、我们用不到也就不写啦！ <strong>MongoDB：</strong> 这次 MongoDB 挺惨啊！由于默认匿名访问、下面给 MongoDB 配置一点安全措施： 安装 MongoDB： 以 CentOS7 为例其余发行版请参考官方文档：<a href="https://docs.mongodb.com/manual/administration/install-on-linux/" target="_blank" rel="noopener">https://docs.mongodb.com/manual/administration/install-on-linux/</a> 1、建一个 yum 源：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">[<span class="symbol">root@</span>MyCloudServer ~]# vim /etc/yum.repos.d/mongodb-org<span class="number">-3.4</span>.repo</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>写入以下内容：</p>
                  <figure class="highlight ini">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="section">[mongodb-org-3.4]</span></span><br><span class="line"><span class="attr">name</span>=MongoDB Repository</span><br><span class="line"><span class="attr">baseurl</span>=https://repo.mongodb.org/yum/redhat/<span class="variable">$releasever</span>/mongodb-org/<span class="number">3.4</span>/x<span class="number">86_64</span>/</span><br><span class="line"><span class="attr">gpgcheck</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">enabled</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">gpgkey</span>=https://www.mongodb.org/static/pgp/server-<span class="number">3.4</span>.asc</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>2、安装 mongoDB 以及相关工具：</p>
                  <figure class="highlight cmake">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">sudo yum <span class="keyword">install</span> -y mongodb-org</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>3、启动 MongoDB：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">sudo<span class="built_in"> service </span>mongod start</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>ＰＳ：如果你的服务器在使用 SELinux 的话，你需要配置 SElinux 允许 MongoDB 启动，当然更简单的方法是关掉 SElinux。 关闭 SElinux:</p>
                  <figure class="highlight autoit">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">[root<span class="symbol">@MyCloudServer</span> ~]<span class="meta"># vim /etc/selinux/config</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>将第 7 行设置为：SELINUX=disabled 4、停止 MongoDB：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">sudo<span class="built_in"> service </span>mongod stop</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>上面安装完按成了 MongoDB 下面要步入正题了： 1、备份和更改配置文件：</p>
                  <figure class="highlight vim">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">[root@MyCloudServer ~]# <span class="keyword">cp</span> /etc/mongod.<span class="keyword">conf</span>  /etc/mongod_backup.<span class="keyword">conf</span></span><br><span class="line">[root@MyCloudServer ~]# <span class="keyword">vim</span> /etc/mongod.<span class="keyword">conf</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>更改第 28 行 prot 2701 为你需要更改的端口（这是 MongoDB 默认的监听端口） 更改第 29 行 bindIp: 127.0.0.1 为 0.0.0.0（MongoDB 默认只能本地访问）ＰＳ：个人建议此处添加你需要连接 MongoDB 服务器的 IP 地址、而不是改成 0.0.0.0。这样做会更安全 启动 MongoDB：</p>
                  <figure class="highlight jboss-cli">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">mongod <span class="params">--config</span> <span class="string">/etc/mongod.conf</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>意思是：指定/etc/mongod.conf 为配置文件启动 MongoDB 好了、配置文件更改完毕，现在可以外网访问我们的 MongoDB 了！不需要用户名！匿名的！现在我们进行下一步设置。 因为 MongoDB 默认是匿名访问的、我们需要开启用户认证。 我估摸着很多哥们儿和我一样没补全 啥都不会干、所以直接在服务器上改就不太现实了，需要借助于第三方客户端。我个人推荐：mongobooster 官方地址：<a href="https://mongobooster.com/" target="_blank" rel="noopener">https://mongobooster.com/</a> 收费版免费版功能一样 不用在意： 首先我们需要连上 MongoDB 服务器（别忘了防火墙放行你使用的端口啊！！！） <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/02/170203.gif" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/02/170203.gif" alt="170203"></a> 连上之后大慨是这个样子： <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/02/17020301.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/02/17020301.png" alt="17020301"></a> 按下 Ctrl+T 打开 shell 界面输入一下内容：</p>
                  <figure class="highlight gherkin">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">use admin</span><br><span class="line">db.createUser(</span><br><span class="line">   &#123;</span><br><span class="line">     user: <span class="string">"你的用户名"</span>,</span><br><span class="line">     pwd: <span class="string">"你的密码"</span>,</span><br><span class="line">     roles: [ &#123;role:<span class="string">"userAdminAnyDatabase"</span>, db:<span class="string">"admin"</span>&#125; ]</span><br><span class="line">    /<span class="symbol">*</span> All build-in Roles</span><br><span class="line">    Database User Roles: read|<span class="string">readWrite</span></span><br><span class="line"><span class="string">    数据库用户角色：读</span>|<span class="string">读写</span></span><br><span class="line"><span class="string">    Database Admion Roles: dbAdmin</span>|<span class="string">dbOwner</span>|userAdmin</span><br><span class="line">    数据库管理角色：数据库管理员|<span class="string">数据库所有者</span>|<span class="string">用户管理</span></span><br><span class="line"><span class="string">    Cluster Admin Roles: clusterAdmin</span>|<span class="string">clusterManager</span>|<span class="string">clusterMonitor</span>|hostManager</span><br><span class="line">    集群管理角色：</span><br><span class="line">    Backup and Restoration Roles: backup|<span class="string">restore</span></span><br><span class="line"><span class="string">    All-Database Roles: readAnyDatabase</span>|<span class="string">readWriteAnyDatabase</span>|<span class="string">userAdminAnyDatabase</span>|dbAdminAnyDatabase</span><br><span class="line">    所有数据库角色：读所有数据库|<span class="string">读写所有数据库</span>|<span class="string">所有数据库的用户管理员</span>|<span class="string">所有数据库的管理员</span></span><br><span class="line"><span class="string">    Superuser Roles: root */</span></span><br><span class="line"><span class="string">   &#125;</span></span><br><span class="line"><span class="string">)</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>再点击 run 运行即可 会在信息栏中提示 True 现在断开数据库连接、再打开会发现多出一个 admin 的数据库。 <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/02/QQ截图20170204001502.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/02/QQ截图20170204001502.png" alt="QQ截图20170204001502"></a> 上面的都做了些什么呢？ 首先我们新建了一个 admin 的数据库（MongoDB 的原则哦、有则切换没有就创建） 然后在 admin 数据中创建了一个用户 和 密码 赋予了这个用户管理 admin 数据库 所有数据库用户的权限。 至于有那些权限 在注释中都有写哦！常用的我估摸着写了个对应意思········· OK！搞定这一部分 就可以开启 MongoDB 的用户认证了！ 怎么开启呢？首先关闭正在运行的 MongoDB：</p>
                  <figure class="highlight vim">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">ps</span> -<span class="keyword">e</span> | <span class="keyword">grep</span> mongod</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>上面的命令会找出 MongoDB 的进程号、然后运行 kill 进程号即可！ 开启 MongoDB：</p>
                  <figure class="highlight jboss-cli">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">mongod <span class="params">--auth</span> <span class="params">--config</span> <span class="string">/etc/mongod.conf</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>意思是：以认证模式 指定/etc/mongod.conf 启动 MongoDB。 加入开机启动：</p>
                  <figure class="highlight jboss-cli">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">echo</span> <span class="string">"mongod --auth --config /etc/mongod.conf"</span> &gt;&gt; <span class="string">/etc/rc.local</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>好了！现在 MongoDB 也配置完成 啦！ 现在如果你需要新建一个用户让其使用数据库 你该怎么做呢？ 像下面这样；首先你需要连接到 admin 数据库！ 在选项 Basic 中照常配置： <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/02/QQ20170204-004332@2x.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/02/QQ20170204-004332@2x.png" alt="QQ20170204-004332@2x"></a> 需要额外设置的是 Authentication 选项： <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/02/QQ20170204-004627@2x.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/02/QQ20170204-004627@2x.png" alt="QQ20170204-004627@2x"></a> 连接成功后大概是这个样子： <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/02/QQ20170204-004930@2x.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/02/QQ20170204-004930@2x.png" alt="QQ20170204-004930@2x"></a> 需要注意的一点是：这个用户只能看到所有的数据库和用户、并不能看到数据！因为我们创建的时候只给了所有数据库用户管理的权限哦！ 然后打开 shell 界面按照创建 admin 的模板执行即可：</p>
                  <figure class="highlight gherkin">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">use 想要创建的数据库</span><br><span class="line">db.createUser(</span><br><span class="line">   &#123;</span><br><span class="line">     user: <span class="string">"想要使用的用户名"</span>,</span><br><span class="line">     pwd: <span class="string">"想要使用的密码"</span>,</span><br><span class="line">     roles: [ &#123;role:<span class="string">"赋予什么样的权限"</span>, db:<span class="string">"创建的数据库"</span>&#125; ]</span><br><span class="line">    /<span class="symbol">*</span> All build-in Roles</span><br><span class="line">    Database User Roles: read|<span class="string">readWrite</span></span><br><span class="line"><span class="string">    数据库用户角色：读</span>|<span class="string">读写</span></span><br><span class="line"><span class="string">    Database Admion Roles: dbAdmin</span>|<span class="string">dbOwner</span>|userAdmin</span><br><span class="line">    数据库管理角色：数据库管理员|<span class="string">数据库所有者</span>|<span class="string">用户管理</span></span><br><span class="line"><span class="string">    Cluster Admin Roles: clusterAdmin</span>|<span class="string">clusterManager</span>|<span class="string">clusterMonitor</span>|hostManager</span><br><span class="line">    集群管理角色：</span><br><span class="line">    Backup and Restoration Roles: backup|<span class="string">restore</span></span><br><span class="line"><span class="string">    All-Database Roles: readAnyDatabase</span>|<span class="string">readWriteAnyDatabase</span>|<span class="string">userAdminAnyDatabase</span>|dbAdminAnyDatabase</span><br><span class="line">    所有数据库角色：读所有数据库|<span class="string">读写所有数据库</span>|<span class="string">所有数据库的用户管理员</span>|<span class="string">所有数据库的管理员</span></span><br><span class="line"><span class="string">    Superuser Roles: root */</span></span><br><span class="line"><span class="string">   &#125;</span></span><br><span class="line"><span class="string">)</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>创建完成后、就可以用创建好的用户名和密码去链接有权限的数据库啦！！是不是 So Easy！！！ 其实吧 还是 bindIp 安全 哈哈哈！ 以上完毕！！ 下一篇就是基于 Scrapy-Redis 的分布式了、真的超级简单！简单得不要不要的</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/哎哟卧槽" class="author" itemprop="url" rel="index">哎哟卧槽</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2017-02-04 00:59:05" itemprop="dateCreated datePublished" datetime="2017-02-04T00:59:05+08:00">2017-02-04</time>
                </span>
                <span id="/4020.html" class="post-meta-item leancloud_visitors" data-flag-title="Scrapy分布式的前篇--让redis和MongoDB安全点" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>4.8k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>4 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/3998.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="静觅丨崔庆才的个人站点专业为您提供爬虫教程,爬虫,Python,Python爬虫,Python爬虫教程,爬虫书的相关信息，想要了解更多详情，请联系我们。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> 个人日记 <i class="label-arrow"></i>
                  </a>
                  <a href="/3998.html" class="post-title-link" itemprop="url">回首我的二零一六</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>没有选择那个二零一六年尾，而是选择了这个二零一六年尾来总结。</p>
                  <p>毕竟元旦那时候真的被一堆考试烦透，说到考试，可以说我是极其反对这种形式，在我看来，因为有了考试，学一门课反倒成了任务，而不是真正踏实地去学，有了考试，学习的目的不再是单纯学习，而是为了最后的应考。所以很多科目，经验之谈，一旦它成了我的课程，我反倒没有那么多耐心去学它。而又有很多考试，理解性的东西真的不考察理解，你背过，就高分了，背不过，那就没分。做到原题了，就有分了，做不到原题，那就不一定有分。到头来，一门课程的结束伴随着你仅仅在短时间内记忆了一些概念和题目去应考。考试结束，抛掉了，你还记得什么？何况，某些课，你可能这辈子都用不到了。 然而就是这样，或许真的没有比这更合适的考察方式了吧。 果然一扯就停不下来，后面简单点扯。 嗯，就是这样，我来北航读研了，2016级的新生，刚刚渡过了研究生第一个学期。这个学期，基本上把研究生所有的课都上完。我能体会到自己还是偏重于实践性的东西而非理论，一个想法，纯理论都是空谈，实现出来才是最终目标。作为一名程序猿，平时我喜欢瞎捣腾些东西，逛GitHub，搜开源项目，找到有趣的组件来实现自己想要的功能。 二零一六年上半年，毕设的一段时间吧，由于自己对爬虫比较感兴趣，正好毕设也有个选题是关于爬虫的，所以干脆毕设就实现了一个分布式爬虫框架，虽然也是开源项目组合起来的，Scrapy，Redis，Mongo，Splash，Django等等吧，不过这个过程的探索也是受益匪浅。哦对了，也是上半年这个时候吧，换上了自己的第一台Mac，联想也终于寿终正寝了，我也算是真正踏上了程序员的行列。一年下来，不得不说，开发真的太便捷。 那时候正好是大四，也没多少事，期间也接着大大小小的外包，赚点外快，后来又入手了单反，然而到现在我发现自己没有那么狂爱摄影。 每年都有毕业季，今年轮到我们了。毕业行去了云南，还有些意犹未尽的感觉，也感谢一路同行的小伙伴给我拍的绝世美照哈哈。后来忙着毕业照啦，穿上学士服，辗转各大校区，各种奇怪的姿势拍拍拍。现在真的挺想念山大的，那里的人儿，那里的事儿。嗯，毕业快乐。 暑假，我又回到北京。一件重要的事那就是女朋友保研，虽然中间出了点小叉子，不过还是恭喜她能被中科院录取，随后在北京呆了近整个暑假。 随之而来的，便是北航研究生的新学期了。嗯，从山大到了北航。开学时我并没有那么欣喜，或许是已经过来太多次了习惯了。上学期课满满当当，然而你以为我会乖乖听课？我可不是那种学霸。我总是有着自己的学习和项目计划，学习一些我觉得有用的东西，比如Andrew Ng的机器学习、Web相关知识还有在做自己在忙的一些项目。前面说了我不喜欢上课，不喜欢考试，因为我觉得这些时间，可以去做更有意义的事情。最后几个星期突击一下就好了。其实我的大学就是这么过来的，上课都在学习别的和撸代码去了，成绩也还说得过去，不过感觉这样还是挺充实的。然而考前突击的时候是难了点儿，因为大部分我得预习。还好，这学期过去了，后面的时间我终于可以尽情做我想做的事情了，喜欢无拘无束自己探索的感觉。 期间其实还在和同学创业，演艺行业平台，自己负责技术这方面，好玩表演（hwby.com），一年来了吧，网站实现后投入运营，前期还是非常艰难，不过近期也还是有了起色，继续加油。写的过程中也抽离出了自己的一套CMS，以便后期开发应用的时候更加便捷，现在还不成熟，暂未公开。 说一件值得骄傲的事情吧，每天坚持记有道，把每天完成的事情，成功的事情，失败的事情每天做一下总结，这种感觉似乎是记录了自己路途的脚印，自己能感觉出自己走了多远，收获了多少，有一种自我激励的感觉。从14年开始记录到到今天了，希望自己能坚持下去。 哦又想到一个，之前博客上会有很多人加我，后来我想，干脆建一个交流群多好，于是乎在九月份左右，进击的Coder诞生了，三个多月的时间吧，几乎每天都有人加，刚才看了下已经788人啦，在群里跟大家探讨经验，交流技术，没事吐吐槽，扯扯淡，真的很愉快，爱你们。 然而现在还是觉得自己有时候懒癌发作之后就什么也不想干，执行力差，定了一些计划，今天拖明天，明天拖后天，最后就那么不了了之了。半年前定的学习鬼步舞呢，到现在跳的依然那么差。说好的练好腹肌呢，现在似乎没多大效果。 总结了这么多，似乎也没有多么值得骄傲的一件事，算是瞎忙了一整年吧哈哈。 新年计划： 1.写一本爬虫的书并出版，出套算不上教程的经验分享 2.完善好我的CMS，长期维护下去 3.学习数据挖掘和Web安全，向大牛进发 4.懒癌，不敢说改掉，但也能稍微缓解下吧 5.好玩表演，燥起来。 太多太多…. 觉得自己不会的还是太多，想学的也太多，好好提高自己的执行力和自制力吧，新的一年成为更好的自己。 凌晨三点了，安。</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2017-01-27 02:49:20" itemprop="dateCreated datePublished" datetime="2017-01-27T02:49:20+08:00">2017-01-27</time>
                </span>
                <span id="/3998.html" class="post-meta-item leancloud_visitors" data-flag-title="回首我的二零一六" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>2k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>2 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/3992.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="静觅丨崔庆才的个人站点专业为您提供爬虫教程,爬虫,Python,Python爬虫,Python爬虫教程,爬虫书的相关信息，想要了解更多详情，请联系我们。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> PHP <i class="label-arrow"></i>
                  </a>
                  <a href="/3992.html" class="post-title-link" itemprop="url">Mac下升级PHP版本至7.1</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>博主在搞Web开发主要采用的是Laravel，然而发现其对PHP版本的要求是越来越高，PHP5.6已经越来受到限制，Laravel 5.5将正式弃用PHP5.6，所以博主决定直接升级到7.1版本。</p>
                  <h2 id="移除旧版本"><a href="#移除旧版本" class="headerlink" title="移除旧版本"></a>移除旧版本</h2>
                  <p>由于系统本身已经装了PHP5.6，所以需要先将其移除。 在这里列出目录以及移除需要的命令。</p>
                  <figure class="highlight groovy">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="regexp">/private/</span>etc/               sudo rm -rf php-fpm.conf.<span class="keyword">default</span> php.ini php.ini.<span class="keyword">default</span></span><br><span class="line"><span class="regexp">/usr/</span>bin/               sudo rm -rf php php-config phpdoc phpize</span><br><span class="line"><span class="regexp">/usr/</span>include                sudo rm -rf php</span><br><span class="line"><span class="regexp">/usr/</span>lib                sudo rm -rf php</span><br><span class="line"><span class="regexp">/usr/</span>sbin               sudo rm -rf php-fpm</span><br><span class="line"><span class="regexp">/usr/</span>share              sudo rm -rf php</span><br><span class="line"><span class="regexp">/usr/</span>share<span class="regexp">/man/</span>man1         sudo rm -rf php-config<span class="number">.1</span> php<span class="number">.1</span> phpize<span class="number">.1</span></span><br><span class="line"><span class="regexp">/usr/</span>share<span class="regexp">/man/</span>man8         sudo rm -rf php-fpm<span class="number">.8</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>顺次手动删除它们即可。</p>
                  <h2 id="搞清关系"><a href="#搞清关系" class="headerlink" title="搞清关系"></a>搞清关系</h2>
                  <p>在卸载过程中你会发现有PHP、FastCGI、php-fpm、spawn-fcgi等等的概念，所以在这里先梳理一下。</p>
                  <h3 id="CGI"><a href="#CGI" class="headerlink" title="CGI"></a>CGI</h3>
                  <p>CGI是为了保证web server传递过来的数据是标准格式的，方便CGI程序的编写者。 web server（比如说nginx）只是内容的分发者。比如，如果请求<code>/index.html</code>，那么web server会去文件系统中找到这个文件，发送给浏览器，这里分发的是静态数据。好了，如果现在请求的是<code>/index.php</code>，根据配置文件，nginx知道这个不是静态文件，需要去找PHP解析器来处理，那么他会把这个请求简单处理后交给PHP解析器。Nginx会传哪些数据给PHP解析器呢？url要有吧，查询字符串也得有吧，POST数据也要有，HTTP header不能少吧，好的，CGI就是规定要传哪些数据、以什么样的格式传递给后方处理这个请求的协议。仔细想想，你在PHP代码中使用的用户从哪里来的。 当web server收到<code>/index.php</code>这个请求后，会启动对应的CGI程序，这里就是PHP的解析器。接下来PHP解析器会解析php.ini文件，初始化执行环境，然后处理请求，再以规定CGI规定的格式返回处理后的结果，退出进程。web server再把结果返回给浏览器。</p>
                  <h3 id="FastCGI"><a href="#FastCGI" class="headerlink" title="FastCGI"></a>FastCGI</h3>
                  <p>Fastcgi是用来提高CGI程序性能的。 那么CGI程序的性能问题在哪呢？”PHP解析器会解析php.ini文件，初始化执行环境”，就是这里了。标准的CGI对每个请求都会执行这些步骤（不闲累啊！启动进程很累的说！），所以处理每个时间的时间会比较长。这明显不合理嘛！那么Fastcgi是怎么做的呢？首先，Fastcgi会先启一个master，解析配置文件，初始化执行环境，然后再启动多个worker。当请求过来时，master会传递给一个worker，然后立即可以接受下一个请求。这样就避免了重复的劳动，效率自然是高。而且当worker不够用时，master可以根据配置预先启动几个worker等着；当然空闲worker太多时，也会停掉一些，这样就提高了性能，也节约了资源。这就是fastcgi的对进程的管理。</p>
                  <h3 id="PHP-FPM"><a href="#PHP-FPM" class="headerlink" title="PHP-FPM"></a>PHP-FPM</h3>
                  <p>是一个实现了Fastcgi的程序，被PHP官方收了。 大家都知道，PHP的解释器是php-cgi。php-cgi只是个CGI程序，他自己本身只能解析请求，返回结果，不会进程管理（皇上，臣妾真的做不到啊！）所以就出现了一些能够调度php-cgi进程的程序，比如说由lighthttpd分离出来的spawn-fcgi。好了PHP-FPM也是这么个东东，在长时间的发展后，逐渐得到了大家的认可（要知道，前几年大家可是抱怨PHP-FPM稳定性太差的），也越来越流行。 php-fpm的管理对象是php-cgi。但不能说php-fpm是fastcgi进程的管理器，因为前面说了fastcgi是个协议，似乎没有这么个进程存在，就算存在php-fpm也管理不了他（至少目前是）。 有的说，php-fpm是php内核的一个补丁 以前是对的。因为最开始的时候php-fpm没有包含在PHP内核里面，要使用这个功能，需要找到与源码版本相同的php-fpm对内核打补丁，然后再编译。后来PHP内核集成了PHP-FPM之后就方便多了，使用<code>\--enalbe-fpm</code>这个编译参数即可。</p>
                  <h2 id="安装PHP7-1"><a href="#安装PHP7-1" class="headerlink" title="安装PHP7.1"></a>安装PHP7.1</h2>
                  <p>用brew进行安装。</p>
                  <figure class="highlight armasm">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">brew </span>install homebrew/php/php71</span><br><span class="line"><span class="keyword">brew </span>install homebrew/php/php71-mcrypt</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>安装完了之后它会自带PHP-FPM，在 启动PHP-FPM</p>
                  <figure class="highlight ebnf">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attribute">sudo php-fpm</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h3 id="配置文件目录"><a href="#配置文件目录" class="headerlink" title="配置文件目录"></a>配置文件目录</h3>
                  <p>php.ini</p>
                  <figure class="highlight awk">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="regexp">/usr/</span>local<span class="regexp">/etc/</span>php<span class="regexp">/7.1/</span>php.ini</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>php-fpm.conf</p>
                  <figure class="highlight awk">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="regexp">/usr/</span>local<span class="regexp">/etc/</span>php<span class="regexp">/7.1/</span>php-fpm.conf</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>php-fpm</p>
                  <figure class="highlight awk">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="regexp">/usr/</span>local<span class="regexp">/opt/</span>php71<span class="regexp">/sbin/</span>php-fpm</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>但是执行<code>php-fpm</code>发现没有反应，所以这里需要加一个symlink</p>
                  <figure class="highlight awk">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">ln -s <span class="regexp">/usr/</span>local<span class="regexp">/opt/</span>php71<span class="regexp">/sbin/</span>php-fpm <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>php-fpm</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>然后运行php-fpm</p>
                  <figure class="highlight ebnf">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attribute">sudo php-fpm</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>启动nginx</p>
                  <figure class="highlight ebnf">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attribute">sudo nginx</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>关于MySQL和其他的安装在这就不再赘述。 以上便完成了PHP的升级。</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2017-01-26 22:05:48" itemprop="dateCreated datePublished" datetime="2017-01-26T22:05:48+08:00">2017-01-26</time>
                </span>
                <span id="/3992.html" class="post-meta-item leancloud_visitors" data-flag-title="Mac下升级PHP版本至7.1" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>2.3k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>2 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/3952.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="静觅丨崔庆才的个人站点专业为您提供爬虫教程,爬虫,Python,Python爬虫,Python爬虫教程,爬虫书的相关信息，想要了解更多详情，请联系我们。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/3952.html" class="post-title-link" itemprop="url">小白进阶之Scrapy第二篇（登录篇）</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p><a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/QQ图片20161021225948.jpg" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/QQ图片20161021225948.jpg" alt="QQ图片20161021225948"></a>其实拿这个网站当教程刚开始我是拒绝、换其他网站吧，又没什么动力···· 然后就··········· 上一篇 Scrapy 带大家玩了 Spider 今天带带大家玩的东西有两点、第一 CrawlSpider、第二 Scrapy 登录。 目标站点：www.haoduofuli.wang <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/9555112.jpg" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/9555112.jpg" alt="9555112"></a> Go Go Go！开整！ 还记得第一步要干啥？ 创建项目文件啊！没有 Scrapy 环境的小伙伴们请参考第一篇安装一下环境哦！ 打开你的命令行界面（Windows 是 CMD）使用切换目录的命令到你需要的存放项目文件的磁盘目录</p>
                  <figure class="highlight properties">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attr">D</span>:<span class="string"></span></span><br><span class="line"><span class="attr">scrapy</span> <span class="string">startproject haoduofuli</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>好了 我在 D 盘创建了一个叫做 haoduofuli 的项目。 用 Pycharm 打开这个目录开始我们的爬取之路 Come on！ 下一步我们该做什么记得吧？当然是在 items.py 中声明字段了！方便我们在 Spider 中保存获取的内容并通过 Pipline 进行保存（items.py 本质上是一个 dict 字典） 我在 items.py 中声明了以下类容：</p>
                  <figure class="highlight mipsasm">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Define here the models for your scraped items</span></span><br><span class="line">#</span><br><span class="line"><span class="comment"># See documentation in:</span></span><br><span class="line"><span class="comment"># http://doc.scrapy.org/en/latest/topics/items.html</span></span><br><span class="line"></span><br><span class="line">import <span class="keyword">scrapy</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword">class </span>HaoduofuliItem(<span class="keyword">scrapy.Item):</span></span><br><span class="line"><span class="keyword"> </span>   <span class="comment"># define the fields for your item here like:</span></span><br><span class="line">    <span class="comment"># name = scrapy.Field()</span></span><br><span class="line"></span><br><span class="line">    category = <span class="keyword">scrapy.Field() </span><span class="comment">#类型</span></span><br><span class="line">    title = <span class="keyword">scrapy.Field() </span> <span class="comment">#标题</span></span><br><span class="line">    imgurl = <span class="keyword">scrapy.Field() </span><span class="comment">#图片的地址</span></span><br><span class="line">    yunlink = <span class="keyword">scrapy.Field() </span>   <span class="comment">#百度云盘的连接</span></span><br><span class="line">    password = <span class="keyword">scrapy.Field() </span>  <span class="comment">#百度云盘的密码</span></span><br><span class="line">    url = <span class="keyword">scrapy.Field() </span>   <span class="comment">#页面的地址</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>至于为啥声明的这些类容：各位自己去网站上观察一下、（主要是吧，贴在这儿的话 估计这博文就要被人道主义销毁了） 别忘记上一篇博文教大家的那种在 IDE 中运行 Scrapy 的方法哦！ 好上面的我们搞定、开始下一步编写 Spider 啦！ <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/QQ图片20161021223818.jpg" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/QQ图片20161021223818.jpg" alt="QQ图片20161021223818"></a> 在 spiders 文件夹中新建一个文件 haoduofuli.py（还不清楚目录和作用的小哥儿快去看看 Scrapy 的第一篇） 首先导入以下包:</p>
                  <figure class="highlight clean">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> scrapy.spiders <span class="keyword">import</span> CrawlSpider, Rule, Request ##CrawlSpider与Rule配合使用可以骑到历遍全站的作用、Request干啥的我就不解释了</span><br><span class="line"><span class="keyword">from</span> scrapy.linkextractors <span class="keyword">import</span> LinkExtractor ##配合Rule进行URL规则匹配</span><br><span class="line"><span class="keyword">from</span> haoduofuli.items <span class="keyword">import</span> HaoduofuliItem ##不解释</span><br><span class="line"><span class="keyword">from</span> scrapy <span class="keyword">import</span> FormRequest ##Scrapy中用作登录使用的一个包</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>详细介绍请参考：<a href="http://scrapy-chs.readthedocs.io/zh_CN/latest/topics/spiders.html" target="_blank" rel="noopener">http://scrapy-chs.readthedocs.io/zh_CN/latest/topics/spiders.html</a> 中的：CrawlSpider、爬取规则(Crawling rules)、pare_start_url(response)|(此方法重写 start_urls)、以及 Spider 中 start_requests()方法的重写。 下面我带大家简单的玩玩儿顺便获取我们想要的东西。 前面提到了我们需要获取全站的资源、如果使用 Spider 的话就需要写大量的代码（当然只是相对而言的大量代码）！但是我们还有另一个选择那就是今天要说的 CrawlSpider！ <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/吃惊表情1.jpg" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/吃惊表情1.jpg" alt="吃惊表情1"></a> 首先我们新建一个函数 继承 CrawlSpider（上一篇博文是继承 Spider 哦！） 见证奇迹的时刻到了!</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> scrapy.spiders <span class="keyword">import</span> CrawlSpider, Rule, Request <span class="comment">##CrawlSpider与Rule配合使用可以骑到历遍全站的作用、Request干啥的我就不解释了</span></span><br><span class="line"><span class="keyword">from</span> scrapy.linkextractors <span class="keyword">import</span> LinkExtractor <span class="comment">##配合Rule进行URL规则匹配</span></span><br><span class="line"><span class="keyword">from</span> haoduofuli.items <span class="keyword">import</span> HaoduofuliItem <span class="comment">##不解释</span></span><br><span class="line"><span class="keyword">from</span> scrapy <span class="keyword">import</span> FormRequest <span class="comment">##Scrapy中用作登录使用的一个包</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myspider</span><span class="params">(CrawlSpider)</span>:</span></span><br><span class="line"></span><br><span class="line">    name = <span class="string">'haoduofuli'</span></span><br><span class="line">    allowed_domains = [<span class="string">'haoduofuli.wang'</span>]</span><br><span class="line">    start_urls = [<span class="string">'http://www.haoduofuli.wang'</span>]</span><br><span class="line"></span><br><span class="line">    rules = (</span><br><span class="line">        Rule(LinkExtractor(allow=(<span class="string">'\.html'</span>,)), callback=<span class="string">'parse_item'</span>, follow=<span class="literal">True</span>),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse_item</span><span class="params">(self, response)</span>:</span></span><br><span class="line">        print(response.url)</span><br><span class="line">        <span class="keyword">pass</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>是不是很厉害！加上中间的空行也就不到二十行代码啊！就把整个网站历遍了！So Easy！！ 上面的几行代码的意思 很明了了啊！我只说说 rules 这一块儿 表示所有 response 都会通过这个规则进行过滤匹配、匹配啥？当然是后缀为.html 的 URL 了、callback=’parse<em>item’表示将获取到的 response 交给 parse_item 函数处理（这儿要注意了、不要使用 parse 函数、因为 CrawlSpider 使用的 parse 来实现逻辑、如果你使用了 parse 函数、CrawlSpider 会运行失败。）、follow=True 表示跟进匹配到的 URL（顺便说一句 allow 的参数支持正则表达式、虽然我也用得不熟、不过超级好使） 至于我这儿的 allow 的参数为啥是’.\html’；大伙儿自己观察一下我们需要获取想要信息的页面的 URL 是不是都是以.html 结束的？明白了吧！ 然后 rules 的大概运作方式是下面这样： <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/01/QQ截图20170122164117.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/01/QQ截图20170122164117.png" alt="QQ截图20170122164117"></a> 图很清晰明了了（本人也是初学、如有错误 还请各位及时留言 我好纠正。）中间的数据流向是靠引擎来完成的。 好了 我们来看看效果如何： <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/01/QQ20170122-011812.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/01/QQ20170122-011812.png" alt="QQ20170122-011812"></a> 这是我们返回 response 的 URL、一水儿的 URL 啊！完美！下面就可以进行提取数据了（诶！不对啊怎么没有没什么提取工具啊！还记得上篇博文说的不？下载器返回的 response 是支持 Xpath 的哦！我们直接使用 Xpath 来提取数据就行啦！） <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/表情2.jpg" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/表情2.jpg" alt="表情2"></a> 那么问题来了！Xpath 没用过啊！不会用啊！这可咋整啊！别怕！草鸡简单的！！来不着急！ 先大声跟我念：Google 大法好啊！ 哈哈哈 没错、我们需要 Chrome（至于为啥不用 Firefox、因为不知道为啥 Firefox 的 Xpath 有时和 Chrome 的结构不一样 有些时候提取不到数据、Chrome 则没什么问题） 来来！跟着我的节奏来！包你五分钟学会使用 Xpath！学不会也没关系、毕竟你也不能顺着网线来打我啊！ 第一步：打开你的 Chrome 浏览器 挑选上面任意一个 URL 打开进入我们提取数据的页面（不贴图 容易被 Say GoogBay）： 第二步：打开 Chrome 的调试模式找到我们需要提取的内容（如何快速找到呢？还不知道的小哥儿 我只能说你实在是太水了） 点击下面红圈的箭头 然后去网页上点击你需要的内容就 哔！的一下跳过去了！ <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/01/QQ20170122-013435.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/01/QQ20170122-013435.png" alt="QQ20170122-013435"></a> 第三步：在跳转的那一行就是你想要提取内容的一行（背景色完全区别于其它行！！）右键 Copy ——Copy XPath: 就像下面我提取标题： <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/01/QQ20170122-013823.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/01/QQ20170122-013823.png" alt="QQ20170122-013823"></a> 你会得到这样的内容： //</em>[@id=”post<em>content”]/p[1] 意思是：在根节点下面的有一个 id 为 post_content 的标签里面的第一个 p 标签（p[1]） 如果你需要提取的是这个标签的文本你需要在后面加点东西变成下面这样： //</em>[@id=”post_content”]/p[1]/text() 后面加上 text()标签就是提取文本 如果要提取标签里面的属性就把 text()换成@属性比如： //*[@id=”post_content”]/p[1]/@src So Easy！XPath 提取完毕！来看看怎么用的！那就更简单了！！！！ response.xpath(‘你 Copy 的 XPath’).extract()[‘要取第几个值’] 注意 XPath 提取出来的默认是 List。 <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/QQ图片20161021224219.gif" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/QQ图片20161021224219.gif" alt="QQ图片20161021224219"></a> 看完上面这一段 估计还没有五分钟吧 ！好了 XPath 掌握了！我们来开始取我们想要的东西吧！现在我们的代码应该变成这样了：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> scrapy.spiders <span class="keyword">import</span> CrawlSpider, Rule, Request <span class="comment">##CrawlSpider与Rule配合使用可以骑到历遍全站的作用、Request干啥的我就不解释了</span></span><br><span class="line"><span class="keyword">from</span> scrapy.linkextractors <span class="keyword">import</span> LinkExtractor <span class="comment">##配合Rule进行URL规则匹配</span></span><br><span class="line"><span class="keyword">from</span> haoduofuli.items <span class="keyword">import</span> HaoduofuliItem <span class="comment">##不解释</span></span><br><span class="line"><span class="keyword">from</span> scrapy <span class="keyword">import</span> FormRequest <span class="comment">##Scrapy中用作登录使用的一个包</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myspider</span><span class="params">(CrawlSpider)</span>:</span></span><br><span class="line"></span><br><span class="line">    name = <span class="string">'haoduofuli'</span></span><br><span class="line">    allowed_domains = [<span class="string">'haoduofuli.wang'</span>]</span><br><span class="line">    start_urls = [<span class="string">'http://www.haoduofuli.wang'</span>]</span><br><span class="line"></span><br><span class="line">    rules = (</span><br><span class="line">        Rule(LinkExtractor(allow=(<span class="string">'\.html'</span>,)), callback=<span class="string">'parse_item'</span>, follow=<span class="literal">True</span>),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse_item</span><span class="params">(self, response)</span>:</span></span><br><span class="line">        item = HaoduofuliItem()</span><br><span class="line">        item[<span class="string">'url'</span>] = response.url</span><br><span class="line">        item[<span class="string">'category'</span>] = response.xpath(<span class="string">'//*[@id="content"]/div[1]/div[1]/span[2]/a/text()'</span>).extract()[<span class="number">0</span>]</span><br><span class="line">        item[<span class="string">'title'</span>] = response.xpath(<span class="string">'//*[@id="content"]/div[1]/h1/text()'</span>).extract()[<span class="number">0</span>]</span><br><span class="line">        item[<span class="string">'imgurl'</span>] = response.xpath(<span class="string">'//*[@id="post_content"]/p/img/@src'</span>).extract()</span><br><span class="line">        <span class="keyword">return</span> item</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>我们来跑一下！简直完美！ <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/01/QQ20170122-020745.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/01/QQ20170122-020745.png" alt="QQ20170122-020745"></a> 关于 imgurl 那个 XPath： 你先随便找一找图片的地址 Copy XPath 类似得到这样的： //<em>[@id=”post_content”]/p[2]/img 你瞅瞅网页会发现每一个有几张图片 每张地址都在一个 p 标签下的 img 标签的 src 属性中 把这个 2 去掉变成： //</em>[@id=”post_content”]/p/img 就变成了所有 p 标签下的 img 标签了！加上 /@src 后所有图片就获取到啦！（不加[0]是因为我们要所有的地址、加了 就只能获取一个了！） 关于 XPath 更多的用法与功能详解，建议大家去看看 w3cschool (^o^)/ 第一部分完工、开始第二部分的工作吧!登！录! <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/QQ图片20161022193315.gif" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/QQ图片20161022193315.gif" alt="QQ图片20161022193315"></a> 毕竟这些都不是我们要的重点！我们要的是资源 资源啊！能下载东西的地方！如果不是为了资源 那么爬虫将毫无意义（给工钱的另算）。 但是下载资源是隐藏的，需要登录才能看见（别找我要帐号、我也是借的别人的。） 我们先来看看这个网站是怎么登录的，使用 Firefox 打开www.haoduofuli.wang/login.php（为啥是Firefox、因为个人感觉Firefox的表单界面看起来很爽啊！哈哈哈） 打开页面之后开启调试模式（怎么开不说了）—开启持续日志（不然跳转之后没了） <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/01/QQ截图20170122101749.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/01/QQ截图20170122101749.png" alt="QQ截图20170122101749"></a> 然后选择网络—选中 html 和 XHR（这样页面类容就会少很多、又不会缺少我们需要的东西） <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/01/QQ截图20170122103140.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/01/QQ截图20170122103140.png" alt="QQ截图20170122103140"></a> 现在开始登录（顺手把记住登录也勾上）！调试窗口不要关啊！！！！登录完毕之后你会发现出现一些内容 我们找到其中方法为 post 的请求、然后选择 参数 就能看到我们需要的登录表单啦！ <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/01/QQ截图20170122104241.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/01/QQ截图20170122104241.png" alt="QQ截图20170122104241"></a> 我划掉的是帐号密码、这个位置应该显示你的帐号密码（这是很简单的一个登录表单、不通用但是思路是一样的。）找到了我们想要的东西我们开始登录吧 首先要知道 Scrapy 登录是如何实现的？ 借助于 FromRequests 这个包实现的（前面已经导入过了），下面开整。不需要太大的改动只需增加一些函数 就可以轻而易举的实现的登录。 将我们的 start_urls 中的地址换掉换成我们我们的登陆地址www.haoduofuli.wang/login.php变成这样：</p>
                  <figure class="highlight clean">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> scrapy.spiders <span class="keyword">import</span> CrawlSpider, Rule, Request ##CrawlSpider与Rule配合使用可以骑到历遍全站的作用、Request干啥的我就不解释了</span><br><span class="line"><span class="keyword">from</span> scrapy.linkextractors <span class="keyword">import</span> LinkExtractor ##配合Rule进行URL规则匹配</span><br><span class="line"><span class="keyword">from</span> haoduofuli.items <span class="keyword">import</span> HaoduofuliItem ##不解释</span><br><span class="line"><span class="keyword">from</span> scrapy <span class="keyword">import</span> FormRequest ##Scrapy中用作登录使用的一个包</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">account = <span class="string">'你的账号'</span></span><br><span class="line">password = <span class="string">'你的密码'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> myspider(CrawlSpider):</span><br><span class="line"></span><br><span class="line">    name = <span class="string">'haoduofuli'</span></span><br><span class="line">    allowed_domains = [<span class="string">'haoduofuli.wang'</span>]</span><br><span class="line">    start_urls = [<span class="string">'http://www.haoduofuli.wang/wp-login.php'</span>]</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>那么问题来了！参考上面的流程图你会发现、这丫的没法登录表单没法写啊！start_urls 返回的 responses 就直接给 rules 进行处理了诶！我们需要一个什么方法来截断 start_urls 返回的 responses 方便我们把登录的表单提交上去！那么问题来了 ！该用啥？ 答案是：parse_start_url(response)这方法；此方法作用是当 start_url 返回 responses 时调用这个方法。官方解释如下： <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/01/QQ截图20170122105258.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/01/QQ截图20170122105258.png" alt="QQ截图20170122105258"></a> 然后呢？当然是构造表单并通过 FormRequests 提交了！所以我们的程序现在就应该变成这样子了:</p>
                  <figure class="highlight clean">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> scrapy.spiders <span class="keyword">import</span> CrawlSpider, Rule, Request ##CrawlSpider与Rule配合使用可以骑到历遍全站的作用、Request干啥的我就不解释了</span><br><span class="line"><span class="keyword">from</span> scrapy.linkextractors <span class="keyword">import</span> LinkExtractor ##配合Rule进行URL规则匹配</span><br><span class="line"><span class="keyword">from</span> haoduofuli.items <span class="keyword">import</span> HaoduofuliItem ##不解释</span><br><span class="line"><span class="keyword">from</span> scrapy <span class="keyword">import</span> FormRequest ##Scrapy中用作登录使用的一个包</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">account = <span class="string">'你的帐号'</span></span><br><span class="line">password = <span class="string">'你的密码'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> myspider(CrawlSpider):</span><br><span class="line"></span><br><span class="line">    name = <span class="string">'haoduofuli'</span></span><br><span class="line">    allowed_domains = [<span class="string">'haoduofuli.wang'</span>]</span><br><span class="line">    start_urls = [<span class="string">'http://www.haoduofuli.wang/wp-login.php'</span>]</span><br><span class="line"></span><br><span class="line">    def parse_start_url(self, response):</span><br><span class="line">        ###</span><br><span class="line">        如果你登录的有验证码之类的，你就可以在此处加入各种处理方法；</span><br><span class="line">        比如提交给打码平台，或者自己手动输入、再或者pil处理之类的</span><br><span class="line">        ###</span><br><span class="line">        formdate = &#123;</span><br><span class="line">                <span class="string">'log'</span>: account,</span><br><span class="line">                <span class="string">'pwd'</span>: password,</span><br><span class="line">                <span class="string">'rememberme'</span>: <span class="string">"forever"</span>,</span><br><span class="line">                <span class="string">'wp-submit'</span>: <span class="string">"登录"</span>,</span><br><span class="line">                <span class="string">'redirect_to'</span>: <span class="string">"http://www.haoduofuli.wang/wp-admin/"</span>,</span><br><span class="line">                <span class="string">'testcookie'</span>: <span class="string">"1"</span></span><br><span class="line">         &#125;</span><br><span class="line">        return [FormRequest.from_response(response, formdata=formdate, callback=self.after_login)]</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>最后一句的意思是提交表单 formdate 并将回调 after_login 函数处理后续内容（一般用来判断是否登录成功） 然后开始请求我们需要爬取的页面 现在就变成这样了！</p>
                  <figure class="highlight scala">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">from scrapy.spiders <span class="keyword">import</span> <span class="type">CrawlSpider</span>, <span class="type">Rule</span>, <span class="type">Request</span> ##<span class="type">CrawlSpider</span>与<span class="type">Rule</span>配合使用可以骑到历遍全站的作用、<span class="type">Request</span>干啥的我就不解释了</span><br><span class="line">from scrapy.linkextractors <span class="keyword">import</span> <span class="type">LinkExtractor</span> ##配合<span class="type">Rule</span>进行<span class="type">URL</span>规则匹配</span><br><span class="line">from haoduofuli.items <span class="keyword">import</span> <span class="type">HaoduofuliItem</span> ##不解释</span><br><span class="line">from scrapy <span class="keyword">import</span> <span class="type">FormRequest</span> ##<span class="type">Scrapy</span>中用作登录使用的一个包</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">account = '你的帐号'</span><br><span class="line">password = '你的密码'</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myspider</span>(<span class="params"><span class="type">CrawlSpider</span></span>)</span>:</span><br><span class="line"></span><br><span class="line">    name = <span class="symbol">'haoduoful</span>i'</span><br><span class="line">    allowed_domains = [<span class="symbol">'haoduofuli</span>.wang']</span><br><span class="line">    start_urls = [<span class="symbol">'http</span>:<span class="comment">//www.haoduofuli.wang/wp-login.php']</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse_start_url</span></span>(self, response):</span><br><span class="line">        ###</span><br><span class="line">        如果你登录的有验证码之类的，你就可以在此处加入各种处理方法；</span><br><span class="line">        比如提交给打码平台，或者自己手动输入、再或者pil处理之类的</span><br><span class="line">        ###</span><br><span class="line">        formdate = &#123;</span><br><span class="line">                <span class="symbol">'lo</span>g': account,</span><br><span class="line">                <span class="symbol">'pw</span>d': password,</span><br><span class="line">                <span class="symbol">'rememberm</span>e': <span class="string">"forever"</span>,</span><br><span class="line">                <span class="symbol">'wp</span>-submit': <span class="string">"登录"</span>,</span><br><span class="line">                <span class="symbol">'redirect_t</span>o': <span class="string">"http://www.haoduofuli.wang/wp-admin/"</span>,</span><br><span class="line">                <span class="symbol">'testcooki</span>e': <span class="string">"1"</span></span><br><span class="line">         &#125;</span><br><span class="line">        <span class="keyword">return</span> [<span class="type">FormRequest</span>.from_response(response, formdata=formdate, callback=self.after_login)]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">after_login</span></span>(self, response):</span><br><span class="line">        ###</span><br><span class="line">        可以在此处加上判断来确认是否登录成功、进行其他动作。</span><br><span class="line">        ###</span><br><span class="line">        lnk = <span class="symbol">'http</span>:<span class="comment">//www.haoduofuli.wang'</span></span><br><span class="line">        <span class="keyword">return</span> <span class="type">Request</span>(lnk)</span><br><span class="line"></span><br><span class="line">    rules = (</span><br><span class="line">        <span class="type">Rule</span>(<span class="type">LinkExtractor</span>(allow=('\.html',)), callback=<span class="symbol">'parse_ite</span>m', follow=<span class="type">True</span>),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse_item</span></span>(self, response):</span><br><span class="line">        item = <span class="type">HaoduofuliItem</span>()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            item[<span class="symbol">'categor</span>y'] = response.xpath('<span class="comment">//*[@id="content"]/div[1]/div[1]/span[2]/a/text()').extract()[0]</span></span><br><span class="line">            item[<span class="symbol">'titl</span>e'] = response.xpath('<span class="comment">//*[@id="content"]/div[1]/h1/text()').extract()[0]</span></span><br><span class="line">            item[<span class="symbol">'imgur</span>l'] = response.xpath('<span class="comment">//*[@id="post_content"]/p/img/@src').extract()</span></span><br><span class="line">            item[<span class="symbol">'yunlin</span>k'] = response.xpath('<span class="comment">//*[@id="post_content"]/blockquote/a/@href').extract()[0]</span></span><br><span class="line">            item[<span class="symbol">'passwor</span>d'] = response.xpath('<span class="comment">//*[@id="post_content"]/blockquote/font/text()').extract()[0]</span></span><br><span class="line">            <span class="keyword">return</span> item</span><br><span class="line">        except:</span><br><span class="line">            item[<span class="symbol">'categor</span>y'] = response.xpath('<span class="comment">//*[@id="content"]/div[1]/div[1]/span[2]/a/text()').extract()[0]</span></span><br><span class="line">            item[<span class="symbol">'titl</span>e'] = response.xpath('<span class="comment">//*[@id="content"]/div[1]/h1/text()').extract()[0]</span></span><br><span class="line">            item[<span class="symbol">'imgur</span>l'] = response.xpath('<span class="comment">//*[@id="post_content"]/p/img/@src').extract()</span></span><br><span class="line">            item[<span class="symbol">'yunlin</span>k'] = response.xpath('<span class="comment">//*[@id="post_content"]/blockquote/p/a/@href).extract()[0]</span></span><br><span class="line">            item[<span class="symbol">'passwor</span>d'] = response.xpath('<span class="comment">//*[@id="post_content"]/blockquote/p/span/text()').extract()[0]</span></span><br><span class="line">            <span class="keyword">return</span> item</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>return Request（lnk）就表示我们的开始页面了 至于为啥多了一个 try 判断；完全是因为 这站长不守规矩啊！有些页面不一样·····我能怎么办 我也很无奈啊！ 都是被逼的。囧 好了！Spider 写完啦！但是我们的工作还没完！！！网站是靠什么知道这个 request 是否是登录用户发出的？答案是 Cookie！ 所以我们需要 下载器 在下载网页之前在 request 中加入 Cookie 来向网站证明我们是登录用户身份；才能获取到需要登录才能查看的信息！ 这个该怎么做？现在 Scrapy 的中间件派上用场了！ 关于 Cookie 中间件参考：<a href="http://scrapy-chs.readthedocs.io/zh_CN/latest/topics/downloader-middleware.html#module-scrapy.contrib.downloadermiddleware.cookies" target="_blank" rel="noopener">http://scrapy-chs.readthedocs.io/zh_CN/latest/topics/downloader-middleware.html#module-scrapy.contrib.downloadermiddleware.cookies</a> 我们需要做的就是在 settings.py 中的 DOWNLOADER_MIDDLEWARES 开启这个中间件：scrapy.downloadermiddlewares.cookies.CookiesMiddleware 请注意！！！！！！ 每一个中间件会对 request 进行操作、你所做的操作可能会依赖于前一个中间件、所以每个中间件的顺序就异常的重要。具体该设置多少请参考： <a href="http://scrapy-chs.readthedocs.io/zh_CN/latest/topics/settings.html#std:setting-DOWNLOADER_MIDDLEWARES_BASE" target="_blank" rel="noopener">http://scrapy-chs.readthedocs.io/zh_CN/latest/topics/settings.html#std:setting-DOWNLOADER_MIDDLEWARES_BASE</a> <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/01/QQ截图20170122165743.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/01/QQ截图20170122165743.png" alt="QQ截图20170122165743"></a> 中的值设置！！这点务必注意···如果不清楚依赖关系 请按照上图的值设置。 从上面可以看出 Cookie 中间件的值为 700 、我们在 settings.py 设置也应该为 700 <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/01/QQ截图20170122170041.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/01/QQ截图20170122170041.png" alt="QQ截图20170122170041"></a> 我注释掉的请无视掉！！！ 做好这些以后 Scrapy 运作的整个流程大概就变成了下面这样： <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/01/QQ20170122-232839.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/01/QQ20170122-232839.png" alt="QQ20170122-232839"></a></p>
                  <figure class="highlight kotlin">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">return</span> Request(lnk) 这一个请求也算作 初始URL 只不过 不是start_urls的返回response 所以不会调用parse_start_url函数哦！</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p><a href="http://cdn.cuiqingcai.com/wp-content/uploads/2017/01/QQ20170122-230207.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2017/01/QQ20170122-230207.png" alt="QQ20170122-230207"></a> 跑一下！效果杠杠滴！！！至于后面的数据持久化（如何保存数据、大家请自行解决哦！比毕竟上一篇博文讲过了、） 这种更适合使用 MongoDB 存储 超级简单好使。 至此本篇博文结束。 这个还有一个分布式的版本、现在不想写了··· 等年后再写吧。 另外我真的一个资源都没看。另外我真的一个资源都没看。另外我真的一个资源都没看。另外我真的一个资源都没看。另外我真的一个资源都没看。另外我真的一个资源都没看。另外我真的一个资源都没看。另外我真的一个资源都没看。另外我真的一个资源都没看。另外我真的一个资源都没看。另外我真的一个资源都没看。另外我真的一个资源都没看。另外我真的一个资源都没看。另外我真的一个资源都没看。另外我真的一个资源都没看。另外我真的一个资源都没看。另外我真的一个资源都没看。另外我真的一个资源都没看。另外我真的一个资源都没看。另外我真的一个资源都没看。另外我真的一个资源都没看。另外我真的一个资源都没看。</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/哎哟卧槽" class="author" itemprop="url" rel="index">哎哟卧槽</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2017-01-22 23:34:39" itemprop="dateCreated datePublished" datetime="2017-01-22T23:34:39+08:00">2017-01-22</time>
                </span>
                <span id="/3952.html" class="post-meta-item leancloud_visitors" data-flag-title="小白进阶之Scrapy第二篇（登录篇）" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>10k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>9 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/3801.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="静觅丨崔庆才的个人站点专业为您提供爬虫教程,爬虫,Python,Python爬虫,Python爬虫教程,爬虫书的相关信息，想要了解更多详情，请联系我们。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/3801.html" class="post-title-link" itemprop="url">使用Python收集获取Linux系统主机信息</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>使用 python 代码收集主机的系统信息，主要：主机名称、IP、系统版本、服务器厂商、型号、序列号、CPU信息、内存等系统信息。</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#encoding: utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">收集主机的信息：</span></span><br><span class="line"><span class="string">主机名称、IP、系统版本、服务器厂商、型号、序列号、CPU信息、内存信息</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> subprocess <span class="keyword">import</span> Popen, PIPE</span><br><span class="line"><span class="keyword">import</span> os,sys</span><br><span class="line"></span><br><span class="line"><span class="string">''' 获取 ifconfig 命令的输出 '''</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getIfconfig</span><span class="params">()</span>:</span></span><br><span class="line">    p = Popen([<span class="string">'ifconfig'</span>], stdout = PIPE)</span><br><span class="line">    data = p.stdout.read()</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="string">''' 获取 dmidecode 命令的输出 '''</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getDmi</span><span class="params">()</span>:</span></span><br><span class="line">    p = Popen([<span class="string">'dmidecode'</span>], stdout = PIPE)</span><br><span class="line">    data = p.stdout.read()</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="string">''' 根据空行分段落 返回段落列表'''</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parseData</span><span class="params">(data)</span>:</span></span><br><span class="line">    parsed_data = []</span><br><span class="line">    new_line = <span class="string">''</span></span><br><span class="line">    data = [i <span class="keyword">for</span> i <span class="keyword">in</span> data.split(<span class="string">'\n'</span>) <span class="keyword">if</span> i]</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> data:</span><br><span class="line">        <span class="keyword">if</span> line[<span class="number">0</span>].strip():</span><br><span class="line">            parsed_data.append(new_line)</span><br><span class="line">            new_line = line + <span class="string">'\n'</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            new_line += line + <span class="string">'\n'</span></span><br><span class="line">    parsed_data.append(new_line)</span><br><span class="line">    <span class="keyword">return</span> [i <span class="keyword">for</span> i <span class="keyword">in</span> parsed_data <span class="keyword">if</span> i]</span><br><span class="line"></span><br><span class="line"><span class="string">''' 根据输入的段落数据分析出ifconfig的每个网卡ip信息 '''</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parseIfconfig</span><span class="params">(parsed_data)</span>:</span></span><br><span class="line">    dic = &#123;&#125;</span><br><span class="line">    parsed_data = [i <span class="keyword">for</span> i <span class="keyword">in</span> parsed_data <span class="keyword">if</span> <span class="keyword">not</span> i.startswith(<span class="string">'lo'</span>)]</span><br><span class="line">    <span class="keyword">for</span> lines <span class="keyword">in</span> parsed_data:</span><br><span class="line">        line_list = lines.split(<span class="string">'\n'</span>)</span><br><span class="line">        devname = line_list[<span class="number">0</span>].split()[<span class="number">0</span>]</span><br><span class="line">        macaddr = line_list[<span class="number">0</span>].split()[<span class="number">-1</span>]</span><br><span class="line">        ipaddr  = line_list[<span class="number">1</span>].split()[<span class="number">1</span>].split(<span class="string">':'</span>)[<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    dic[<span class="string">'ip'</span>] = ipaddr</span><br><span class="line">    <span class="keyword">return</span> dic</span><br><span class="line"></span><br><span class="line"><span class="string">''' 根据输入的dmi段落数据 分析出指定参数 '''</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parseDmi</span><span class="params">(parsed_data)</span>:</span></span><br><span class="line">    dic = &#123;&#125;</span><br><span class="line">    parsed_data = [i <span class="keyword">for</span> i <span class="keyword">in</span> parsed_data <span class="keyword">if</span> i.startswith(<span class="string">'System Information'</span>)]</span><br><span class="line">    parsed_data = [i <span class="keyword">for</span> i <span class="keyword">in</span> parsed_data[<span class="number">0</span>].split(<span class="string">'\n'</span>)[<span class="number">1</span>:] <span class="keyword">if</span> i]</span><br><span class="line">    dmi_dic = dict([i.strip().split(<span class="string">':'</span>) <span class="keyword">for</span> i <span class="keyword">in</span> parsed_data])</span><br><span class="line">    dic[<span class="string">'vender'</span>] = dmi_dic[<span class="string">'Manufacturer'</span>].strip()</span><br><span class="line">    dic[<span class="string">'product'</span>] = dmi_dic[<span class="string">'Product Name'</span>].strip()</span><br><span class="line">    dic[<span class="string">'sn'</span>] = dmi_dic[<span class="string">'Serial Number'</span>].strip()</span><br><span class="line">    <span class="keyword">return</span> dic</span><br><span class="line"></span><br><span class="line"><span class="string">''' 获取Linux系统主机名称 '''</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getHostname</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'/etc/sysconfig/network'</span>) <span class="keyword">as</span> fd:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> fd:</span><br><span class="line">            <span class="keyword">if</span> line.startswith(<span class="string">'HOSTNAME'</span>):</span><br><span class="line">                hostname = line.split(<span class="string">'='</span>)[<span class="number">1</span>].strip()</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">'hostname'</span>:hostname&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">''' 获取Linux系统的版本信息 '''</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getOsVersion</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'/etc/issue'</span>) <span class="keyword">as</span> fd:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> fd:</span><br><span class="line">            osver = line.strip()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">'osver'</span>:osver&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">''' 获取CPU的型号和CPU的核心数 '''</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getCpu</span><span class="params">()</span>:</span></span><br><span class="line">    num = <span class="number">0</span></span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'/proc/cpuinfo'</span>) <span class="keyword">as</span> fd:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> fd:</span><br><span class="line">            <span class="keyword">if</span> line.startswith(<span class="string">'processor'</span>):</span><br><span class="line">                num += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> line.startswith(<span class="string">'model name'</span>):</span><br><span class="line">                cpu_model = line.split(<span class="string">':'</span>)[<span class="number">1</span>].strip().split()</span><br><span class="line">                cpu_model = cpu_model[<span class="number">0</span>] + <span class="string">' '</span> + cpu_model[<span class="number">2</span>]  + <span class="string">' '</span> + cpu_model[<span class="number">-1</span>]</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">'cpu_num'</span>:num, <span class="string">'cpu_model'</span>:cpu_model&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">''' 获取Linux系统的总物理内存 '''</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getMemory</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'/proc/meminfo'</span>) <span class="keyword">as</span> fd:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> fd:</span><br><span class="line">            <span class="keyword">if</span> line.startswith(<span class="string">'MemTotal'</span>):</span><br><span class="line">                mem = int(line.split()[<span class="number">1</span>].strip())</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    mem = <span class="string">'%.f'</span> % (mem / <span class="number">1024.0</span>) + <span class="string">' MB'</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">'Memory'</span>:mem&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    dic = &#123;&#125;</span><br><span class="line">    data_ip = getIfconfig()</span><br><span class="line">    parsed_data_ip = parseData(data_ip)</span><br><span class="line">    ip = parseIfconfig(parsed_data_ip)</span><br><span class="line">    </span><br><span class="line">    data_dmi = getDmi()</span><br><span class="line">    parsed_data_dmi = parseData(data_dmi)</span><br><span class="line">    dmi = parseDmi(parsed_data_dmi)</span><br><span class="line"></span><br><span class="line">    hostname = getHostname()</span><br><span class="line">    osver = getOsVersion()</span><br><span class="line">    cpu = getCpu()</span><br><span class="line">    mem = getMemory()</span><br><span class="line">    </span><br><span class="line">    dic.update(ip)</span><br><span class="line">    dic.update(dmi)</span><br><span class="line">    dic.update(hostname)</span><br><span class="line">    dic.update(osver)</span><br><span class="line">    dic.update(cpu)</span><br><span class="line">    dic.update(mem)</span><br><span class="line"></span><br><span class="line">    <span class="string">''' 将获取到的所有数据信息并按简单格式对齐显示 '''</span></span><br><span class="line">    <span class="keyword">for</span> k,v <span class="keyword">in</span> dic.items():</span><br><span class="line">        <span class="keyword">print</span> <span class="string">'%-10s:%s'</span> % (k, v)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>实验测试结果：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">product   :VMware Virtual Platform</span><br><span class="line">osver     :CentOS release <span class="number">6.4</span> (Final)</span><br><span class="line">sn        :VMware<span class="number">-56</span> <span class="number">4</span>d b4 <span class="number">6</span>c <span class="number">05</span> e5 <span class="number">20</span> dc-c6 <span class="number">49</span> <span class="number">0</span>c e1 e0 <span class="number">18</span> <span class="number">1</span>c <span class="number">75</span></span><br><span class="line">Memory    :<span class="number">1870</span> MB</span><br><span class="line">cpu_num   :<span class="number">2</span></span><br><span class="line">ip        :<span class="number">192.168</span><span class="number">.0</span><span class="number">.8</span></span><br><span class="line">vender    :VMware, Inc.</span><br><span class="line">hostname  :vip</span><br><span class="line">cpu_model :Intel(R) i7<span class="number">-4710</span>MQ <span class="number">2.50</span>GHz</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/李伟" class="author" itemprop="url" rel="index">李伟</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2016-12-19 21:22:20" itemprop="dateCreated datePublished" datetime="2016-12-19T21:22:20+08:00">2016-12-19</time>
                </span>
                <span id="/3801.html" class="post-meta-item leancloud_visitors" data-flag-title="使用Python收集获取Linux系统主机信息" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>3.1k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>3 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/3472.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="静觅丨崔庆才的个人站点专业为您提供爬虫教程,爬虫,Python,Python爬虫,Python爬虫教程,爬虫书的相关信息，想要了解更多详情，请联系我们。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/3472.html" class="post-title-link" itemprop="url">小白进阶之Scrapy第一篇</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>这博文写得我懒癌犯了，最后的那个章节内容排序，我没有实验是否是正确的，不过这只是个教大家用 Scrapy 的教程，正确与否并不重要··· 如果不正确，记得留言；等我懒癌过了，我再改改······ 还有其它的问题也是一样··· ，把问题留言下； 等我懒癌过了·· 我改回来！嗯！是等我懒癌结束了，再改。 前面几篇博文，给大家从头到尾做了一个比较高效的爬虫，从这篇起来说说 Python 的爬虫框架 Scrapy； 至于为什么要说框架呢？因为啊，框架可以帮我们处理一部分事情，比如下载模块不用我们自己写了，我们只需专注于提取数据就好了； 最重要的一点啊！框架使用了异步的模式;可以加快我们的下载速度，而不用自己去实现异步框架；毕竟实现异步爬虫是一件比较麻烦的事情。 不过啊！反爬虫这个坎还是要我们自己迈过去啊！这是后话，以后再说。我们先来让 Scrapy 能跑起来，并提取出我们需要的数据，再解决其它问题。 官方文档在这儿：点我 <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/9555112.jpg" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/9555112.jpg" alt="9555112"></a> <strong>环境搭建：</strong> 关于这一点，对在 Windows 环境下使用的小伙伴来说，请务必使用我之前提到的 Anaconda 这个 Python 的发行版本，不然光环境的各种报错就能消磨掉你所有的学习兴趣！ <strong>下载地址在这儿：<a href="http://pan.baidu.com/s/1pLgySav" target="_blank" rel="noopener">http://pan.baidu.com/s/1pLgySav</a></strong> 安装完成之后，在 cmd 中执行：conda install Scrapy (如果需要使用特定版本，请在 Scrapy 后面加上 ==XXXX XXXX 代表你需要的版本号) 下面是安装示意图： <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/11/安装Scrapy.gif" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/11/安装Scrapy.gif" alt="安装Scrapy"></a> So Easy@@！环境搭建完成！是不是超简单？全程无痛啊！ 下面开始踏上新的征程！Go Go Go！！ 使用 Scrapy 第一步：创建项目；CMD 进入你需要放置项目的目录 输入：</p>
                  <figure class="highlight mipsasm">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">scrapy </span>startproject XXXXX             XXXXX代表你项目的名字</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p><a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/11/创建项目.gif" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/11/创建项目.gif" alt="创建项目"></a> OK 项目创建完成。现在可以开始我们的爬取之旅了！ 下面是目录中各个文件的作用 <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/11/各个文件的作用.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/11/各个文件的作用.png" alt="各个文件的作用"></a> 好了，目录我们认识完了，在开始之前给大家一个小技巧，Scrapy 默认是不能在 IDE 中调试的，我们在根目录中新建一个 py 文件叫：entrypoint.py；在里面写入以下内容：</p>
                  <figure class="highlight smali">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">from scrapy.cmdline import execute</span><br><span class="line">execute(['scrapy', 'crawl', 'dingdian'])</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p><strong>注意！第二行中代码中的前两个参数是不变的，第三个参数请使用自己的 spider 的名字。稍后我会讲到！！</strong> 现在整个目录看起来是这样： <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/11/快捷启动.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/11/快捷启动.png" alt="快捷启动"></a> 基础工作准备完毕！我们来说说基本思路。 上面的准备工作完成之后，我们先不要着急开始工作，毕竟作为一个框架，还是很复杂的；贸然上手 开整，很容易陷入懵逼状态啊！一团浆糊，理不清思路，后面的事情做起来很很麻烦啦！ 我们来看看下面这张图： <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/scrapy_architecture.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/scrapy_architecture.png" alt="scrapy_architecture"></a> 这就是整个 Scrapy 的架构图了； <strong>Scrapy Engine: 这是引擎，负责 Spiders、ItemPipeline、Downloader、Scheduler 中间的通讯，信号、数据传递等等！（像不像人的身体？）</strong> <strong>Scheduler(调度器): 它负责接受引擎发送过来的 requests 请求，并按照一定的方式进行整理排列，入队、并等待 Scrapy Engine(引擎)来请求时，交给引擎。</strong> <strong>Downloader（下载器）：负责下载 Scrapy Engine(引擎)发送的所有 Requests 请求，并将其获取到的 Responses 交还给 Scrapy Engine(引擎)，由引擎交给 Spiders 来处理，</strong> <strong>Spiders：它负责处理所有 Responses,从中分析提取数据，获取 Item 字段需要的数据，并将需要跟进的 URL 提交给引擎，再次进入 Scheduler(调度器)，</strong> <strong>Item Pipeline：它负责处理 Spiders 中获取到的 Item，并进行处理，比如去重，持久化存储（存数据库，写入文件，总之就是保存数据用的）</strong> <strong>Downloader Middlewares（下载中间件）：你可以当作是一个可以自定义扩展下载功能的组件</strong> <strong>Spider Middlewares（Spider 中间件）：你可以理解为是一个可以自定扩展和操作引擎和 Spiders 中间‘通信‘的功能组件（比如进入 Spiders 的 Responses;和从 Spiders 出去的 Requests）</strong> <strong>数据在整个 Scrapy 的流向：</strong> 程序运行的时候， <strong>引擎：</strong>Hi！Spider, 你要处理哪一个网站？ <strong>Spiders：</strong>我要处理 23wx.com <strong>引擎：</strong>你把第一个需要的处理的 URL 给我吧。 <strong>Spiders：</strong>给你第一个 URL 是 XXXXXXX.com <strong>引擎：</strong>Hi！调度器，我这有 request 你帮我排序入队一下。 <strong>调度器：</strong>好的，正在处理你等一下。 <strong>引擎：</strong>Hi！调度器，把你处理好的 request 给我， <strong>调度器：</strong>给你，这是我处理好的 request <strong>引擎：</strong>Hi！下载器，你按照下载中间件的设置帮我下载一下这个 request <strong>下载器：</strong>好的！给你，这是下载好的东西。（如果失败：不好意思，这个 request 下载失败，然后<strong>引擎</strong>告诉<strong>调度器</strong>，这个 request 下载失败了，你记录一下，我们待会儿再下载。） <strong>引擎：</strong>Hi！Spiders，这是下载好的东西，并且已经按照 Spider 中间件处理过了，你处理一下（<strong>注意！这儿 responses 默认是交给 def parse 这个函数处理的</strong>） <strong>Spiders：（处理完毕数据之后对于需要跟进的 URL）</strong>，Hi！<strong>引擎</strong>，这是我需要跟进的 URL，将它的 responses 交给函数 def xxxx(self, responses)处理。还有这是我获取到的 Item。 <strong>引擎</strong>：Hi ！<strong>Item Pipeline</strong> 我这儿有个 item 你帮我处理一下！<strong>调度器！</strong>这是我需要的 URL 你帮我处理下。然后从第四步开始循环，直到获取到你需要的信息， 注意！只有当调度器中不存在任何 request 了，整个程序才会停止，（也就是说，对于下载失败的ＵＲＬ，Scrapy 会重新下载。） 以上就是 Scrapy 整个流程了。 <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/QQ图片20161022193315.gif" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/QQ图片20161022193315.gif" alt="QQ图片20161022193315"></a> 大家将就着看看。 建立一个项目之后： <strong>第一件事情</strong>是在 items.py 文件中定义一些字段，这些字段用来临时存储你需要保存的数据。方便后面保存数据到其他地方，比如数据库 或者 本地文本之类的。 <strong>第二件事情</strong>在 spiders 文件夹中编写自己的爬虫 <strong>第三件事情</strong>在 pipelines.py 中存储自己的数据 <strong>还有一件事情</strong>，不是非做不可的，就 settings.py 文件 并不是一定要编辑的，只有有需要的时候才会编辑。 <strong>建议一点：在大家调试的时候建议大家在 settings.py 中取消下面几行的注释：</strong> <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/设置setting01.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/设置setting01.png" alt="设置setting01"></a> 这几行注释的作用是，Scrapy 会缓存你有的 Requests!当你再次请求时，如果存在缓存文档则返回缓存文档，而不是去网站请求，这样既加快了本地调试速度，也减轻了 网站的压力。一举多得 <strong>第一步定义字段：</strong> 好了，我们来做 第一步 定义一些字段；那具体我们要定义那些字段呢？ 这个根据自己需要的提取的内容来定义。 比如：我们爬取小说站点都需要提取些什么数据啊？ 小说名字、作者、小说地址、连载状态、连载字数、文章类别 就像下面这样： <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/Scrapy01.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/Scrapy01.png" alt="Scrapy01"></a> 这样我们第一步就完成啦！是不是 So Easy？ヾ(<em>´▽‘</em>)ﾉ ； 下面开始重点了哦！编写 spider（就是我们用来提取数据的爬虫了） <strong>第二步编写 Spider：</strong> 在 spiders 文件中新建一个 dingdian.py 文件 并导入我们需用的模块 <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/Scrapy02.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/Scrapy02.png" alt="Scrapy02"></a> <strong>PS：Scrapy 中 Response 可以直接使用 Xpath 来解析数据；不过大家也可以使用自己习惯的包，比如我导入的 BS4 、re ；当然也可以使其他比如 pyquery 之类的。这个并没有什么限制</strong> <strong>另外或许个别小伙伴会遇到 from dingdian.items import DingdianItem 这个导入失败的情况；可以试试把项目文件移动到根目录。</strong> <strong>Request 这个模块可以用来重写单独请求一个 URL，用于我们后面跟进 URL。</strong> 好了开整；首先我们需要什么？ 我们需要从一个地址入手开始爬取，我在顶点小说上没有发现有全站小说地址，但是我找到每个分类地址全部小说： 玄幻魔幻：<a href="http://www.23wx.com/class/1_1.html" target="_blank" rel="noopener">http://www.23wx.com/class/1_1.html</a> 武侠修真：<a href="http://www.23wx.com/class/2_1.html" target="_blank" rel="noopener">http://www.23wx.com/class/2_1.html</a> 都市言情：<a href="http://www.23wx.com/class/3_1.html" target="_blank" rel="noopener">http://www.23wx.com/class/3_1.html</a> 历史军事：<a href="http://www.23wx.com/class/4_1.html" target="_blank" rel="noopener">http://www.23wx.com/class/4_1.html</a> 侦探推理：<a href="http://www.23wx.com/class/5_1.html" target="_blank" rel="noopener">http://www.23wx.com/class/5_1.html</a> 网游动漫：<a href="http://www.23wx.com/class/6_1.html" target="_blank" rel="noopener">http://www.23wx.com/class/6_1.html</a> 科幻小说：<a href="http://www.23wx.com/class/7_1.html" target="_blank" rel="noopener">http://www.23wx.com/class/7_1.html</a> 恐怖灵异：<a href="http://www.23wx.com/class/8_1.html" target="_blank" rel="noopener">http://www.23wx.com/class/8_1.html</a> 散文诗词：<a href="http://www.23wx.com/class/9_1.html" target="_blank" rel="noopener">http://www.23wx.com/class/9_1.html</a> 其他：<a href="http://www.23wx.com/class/10_1.html" target="_blank" rel="noopener">http://www.23wx.com/class/10_1.html</a> 全本：<a href="http://www.23wx.com/quanben/1" target="_blank" rel="noopener">http://www.23wx.com/quanben/1</a> 好啦！入口地址我们找到了，现在开始写第一部分代码： 当然对于上面的地址，我们是可以直接全使用 Start_urls 这种列表全部请求，不过并不太美观，我需要把其中，有规律的部分，单独其他方式实现，比如字典之类的： <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/Scrapy22.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/Scrapy22.png" alt="Scrapy22"></a> 第十行：首先我们创建一个类 Myspider；这个类继承自 scrapy.Spider（当然还有一些其他父类，继承各个父类后能实现的功能不一样）； 第十二行：我们定义 name：dingdian （请注意，这 name 就是我们在 entrypoint.py 文件中的第三个参数！）！！！！<strong>请务必注意：此 Name 的！名字！在整个项目中有且只能有一个、名字不可重复！！！！</strong> 第十一行：我们定义了一个 allowed_domains；这个不是必须的；但是在某写情况下需要用得到，比如使用爬取规则的时候就需要了；它的作用是只会跟进存在于 allowed_domains 中的 URL。不存在的 URL 会被忽略。 第十七行到第十九行：我们使用字符串拼接的方式实现了我们上面发现的全部 URL。 第二十行和二十一行：我们使用了导入的 Request 包，来跟进我们的 URL（并将返回的 response 作为参数传递给 self.parse, 嗯！这个叫<strong>回调函数</strong>！） 第二十三行：使用 parse 函数接受上面 request 获取到的 response。（请务必注意：不要轻易改写 parse 函数（意思就是不要把 parse 函数用作它用）；因为这样 request 的回调函数被你用了，就没谁接受 request 返回的 response 啦！如果你非要用作它用，则需要自己给 request 一个回调函数哦！）</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> scrapy <span class="comment">#导入scrapy包</span></span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"><span class="keyword">from</span> scrapy.http <span class="keyword">import</span> Request <span class="comment">##一个单独的request的模块，需要跟进URL的时候，需要用它</span></span><br><span class="line"><span class="keyword">from</span> dingdian.items <span class="keyword">import</span> DingdianItem <span class="comment">##这是我定义的需要保存的字段，（导入dingdian项目中，items文件中的DingdianItem类）</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Myspider</span><span class="params">(scrapy.Spider)</span>:</span></span><br><span class="line"></span><br><span class="line">    name = <span class="string">'dingdian'</span></span><br><span class="line">    allowed_domains = [<span class="string">'23wx.com'</span>]</span><br><span class="line">    bash_url = <span class="string">'http://www.23wx.com/class/'</span></span><br><span class="line">    bashurl = <span class="string">'.html'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_requests</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">11</span>):</span><br><span class="line">            url = self.bash_url + str(i) + <span class="string">'_1'</span> + self.bashurl</span><br><span class="line">            <span class="keyword">yield</span> Request(url, self.parse)</span><br><span class="line">        <span class="keyword">yield</span> Request(<span class="string">'http://www.23wx.com/quanben/1'</span>, self.parse)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse</span><span class="params">(self, response)</span>:</span></span><br><span class="line">        print(response.text)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>我们测试一下是否正常工作：在 IDE 中运行我们之前创建的 entrypoint.py 文件（如果没有这个文件是不能在 IDE 中运行的哦！ヽ(=^･ω･^=)丿） 然后会像这样： <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/11/Spider编写03.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/11/Spider编写03.png" alt="Spider编写03"></a> 你会发现在红色状态报告之后，所有页面几乎是一瞬间出现的；那是因为 Scrapy 使用了异步啦！ヽ(°◇° )ノ 另外因为 Scrapy 遵循了 robots 规则，如果你想要获取的页面在 robots 中被禁止了，Scrapy 是会忽略掉的哦！！ヾ(。￣ □ ￣)ﾂ゜゜゜ 请求就这么轻而易举的实现了啊！简直 So Easy！ 继续 继续！ 我们需要历遍所有页面才能取得所有的小说页面连接： <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/11/分析网页2.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/11/分析网页2.png" alt="分析网页2"></a> <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/11/分析网页01.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/11/分析网页01.png" alt="分析网页01"></a> 每个页面的这个位置都是最后一个页面，我们提取出它，历遍就可以拼接出一个完整的 URL 了ヾ§ ￣ ▽)ゞ 2333333 Go Go <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/Scrapy20.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/Scrapy20.png" alt="Scrapy20"></a> 第二十三行：def parse(self, response)这个函数接受来在二十一行返回的 response，并处理。 第二十四行：我们使用 BS4 从 response 中获取到了最大页码。 第二十五行至二十七行：我们照例拼接了一个完整的 URL（response.url:就是这个 response 的 URL 地址） 第二十八行：功能和第二十行一样，callback= 是指定回调函数，不过不写 callback=也没有什么影响！ 注意我只是说的 callback=这个几个；不是后面的 self.get_name. 看清楚了 response 是怎么用的没？ヾ§ ￣ ▽)ゞ 2333333 是不是 So Easy？ 如果不清楚那个拼接 URL 的小伙伴可以打印出来，看看哦··· 再去观察一下网页，就很明白啦 上面两个函数就彻底的把整个网站的所有小说的页面 URL 的提取出来了，并将每个页面的 response 交给了 get_name 函数处理哦！ 现在我们的爬虫就开始处理具体的小说了哦： <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/Scrapy07.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/Scrapy07.png" alt="Scrapy07"></a> 瞅见没 我们需要的东西，快用 F12 工具看一下吧，在什么位置有什么标签，可以方便我们提取数据。还不知道怎么看的小伙伴，去看看妹子图那个教程，有教哦；实在不行百度一下也行！ 过程忽略了，直接上代码（主要是懒癌来了）： <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/Scrapy09.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/Scrapy09.png" alt="Scrapy09"></a> 前面三行不说了， 第三十七和三十八行：是我们的小说名字和 URL 第三十九行和第四十行；大伙儿可能会发现，多了个一个 meta 这么一个字典，这是 Scrapy 中传递额外数据的方法。因我们还有一些其他内容需要在下一个页面中才能获取到。 下面我的爬虫进入了这个页面： <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/Scrapy10.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/Scrapy10.png" alt="Scrapy10"></a> 这个页面就有很多我们需要的信息了：废话不说了代码上来： <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/Scrapy11.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/Scrapy11.png" alt="Scrapy11"></a> 第四十行：将我们导入的 item 文件进行实例化，用来存储我们的数据。 后面全部：将需要的数据，复制给 item[key] (注意这儿的 Key 就是我们前面在 item 文件中定义的那些字段。) 注意！response.meta[key]：这个是提取从上一个函数传递下来的值。 return item 就是返回我们的字典了，然后 Pipelines 就可以开始对这些数据进行处理了。比如 存储之类的。 好啦，Spiders 我们先编写到这个地方。（是不是有小伙伴发现我还有几个字段没有取值？当然留着你们自己试试了，哈哈哈ヽ(=^･ω･^=)丿）后面再继续。 我现在教教大家怎么处理这些数据：对头就是说说 Pipeline 了： 对于基本的 Pipeline 存储方式，网上有很多教程了，今天我们做一个自定义的 MySQL 的 Pipeline： 首先为了能好区分框架自带的 Pipeline，我们把 MySQL 的 Pipeline 单独放到一个目录里面。 <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/Scrapy12.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/Scrapy12.png" alt="Scrapy12"></a> 我们在项目中新建了一个 mysqlpipelines 的文件夹，我们所有的 MySQL 文件都放在这个目录。 <strong>init</strong>.py 这个文件不需要我说了吧，不知道做啥的小哥儿自己百度。 pipelines.py 这个是我们写存放数据的文件 sql.py 看名字就知道，需要的 sql 语句。 首先是需要的 MySQL 表，（MySQL 都没有的小哥儿 自己百度装一个啊，我就不教了）</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">DROP TABLE <span class="keyword">IF</span> EXISTS `dd_name`;</span><br><span class="line">CREATE TABLE `dd_name` (</span><br><span class="line">  `id` int(11) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `xs_name` varchar(255)<span class="built_in"> DEFAULT </span><span class="literal">NULL</span>,</span><br><span class="line">  `xs_author` varchar(255)<span class="built_in"> DEFAULT </span><span class="literal">NULL</span>,</span><br><span class="line">  `category` varchar(255)<span class="built_in"> DEFAULT </span><span class="literal">NULL</span>,</span><br><span class="line">  `name_id` varchar(255)<span class="built_in"> DEFAULT </span><span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) <span class="attribute">ENGINE</span>=InnoDB <span class="attribute">AUTO_INCREMENT</span>=38<span class="built_in"> DEFAULT </span><span class="attribute">CHARSET</span>=utf8mb4;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>首先我们再 settings.py 文件中定义好 MySQL 的配置文件（当然你也可以直接定义在 sql.py 文件中）： <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/MySQL-setting.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/MySQL-setting.png" alt="MySQL setting"></a> <strong>PS :注意 MySQL 的默认端口是 3306；我自己的 MySQL 改成了 3389。这儿各位酌情自己更改。</strong> 在开始写 sql.py 之前，我们需要安装一个 Python 操作 MySQL 的包，来自 MySQL 官方的一个包：<a href="http://cdn.mysql.com//Downloads/Connector-Python/mysql-connector-python-2.1.4.zip" target="_blank" rel="noopener">点我下载</a> 下载完成后解压出来，从 CMD 进入该目录的绝对路径，然后 Python setup.py install ；即可完成安装 下面是我们的 sql.py 文件： <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/sql01.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/sql01.png" alt="sql01"></a> 第一行至第二行分别导入了：我的 MySQL 操作包，settings 配置文件 第四行至第八行 ： 从 settings 配置文件中获取到了，我们的 MySQL 配置文件 第十行至第十一行： 初始化了一个 MySQL 的操作游标 第十三行： 定义了一个 Sql 的类 第十六行至第二十五行：定义了一个函数，将函数中的四个变量写入数据库（这四个变量就是我们后面传进来的需要存储的数据。） <strong>关于@classmethod 这个是一个修饰符；作用是我们不需要初始化类就可以直接调用类中的函数使用（具体说起来麻烦，知道作用就好啦）</strong> 好了第一部分写完了，我们还需要一个能够去重的： <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/sql01-1.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/sql01-1.png" alt="sql01"></a> 这一段代码会查找 name_id 这个字段，如果存在则会返回 1 不存在则会返回 0 Nice！sqi.py 这一部分我们完成，来开始写 pipeline 吧： <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/pipeline02.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/pipeline02.png" alt="pipeline02"></a> 第一行至第二行：我们导入了之前编写的 sql.py 中的 Sql 类，和我们建立的 item 第六行：建立了一个 DingdianPipeline 的类（别忘了一定要继承 object 这个类啊，这是做啥的不用多了解，说多了你们头晕，我也懒） 第八行：我们定义了一个 process_item 函数并有，item 和 spider 这两个参数（请注意啊！这两玩意儿 务必！！！要加上！！千万不能少！！！！务必！！！务必！！！） 第十行：你这样理解如果在 item 中存在 DingdianItem；就执行下面的。 第十一行：从 item 中取出 name_id 的值。 第十二行：调用 Sql 中的 select_name 函数获得返回值 第十三行：判断 ret 是否等于 1 ，是的话证明已经存了 第二十行：调用 Sql 中的 insert_dd_name 函数，存储上面几个值。 搞完！下面我们启用这个 Pipeline 在 settings 中作如下设置： <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/setting02.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/setting02.png" alt="setting02"></a> <strong>PS: dingdian（项目目录）.mysqlpipelines（自己建立的 MySQL 目录）.pipelines（自己建立的 pipelines 文件）.DingdianPipeline（其中定义的类） 后面的 1 是优先级程度（1-1000 随意设置，数值越低，组件的优先级越高）</strong> 好！我们来运行一下试试！！Go Go Go！ <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/scrapy15.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/scrapy15.png" alt="scrapy15"></a> Nice!!完美！！我之前运行过了 所以提示已经存在。 <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/scrapy17.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/scrapy17.png" alt="scrapy17"></a> 下面我们开始还剩下的一些内容获取：小说章节 和章节内容 首先我们在 item 中新定义一些需要获取内容的字段： <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/scrapy16.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/scrapy16.png" alt="scrapy16"></a> 代码不解释了哦！（懒癌来了，写不下去了） 继续编写 Spider 文件： <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/scrapy18.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/scrapy18.png" alt="scrapy18"></a> 请注意我图中画红框的的地方，这个地方返回 item 是不能用 return 的哦！用了就结束了，程序就不会继续下去了，得用 yield（你知道就行，这玩意儿说起来麻烦。） 第五十八行： num 这个变量的作用是 因为 Scrapy 是异步的方式运作，你采集到的章节顺序都是混乱的，需要给它有序的序列，我们按照这个排序就能得到正确的章节顺序啦 请注意在顶部导入定义的第二个 item 类！ 下面我们来写存储这部分 spider 的 Pipeline： 数据表：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">DROP TABLE <span class="keyword">IF</span> EXISTS `dd_chaptername`;</span><br><span class="line">CREATE TABLE `dd_chaptername` (</span><br><span class="line">  `id` int(11) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `xs_chaptername` varchar(255)<span class="built_in"> DEFAULT </span><span class="literal">NULL</span>,</span><br><span class="line">  `xs_content` text,</span><br><span class="line">  `id_name` int(11)<span class="built_in"> DEFAULT </span><span class="literal">NULL</span>,</span><br><span class="line">  `num_id` int(11)<span class="built_in"> DEFAULT </span><span class="literal">NULL</span>,</span><br><span class="line">  `url` varchar(255)<span class="built_in"> DEFAULT </span><span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) <span class="attribute">ENGINE</span>=InnoDB <span class="attribute">AUTO_INCREMENT</span>=2726<span class="built_in"> DEFAULT </span><span class="attribute">CHARSET</span>=gb18030;</span><br><span class="line"><span class="builtin-name">SET</span> <span class="attribute">FOREIGN_KEY_CHECKS</span>=1;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>Sql.py: <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/Scrapy13.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/Scrapy13.png" alt="Scrapy13"></a> <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/Scrapy14.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/Scrapy14.png" alt="Scrapy14"></a> 不解释了哦！ 下面是 Pipeline： <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/scrapy21.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/scrapy21.png" alt="scrapy21"></a> 有小伙伴注意，这儿比上面一个 Pipeline 少一个判断，因为我把判断移动到 Spider 中去了，这样就可以减少一次 Request，减轻服务器压力。 改变后的 Spider 长这样： <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/Scrapy16.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/12/Scrapy16.png" alt="Scrapy16"></a> 别忘了在 spider 中导入 Sql 哦！ヾ(。￣ □ ￣)ﾂ゜゜゜ 到此收工！！！！ 至于小说图片，因为 Scrapy 的图片下载管道，是自动以 md5 命名，而且感觉不爽··· 后面单独写一个异步下载的脚本··· <a href="https://github.com/thsheep/dingdian" target="_blank" rel="noopener">https://github.com/thsheep/dingdian</a></p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/哎哟卧槽" class="author" itemprop="url" rel="index">哎哟卧槽</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2016-12-07 16:44:48" itemprop="dateCreated datePublished" datetime="2016-12-07T16:44:48+08:00">2016-12-07</time>
                </span>
                <span id="/3472.html" class="post-meta-item leancloud_visitors" data-flag-title="小白进阶之Scrapy第一篇" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>8.7k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>8 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/3494.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="静觅丨崔庆才的个人站点专业为您提供爬虫教程,爬虫,Python,Python爬虫,Python爬虫教程,爬虫书的相关信息，想要了解更多详情，请联系我们。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> PHP <i class="label-arrow"></i>
                  </a>
                  <a href="/3494.html" class="post-title-link" itemprop="url">Composer进阶使用之常用命令和版本约束</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>这篇文章主要介绍一些常用的包管理命令以及包的版本如何进行约束。</p>
                  <h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2>
                  <h3 id="require命令"><a href="#require命令" class="headerlink" title="require命令"></a>require命令</h3>
                  <p>在《Composer快速入门》中已经简单介绍过使用<code>install</code>命令安装依赖的方式。除了<code>install</code>命令，我们还可以使用<code>require</code>命令快速的安装一个依赖而不需要手动在<code>composer.json</code>里添加依赖信息：</p>
                  <figure class="highlight sql">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">$ composer require monolog/monolog</span><br><span class="line">Using version ^1.19 for monolog/monolog</span><br><span class="line">./composer.json has been updated</span><br><span class="line">Loading composer repositories <span class="keyword">with</span> <span class="keyword">package</span> information</span><br><span class="line">Updating dependencies (<span class="keyword">including</span> require-dev)</span><br><span class="line">  - Installing psr/<span class="keyword">log</span> (<span class="number">1.0</span><span class="number">.0</span>)</span><br><span class="line">    Downloading: <span class="number">100</span>%         </span><br><span class="line"></span><br><span class="line">  - Installing monolog/monolog (<span class="number">1.19</span><span class="number">.0</span>)</span><br><span class="line">    Downloading: <span class="number">100</span>%         </span><br><span class="line"></span><br><span class="line">monolog/monolog suggests installing graylog2/gelf-php (<span class="keyword">Allow</span> sending <span class="keyword">log</span> messages <span class="keyword">to</span> a GrayLog2 <span class="keyword">server</span>)</span><br><span class="line">......</span><br><span class="line">monolog/monolog suggests installing php-console/php-console (<span class="keyword">Allow</span> sending <span class="keyword">log</span> messages <span class="keyword">to</span> Google Chrome)</span><br><span class="line">Writing <span class="keyword">lock</span> <span class="keyword">file</span></span><br><span class="line">Generating autoload files</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>Composer会先找到合适的版本，然后更新<code>composer.json</code>文件，在<code>require</code>那添加<code>monolog/monolog</code>包的相关信息，再把相关的依赖下载下来进行安装，最后更新<code>composer.lock</code>文件并生成php的自动加载文件。</p>
                  <h3 id="update命令"><a href="#update命令" class="headerlink" title="update命令"></a>update命令</h3>
                  <p>通过<code>update</code>命令，可以更新项目里所有的包，或者指定的某些包。</p>
                  <figure class="highlight elixir">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment"># 更新所有依赖</span></span><br><span class="line"><span class="variable">$ </span>composer update</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新指定的包</span></span><br><span class="line"><span class="variable">$ </span>composer update monolog/monolog</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新指定的多个包</span></span><br><span class="line"><span class="variable">$ </span>composer update monolog/monolog symfony/dependency-injection</span><br><span class="line"></span><br><span class="line"><span class="comment"># 还可以通过通配符匹配包</span></span><br><span class="line"><span class="variable">$ </span>composer update monolog/monolog symfony/*</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>需要注意的时，包能升级的版本会受到版本约束的约束，包不会升级到超出约束的版本的范围。例如如果<code>composer.json</code>里包的版本约束为<code>^1.10</code>，而最新版本为2.0。那么<code>update</code>命令是不能把包升级到2.0版本的，只能最高升级到1.x版本。关于版本约束请看后面的介绍。</p>
                  <h3 id="remove命令"><a href="#remove命令" class="headerlink" title="remove命令"></a>remove命令</h3>
                  <p>使用remove命令可以移除一个包及其依赖（在依赖没有被其他包使用的情况下）：</p>
                  <figure class="highlight sql">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">$ composer remove monolog/monolog</span><br><span class="line">Loading composer repositories <span class="keyword">with</span> <span class="keyword">package</span> information</span><br><span class="line">Updating dependencies (<span class="keyword">including</span> require-dev)</span><br><span class="line">  - Removing monolog/monolog (<span class="number">1.19</span><span class="number">.0</span>)</span><br><span class="line">  - Removing psr/<span class="keyword">log</span> (<span class="number">1.0</span><span class="number">.0</span>)</span><br><span class="line">Writing <span class="keyword">lock</span> <span class="keyword">file</span></span><br><span class="line">Generating autoload files</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h3 id="search命令"><a href="#search命令" class="headerlink" title="search命令"></a>search命令</h3>
                  <p>使用<code>search</code>命令可以进行包的搜索：</p>
                  <figure class="highlight vim">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">$ composer <span class="built_in">search</span> monolog</span><br><span class="line">monolog/monolog Sends your logs <span class="keyword">to</span> <span class="keyword">files</span>, sockets, inboxes, databases <span class="built_in">and</span> various web services</span><br><span class="line"></span><br><span class="line"># 如果只是想匹配名称可以使用--<span class="keyword">only</span>-name选项</span><br><span class="line">$ composer <span class="built_in">search</span> --<span class="keyword">only</span>-name monolog</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h3 id="show命令"><a href="#show命令" class="headerlink" title="show命令"></a>show命令</h3>
                  <p>使用<code>show</code>命令可以列出项目目前所安装的包的信息：</p>
                  <figure class="highlight elixir">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment"># 列出所有已经安装的包</span></span><br><span class="line"><span class="variable">$ </span>composer show</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以通过通配符进行筛选</span></span><br><span class="line"><span class="variable">$ </span>composer show monolog/*</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示具体某个包的信息</span></span><br><span class="line"><span class="variable">$ </span>composer show monolog/monolog</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>以上是常用命令的介绍。</p>
                  <h2 id="版本约束"><a href="#版本约束" class="headerlink" title="版本约束"></a>版本约束</h2>
                  <p>前面说到，我们可以指定要下载的包的版本。例如我们想要下载版本1.19的monolog。我们可以通过<code>composer.json</code>文件：</p>
                  <figure class="highlight json">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"require"</span>: &#123;</span><br><span class="line">        <span class="attr">"monolog/monolog"</span>: <span class="string">"1.19"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>然后运行<code>install</code>命令，或者通过<code>require</code>命令达到目的：</p>
                  <figure class="highlight elixir">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="variable">$ </span>composer <span class="keyword">require</span> monolog/<span class="symbol">monolog:</span><span class="number">1.19</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line"><span class="variable">$ </span>composer <span class="keyword">require</span> monolog/monolog=<span class="number">1.19</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line"><span class="variable">$composer</span> <span class="keyword">require</span> monolog/monolog <span class="number">1.19</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>除了像上面那样指定具体的版本，我们还可以通过不同的约束方式去指定版本。</p>
                  <h3 id="基本约束"><a href="#基本约束" class="headerlink" title="基本约束"></a>基本约束</h3>
                  <h4 id="精确版本"><a href="#精确版本" class="headerlink" title="精确版本"></a>精确版本</h4>
                  <p>可以指定具体的版本，告诉Composer只能安装这个版本。但是如果其他的依赖需要用到其他的版本，则包的安装或者更新最后会失败并终止。 例子：<code>1.0.2</code></p>
                  <h4 id="范围"><a href="#范围" class="headerlink" title="范围"></a>范围</h4>
                  <p>使用比较操作符你可以指定包的范围。这些操作符包括：<code>\&gt;</code>，<code>\&gt;=</code>，<code>&lt;</code>，<code>&lt;=</code>，<code>!=</code>。 你可以定义多个范围，使用空格 或者逗号<code>,</code>表示逻辑上的与，使用双竖线<code>||</code>表示逻辑上的或。其中与的优先级会大于或。</p>
                  <blockquote>
                    <p>需要注意的是，使用没有边界的范围有可能会导致安装不可预知的版本，并破坏向下的兼容性。建议使用折音号操作符。</p>
                  </blockquote>
                  <p>例子：</p>
                  <ul>
                    <li><code>\&gt;=1.0</code></li>
                    <li><code>\&gt;=1.0 &lt;2.0</code></li>
                    <li><code>\&gt;=1.0 &lt;1.1 || &gt;=1.2</code></li>
                  </ul>
                  <h4 id="范围（使用连字符）"><a href="#范围（使用连字符）" class="headerlink" title="范围（使用连字符）"></a>范围（使用连字符）</h4>
                  <p>带连字符的范围表明了包含的版本范围，意味着肯定是有边界的。其中连字符的左边表明了<code>\&gt;=</code>的版本，而连字符的右边情况则稍微有点复杂。如果右边的版本不是完整的版本号，则会被使用通配符进行补全。例如<code>1.0 - 2.0</code>等同于<code>\&gt;=1.0.0 &lt;2.1</code>（<code>2.0</code>相当于<code>2.0.*</code>），而<code>1.0.0 - 2.1.0</code>则等同于<code>\&gt;=1.0.0 &lt;=2.1.0</code>。 例子：<code>1.0 - 2.0</code></p>
                  <h4 id="通配符"><a href="#通配符" class="headerlink" title="通配符"></a>通配符</h4>
                  <p>可以使用通配符去定义版本。<code>1.0.*</code>相当于<code>\&gt;=1.0 &lt;1.1</code>。 例子：<code>1.0.*</code></p>
                  <h3 id="下一个重要版本操作符"><a href="#下一个重要版本操作符" class="headerlink" title="下一个重要版本操作符"></a>下一个重要版本操作符</h3>
                  <h4 id="波浪号"><a href="#波浪号" class="headerlink" title="波浪号~"></a>波浪号<code>~</code></h4>
                  <p>我们先通过后面这个例子去解释<code>~</code>操作符的用法：<code>~1.2</code>相当于<code>\&gt;=1.2 &lt;2.0.0</code>，而<code>~1.2.3</code>相当于<code>\&gt;=1.2.3 &lt;1.3.0</code>。对于使用<a href="http://semver.org/" target="_blank" rel="noopener">Semantic Versioning</a>作为版本号标准的项目来说，这种版本约束方式很实用。例如<code>~1.2</code>定义了最小的小版本号，然后你可以升级2.0以下的任何版本而不会出问题，因为按照<a href="http://semver.org/" target="_blank" rel="noopener">Semantic Versioning</a>的版本定义，小版本的升级不应该有兼容性的问题。简单来说，<code>~</code>定义了最小的版本，并且允许版本的最后一位版本号进行升级（没懂得话，请再看一边前面的例子）。 例子：<code>~1.2</code></p>
                  <blockquote>
                    <p>需要注意的是，如果<code>~</code>作用在主版本号上，例如<code>~1</code>，按照上面的说法，Composer可以安装版本1以后的主版本，但是事实上是<code>~1</code>会被当作<code>~1.0</code>对待，只能增加小版本，不能增加主版本。</p>
                  </blockquote>
                  <h4 id="折音号"><a href="#折音号" class="headerlink" title="折音号^"></a>折音号<code>^</code></h4>
                  <p><code>^</code>操作符的行为跟<a href="http://semver.org/" target="_blank" rel="noopener">Semantic Versioning</a>有比较大的关联，它允许升级版本到安全的版本。例如，<code>^1.2.3</code>相当于<code>\&gt;=1.2.3 &lt;2.0.0</code>，因为在2.0版本前的版本应该都没有兼容性的问题。而对于1.0之前的版本，这种约束方式也考虑到了安全问题，例如<code>^0.3</code>会被当作<code>\&gt;=0.3.0 &lt;0.4.0</code>对待。 例子：<code>^1.2.3</code></p>
                  <h3 id="版本稳定性"><a href="#版本稳定性" class="headerlink" title="版本稳定性"></a>版本稳定性</h3>
                  <p>如果你没有显式的指定版本的稳定性，Composer会根据使用的操作符，默认在内部指定为<code>\-dev</code>或者<code>\-stable</code>。例如：</p>
                  <p>约束</p>
                  <p>内部约束</p>
                  <p>1.2.3</p>
                  <p>\=1.2.3.0-stable</p>
                  <p>>1.2</p>
                  <p>>1.2.0.0-stable</p>
                  <p>>=1.2</p>
                  <p>>=1.2.0.0-dev</p>
                  <p>>=1.2-stable</p>
                  <p>>=1.2.0.0-stable</p>
                  <p>&lt;1.3</p>
                  <p>&lt;1.3.0.0-dev</p>
                  <p>&lt;=1.3</p>
                  <p>&lt;=1.3.0.0-stable</p>
                  <p>1 - 2</p>
                  <p>>=1.0.0.0-dev &lt;3.0.0.0-dev</p>
                  <p>~1.3</p>
                  <p>>=1.3.0.0-dev &lt;2.0.0.0-dev</p>
                  <p>1.4.*</p>
                  <p>>=1.4.0.0-dev &lt;1.5.0.0-dev</p>
                  <p>如果你想指定版本只要稳定版本，你可以在版本后面添加后缀<code>\-stable</code>。 <code>minimum-stability</code> 配置项定义了包在选择版本时对稳定性的选择的默认行为。默认是<code>stable</code>。它的值如下（按照稳定性排序）：<code>dev</code>，<code>alpha</code>，<code>beta</code>，<code>RC</code>和<code>stable</code>。除了修改这个配置去修改这个默认行为，我们还可以通过<a href="https://getcomposer.org/doc/04-schema.md#package-links" target="_blank" rel="noopener">稳定性标识</a>（例如<code>@stable</code>和<code>@dev</code>）来安装一个相比于默认配置不同稳定性的版本。例如：</p>
                  <figure class="highlight json">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"require"</span>: &#123;</span><br><span class="line">        <span class="attr">"monolog/monolog"</span>: <span class="string">"1.0.*@beta"</span>,</span><br><span class="line">        <span class="attr">"acme/foo"</span>: <span class="string">"@dev"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>以上是版本约束的介绍</p>
                  <h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2>
                  <ul>
                    <li><a href="https://segmentfault.com/a/1190000005898222" target="_blank" rel="noopener">https://segmentfault.com/a/1190000005898222</a></li>
                    <li><a href="https://getcomposer.org/doc/03-cli.md%5B2%5D" target="_blank" rel="noopener">https://getcomposer.org/doc/03-cli.md[2]</a></li>
                    <li><a href="https://getcomposer.org/doc/articles/versions.md%5B3%5D" target="_blank" rel="noopener">https://getcomposer.org/doc/articles/versions.md[3]</a></li>
                    <li><a href="http://semver.org/%5B1%5D" target="_blank" rel="noopener">http://semver.org/[1]</a></li>
                  </ul>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2016-11-26 18:00:10" itemprop="dateCreated datePublished" datetime="2016-11-26T18:00:10+08:00">2016-11-26</time>
                </span>
                <span id="/3494.html" class="post-meta-item leancloud_visitors" data-flag-title="Composer进阶使用之常用命令和版本约束" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>4k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>4 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/3443.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="静觅丨崔庆才的个人站点专业为您提供爬虫教程,爬虫,Python,Python爬虫,Python爬虫教程,爬虫书的相关信息，想要了解更多详情，请联系我们。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/3443.html" class="post-title-link" itemprop="url">Python爬虫进阶七之设置ADSL拨号服务器代理</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <h2 id="2022-年最新-Python3-网络爬虫教程"><a href="#2022-年最新-Python3-网络爬虫教程" class="headerlink" title="2022 年最新 Python3 网络爬虫教程"></a>2022 年最新 Python3 网络爬虫教程</h2>
                  <p>大家好，我是崔庆才，由于爬虫技术不断迭代升级，一些旧的教程已经过时、案例已经过期，最前沿的爬虫技术比如异步、JavaScript 逆向、安卓逆向、智能解析、WebAssembly、大规模分布式、Kubernetes 等技术层出不穷，我最近新出了一套最新最全面的 Python3 网络爬虫系列教程。</p>
                  <blockquote>
                    <p>博主自荐：截止 2022 年，可以将最前沿最全面的爬虫技术都涵盖的教程，如异步、JavaScript 逆向、安卓逆向、智能解析、WebAssembly、大规模分布式、Kubernetes 等，市面上目前就这一套了。</p>
                  </blockquote>
                  <p>最新教程对旧的爬虫技术内容进行了全面更新，搭建了全新的案例平台进行全面讲解，保证案例稳定有效不过期。</p>
                  <p>教程请移步：</p>
                  <p><a href="https://cuiqingcai.com/17777.html">【2022 版】Python3 网络爬虫学习教程</a></p>
                  <p>如下为原文。</p>
                  <h2 id="提示"><a href="#提示" class="headerlink" title="提示"></a>提示</h2>
                  <p>本教程方法已不是最优，最新解决方案请移步 <a href="http://cuiqingcai.com/4596.html">http://cuiqingcai.com/4596.html</a></p>
                  <h2 id="那夜"><a href="#那夜" class="headerlink" title="那夜"></a>那夜</h2>
                  <p>那是一个寂静的深夜，科比还没起床练球，虽然他真的可能不练了。 我废了好大劲，爬虫终于写好了！BUG 也全部调通了！心想，终于可以坐享其成了！ 泡杯茶，安静地坐在椅子上看着屏幕上一行行文字在控制台跳出，一条条数据嗖嗖进入我的数据库，一张张图片悄悄存入我的硬盘。人生没有几个比这更惬意的事情了。 我端起茶杯，抿了一口，静静地回味着茶香。 这时，什么情况！屏幕爆红了！爆红了！一口茶的功夫啊喂！ 怎么回事！咋爬不动了，不动了！我用浏览器点开那一个个报错的链接，浏览器显示</p>
                  <blockquote>
                    <p>您的请求过于频繁，IP 已经被暂时封禁，请稍后再试！</p>
                  </blockquote>
                  <p>沃日，我 IP 被封了？此时此刻，空气凝固了，茶也不再香了，请给我一个爱的抱抱啊。 时候不早了，还是洗洗睡吧。</p>
                  <h2 id="次日"><a href="#次日" class="headerlink" title="次日"></a>次日</h2>
                  <p>那一晚，辗转反侧难以入睡。 怎么办？怎么办？如果是你你该怎么办？ 手动换个 IP？得了吧，一会又要封了，还能不能安心睡觉啊？ 找免费代理？可行，不过我之前测过不少免费代理 IP，一大半都不好用，而且慢。不过可以一直维护一个代理池，定时更新。 买代理？可以可以，不过优质的代理服务商价格可是不菲的，我买过一些廉价的，比如几块钱套餐一次提取几百 IP 的，算了还是不说了都是泪。 然而最行之有效的方法是什么？那当然是 ADSL 拨号！ 这是个啥？且听我慢慢道来。</p>
                  <h2 id="什么是-ADSL"><a href="#什么是-ADSL" class="headerlink" title="什么是 ADSL"></a>什么是 ADSL</h2>
                  <p>ADSL （Asymmetric Digital Subscriber Line ，非对称数字用户环路）是一种新的数据传输方式。它因为上行和下行带宽不对称，因此称为非对称数字用户线环路。它采用频分复用技术把普通的电话线分成了电话、上行和下行三个相对独立的信道，从而避免了相互之间的干扰。 他有个独有的特点，每拨一次号，就获取一个新的 IP。也就是它的 IP 是不固定的，不过既然是拨号上网嘛，速度也是有保障的，用它搭建一个代理，那既能保证可用，又能自由控制拨号切换。 如果你是用的 ADSL 上网方式，那就不用过多设置了，直接自己电脑调用一个拨号命令就好了，自动换 IP，分分钟解决封 IP 的事。 然而，你可能说？我家宽带啊，我连得公司无线啊，我蹭的网上的啊！那咋办？ 这时，你就需要一台 VPS 拨号主机。</p>
                  <h2 id="购买服务器"><a href="#购买服务器" class="headerlink" title="购买服务器"></a>购买服务器</h2>
                  <p>某度广告做的那么好是吧？一搜一片，这点谷歌可是远远比不上啊。 于是乎，我就搜了搜，键入：拨号服务器，有什么骑士互联啊、无极网络啊、挂机宝啊等等的。我选了个价钱还凑合的，选了个无极网络（这里不是在打广告），80 一个月的配置，一天两块钱多点。 2 核、512M 内存，10M 带宽。 <a href="http://www.yunlifang.cn/" target="_blank" rel="noopener">云立方</a> 大家觉得有更便宜的更好用请告诉我呀！ 接下来开始装操作系统，进入后台，有一个自助装系统的页面。 <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/11/QQ20161121-0.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/11/QQ20161121-0-1024x399.png" alt="QQ20161121-0"></a> 我装的 CentOS 的，在后面设置代理啊，定时任务啊，远程 SSH 管理啊之类的比较方便。如果你想用 Windows，能配置好代理那也没问题。 有的小伙伴可能会问了，既然它的 IP 是拨号变化的，你咋用 SSH 连？其实服务商提供了一个域名，做了动态解析和端口映射，映射到这台主机的 22 端口就好了，所以不用担心 IP 变化导致 SSH 断开的问题。 好了装好了服务器之后，服务商提供了一个 ADSL 的拨号操作过程，用 pppoe 命令都可以完成，如果你的是 Linux 的主机一般都是用这个。然后服务商还会给给你一个拨号账号和密码。 那么接下来就是试下拨号了。 服务商会提供详细的拨号流程说明。 比如无极的是这样的： <a href="http://cloud.871020.com/vpsadm/pppoe.html" target="_blank" rel="noopener">拨号流程</a> 设置好了之后，就有几个关键命令：</p>
                  <figure class="highlight sql">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">pppoe-<span class="keyword">start</span> 拨号</span><br><span class="line">pppoe-<span class="keyword">stop</span>  断开拨号</span><br><span class="line">pppoe-<span class="keyword">status</span> 拨号连接状态</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>如果想重新拨号，那就执行 stop、start 就可以了。 反复执行，然后查看下 ip 地址，你会发现拨号一次换一个 IP，是不是爽翻了！ 好，那接下来就设置代理吧。</p>
                  <h2 id="设置代理服务器"><a href="#设置代理服务器" class="headerlink" title="设置代理服务器"></a>设置代理服务器</h2>
                  <p>之前总是用别人的代理，没自己设置过吧？那么接下来我们就来亲自搭建 HTTP 代理。 Linux 下搭建 HTTP 代理，推荐 Squid 和 TinyProxy。都非常好配置，你想用哪个都行，且听我慢慢道来。 我的系统是 CentOS，以它为例进行说明。</p>
                  <h3 id="Squid"><a href="#Squid" class="headerlink" title="Squid"></a>Squid</h3>
                  <p>首先利用 yum 安装 squid</p>
                  <figure class="highlight cmake">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">yum -y <span class="keyword">install</span> squid</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>设置开机启动</p>
                  <figure class="highlight nginx">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attribute">chkconfig</span> --level <span class="number">35</span> squid <span class="literal">on</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>修改配置文件</p>
                  <figure class="highlight vim">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">vi</span> /etc/squid/squid.<span class="keyword">conf</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>修改如下几个部分：</p>
                  <figure class="highlight yaml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="string">http_access</span> <span class="string">allow</span> <span class="type">!Safe_ports</span>    <span class="comment">#deny改成allow</span></span><br><span class="line"><span class="string">http_access</span> <span class="string">allow</span> <span class="string">CONNECT</span> <span class="type">!SSL_ports</span>  <span class="comment">#deny改成allow</span></span><br><span class="line"><span class="string">http_access</span> <span class="string">allow</span> <span class="string">all</span>  <span class="comment">#deny改成allow</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>其他的不需要过多配置。 启动 squid</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">sudo<span class="built_in"> service </span>squid start</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>如此一来配置就完成了。 代理使用的端口是 3128</p>
                  <h3 id="TinyProxy"><a href="#TinyProxy" class="headerlink" title="TinyProxy"></a>TinyProxy</h3>
                  <p>首先添加一下镜像源，然后安装</p>
                  <figure class="highlight properties">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attr">rpm</span> <span class="string">-Uvh http://dl.fedoraproject.org/pub/epel/5/i386/epel-release-5-4.noarch.rpm</span></span><br><span class="line"><span class="attr">yum</span> <span class="string">update</span></span><br><span class="line"><span class="attr">yum</span> <span class="string">install tinyproxy</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>修改配置</p>
                  <figure class="highlight vim">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">vi</span> /etc/tinyproxy/tinyproxy.<span class="keyword">conf</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可以修改端口和允许的 IP，如果想任意主机都连接那就把 Allow 这一行注释掉。</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">Port <span class="number">8888</span> #预设是<span class="number">8888</span> Port,你可以更改</span><br><span class="line">Allow <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> #将<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>改成你自己的IP</span><br><span class="line">#例如你的IP 是<span class="number">1.2</span><span class="number">.3</span><span class="number">.4</span>,你改成Allow <span class="number">1.2</span><span class="number">.3</span><span class="number">.4</span>,那只有你才可以连上这个Proxy</span><br><span class="line">#若你想任何IP都可以脸到Proxy在Allow前面打#注释</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>启动 TinyProxy</p>
                  <figure class="highlight crmsh">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">service tinyproxy <span class="literal">start</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>好了，两个代理都配置好了。 你想用那个都可以！ 不过你以为这样就完了吗？太天真了，我被困扰了好几天，怎么都连不上，我还在怀疑是不是我哪里设置得不对？各种搜，一直以为是哪里配置有遗漏，后来发现是 iptables 的锅，万恶的防火墙。踩过的的坑，那就不要让大家踩了，用下面的命令设置下 iptables，放行 3128 和 8888 端口就好了。</p>
                  <figure class="highlight properties">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attr">service</span> <span class="string">iptables save</span></span><br><span class="line"><span class="attr">systemctl</span> <span class="string">stop firewalld</span></span><br><span class="line"><span class="attr">systemctl</span> <span class="string">disable  firewalld</span></span><br><span class="line"><span class="attr">systemctl</span> <span class="string">start iptables</span></span><br><span class="line"><span class="attr">systemctl</span> <span class="string">status iptables</span></span><br><span class="line"><span class="attr">systemctl</span> <span class="string">enable iptables</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>修改 iptables 配置</p>
                  <figure class="highlight awk">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">vi <span class="regexp">/etc/</span>sysconfig<span class="regexp">/iptables</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在</p>
                  <figure class="highlight brainfuck">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="literal">-</span><span class="comment">A</span> <span class="comment">IN_public_allow</span> <span class="literal">-</span><span class="comment">p</span> <span class="comment">tcp</span> <span class="literal">-</span><span class="comment">m</span> <span class="comment">tcp</span> --<span class="comment">dport</span> <span class="comment">22</span> <span class="literal">-</span><span class="comment">m</span> <span class="comment">conntrack</span> --<span class="comment">ctstate</span> <span class="comment">NEW</span> <span class="literal">-</span><span class="comment">j</span> <span class="comment">ACCEPT</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>的下面添加两条规则</p>
                  <figure class="highlight brainfuck">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="literal">-</span><span class="comment">A</span> <span class="comment">IN_public_allow</span> <span class="literal">-</span><span class="comment">p</span> <span class="comment">tcp</span> <span class="literal">-</span><span class="comment">m</span> <span class="comment">tcp</span> --<span class="comment">dport</span> <span class="comment">3128</span> <span class="literal">-</span><span class="comment">m</span> <span class="comment">conntrack</span> --<span class="comment">ctstate</span> <span class="comment">NEW</span> <span class="literal">-</span><span class="comment">j</span> <span class="comment">ACCEPT</span></span><br><span class="line"><span class="comment"></span><span class="literal">-</span><span class="comment">A</span> <span class="comment">IN_public_allow</span> <span class="literal">-</span><span class="comment">p</span> <span class="comment">tcp</span> <span class="literal">-</span><span class="comment">m</span> <span class="comment">tcp</span> --<span class="comment">dport</span> <span class="comment">8888</span> <span class="literal">-</span><span class="comment">m</span> <span class="comment">conntrack</span> --<span class="comment">ctstate</span> <span class="comment">NEW</span> <span class="literal">-</span><span class="comment">j</span> <span class="comment">ACCEPT</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>如图所示 <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/11/QQ20161121-0@2x.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/11/QQ20161121-0@2x-1024x688.png" alt="QQ20161121-0@2x"></a> 保存，然后重启 iptables</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">sudo<span class="built_in"> service </span>iptabels restart</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>输入 ifconfig 得到 IP 地址，在其他的主机上输入</p>
                  <figure class="highlight css">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="selector-tag">curl</span> <span class="selector-tag">-x</span> <span class="selector-tag">IP</span><span class="selector-pseudo">:8888</span> <span class="selector-tag">www</span><span class="selector-class">.baidu</span><span class="selector-class">.com</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>测试一下，如果能出现结果，那就说明没问题。 <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/11/QQ20161121-1@2x.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/11/QQ20161121-1@2x-1024x688.png" alt="QQ20161121-1@2x"></a> 如果怎么配都连不上，那干脆关了你的防火墙吧。虽然不推荐。</p>
                  <h2 id="连接代理"><a href="#连接代理" class="headerlink" title="连接代理"></a>连接代理</h2>
                  <p>接下来才是重头戏，你咋知道你的服务器 IP 现在到底是多少啊？拨一次号 IP 就换一次，那这还了得？ 如果服务商提供了端口映射！那一切都解决了！直接用端口映射过去就好了。然而，我的并没有。 自力更生，艰苦创业！ 首先我研究了一下 DDNS 服务，也就是动态域名解析。即使你的 IP 在变化，那也可以通过一个域名来映射过来。 原理简单而统一：当前拨号主机定时向一个固定的服务器发请求，服务器获取 remote_addr 就好了，可以做到定时更新和解析。 那么我找了一下，国内做的比较好的就是花生壳了，然后又找到了 DNSPOD 的接口解析。 下面简单说下我的折腾过程，大家可以先不用试，后面有更有效的方法。</p>
                  <h3 id="花生壳"><a href="#花生壳" class="headerlink" title="花生壳"></a>花生壳</h3>
                  <p>现在花生壳出到 3.0 版本了，有免费版和付费版之分，我就试用了一下免费版的。这里是花生壳的一些配置和下载： <a href="http://service.oray.com/question/4287.html" target="_blank" rel="noopener">花生壳配置</a> 下载花生壳客户端之后，会生成 SN 码，用这个在花生壳的官网登录后，会分配给你一个免费的域名。 接下来这个域名就能解析到你的主机了。</p>
                  <h3 id="DNSPOD"><a href="#DNSPOD" class="headerlink" title="DNSPOD"></a>DNSPOD</h3>
                  <p>DNSPOD 原理也是一样，不过好处是你可以配置自己的域名。 在 GitHub 上有脚本可以使用。 <a href="https://github.com/xdtianyu/scripts/tree/master/ddns" target="_blank" rel="noopener">脚本链接</a> 具体的细节我就不说了，实际上就是定时请求，利用 remote_addr 更新 DNSPOD 记录，做到动态解析。 <a href="https://www.dnspod.cn/docs/records.html#dns" target="_blank" rel="noopener">解析接口</a> 不过！这两个有个通病！慢！ 什么慢？解析慢！但这不是他们的锅，因为 DNS 修改后完全生效就是需要一定的时间，这一秒你拨号了，然后更新了 IP，但是域名可能还是解析着原来的 IP，需要过几分钟才能变过来。这能忍吗？ 我可是在跑爬虫啊，这还能忍？</p>
                  <h2 id="自力更生"><a href="#自力更生" class="headerlink" title="自力更生"></a>自力更生</h2>
                  <p>嗯，V2EX 果然是个好地方，逛了一下，收获不小。 <a href="https://www.v2ex.com/t/249694" target="_blank" rel="noopener">链接在此</a> 参考了 abelyao 的思路，自己写了脚本来获取 IP，保证秒级更新！ 此时，你还需要另一台固定 IP 的主机或者某个云服务器，只要是地址固定的就好。在这里我用了另一台有固定 IP 的阿里云主机，当然你如果有什么新浪云啊之类的也可以。 那么现在的思路就是，拨号 VPS 定时拨号换 IP，然后请求阿里云主机，阿里云主机获取 VPS 的 IP 地址即可。 拨号 VPS 做的事情： 定时拨号，定时请求服务器。使用 bash 脚本，然后 crontab 定时执行。 远程服务器： 接收请求，获取 remote_addr，保存起来。使用 Flask 搭建服务器，接收请求。 废话少说，上代码 <a href="https://github.com/Germey/AutoProxy" target="_blank" rel="noopener">AutoProxy</a></p>
                  <h3 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h3>
                  <p>由于 DDNS 生效时间过长，对于爬虫等一些时间要求比较紧迫的项目就不太适用，为此本项目根据 DDNS 基本原理来实现实时获取 ADSL 拨号主机 IP。</p>
                  <h3 id="基本原理"><a href="#基本原理" class="headerlink" title="基本原理"></a>基本原理</h3>
                  <p>client 文件夹由 ADSL 拨号客户机运行。它会定时执行拨号操作，然后请求某个固定地址的服务器，以便让服务器获取 ADSL 拨号客户机的 IP，主要是定时 bash 脚本运行。 server 文件夹是服务器端运行，利用 Python 的 Flask 搭建服务器，然后接收 ADSL 拨号客户机的请求，得到 remote_addr，获取客户机拨号后的 IP。</p>
                  <h3 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h3>
                  <h4 id="server"><a href="#server" class="headerlink" title="server"></a>server</h4>
                  <ul>
                    <li>config.py 配置文件。</li>
                    <li>ip 客户端请求后获取的客户端 IP，文本保存。</li>
                    <li>main.py Flask 主程序，提供两个接口，一个是接收客户端请求，然后将 IP 保存，另外一个是获取当前保存的 IP。</li>
                  </ul>
                  <h4 id="client"><a href="#client" class="headerlink" title="client"></a>client</h4>
                  <ul>
                    <li>crontab 定时任务命令示例。</li>
                    <li>pppoe.sh 拨号脚本，主要是实现重新拨号的几个命令。</li>
                    <li>request.sh 请求服务器的脚本，主要是实现拨号后请求服务器的操作。</li>
                    <li>request.conf 配置文件。</li>
                  </ul>
                  <h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3>
                  <h4 id="服务器"><a href="#服务器" class="headerlink" title="服务器"></a>服务器</h4>
                  <p>服务器提供两个功能，record 方法是客户机定时请求，然后获取客户机 IP 并保存。proxy 方法是供我们自己用，返回保存的客户机 IP，提取代理。</p>
                  <h5 id="克隆项目"><a href="#克隆项目" class="headerlink" title="克隆项目"></a>克隆项目</h5>
                  <figure class="highlight crmsh">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">git <span class="keyword">clone</span> <span class="title">https</span>://github.com/Germey/AutoProxy.git</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h5 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h5>
                  <p>修改 config.py 文件</p>
                  <ul>
                    <li>KEY 是客户端请求服务器时的凭证，在 client 的 request.conf 也有相同的配置，二者保持一致即可。</li>
                    <li>NEED_AUTH 在获取当前保存的 IP（即代理的 IP）的时候，为防止自己的主机代理被滥用，在获取 IP 的时候，需要加权限验证。</li>
                    <li>AUTH_USER 和 AUTH_PASSWORD 分别是认证用户名密码。</li>
                    <li>PORT 默认端口，返回保存的结果中会自动添加这个端口，组成一个 IP:PORT 的代理形式。</li>
                  </ul>
                  <h4 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h4>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">cd server</span><br><span class="line">nohup python main.py</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h4 id="ADSL-客户机"><a href="#ADSL-客户机" class="headerlink" title="ADSL 客户机"></a>ADSL 客户机</h4>
                  <h5 id="克隆项目-1"><a href="#克隆项目-1" class="headerlink" title="克隆项目"></a>克隆项目</h5>
                  <figure class="highlight crmsh">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">git <span class="keyword">clone</span> <span class="title">https</span>://github.com/Germey/AutoProxy.git</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h5 id="修改配置-1"><a href="#修改配置-1" class="headerlink" title="修改配置"></a>修改配置</h5>
                  <p>修改 reqeust.conf 文件</p>
                  <ul>
                    <li>KEY 是客户端请求服务器时的凭证，在 server 的 config.py 也有相同的配置，二者保持一致即可。</li>
                    <li>SERVER 是服务器项目运行后的地址，一般为 http://&lt;服务器 IP&gt;:&lt;服务器端口&gt;/record。如<code>http://120.27.14.24:5000/record</code>。</li>
                  </ul>
                  <p>修改 pppoe.sh 文件 这里面写上重新拨号的几条命令，记得在前两行配置一下环境变量，配置上拨号命令所在的目录，以防出现脚本无法运行的问题。</p>
                  <h4 id="运行-1"><a href="#运行-1" class="headerlink" title="运行"></a>运行</h4>
                  <p>设置定时任务</p>
                  <figure class="highlight ebnf">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attribute">crontab -e</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>输入 crontab 的实例命令</p>
                  <figure class="highlight awk">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">*<span class="regexp">/5 * * * * /</span>var<span class="regexp">/py/</span>AutoProxy<span class="regexp">/client/</span>request.sh <span class="regexp">/var/</span>py<span class="regexp">/AutoProxy/</span>client<span class="regexp">/request.conf &gt;&gt; /</span>var<span class="regexp">/py/</span>AutoProxy<span class="regexp">/client/</span>request.log</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>注意修改路径，你的项目在哪里，都统一修改成自己项目的路径。 最前面的*/5 是 5 分钟执行一次。 好了，保存之后，定时任务就会开启。</p>
                  <h3 id="验证结果"><a href="#验证结果" class="headerlink" title="验证结果"></a>验证结果</h3>
                  <p>这样一来，访问服务器地址，就可以得到 ADSL 拨号客户机的 IP 了。</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://120.27.14.24:5000'</span></span><br><span class="line">proxy = requests.<span class="builtin-name">get</span>(url, auth=(<span class="string">'admin'</span>, <span class="string">'123'</span>)).text</span><br><span class="line"><span class="builtin-name">print</span>(proxy)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>实例结果：</p>
                  <figure class="highlight accesslog">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="number">116.208.97.22:8888</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h3 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h3>
                  <p>如果你有域名，可以自己解析一个域名，这样就可以直接请求自己的域名，拿到实时好用的代理了，而且定时更新。 <img src="http://opencdn.cuiqingcai.com/proxy.png" alt=""></p>
                  <h3 id="代理设置"><a href="#代理设置" class="headerlink" title="代理设置"></a>代理设置</h3>
                  <h4 id="urllib2"><a href="#urllib2" class="headerlink" title="urllib2"></a>urllib2</h4>
                  <figure class="highlight reasonml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import urllib2</span><br><span class="line">proxy_handler = urllib2.<span class="constructor">ProxyHandler(&#123;<span class="string">"http"</span>: '<span class="params">http</span>:<span class="operator">/</span><span class="operator">/</span>' + <span class="params">proxy</span>&#125;)</span></span><br><span class="line">opener = urllib2.build<span class="constructor">_opener(<span class="params">proxy_handler</span>)</span></span><br><span class="line">urllib2.install<span class="constructor">_opener(<span class="params">opener</span>)</span></span><br><span class="line">response = urllib2.urlopen('http:<span class="comment">//httpbin.org/get')</span></span><br><span class="line">print response.read<span class="literal">()</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h3 id="requests"><a href="#requests" class="headerlink" title="requests"></a>requests</h3>
                  <figure class="highlight processing">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">proxies = &#123;</span><br><span class="line"><span class="string">'http'</span>: <span class="string">'http://'</span> + proxy,</span><br><span class="line">&#125;</span><br><span class="line">r = requests.<span class="built_in">get</span>(<span class="string">'http://httpbin.org/get'</span>, proxies=proxies)</span><br><span class="line"><span class="built_in">print</span>(r.<span class="built_in">text</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>以上便秒级解决了动态 IP 解析，自己实现了一遍 DDNS，爽！ 那这样以来，以后就可以直接请求你的主机获取一个最新可用的代理 IP 了，稳定可用，定时变化！ 以上便是 ADSL 拨号服务器配置的全过程，希望对大家有帮助！</p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2016-11-22 00:18:06" itemprop="dateCreated datePublished" datetime="2016-11-22T00:18:06+08:00">2016-11-22</time>
                </span>
                <span id="/3443.html" class="post-meta-item leancloud_visitors" data-flag-title="Python爬虫进阶七之设置ADSL拨号服务器代理" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>6.4k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>6 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/3363.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="静觅丨崔庆才的个人站点专业为您提供爬虫教程,爬虫,Python,Python爬虫,Python爬虫教程,爬虫书的相关信息，想要了解更多详情，请联系我们。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/3363.html" class="post-title-link" itemprop="url">小白爬虫第四弹之爬虫快跑（多进程+多线程）</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p>ＰＳ：使用多线程时好像在目录切换的问题上存在问题，可以给线程加个锁试试 Hello 大家好！我又来了。 <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/11/QQ图片20161102215153.jpg" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/11/QQ图片20161102215153.jpg" alt="QQ图片20161102215153"></a> 你是不是发现下载图片速度特别慢、难以忍受啊！对于这种问题 一般解决办法就是多进程了！一个进程速度慢！我就用十个进程，相当于十个人一起干。速度就会快很多啦！（为什么不说多线程？懂点 Python 的小伙伴都知道、GIL 的存在 导致 Python 的多线程有点坑啊！）今天就教大家来做一个多进程的爬虫（其实吧、可以用来做一个超简化版的分布式爬虫） 其实吧！还有一种加速的方法叫做“异步”！不过这玩意儿我没怎么整明白就不出来误人子弟了！（因为爬虫大部分时间都是在等待 response 中！‘异步’则能让程序在等待 response 的时间去做的其他事情。） <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/QQ图片20161022193315.gif" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/QQ图片20161022193315.gif" alt="QQ图片20161022193315"></a> 学过 Python 基础的同学都知道、在多进程中，进程之间是不能相互通信的，这就有一个很坑爹的问题的出现了！多个进程怎么知道那那些需要爬取、哪些已经被爬取了！ 这就涉及到一个东西！这玩意儿叫做队列！！队列！！队列！！其实吧正常来说应该给大家用队列来完成这个教程的， 比如 Tornado 的 queue 模块。（如果需要更为稳定健壮的队列，则请考虑使用 Celery 这一类的专用消息传递工具） 不过为了简化技术种类啊！（才不会告诉你们是我懒，嫌麻烦呢！）这次我们继续使用 MongoDB。 好了！先来理一下思路： 每个进程需要知道那些 URL 爬取过了、哪些 URL 需要爬取！我们来给每个 URL 设置两种状态： outstanding:等待爬取的 URL complete:爬取完成的 URL 诶！等等我们好像忘了啥？ 失败的 URL 的怎么办啊？我们在增加一种状态： processing:正在进行的 URL。 嗯！当一个所有初始的 URL 状态都为 outstanding；当开始爬取的时候状态改为：processing；爬取完成状态改为：complete；失败的 URL 重置状态为：outstanding。为了能够处理 URL 进程被终止的情况、我们设置一个计时参数，当超过这个值时；我们则将状态重置为 outstanding。 下面开整 Go Go Go！ 首先我们需要一个模块：datetime(这个模块比内置 time 模块要好使一点)不会装？？不是吧！ pip install datetime 还有上一篇博文我们已经使用过的 pymongo 下面是队列的代码：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta</span><br><span class="line"><span class="keyword">from</span> pymongo <span class="keyword">import</span> MongoClient, errors</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MogoQueue</span><span class="params">()</span>:</span></span><br><span class="line"></span><br><span class="line">    OUTSTANDING = <span class="number">1</span> <span class="comment">##初始状态</span></span><br><span class="line">    PROCESSING = <span class="number">2</span> <span class="comment">##正在下载状态</span></span><br><span class="line">    COMPLETE = <span class="number">3</span> <span class="comment">##下载完成状态</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, db, collection, timeout=<span class="number">300</span>)</span>:</span><span class="comment">##初始mongodb连接</span></span><br><span class="line">        self.client = MongoClient()</span><br><span class="line">        self.Client = self.client[db]</span><br><span class="line">        self.db = self.Client[collection]</span><br><span class="line">        self.timeout = timeout</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__bool__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        这个函数，我的理解是如果下面的表达为真，则整个类为真</span></span><br><span class="line"><span class="string">        至于有什么用，后面我会注明的（如果我的理解有误，请指点出来谢谢，我也是Python新手）</span></span><br><span class="line"><span class="string">        $ne的意思是不匹配</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        record = self.db.find_one(</span><br><span class="line">            &#123;<span class="string">'status'</span>: &#123;<span class="string">'$ne'</span>: self.COMPLETE&#125;&#125;</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span> <span class="keyword">if</span> record <span class="keyword">else</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">push</span><span class="params">(self, url, title)</span>:</span> <span class="comment">##这个函数用来添加新的URL进队列</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.db.insert(&#123;<span class="string">'_id'</span>: url, <span class="string">'status'</span>: self.OUTSTANDING, <span class="string">'主题'</span>: title&#125;)</span><br><span class="line">            print(url, <span class="string">'插入队列成功'</span>)</span><br><span class="line">        <span class="keyword">except</span> errors.DuplicateKeyError <span class="keyword">as</span> e:  <span class="comment">##报错则代表已经存在于队列之中了</span></span><br><span class="line">            print(url, <span class="string">'已经存在于队列中了'</span>)</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">push_imgurl</span><span class="params">(self, title, url)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.db.insert(&#123;<span class="string">'_id'</span>: title, <span class="string">'statue'</span>: self.OUTSTANDING, <span class="string">'url'</span>: url&#125;)</span><br><span class="line">            print(<span class="string">'图片地址插入成功'</span>)</span><br><span class="line">        <span class="keyword">except</span> errors.DuplicateKeyError <span class="keyword">as</span> e:</span><br><span class="line">            print(<span class="string">'地址已经存在了'</span>)</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pop</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        这个函数会查询队列中的所有状态为OUTSTANDING的值，</span></span><br><span class="line"><span class="string">        更改状态，（query后面是查询）（update后面是更新）</span></span><br><span class="line"><span class="string">        并返回_id（就是我们的ＵＲＬ），MongDB好使吧，^_^</span></span><br><span class="line"><span class="string">        如果没有OUTSTANDING的值则调用repair()函数重置所有超时的状态为OUTSTANDING，</span></span><br><span class="line"><span class="string">        $set是设置的意思，和MySQL的set语法一个意思</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        record = self.db.find_and_modify(</span><br><span class="line">            query=&#123;<span class="string">'status'</span>: self.OUTSTANDING&#125;,</span><br><span class="line">            update=&#123;<span class="string">'$set'</span>: &#123;<span class="string">'status'</span>: self.PROCESSING, <span class="string">'timestamp'</span>: datetime.now()&#125;&#125;</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">if</span> record:</span><br><span class="line">            <span class="keyword">return</span> record[<span class="string">'_id'</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.repair()</span><br><span class="line">            <span class="keyword">raise</span> KeyError</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pop_title</span><span class="params">(self, url)</span>:</span></span><br><span class="line">        record = self.db.find_one(&#123;<span class="string">'_id'</span>: url&#125;)</span><br><span class="line">        <span class="keyword">return</span> record[<span class="string">'主题'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">peek</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""这个函数是取出状态为 OUTSTANDING的文档并返回_id(URL)"""</span></span><br><span class="line">        record = self.db.find_one(&#123;<span class="string">'status'</span>: self.OUTSTANDING&#125;)</span><br><span class="line">        <span class="keyword">if</span> record:</span><br><span class="line">            <span class="keyword">return</span> record[<span class="string">'_id'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">complete</span><span class="params">(self, url)</span>:</span></span><br><span class="line">        <span class="string">"""这个函数是更新已完成的URL完成"""</span></span><br><span class="line">        self.db.update(&#123;<span class="string">'_id'</span>: url&#125;, &#123;<span class="string">'$set'</span>: &#123;<span class="string">'status'</span>: self.COMPLETE&#125;&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">repair</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""这个函数是重置状态$lt是比较"""</span></span><br><span class="line">        record = self.db.find_and_modify(</span><br><span class="line">           query=&#123;</span><br><span class="line">               <span class="string">'timestamp'</span>: &#123;<span class="string">'$lt'</span>: datetime.now() - timedelta(seconds=self.timeout)&#125;,</span><br><span class="line">               <span class="string">'status'</span>: &#123;<span class="string">'$ne'</span>: self.COMPLETE&#125;</span><br><span class="line">           &#125;,</span><br><span class="line">            update=&#123;<span class="string">'$set'</span>: &#123;<span class="string">'status'</span>: self.OUTSTANDING&#125;&#125;</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">if</span> record:</span><br><span class="line">            print(<span class="string">'重置URL状态'</span>, record[<span class="string">'_id'</span>])</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clear</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""这个函数只有第一次才调用、后续不要调用、因为这是删库啊！"""</span></span><br><span class="line">        self.db.drop()</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>好了，队列我们做好了，下面是获取所有页面的代码：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> Download <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">from</span> mongodb_queue <span class="keyword">import</span> MogoQueue</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">spider_queue = MogoQueue(<span class="string">'meinvxiezhenji'</span>, <span class="string">'crawl_queue'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(url)</span>:</span></span><br><span class="line">    response = request.get(url, <span class="number">3</span>)</span><br><span class="line">    Soup = BeautifulSoup(response.text, <span class="string">'lxml'</span>)</span><br><span class="line">    all_a = Soup.find(<span class="string">'div'</span>, class_=<span class="string">'all'</span>).find_all(<span class="string">'a'</span>)</span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> all_a:</span><br><span class="line">        title = a.get_text()</span><br><span class="line">        url = a[<span class="string">'href'</span>]</span><br><span class="line">        spider_queue.push(url, title)</span><br><span class="line">    <span class="string">"""上面这个调用就是把URL写入MongoDB的队列了"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    start(<span class="string">'http://www.mzitu.com/all'</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">"""这一段儿就不解释了哦！超级简单的"""</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>下面就是多进程+多线程的下载代码了：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"><span class="keyword">from</span> mongodb_queue <span class="keyword">import</span> MogoQueue</span><br><span class="line"><span class="keyword">from</span> Download <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"></span><br><span class="line">SLEEP_TIME = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mzitu_crawler</span><span class="params">(max_threads=<span class="number">10</span>)</span>:</span></span><br><span class="line">    crawl_queue = MogoQueue(<span class="string">'meinvxiezhenji'</span>, <span class="string">'crawl_queue'</span>) <span class="comment">##这个是我们获取URL的队列</span></span><br><span class="line">    <span class="comment">##img_queue = MogoQueue('meinvxiezhenji', 'img_queue')</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pageurl_crawler</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                url = crawl_queue.pop()</span><br><span class="line">                print(url)</span><br><span class="line">            <span class="keyword">except</span> KeyError:</span><br><span class="line">                print(<span class="string">'队列没有数据'</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                img_urls = []</span><br><span class="line">                req = request.get(url, <span class="number">3</span>).text</span><br><span class="line">                title = crawl_queue.pop_title(url)</span><br><span class="line">                mkdir(title)</span><br><span class="line">                os.chdir(<span class="string">'D:\mzitu\\'</span> + title)</span><br><span class="line">                max_span = BeautifulSoup(req, <span class="string">'lxml'</span>).find(<span class="string">'div'</span>, class_=<span class="string">'pagenavi'</span>).find_all(<span class="string">'span'</span>)[<span class="number">-2</span>].get_text()</span><br><span class="line">                <span class="keyword">for</span> page <span class="keyword">in</span> range(<span class="number">1</span>, int(max_span) + <span class="number">1</span>):</span><br><span class="line">                    page_url = url + <span class="string">'/'</span> + str(page)</span><br><span class="line">                    img_url = BeautifulSoup(request.get(page_url, <span class="number">3</span>).text, <span class="string">'lxml'</span>).find(<span class="string">'div'</span>, class_=<span class="string">'main-image'</span>).find(<span class="string">'img'</span>)[<span class="string">'src'</span>]</span><br><span class="line">                    img_urls.append(img_url)</span><br><span class="line">                    save(img_url)</span><br><span class="line">                crawl_queue.complete(url) <span class="comment">##设置为完成状态</span></span><br><span class="line">                <span class="comment">##img_queue.push_imgurl(title, img_urls)</span></span><br><span class="line">                <span class="comment">##print('插入数据库成功')</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">save</span><span class="params">(img_url)</span>:</span></span><br><span class="line">        name = img_url[<span class="number">-9</span>:<span class="number">-4</span>]</span><br><span class="line">        print(<span class="string">u'开始保存：'</span>, img_url)</span><br><span class="line">        img = request.get(img_url, <span class="number">3</span>)</span><br><span class="line">        f = open(name + <span class="string">'.jpg'</span>, <span class="string">'ab'</span>)</span><br><span class="line">        f.write(img.content)</span><br><span class="line">        f.close()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mkdir</span><span class="params">(path)</span>:</span></span><br><span class="line">        path = path.strip()</span><br><span class="line">        isExists = os.path.exists(os.path.join(<span class="string">"D:\mzitu"</span>, path))</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> isExists:</span><br><span class="line">            print(<span class="string">u'建了一个名字叫做'</span>, path, <span class="string">u'的文件夹！'</span>)</span><br><span class="line">            os.makedirs(os.path.join(<span class="string">"D:\mzitu"</span>, path))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(<span class="string">u'名字叫做'</span>, path, <span class="string">u'的文件夹已经存在了！'</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    threads = []</span><br><span class="line">    <span class="keyword">while</span> threads <span class="keyword">or</span> crawl_queue:</span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        这儿crawl_queue用上了，就是我们__bool__函数的作用，为真则代表我们MongoDB队列里面还有数据</span></span><br><span class="line"><span class="string">        threads 或者 crawl_queue为真都代表我们还没下载完成，程序就会继续执行</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">for</span> thread <span class="keyword">in</span> threads:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> thread.is_alive(): <span class="comment">##is_alive是判断是否为空,不是空则在队列中删掉</span></span><br><span class="line">                threads.remove(thread)</span><br><span class="line">        <span class="keyword">while</span> len(threads) &lt; max_threads <span class="keyword">or</span> crawl_queue.peek(): <span class="comment">##线程池中的线程少于max_threads 或者 crawl_qeue时</span></span><br><span class="line">            thread = threading.Thread(target=pageurl_crawler) <span class="comment">##创建线程</span></span><br><span class="line">            thread.setDaemon(<span class="literal">True</span>) <span class="comment">##设置守护线程</span></span><br><span class="line">            thread.start() <span class="comment">##启动线程</span></span><br><span class="line">            threads.append(thread) <span class="comment">##添加进线程队列</span></span><br><span class="line">        time.sleep(SLEEP_TIME)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">process_crawler</span><span class="params">()</span>:</span></span><br><span class="line">    process = []</span><br><span class="line">    num_cpus = multiprocessing.cpu_count()</span><br><span class="line">    print(<span class="string">'将会启动进程数为：'</span>, num_cpus)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(num_cpus):</span><br><span class="line">        p = multiprocessing.Process(target=mzitu_crawler) <span class="comment">##创建进程</span></span><br><span class="line">        p.start() <span class="comment">##启动进程</span></span><br><span class="line">        process.append(p) <span class="comment">##添加进进程队列</span></span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> process:</span><br><span class="line">        p.join() <span class="comment">##等待进程队列里面的进程结束</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    process_crawler()</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>好啦！一个多进程多线的爬虫就完成了，（其实你可以设置一下 MongoDB，然后调整一下连接配置，在多台机器上跑哦！！嗯，就是超级简化版的分布式爬虫了，虽然很是简陋。） 本来还想下载图片那一块儿加上异步（毕竟下载图片是Ｉ＼Ｏ等待最久的时间了，），可惜异步我也没怎么整明白，就不拿出来贻笑大方了。 另外，各位小哥儿可以参考上面代码，单独处理图片地址试试（就是多个进程直接下载图片）？ 我测试了一下八分钟下载 100 套图 <em><strong>PS：请务必使用 第二篇博文中的下载模块，或者自己写一个自动更换代理的下载模块！！！不然寸步难行，分分钟被服务器 BAN 掉！</strong></em> <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/11/QQ图片20161102215153.jpg" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/11/QQ图片20161102215153.jpg" alt="QQ图片20161102215153"></a>小白教程就到此结束了，后面我教大家玩玩 Scrapy；目标 顶点小说网， 爬完全站的小说。 再后面带大家玩玩 抓新浪 汤不热、模拟登录 之类的。或许维护一个公共代理 IP 池之类的。 这个所有代码我放在这个位置了：<a href="https://github.com/thsheep/mzitu/" target="_blank" rel="noopener">https://github.com/thsheep/mzitu/</a></p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/哎哟卧槽" class="author" itemprop="url" rel="index">哎哟卧槽</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2016-11-20 18:33:20" itemprop="dateCreated datePublished" datetime="2016-11-20T18:33:20+08:00">2016-11-20</time>
                </span>
                <span id="/3363.html" class="post-meta-item leancloud_visitors" data-flag-title="小白爬虫第四弹之爬虫快跑（多进程+多线程）" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>6.3k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>6 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/3335.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="静觅丨崔庆才的个人站点专业为您提供爬虫教程,爬虫,Python,Python爬虫,Python爬虫教程,爬虫书的相关信息，想要了解更多详情，请联系我们。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/3335.html" class="post-title-link" itemprop="url">Python爬虫进阶六之多进程的用法</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <h2 id="2022-年最新-Python3-网络爬虫教程"><a href="#2022-年最新-Python3-网络爬虫教程" class="headerlink" title="2022 年最新 Python3 网络爬虫教程"></a>2022 年最新 Python3 网络爬虫教程</h2>
                  <p>大家好，我是崔庆才，由于爬虫技术不断迭代升级，一些旧的教程已经过时、案例已经过期，最前沿的爬虫技术比如异步、JavaScript 逆向、安卓逆向、智能解析、WebAssembly、大规模分布式、Kubernetes 等技术层出不穷，我最近新出了一套最新最全面的 Python3 网络爬虫系列教程。</p>
                  <blockquote>
                    <p>博主自荐：截止 2022 年，可以将最前沿最全面的爬虫技术都涵盖的教程，如异步、JavaScript 逆向、安卓逆向、智能解析、WebAssembly、大规模分布式、Kubernetes 等，市面上目前就这一套了。</p>
                  </blockquote>
                  <p>最新教程对旧的爬虫技术内容进行了全面更新，搭建了全新的案例平台进行全面讲解，保证案例稳定有效不过期。</p>
                  <p>教程请移步：</p>
                  <p><a href="https://cuiqingcai.com/17777.html">【2022 版】Python3 网络爬虫学习教程</a></p>
                  <p>如下为原文。</p>
                  <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2>
                  <p>在上一节中介绍了 thread 多线程库。python 中的多线程其实并不是真正的多线程，并不能做到充分利用多核 CPU 资源。 如果想要充分利用，在 python 中大部分情况需要使用多进程，那么这个包就叫做 multiprocessing。 借助它，可以轻松完成从单进程到并发执行的转换。multiprocessing 支持子进程、通信和共享数据、执行不同形式的同步，提供了 Process、Queue、Pipe、Lock 等组件。 那么本节要介绍的内容有：</p>
                  <ul>
                    <li>Process</li>
                    <li>Lock</li>
                    <li>Semaphore</li>
                    <li>Queue</li>
                    <li>Pipe</li>
                    <li>Pool</li>
                  </ul>
                  <h2 id="Process"><a href="#Process" class="headerlink" title="Process"></a>Process</h2>
                  <h3 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h3>
                  <p>在 multiprocessing 中，每一个进程都用一个 Process 类来表示。首先看下它的 API</p>
                  <figure class="highlight reasonml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="constructor">Process([<span class="params">group</span> [, <span class="params">target</span> [, <span class="params">name</span> [, <span class="params">args</span> [, <span class="params">kwargs</span>]]]]])</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <ul>
                    <li>target 表示调用对象，你可以传入方法的名字</li>
                    <li>args 表示被调用对象的位置参数元组，比如 target 是函数 a，他有两个参数 m，n，那么 args 就传入(m, n)即可</li>
                    <li>kwargs 表示调用对象的字典</li>
                    <li>name 是别名，相当于给这个进程取一个名字</li>
                    <li>group 分组，实际上不使用</li>
                  </ul>
                  <p>我们先用一个实例来感受一下：</p>
                  <figure class="highlight livecodeserver">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import multiprocessing</span><br><span class="line"></span><br><span class="line">def <span class="built_in">process</span>(<span class="built_in">num</span>):</span><br><span class="line">    print <span class="string">'Process:'</span>, <span class="built_in">num</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">        p = multiprocessing.Process(target=<span class="built_in">process</span>, args=(i,))</span><br><span class="line">        p.<span class="built_in">start</span>()</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>最简单的创建 Process 的过程如上所示，target 传入函数名，args 是函数的参数，是元组的形式，如果只有一个参数，那就是长度为 1 的元组。 然后调用 start()方法即可启动多个进程了。 另外你还可以通过 cpu_count() 方法还有 active_children() 方法获取当前机器的 CPU 核心数量以及得到目前所有的运行的进程。 通过一个实例来感受一下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">import multiprocessing</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line">def process(num):</span><br><span class="line">    time.sleep(num)</span><br><span class="line">    <span class="builtin-name">print</span> <span class="string">'Process:'</span>, num</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(5):</span><br><span class="line">        p = multiprocessing.Process(<span class="attribute">target</span>=process, args=(i,))</span><br><span class="line">        p.start()</span><br><span class="line"></span><br><span class="line">    <span class="builtin-name">print</span>(<span class="string">'CPU number:'</span> + str(multiprocessing.cpu_count()))</span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> multiprocessing.active_children():</span><br><span class="line">        <span class="builtin-name">print</span>(<span class="string">'Child process name: '</span> + p.name + <span class="string">' id: '</span> + str(p.pid))</span><br><span class="line"></span><br><span class="line">    <span class="builtin-name">print</span>(<span class="string">'Process Ended'</span>)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果：</p>
                  <figure class="highlight yaml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attr">Process:</span> <span class="number">0</span></span><br><span class="line"><span class="string">CPU</span> <span class="string">number:8</span></span><br><span class="line"><span class="attr">Child process name: Process-2 id:</span> <span class="number">9641</span></span><br><span class="line"><span class="attr">Child process name: Process-4 id:</span> <span class="number">9643</span></span><br><span class="line"><span class="attr">Child process name: Process-5 id:</span> <span class="number">9644</span></span><br><span class="line"><span class="attr">Child process name: Process-3 id:</span> <span class="number">9642</span></span><br><span class="line"><span class="string">Process</span> <span class="string">Ended</span></span><br><span class="line"><span class="attr">Process:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">Process:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">Process:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">Process:</span> <span class="number">4</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <h3 id="自定义类"><a href="#自定义类" class="headerlink" title="自定义类"></a>自定义类</h3>
                  <p>另外你还可以继承 Process 类，自定义进程类，实现 run 方法即可。 用一个实例来感受一下：</p>
                  <figure class="highlight haskell">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="title">from</span> multiprocessing <span class="keyword">import</span> Process</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="type">MyProcess</span>(<span class="type">Process</span>):</span></span><br><span class="line"><span class="class">    def __init__(<span class="title">self</span>, <span class="title">loop</span>):</span></span><br><span class="line"><span class="class">        <span class="type">Process</span>.__init__(<span class="title">self</span>)</span></span><br><span class="line"><span class="class">        self.loop = loop</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">    def run(<span class="title">self</span>):</span></span><br><span class="line"><span class="class">        for count in range(<span class="title">self</span>.<span class="title">loop</span>):</span></span><br><span class="line"><span class="class">            time.sleep(1)</span></span><br><span class="line"><span class="class">            print('<span class="type">Pid</span>: ' + <span class="title">str</span>(<span class="title">self</span>.<span class="title">pid</span>) + ' <span class="type">LoopCount</span>: ' + str(<span class="title">count</span>))</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">if __name__ == '__main__':</span></span><br><span class="line"><span class="class">    for i in range(2, 5):</span></span><br><span class="line"><span class="class">        p = <span class="type">MyProcess</span>(<span class="title">i</span>)</span></span><br><span class="line"><span class="class">        p.start()</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在上面的例子中，我们继承了 Process 这个类，然后实现了 run 方法。打印出来了进程号和参数。 运行结果：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">Pid: <span class="number">28116</span> LoopCount: <span class="number">0</span></span><br><span class="line">Pid: <span class="number">28117</span> LoopCount: <span class="number">0</span></span><br><span class="line">Pid: <span class="number">28118</span> LoopCount: <span class="number">0</span></span><br><span class="line">Pid: <span class="number">28116</span> LoopCount: <span class="number">1</span></span><br><span class="line">Pid: <span class="number">28117</span> LoopCount: <span class="number">1</span></span><br><span class="line">Pid: <span class="number">28118</span> LoopCount: <span class="number">1</span></span><br><span class="line">Pid: <span class="number">28117</span> LoopCount: <span class="number">2</span></span><br><span class="line">Pid: <span class="number">28118</span> LoopCount: <span class="number">2</span></span><br><span class="line">Pid: <span class="number">28118</span> LoopCount: <span class="number">3</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可以看到，三个进程分别打印出了 2、3、4 条结果。 我们可以把一些方法独立的写在每个类里封装好，等用的时候直接初始化一个类运行即可。</p>
                  <h3 id="deamon"><a href="#deamon" class="headerlink" title="deamon"></a>deamon</h3>
                  <p>在这里介绍一个属性，叫做 deamon。每个线程都可以单独设置它的属性，如果设置为 True，当父进程结束后，子进程会自动被终止。 用一个实例来感受一下，还是原来的例子，增加了 deamon 属性：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyProcess</span><span class="params">(Process)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, loop)</span>:</span></span><br><span class="line">        Process.__init__(self)</span><br><span class="line">        self.loop = loop</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> count <span class="keyword">in</span> range(self.loop):</span><br><span class="line">            time.sleep(<span class="number">1</span>)</span><br><span class="line">            print(<span class="string">'Pid: '</span> + str(self.pid) + <span class="string">' LoopCount: '</span> + str(count))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>, <span class="number">5</span>):</span><br><span class="line">        p = MyProcess(i)</span><br><span class="line">        p.daemon = <span class="literal">True</span></span><br><span class="line">        p.start()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> <span class="string">'Main process Ended!'</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在这里，调用的时候增加了设置 deamon，最后的主进程（即父进程）打印输出了一句话。 运行结果：</p>
                  <figure class="highlight arduino">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">Main <span class="built_in">process</span> Ended!</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>结果很简单，因为主进程没有做任何事情，直接输出一句话结束，所以在这时也直接终止了子进程的运行。 这样可以有效防止无控制地生成子进程。如果这样写了，你在关闭这个主程序运行时，就无需额外担心子进程有没有被关闭了。 不过这样并不是我们想要达到的效果呀，能不能让所有子进程都执行完了然后再结束呢？那当然是可以的，只需要加入 join()方法即可。</p>
                  <figure class="highlight haskell">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="title">from</span> multiprocessing <span class="keyword">import</span> Process</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="type">MyProcess</span>(<span class="type">Process</span>):</span></span><br><span class="line"><span class="class">    def __init__(<span class="title">self</span>, <span class="title">loop</span>):</span></span><br><span class="line"><span class="class">        <span class="type">Process</span>.__init__(<span class="title">self</span>)</span></span><br><span class="line"><span class="class">        self.loop = loop</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">    def run(<span class="title">self</span>):</span></span><br><span class="line"><span class="class">        for count in range(<span class="title">self</span>.<span class="title">loop</span>):</span></span><br><span class="line"><span class="class">            time.sleep(1)</span></span><br><span class="line"><span class="class">            print('<span class="type">Pid</span>: ' + <span class="title">str</span>(<span class="title">self</span>.<span class="title">pid</span>) + ' <span class="type">LoopCount</span>: ' + str(<span class="title">count</span>))</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">if __name__ == '__main__':</span></span><br><span class="line"><span class="class">    for i in range(2, 5):</span></span><br><span class="line"><span class="class">        p = <span class="type">MyProcess</span>(<span class="title">i</span>)</span></span><br><span class="line"><span class="class">        p.daemon = <span class="type">True</span></span></span><br><span class="line"><span class="class">        p.start()</span></span><br><span class="line"><span class="class">        p.join()</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">    print '<span class="type">Main</span> process <span class="type">Ended</span>!'</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在这里，每个子进程都调用了 join()方法，这样父进程（主进程）就会等待子进程执行完毕。 运行结果：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">Pid: <span class="number">29902</span> LoopCount: <span class="number">0</span></span><br><span class="line">Pid: <span class="number">29902</span> LoopCount: <span class="number">1</span></span><br><span class="line">Pid: <span class="number">29905</span> LoopCount: <span class="number">0</span></span><br><span class="line">Pid: <span class="number">29905</span> LoopCount: <span class="number">1</span></span><br><span class="line">Pid: <span class="number">29905</span> LoopCount: <span class="number">2</span></span><br><span class="line">Pid: <span class="number">29912</span> LoopCount: <span class="number">0</span></span><br><span class="line">Pid: <span class="number">29912</span> LoopCount: <span class="number">1</span></span><br><span class="line">Pid: <span class="number">29912</span> LoopCount: <span class="number">2</span></span><br><span class="line">Pid: <span class="number">29912</span> LoopCount: <span class="number">3</span></span><br><span class="line">Main process Ended!</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>发现所有子进程都执行完毕之后，父进程最后打印出了结束的结果。</p>
                  <h2 id="Lock"><a href="#Lock" class="headerlink" title="Lock"></a>Lock</h2>
                  <p>在上面的一些小实例中，你可能会遇到如下的运行结果： <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/11/QQ20161113-0@2x.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/11/QQ20161113-0@2x-300x126.png" alt=""></a> 什么问题？有的输出错位了。这是由于并行导致的，两个进程同时进行了输出，结果第一个进程的换行没有来得及输出，第二个进程就输出了结果。所以导致这种排版的问题。 那这归根结底是因为线程同时资源（输出操作）而导致的。 那怎么来避免这种问题？那自然是在某一时间，只能一个进程输出，其他进程等待。等刚才那个进程输出完毕之后，另一个进程再进行输出。这种现象就叫做“互斥”。 我们可以通过 Lock 来实现，在一个进程输出时，加锁，其他进程等待。等此进程执行结束后，释放锁，其他进程可以进行输出。 我们现用一个实例来感受一下：</p>
                  <figure class="highlight sql">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">from multiprocessing import Process, <span class="keyword">Lock</span></span><br><span class="line"><span class="keyword">import</span> <span class="built_in">time</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> MyProcess(Process):</span><br><span class="line">    <span class="keyword">def</span> __init__(<span class="keyword">self</span>, <span class="keyword">loop</span>, <span class="keyword">lock</span>):</span><br><span class="line">        Process.__init__(<span class="keyword">self</span>)</span><br><span class="line">        self.loop = <span class="keyword">loop</span></span><br><span class="line">        self.lock = <span class="keyword">lock</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> run(<span class="keyword">self</span>):</span><br><span class="line">        <span class="keyword">for</span> <span class="keyword">count</span> <span class="keyword">in</span> <span class="keyword">range</span>(self.loop):</span><br><span class="line">            time.sleep(<span class="number">0.1</span>)</span><br><span class="line">            <span class="comment">#self.lock.acquire()</span></span><br><span class="line">            print(<span class="string">'Pid: '</span> + <span class="keyword">str</span>(self.pid) + <span class="string">' LoopCount: '</span> + <span class="keyword">str</span>(<span class="keyword">count</span>))</span><br><span class="line">            <span class="comment">#self.lock.release()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">lock</span> = <span class="keyword">Lock</span>()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="keyword">range</span>(<span class="number">10</span>, <span class="number">15</span>):</span><br><span class="line">        p = MyProcess(i, <span class="keyword">lock</span>)</span><br><span class="line">        p.start()</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>首先看一下不加锁的输出结果：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">Pid: <span class="number">45755</span> LoopCount: <span class="number">0</span></span><br><span class="line">Pid: <span class="number">45756</span> LoopCount: <span class="number">0</span></span><br><span class="line">Pid: <span class="number">45757</span> LoopCount: <span class="number">0</span></span><br><span class="line">Pid: <span class="number">45758</span> LoopCount: <span class="number">0</span></span><br><span class="line">Pid: <span class="number">45759</span> LoopCount: <span class="number">0</span></span><br><span class="line">Pid: <span class="number">45755</span> LoopCount: <span class="number">1</span></span><br><span class="line">Pid: <span class="number">45756</span> LoopCount: <span class="number">1</span></span><br><span class="line">Pid: <span class="number">45757</span> LoopCount: <span class="number">1</span></span><br><span class="line">Pid: <span class="number">45758</span> LoopCount: <span class="number">1</span></span><br><span class="line">Pid: <span class="number">45759</span> LoopCount: <span class="number">1</span></span><br><span class="line">Pid: <span class="number">45755</span> LoopCount: <span class="number">2</span>Pid: <span class="number">45756</span> LoopCount: <span class="number">2</span></span><br><span class="line"></span><br><span class="line">Pid: <span class="number">45757</span> LoopCount: <span class="number">2</span></span><br><span class="line">Pid: <span class="number">45758</span> LoopCount: <span class="number">2</span></span><br><span class="line">Pid: <span class="number">45759</span> LoopCount: <span class="number">2</span></span><br><span class="line">Pid: <span class="number">45756</span> LoopCount: <span class="number">3</span></span><br><span class="line">Pid: <span class="number">45755</span> LoopCount: <span class="number">3</span></span><br><span class="line">Pid: <span class="number">45757</span> LoopCount: <span class="number">3</span></span><br><span class="line">Pid: <span class="number">45758</span> LoopCount: <span class="number">3</span></span><br><span class="line">Pid: <span class="number">45759</span> LoopCount: <span class="number">3</span></span><br><span class="line">Pid: <span class="number">45755</span> LoopCount: <span class="number">4</span></span><br><span class="line">Pid: <span class="number">45756</span> LoopCount: <span class="number">4</span></span><br><span class="line">Pid: <span class="number">45757</span> LoopCount: <span class="number">4</span></span><br><span class="line">Pid: <span class="number">45759</span> LoopCount: <span class="number">4</span></span><br><span class="line">Pid: <span class="number">45758</span> LoopCount: <span class="number">4</span></span><br><span class="line">Pid: <span class="number">45756</span> LoopCount: <span class="number">5</span></span><br><span class="line">Pid: <span class="number">45755</span> LoopCount: <span class="number">5</span></span><br><span class="line">Pid: <span class="number">45757</span> LoopCount: <span class="number">5</span></span><br><span class="line">Pid: <span class="number">45759</span> LoopCount: <span class="number">5</span></span><br><span class="line">Pid: <span class="number">45758</span> LoopCount: <span class="number">5</span></span><br><span class="line">Pid: <span class="number">45756</span> LoopCount: <span class="number">6</span>Pid: <span class="number">45755</span> LoopCount: <span class="number">6</span></span><br><span class="line"></span><br><span class="line">Pid: <span class="number">45757</span> LoopCount: <span class="number">6</span></span><br><span class="line">Pid: <span class="number">45759</span> LoopCount: <span class="number">6</span></span><br><span class="line">Pid: <span class="number">45758</span> LoopCount: <span class="number">6</span></span><br><span class="line">Pid: <span class="number">45755</span> LoopCount: <span class="number">7</span>Pid: <span class="number">45756</span> LoopCount: <span class="number">7</span></span><br><span class="line"></span><br><span class="line">Pid: <span class="number">45757</span> LoopCount: <span class="number">7</span></span><br><span class="line">Pid: <span class="number">45758</span> LoopCount: <span class="number">7</span></span><br><span class="line">Pid: <span class="number">45759</span> LoopCount: <span class="number">7</span></span><br><span class="line">Pid: <span class="number">45756</span> LoopCount: <span class="number">8</span>Pid: <span class="number">45755</span> LoopCount: <span class="number">8</span></span><br><span class="line"></span><br><span class="line">Pid: <span class="number">45757</span> LoopCount: <span class="number">8</span></span><br><span class="line">Pid: <span class="number">45758</span> LoopCount: <span class="number">8</span>Pid: <span class="number">45759</span> LoopCount: <span class="number">8</span></span><br><span class="line"></span><br><span class="line">Pid: <span class="number">45755</span> LoopCount: <span class="number">9</span></span><br><span class="line">Pid: <span class="number">45756</span> LoopCount: <span class="number">9</span></span><br><span class="line">Pid: <span class="number">45757</span> LoopCount: <span class="number">9</span></span><br><span class="line">Pid: <span class="number">45758</span> LoopCount: <span class="number">9</span></span><br><span class="line">Pid: <span class="number">45759</span> LoopCount: <span class="number">9</span></span><br><span class="line">Pid: <span class="number">45756</span> LoopCount: <span class="number">10</span></span><br><span class="line">Pid: <span class="number">45757</span> LoopCount: <span class="number">10</span></span><br><span class="line">Pid: <span class="number">45758</span> LoopCount: <span class="number">10</span></span><br><span class="line">Pid: <span class="number">45759</span> LoopCount: <span class="number">10</span></span><br><span class="line">Pid: <span class="number">45757</span> LoopCount: <span class="number">11</span></span><br><span class="line">Pid: <span class="number">45758</span> LoopCount: <span class="number">11</span></span><br><span class="line">Pid: <span class="number">45759</span> LoopCount: <span class="number">11</span></span><br><span class="line">Pid: <span class="number">45758</span> LoopCount: <span class="number">12</span></span><br><span class="line">Pid: <span class="number">45759</span> LoopCount: <span class="number">12</span></span><br><span class="line">Pid: <span class="number">45759</span> LoopCount: <span class="number">13</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可以看到有些输出已经造成了影响。 然后我们对其加锁：</p>
                  <figure class="highlight pgsql">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process, <span class="keyword">Lock</span></span><br><span class="line"><span class="keyword">import</span> <span class="type">time</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> MyProcess(Process):</span><br><span class="line">    def __init__(self, <span class="keyword">loop</span>, <span class="keyword">lock</span>):</span><br><span class="line">        Process.__init__(self)</span><br><span class="line">        self.<span class="keyword">loop</span> = <span class="keyword">loop</span></span><br><span class="line">        self.<span class="keyword">lock</span> = <span class="keyword">lock</span></span><br><span class="line"></span><br><span class="line">    def run(self):</span><br><span class="line">        <span class="keyword">for</span> count <span class="keyword">in</span> range(self.<span class="keyword">loop</span>):</span><br><span class="line">            <span class="type">time</span>.sleep(<span class="number">0.1</span>)</span><br><span class="line">            self.<span class="keyword">lock</span>.acquire()</span><br><span class="line">            print(<span class="string">'Pid: '</span> + str(self.pid) + <span class="string">' LoopCount: '</span> + str(count))</span><br><span class="line">            self.<span class="keyword">lock</span>.<span class="keyword">release</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">lock</span> = <span class="keyword">Lock</span>()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>, <span class="number">15</span>):</span><br><span class="line">        p = MyProcess(i, <span class="keyword">lock</span>)</span><br><span class="line">        p.<span class="keyword">start</span>()</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>我们在 print 方法的前后分别添加了获得锁和释放锁的操作。这样就能保证在同一时间只有一个 print 操作。 看一下运行结果：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">Pid: <span class="number">45889</span> LoopCount: <span class="number">0</span></span><br><span class="line">Pid: <span class="number">45890</span> LoopCount: <span class="number">0</span></span><br><span class="line">Pid: <span class="number">45891</span> LoopCount: <span class="number">0</span></span><br><span class="line">Pid: <span class="number">45892</span> LoopCount: <span class="number">0</span></span><br><span class="line">Pid: <span class="number">45893</span> LoopCount: <span class="number">0</span></span><br><span class="line">Pid: <span class="number">45889</span> LoopCount: <span class="number">1</span></span><br><span class="line">Pid: <span class="number">45890</span> LoopCount: <span class="number">1</span></span><br><span class="line">Pid: <span class="number">45891</span> LoopCount: <span class="number">1</span></span><br><span class="line">Pid: <span class="number">45892</span> LoopCount: <span class="number">1</span></span><br><span class="line">Pid: <span class="number">45893</span> LoopCount: <span class="number">1</span></span><br><span class="line">Pid: <span class="number">45889</span> LoopCount: <span class="number">2</span></span><br><span class="line">Pid: <span class="number">45890</span> LoopCount: <span class="number">2</span></span><br><span class="line">Pid: <span class="number">45891</span> LoopCount: <span class="number">2</span></span><br><span class="line">Pid: <span class="number">45892</span> LoopCount: <span class="number">2</span></span><br><span class="line">Pid: <span class="number">45893</span> LoopCount: <span class="number">2</span></span><br><span class="line">Pid: <span class="number">45889</span> LoopCount: <span class="number">3</span></span><br><span class="line">Pid: <span class="number">45890</span> LoopCount: <span class="number">3</span></span><br><span class="line">Pid: <span class="number">45891</span> LoopCount: <span class="number">3</span></span><br><span class="line">Pid: <span class="number">45892</span> LoopCount: <span class="number">3</span></span><br><span class="line">Pid: <span class="number">45893</span> LoopCount: <span class="number">3</span></span><br><span class="line">Pid: <span class="number">45889</span> LoopCount: <span class="number">4</span></span><br><span class="line">Pid: <span class="number">45890</span> LoopCount: <span class="number">4</span></span><br><span class="line">Pid: <span class="number">45891</span> LoopCount: <span class="number">4</span></span><br><span class="line">Pid: <span class="number">45892</span> LoopCount: <span class="number">4</span></span><br><span class="line">Pid: <span class="number">45893</span> LoopCount: <span class="number">4</span></span><br><span class="line">Pid: <span class="number">45889</span> LoopCount: <span class="number">5</span></span><br><span class="line">Pid: <span class="number">45890</span> LoopCount: <span class="number">5</span></span><br><span class="line">Pid: <span class="number">45891</span> LoopCount: <span class="number">5</span></span><br><span class="line">Pid: <span class="number">45892</span> LoopCount: <span class="number">5</span></span><br><span class="line">Pid: <span class="number">45893</span> LoopCount: <span class="number">5</span></span><br><span class="line">Pid: <span class="number">45889</span> LoopCount: <span class="number">6</span></span><br><span class="line">Pid: <span class="number">45890</span> LoopCount: <span class="number">6</span></span><br><span class="line">Pid: <span class="number">45891</span> LoopCount: <span class="number">6</span></span><br><span class="line">Pid: <span class="number">45893</span> LoopCount: <span class="number">6</span></span><br><span class="line">Pid: <span class="number">45892</span> LoopCount: <span class="number">6</span></span><br><span class="line">Pid: <span class="number">45889</span> LoopCount: <span class="number">7</span></span><br><span class="line">Pid: <span class="number">45890</span> LoopCount: <span class="number">7</span></span><br><span class="line">Pid: <span class="number">45891</span> LoopCount: <span class="number">7</span></span><br><span class="line">Pid: <span class="number">45892</span> LoopCount: <span class="number">7</span></span><br><span class="line">Pid: <span class="number">45893</span> LoopCount: <span class="number">7</span></span><br><span class="line">Pid: <span class="number">45889</span> LoopCount: <span class="number">8</span></span><br><span class="line">Pid: <span class="number">45890</span> LoopCount: <span class="number">8</span></span><br><span class="line">Pid: <span class="number">45891</span> LoopCount: <span class="number">8</span></span><br><span class="line">Pid: <span class="number">45892</span> LoopCount: <span class="number">8</span></span><br><span class="line">Pid: <span class="number">45893</span> LoopCount: <span class="number">8</span></span><br><span class="line">Pid: <span class="number">45889</span> LoopCount: <span class="number">9</span></span><br><span class="line">Pid: <span class="number">45890</span> LoopCount: <span class="number">9</span></span><br><span class="line">Pid: <span class="number">45891</span> LoopCount: <span class="number">9</span></span><br><span class="line">Pid: <span class="number">45892</span> LoopCount: <span class="number">9</span></span><br><span class="line">Pid: <span class="number">45893</span> LoopCount: <span class="number">9</span></span><br><span class="line">Pid: <span class="number">45890</span> LoopCount: <span class="number">10</span></span><br><span class="line">Pid: <span class="number">45891</span> LoopCount: <span class="number">10</span></span><br><span class="line">Pid: <span class="number">45892</span> LoopCount: <span class="number">10</span></span><br><span class="line">Pid: <span class="number">45893</span> LoopCount: <span class="number">10</span></span><br><span class="line">Pid: <span class="number">45891</span> LoopCount: <span class="number">11</span></span><br><span class="line">Pid: <span class="number">45892</span> LoopCount: <span class="number">11</span></span><br><span class="line">Pid: <span class="number">45893</span> LoopCount: <span class="number">11</span></span><br><span class="line">Pid: <span class="number">45893</span> LoopCount: <span class="number">12</span></span><br><span class="line">Pid: <span class="number">45892</span> LoopCount: <span class="number">12</span></span><br><span class="line">Pid: <span class="number">45893</span> LoopCount: <span class="number">13</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>嗯，一切都没问题了。 所以在访问临界资源时，使用 Lock 就可以避免进程同时占用资源而导致的一些问题。</p>
                  <h2 id="Semaphore"><a href="#Semaphore" class="headerlink" title="Semaphore"></a>Semaphore</h2>
                  <p>信号量，是在进程同步过程中一个比较重要的角色。可以控制临界资源的数量，保证各个进程之间的互斥和同步。 如果你学过操作系统，那么一定对这方面非常了解，如果你还不了解信号量是什么，可以参考 <a href="http://blog.csdn.net/qinxiongxu/article/details/7830537" target="_blank" rel="noopener">信号量解析</a> 来了解一下它是做什么的。 那么接下来我们就用一个实例来演示一下进程之间利用 Semaphore 做到同步和互斥，以及控制临界资源数量。</p>
                  <figure class="highlight haskell">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="title">from</span> multiprocessing <span class="keyword">import</span> Process, Semaphore, Lock, Queue</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="title">buffer</span> = <span class="type">Queue</span>(<span class="number">10</span>)</span><br><span class="line"><span class="title">empty</span> = <span class="type">Semaphore</span>(<span class="number">2</span>)</span><br><span class="line"><span class="title">full</span> = <span class="type">Semaphore</span>(<span class="number">0</span>)</span><br><span class="line"><span class="title">lock</span> = <span class="type">Lock</span>()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="type">Consumer</span>(<span class="type">Process</span>):</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">    def run(<span class="title">self</span>):</span></span><br><span class="line"><span class="class">        global buffer, empty, full, lock</span></span><br><span class="line"><span class="class">        while <span class="type">True</span>:</span></span><br><span class="line"><span class="class">            full.acquire()</span></span><br><span class="line"><span class="class">            lock.acquire()</span></span><br><span class="line"><span class="class">            buffer.get()</span></span><br><span class="line"><span class="class">            print('<span class="type">Consumer</span> <span class="title">pop</span> <span class="title">an</span> <span class="title">element'</span>)</span></span><br><span class="line"><span class="class">            time.sleep(1)</span></span><br><span class="line"><span class="class">            lock.release()</span></span><br><span class="line"><span class="class">            empty.release()</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="type">Producer</span>(<span class="type">Process</span>):</span></span><br><span class="line"><span class="class">    def run(<span class="title">self</span>):</span></span><br><span class="line"><span class="class">        global buffer, empty, full, lock</span></span><br><span class="line"><span class="class">        while <span class="type">True</span>:</span></span><br><span class="line"><span class="class">            empty.acquire()</span></span><br><span class="line"><span class="class">            lock.acquire()</span></span><br><span class="line"><span class="class">            buffer.put(1)</span></span><br><span class="line"><span class="class">            print('<span class="type">Producer</span> <span class="title">append</span> <span class="title">an</span> <span class="title">element'</span>)</span></span><br><span class="line"><span class="class">            time.sleep(1)</span></span><br><span class="line"><span class="class">            lock.release()</span></span><br><span class="line"><span class="class">            full.release()</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">if __name__ == '__main__':</span></span><br><span class="line"><span class="class">    p = <span class="type">Producer</span>()</span></span><br><span class="line"><span class="class">    c = <span class="type">Consumer</span>()</span></span><br><span class="line"><span class="class">    p.daemon = c.daemon = <span class="type">True</span></span></span><br><span class="line"><span class="class">    p.start()</span></span><br><span class="line"><span class="class">    c.start()</span></span><br><span class="line"><span class="class">    p.join()</span></span><br><span class="line"><span class="class">    c.join()</span></span><br><span class="line"><span class="class">    print '<span class="type">Ended</span>!'</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>如上代码实现了注明的生产者和消费者问题，定义了两个进程类，一个是消费者，一个是生产者。 定义了一个共享队列，利用了 Queue 数据结构，然后定义了两个信号量，一个代表缓冲区空余数，一个表示缓冲区占用数。 生产者 Producer 使用 empty.acquire()方法来占用一个缓冲区位置，然后缓冲区空闲区大小减小 1，接下来进行加锁，对缓冲区进行操作。然后释放锁，然后让代表占用的缓冲区位置数量+1，消费者则相反。 运行结果如下：</p>
                  <figure class="highlight livecodeserver">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">Producer append <span class="keyword">an</span> <span class="keyword">element</span></span><br><span class="line">Producer append <span class="keyword">an</span> <span class="keyword">element</span></span><br><span class="line">Consumer pop <span class="keyword">an</span> <span class="keyword">element</span></span><br><span class="line">Consumer pop <span class="keyword">an</span> <span class="keyword">element</span></span><br><span class="line">Producer append <span class="keyword">an</span> <span class="keyword">element</span></span><br><span class="line">Producer append <span class="keyword">an</span> <span class="keyword">element</span></span><br><span class="line">Consumer pop <span class="keyword">an</span> <span class="keyword">element</span></span><br><span class="line">Consumer pop <span class="keyword">an</span> <span class="keyword">element</span></span><br><span class="line">Producer append <span class="keyword">an</span> <span class="keyword">element</span></span><br><span class="line">Producer append <span class="keyword">an</span> <span class="keyword">element</span></span><br><span class="line">Consumer pop <span class="keyword">an</span> <span class="keyword">element</span></span><br><span class="line">Consumer pop <span class="keyword">an</span> <span class="keyword">element</span></span><br><span class="line">Producer append <span class="keyword">an</span> <span class="keyword">element</span></span><br><span class="line">Producer append <span class="keyword">an</span> <span class="keyword">element</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可以发现两个进程在交替运行，生产者先放入缓冲区物品，然后消费者取出，不停地进行循环。 通过上面的例子来体会一下信号量的用法。</p>
                  <h2 id="Queue"><a href="#Queue" class="headerlink" title="Queue"></a>Queue</h2>
                  <p>在上面的例子中我们使用了 Queue，可以作为进程通信的共享队列使用。 在上面的程序中，如果你把 Queue 换成普通的 list，是完全起不到效果的。即使在一个进程中改变了这个 list，在另一个进程也不能获取到它的状态。 因此进程间的通信，队列需要用 Queue。当然这里的队列指的是 multiprocessing.Queue 依然是用上面那个例子，我们一个进程向队列中放入数据，然后另一个进程取出数据。</p>
                  <figure class="highlight sql">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">from multiprocessing import Process, Semaphore, <span class="keyword">Lock</span>, Queue</span><br><span class="line"><span class="keyword">import</span> <span class="built_in">time</span></span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line">buffer = Queue(<span class="number">10</span>)</span><br><span class="line"><span class="keyword">empty</span> = Semaphore(<span class="number">2</span>)</span><br><span class="line"><span class="keyword">full</span> = Semaphore(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">lock</span> = <span class="keyword">Lock</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> Consumer(Process):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> run(<span class="keyword">self</span>):</span><br><span class="line">        <span class="keyword">global</span> buffer, <span class="keyword">empty</span>, <span class="keyword">full</span>, <span class="keyword">lock</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            full.acquire()</span><br><span class="line">            lock.acquire()</span><br><span class="line">            print <span class="string">'Consumer get'</span>, buffer.get()</span><br><span class="line">            time.sleep(<span class="number">1</span>)</span><br><span class="line">            lock.release()</span><br><span class="line">            empty.release()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> Producer(Process):</span><br><span class="line">    <span class="keyword">def</span> run(<span class="keyword">self</span>):</span><br><span class="line">        <span class="keyword">global</span> buffer, <span class="keyword">empty</span>, <span class="keyword">full</span>, <span class="keyword">lock</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            empty.acquire()</span><br><span class="line">            lock.acquire()</span><br><span class="line">            <span class="keyword">num</span> = random()</span><br><span class="line">            print <span class="string">'Producer put '</span>, <span class="keyword">num</span></span><br><span class="line">            buffer.put(<span class="keyword">num</span>)</span><br><span class="line">            time.sleep(<span class="number">1</span>)</span><br><span class="line">            lock.release()</span><br><span class="line">            full.release()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    p = Producer()</span><br><span class="line">    c = Consumer()</span><br><span class="line">    p.daemon = c.daemon = <span class="literal">True</span></span><br><span class="line">    p.start()</span><br><span class="line">    c.start()</span><br><span class="line">    p.join()</span><br><span class="line">    c.join()</span><br><span class="line">    print <span class="string">'Ended!'</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">Producer put  <span class="number">0.719213647437</span></span><br><span class="line">Producer put  <span class="number">0.44287326683</span></span><br><span class="line">Consumer <span class="keyword">get</span> <span class="number">0.719213647437</span></span><br><span class="line">Consumer <span class="keyword">get</span> <span class="number">0.44287326683</span></span><br><span class="line">Producer put  <span class="number">0.722859424381</span></span><br><span class="line">Producer put  <span class="number">0.525321338921</span></span><br><span class="line">Consumer <span class="keyword">get</span> <span class="number">0.722859424381</span></span><br><span class="line">Consumer <span class="keyword">get</span> <span class="number">0.525321338921</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可以看到生产者放入队列中数据，然后消费者将数据取出来。 get 方法有两个参数，blocked 和 timeout，意思为阻塞和超时时间。默认 blocked 是 true，即阻塞式。 当一个队列为空的时候如果再用 get 取则会阻塞，所以这时候就需要吧 blocked 设置为 false，即非阻塞式，实际上它就会调用 get_nowait()方法，此时还需要设置一个超时时间，在这么长的时间内还没有取到队列元素，那就抛出 Queue.Empty 异常。 当一个队列为满的时候如果再用 put 放则会阻塞，所以这时候就需要吧 blocked 设置为 false，即非阻塞式，实际上它就会调用 put_nowait()方法，此时还需要设置一个超时时间，在这么长的时间内还没有放进去元素，那就抛出 Queue.Full 异常。 另外队列中常用的方法 Queue.qsize() 返回队列的大小 ，不过在 Mac OS 上没法运行。 原因：</p>
                  <blockquote>
                    <p>def qsize(self): # Raises NotImplementedError on Mac OSX because of broken sem_getvalue() return self._maxsize - self._sem._semlock._get_value()</p>
                  </blockquote>
                  <p>Queue.empty() 如果队列为空，返回 True, 反之 False Queue.full() 如果队列满了，返回 True,反之 False Queue.get([block[, timeout]]) 获取队列，timeout 等待时间 Queue.get_nowait() 相当 Queue.get(False) Queue.put(item) 阻塞式写入队列，timeout 等待时间 Queue.put_nowait(item) 相当 Queue.put(item, False)</p>
                  <h2 id="Pipe"><a href="#Pipe" class="headerlink" title="Pipe"></a>Pipe</h2>
                  <p>管道，顾名思义，一端发一端收。 Pipe 可以是单向(half-duplex)，也可以是双向(duplex)。我们通过 mutiprocessing.Pipe(duplex=False)创建单向管道 (默认为双向)。一个进程从 PIPE 一端输入对象，然后被 PIPE 另一端的进程接收，单向管道只允许管道一端的进程输入，而双向管道则允许从两端输入。 用一个实例来感受一下：</p>
                  <figure class="highlight ruby">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">from multiprocessing import Process, Pipe</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Consumer</span>(<span class="title">Process</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(<span class="keyword">self</span>, pipe)</span></span><span class="symbol">:</span></span><br><span class="line">        Process.__init_<span class="number">_</span>(<span class="keyword">self</span>)</span><br><span class="line">        <span class="keyword">self</span>.pipe = pipe</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">self</span>.pipe.send(<span class="string">'Consumer Words'</span>)</span><br><span class="line">        print <span class="string">'Consumer Received:'</span>, <span class="keyword">self</span>.pipe.recv()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Producer</span>(<span class="title">Process</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(<span class="keyword">self</span>, pipe)</span></span><span class="symbol">:</span></span><br><span class="line">        Process.__init_<span class="number">_</span>(<span class="keyword">self</span>)</span><br><span class="line">        <span class="keyword">self</span>.pipe = pipe</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        print <span class="string">'Producer Received:'</span>, <span class="keyword">self</span>.pipe.recv()</span><br><span class="line">        <span class="keyword">self</span>.pipe.send(<span class="string">'Producer Words'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name_<span class="number">_</span> == <span class="string">'__main__'</span><span class="symbol">:</span></span><br><span class="line">    pipe = Pipe()</span><br><span class="line">    p = Producer(pipe[<span class="number">0</span>])</span><br><span class="line">    c = Consumer(pipe[<span class="number">1</span>])</span><br><span class="line">    p.daemon = c.daemon = True</span><br><span class="line">    p.start()</span><br><span class="line">    c.start()</span><br><span class="line">    p.join()</span><br><span class="line">    c.join()</span><br><span class="line">    print <span class="string">'Ended!'</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在这里声明了一个默认为双向的管道，然后将管道的两端分别传给两个进程。两个进程互相收发。观察一下结果：</p>
                  <figure class="highlight groovy">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">Producer <span class="string">Received:</span> Consumer Words</span><br><span class="line">Consumer <span class="string">Received:</span> Producer Words</span><br><span class="line">Ended!</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>以上是对 pipe 的简单介绍。</p>
                  <h2 id="Pool"><a href="#Pool" class="headerlink" title="Pool"></a>Pool</h2>
                  <p>在利用 Python 进行系统管理的时候，特别是同时操作多个文件目录，或者远程控制多台主机，并行操作可以节约大量的时间。当被操作对象数目不大时，可以直接利用 multiprocessing 中的 Process 动态成生多个进程，十几个还好，但如果是上百个，上千个目标，手动的去限制进程数量却又太过繁琐，此时可以发挥进程池的功效。 Pool 可以提供指定数量的进程，供用户调用，当有新的请求提交到 pool 中时，如果池还没有满，那么就会创建一个新的进程用来执行该请求；但如果池中的进程数已经达到规定最大值，那么该请求就会等待，直到池中有进程结束，才会创建新的进程来它。 在这里需要了解阻塞和非阻塞的概念。 阻塞和非阻塞关注的是程序在等待调用结果（消息，返回值）时的状态。 阻塞即要等到回调结果出来，在有结果之前，当前进程会被挂起。 Pool 的用法有阻塞和非阻塞两种方式。非阻塞即为添加进程后，不一定非要等到改进程执行完就添加其他进程运行，阻塞则相反。 现用一个实例感受一下非阻塞的用法：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> multiprocessing import Lock, Pool</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def function(index):</span><br><span class="line">    <span class="builtin-name">print</span> <span class="string">'Start process: '</span>, index</span><br><span class="line">    time.sleep(3)</span><br><span class="line">    <span class="builtin-name">print</span> <span class="string">'End process'</span>, index</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">   <span class="built_in"> pool </span>= Pool(<span class="attribute">processes</span>=3)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(4):</span><br><span class="line">        pool.apply_async(function, (i,))</span><br><span class="line"></span><br><span class="line">    <span class="builtin-name">print</span> <span class="string">"Started processes"</span></span><br><span class="line">    pool.close()</span><br><span class="line">    pool.join()</span><br><span class="line">    <span class="builtin-name">print</span> <span class="string">"Subprocess done."</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在这里利用了 apply_async 方法，即非阻塞。 运行结果：</p>
                  <figure class="highlight yaml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="string">Started</span> <span class="string">processes</span></span><br><span class="line"><span class="attr">Start process: Start process:</span>  <span class="number">0</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="attr">Start process:</span>  <span class="number">2</span></span><br><span class="line"><span class="string">End</span> <span class="string">processEnd</span> <span class="string">process</span> <span class="number">0</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="attr">Start process:</span>  <span class="number">3</span></span><br><span class="line"><span class="string">End</span> <span class="string">process</span> <span class="number">2</span></span><br><span class="line"><span class="string">End</span> <span class="string">process</span> <span class="number">3</span></span><br><span class="line"><span class="string">Subprocess</span> <span class="string">done.</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可以发现在这里添加三个进程进去后，立马就开始执行，不用非要等到某个进程结束后再添加新的进程进去。 下面再看看阻塞的用法：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> multiprocessing import Lock, Pool</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def function(index):</span><br><span class="line">    <span class="builtin-name">print</span> <span class="string">'Start process: '</span>, index</span><br><span class="line">    time.sleep(3)</span><br><span class="line">    <span class="builtin-name">print</span> <span class="string">'End process'</span>, index</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">   <span class="built_in"> pool </span>= Pool(<span class="attribute">processes</span>=3)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(4):</span><br><span class="line">        pool.apply(function, (i,))</span><br><span class="line"></span><br><span class="line">    <span class="builtin-name">print</span> <span class="string">"Started processes"</span></span><br><span class="line">    pool.close()</span><br><span class="line">    pool.join()</span><br><span class="line">    <span class="builtin-name">print</span> <span class="string">"Subprocess done."</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在这里只需要把 apply_async 改成 apply 即可。 运行结果如下：</p>
                  <figure class="highlight powershell">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">Start <span class="keyword">process</span>:  <span class="number">0</span></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">process</span> <span class="number">0</span></span><br><span class="line">Start <span class="keyword">process</span>:  <span class="number">1</span></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">process</span> <span class="number">1</span></span><br><span class="line">Start <span class="keyword">process</span>:  <span class="number">2</span></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">process</span> <span class="number">2</span></span><br><span class="line">Start <span class="keyword">process</span>:  <span class="number">3</span></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">process</span> <span class="number">3</span></span><br><span class="line">Started processes</span><br><span class="line">Subprocess done.</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样一来就好理解了吧？ 下面对函数进行解释： apply_async(func[, args[, kwds[, callback]]]) 它是非阻塞，apply(func[, args[, kwds]])是阻塞的。 close() 关闭 pool，使其不在接受新的任务。 terminate() 结束工作进程，不在处理未完成的任务。 join() 主进程阻塞，等待子进程的退出， join 方法要在 close 或 terminate 之后使用。 当然每个进程可以在各自的方法返回一个结果。apply 或 apply_async 方法可以拿到这个结果并进一步进行处理。</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> multiprocessing import Lock, Pool</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def function(index):</span><br><span class="line">    <span class="builtin-name">print</span> <span class="string">'Start process: '</span>, index</span><br><span class="line">    time.sleep(3)</span><br><span class="line">    <span class="builtin-name">print</span> <span class="string">'End process'</span>, index</span><br><span class="line">    return index</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">   <span class="built_in"> pool </span>= Pool(<span class="attribute">processes</span>=3)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(4):</span><br><span class="line">        result = pool.apply_async(function, (i,))</span><br><span class="line">        <span class="builtin-name">print</span> result.<span class="builtin-name">get</span>()</span><br><span class="line">    <span class="builtin-name">print</span> <span class="string">"Started processes"</span></span><br><span class="line">    pool.close()</span><br><span class="line">    pool.join()</span><br><span class="line">    <span class="builtin-name">print</span> <span class="string">"Subprocess done."</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果：</p>
                  <figure class="highlight yaml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attr">Start process:</span>  <span class="number">0</span></span><br><span class="line"><span class="string">End</span> <span class="string">process</span> <span class="number">0</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="attr">Start process:</span>  <span class="number">1</span></span><br><span class="line"><span class="string">End</span> <span class="string">process</span> <span class="number">1</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="attr">Start process:</span>  <span class="number">2</span></span><br><span class="line"><span class="string">End</span> <span class="string">process</span> <span class="number">2</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="attr">Start process:</span>  <span class="number">3</span></span><br><span class="line"><span class="string">End</span> <span class="string">process</span> <span class="number">3</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="string">Started</span> <span class="string">processes</span></span><br><span class="line"><span class="string">Subprocess</span> <span class="string">done.</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>另外还有一个非常好用的 map 方法。 如果你现在有一堆数据要处理，每一项都需要经过一个方法来处理，那么 map 非常适合。 比如现在你有一个数组，包含了所有的 URL，而现在已经有了一个方法用来抓取每个 URL 内容并解析，那么可以直接在 map 的第一个参数传入方法名，第二个参数传入 URL 数组。 现在我们用一个实例来感受一下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> multiprocessing import Pool</span><br><span class="line">import requests</span><br><span class="line"><span class="keyword">from</span> requests.exceptions import ConnectionError</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def scrape(url):</span><br><span class="line">    try:</span><br><span class="line">        <span class="builtin-name">print</span> requests.<span class="builtin-name">get</span>(url)</span><br><span class="line">    except ConnectionError:</span><br><span class="line">        <span class="builtin-name">print</span> <span class="string">'Error Occured '</span>, url</span><br><span class="line">    finally:</span><br><span class="line">        <span class="builtin-name">print</span> <span class="string">'URL '</span>, url, <span class="string">' Scraped'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">   <span class="built_in"> pool </span>= Pool(<span class="attribute">processes</span>=3)</span><br><span class="line">    urls = [</span><br><span class="line">        <span class="string">'https://www.baidu.com'</span>,</span><br><span class="line">        <span class="string">'http://www.meituan.com/'</span>,</span><br><span class="line">        <span class="string">'http://blog.csdn.net/'</span>,</span><br><span class="line">        <span class="string">'http://xxxyxxx.net'</span></span><br><span class="line">    ]</span><br><span class="line">    pool.map(scrape, urls)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在这里初始化一个 Pool，指定进程数为 3，如果不指定，那么会自动根据 CPU 内核来分配进程数。 然后有一个链接列表，map 函数可以遍历每个 URL，然后对其分别执行 scrape 方法。 运行结果：</p>
                  <figure class="highlight groovy">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">&lt;Response [<span class="number">403</span>]&gt;</span><br><span class="line">URL  <span class="string">http:</span><span class="comment">//blog.csdn.net/  Scraped</span></span><br><span class="line">&lt;Response [<span class="number">200</span>]&gt;</span><br><span class="line">URL  <span class="string">https:</span><span class="comment">//www.baidu.com  Scraped</span></span><br><span class="line">Error Occured  <span class="string">http:</span><span class="comment">//xxxyxxx.net</span></span><br><span class="line">URL  <span class="string">http:</span><span class="comment">//xxxyxxx.net  Scraped</span></span><br><span class="line">&lt;Response [<span class="number">200</span>]&gt;</span><br><span class="line">URL  <span class="string">http:</span><span class="comment">//www.meituan.com/  Scraped</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可以看到遍历就这么轻松地实现了。</p>
                  <h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2>
                  <p>多进程 multiprocessing 相比多线程功能强大太多，而且使用范围更广，希望本文对大家有帮助！</p>
                  <h2 id="本文参考"><a href="#本文参考" class="headerlink" title="本文参考"></a>本文参考</h2>
                  <p><a href="https://docs.python.org/2/library/multiprocessing.html" target="_blank" rel="noopener">https://docs.python.org/2/library/multiprocessing.html</a> <a href="http://www.cnblogs.com/vamei/archive/2012/10/12/2721484.html" target="_blank" rel="noopener">http://www.cnblogs.com/vamei/archive/2012/10/12/2721484.html</a> <a href="http://www.cnblogs.com/kaituorensheng/p/4445418.html" target="_blank" rel="noopener">http://www.cnblogs.com/kaituorensheng/p/4445418.html</a> <a href="https://my.oschina.net/yangyanxing/blog/296052" target="_blank" rel="noopener">https://my.oschina.net/yangyanxing/blog/296052</a></p>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2016-11-13 20:25:32" itemprop="dateCreated datePublished" datetime="2016-11-13T20:25:32+08:00">2016-11-13</time>
                </span>
                <span id="/3335.html" class="post-meta-item leancloud_visitors" data-flag-title="Python爬虫进阶六之多进程的用法" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>15k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>14 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/3314.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="静觅丨崔庆才的个人站点专业为您提供爬虫教程,爬虫,Python,Python爬虫,Python爬虫教程,爬虫书的相关信息，想要了解更多详情，请联系我们。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/3314.html" class="post-title-link" itemprop="url">小白爬虫第三弹之去重去重</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <p><a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/QQ图片20161022193315.gif" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/QQ图片20161022193315.gif" alt="QQ图片20161022193315"></a> 好了！开头要说点啥，我想你们已经知道了！ <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/QQ图片20161021224219.gif" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/QQ图片20161021224219.gif" alt="QQ图片20161021224219"></a> 没错！我又来装逼了·· 前面两篇博文，不知道大家消化得怎么了。不知道各位有没注意到，前面两篇博文完成的工作，只能保证下载；你电脑不能关机，不能断网，总之不能出意外！否则啊！！！ ！！！！你就得重头开始啊！！！！ <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/11/20160124759183737.gif" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/11/20160124759183737.gif" alt="20160124759183737"></a> 今天，我们来想想办法让它不重头下载；我们来记录我们已经下载过的地址！ヾ(＠⌒ ー ⌒＠)ノ这样就可以实现不重新下载啦！ 本来刚开始我是准备用本地 txt 来记录的，不过仔细一想用本地 txt 逼格不够啊！要不用 MySQL 吧！然后我自己就用了 MySQL。 <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/11/QQ图片20161102215153.jpg" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/11/QQ图片20161102215153.jpg" alt="QQ图片20161102215153"></a> 然而你以为我会在这教程里面用 MySQL 嘛！哈哈哈！我们来用 MongoDB！！这数据库最近很火啊！逼格直线提升啊！哈哈哈！<a href="https://www.mongodb.com" target="_blank" rel="noopener">点我去官网下载</a> 安装 mongoDB: <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/11/123.gif" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/11/123.gif" alt="123"></a> 在 C 盘建一个用来存储数据的文件夹 MongoDB； 创建以下两个目录： C:\data\log\mongod.log 存储日志 C:\data\db 存储数据 在 C:\MongoDB 文件夹下面创建一个 mongod.cfg 的配置文件写入以下配置： 一定要取消隐藏后缀名，不然更改不会生效！</p>
                  <figure class="highlight less">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attribute">systemLog</span>:</span><br><span class="line"> <span class="attribute">destination</span>: file</span><br><span class="line"> <span class="attribute">path</span>: <span class="attribute">C</span>:\data\log\mongod.log</span><br><span class="line"><span class="attribute">storage</span>:</span><br><span class="line"> <span class="attribute">dbPath</span>: <span class="attribute">C</span>:\data\db</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在管理员权限的 cmd 中执行以下命令将 mongoDB 安装成服务:</p>
                  <figure class="highlight taggerscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">"C:<span class="symbol">\m</span>ongodb<span class="symbol">\b</span>in<span class="symbol">\m</span>ongod.exe" --config "C:<span class="symbol">\m</span>ongodb<span class="symbol">\m</span>ongod.cfg" --install</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p><a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/11/安装服务.gif" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/11/安装服务.gif" alt="安装服务"></a> <strong>上面两张图片是 GIF 点击是可以看到过程的哦！！！ヾ(=ﾟ･ﾟ=)ﾉ喵 ♪</strong> 服务器安装完了，CMD 启动一下： <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/11/验证是否安装成功.png" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/11/验证是否安装成功.png" alt="验证是否安装成功"></a> 搞定！ 好啦！数据库装完了，我们来接着上一篇博文的内容继续啦！ 保险起见建议大家还是看一下 MongoDB 的基础（只需要知道那些命令是做了啥，这样就好啦！） 首先我们我们这一次需要一个模块 PyMongo；这是 Python 用来操作 MongoDB 的模块，不要担心使用起来很简单的！</p>
                  <figure class="highlight cmake">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">pip <span class="keyword">install</span> PyMongo</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>现在我们在上一篇博文完成的代码中导入模块：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> pymongo <span class="keyword">import</span> MongoClient</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p><strong>第一步：</strong> 在 class mzitu(): 下面添加这样一个函数：</p>
                  <figure class="highlight ruby">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">    client = MongoClient() <span class="comment">##与MongDB建立连接（这是默认连接本地MongDB数据库）</span></span><br><span class="line">    db = client[<span class="string">'meinvxiezhenji'</span>] <span class="comment">## 选择一个数据库</span></span><br><span class="line">    <span class="keyword">self</span>.meizitu_collection = db[<span class="string">'meizitu'</span>] <span class="comment">##在meizixiezhenji这个数据库中，选择一个集合</span></span><br><span class="line">    <span class="keyword">self</span>.title = <span class="string">''</span> <span class="comment">##用来保存页面主题</span></span><br><span class="line">    <span class="keyword">self</span>.url = <span class="string">''</span> <span class="comment">##用来保存页面地址</span></span><br><span class="line">    <span class="keyword">self</span>.img_urls = [] <span class="comment">##初始化一个 列表 用来保存图片地址</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>好啦！第一步搞定， <strong>第二步：</strong> 我们更改一下 def all_url 函数：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">all_url</span><span class="params">(self, url)</span>:</span></span><br><span class="line">    html = down.get(url, <span class="number">3</span>)</span><br><span class="line">    all_a = BeautifulSoup(html.text, <span class="string">'lxml'</span>).find(<span class="string">'div'</span>, class_=<span class="string">'all'</span>).find_all(<span class="string">'a'</span>)</span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> all_a:</span><br><span class="line">        title = a.get_text()</span><br><span class="line">        self.title = title <span class="comment">##将主题保存到self.title中</span></span><br><span class="line">        print(<span class="string">u'开始保存：'</span>, title)</span><br><span class="line">        path = str(title).replace(<span class="string">"?"</span>, <span class="string">'_'</span>)</span><br><span class="line">        self.mkdir(path)</span><br><span class="line">        os.chdir(<span class="string">"D:\mzitu\\"</span>+path)</span><br><span class="line">        href = a[<span class="string">'href'</span>]</span><br><span class="line">        self.url = href <span class="comment">##将页面地址保存到self.url中</span></span><br><span class="line">        <span class="keyword">if</span> self.meizitu_collection.find_one(&#123;<span class="string">'主题页面'</span>: href&#125;):  <span class="comment">##判断这个主题是否已经在数据库中、不在就运行else下的内容，在则忽略。</span></span><br><span class="line">            print(<span class="string">u'这个页面已经爬取过了'</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.html(href)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p><strong>第三步：</strong> 我们来改一下 def html 这个函数：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">def html(self, href):</span><br><span class="line">    html = down.<span class="builtin-name">get</span>(href, 3)</span><br><span class="line">    max_span = BeautifulSoup(html.text, <span class="string">'lxml'</span>).find_all(<span class="string">'span'</span>)[10].get_text()</span><br><span class="line">    page_num = 0  ##这个当作计数器用 （用来判断图片是否下载完毕）</span><br><span class="line">    <span class="keyword">for</span><span class="built_in"> page </span><span class="keyword">in</span> range(1, int(max_span) + 1):</span><br><span class="line">        page_num = page_num + 1 ##每<span class="keyword">for</span>循环一次就+1  （当page_num等于max_span的时候，就证明我们的在下载最后一张图片了）</span><br><span class="line">        page_url = href + <span class="string">'/'</span> + str(page)</span><br><span class="line">        self.img(page_url, max_span, page_num)  ##把上面我们我们需要的两个变量，传递给下一个函数。</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>第四步： 我们来改一下 def img 这个函数：</p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">img</span><span class="params">(self, page_url, max_span, page_num)</span>:</span> <span class="comment">##添加上面传递的参数</span></span><br><span class="line">    img_html = down.get(page_url, <span class="number">3</span>)</span><br><span class="line">    img_url = BeautifulSoup(img_html.text, <span class="string">'lxml'</span>).find(<span class="string">'div'</span>, class_=<span class="string">'main-image'</span>).find(<span class="string">'img'</span>)[<span class="string">'src'</span>]</span><br><span class="line">    self.img_urls.append(img_url) <span class="comment">##每一次 for page in range(1, int(max_span) + 1)获取到的图片地址都会添加到 img_urls这个初始化的列表</span></span><br><span class="line">    <span class="keyword">if</span> int(max_span) == page_num: <span class="comment">##我们传递下来的两个参数用上了 当max_span和Page_num相等时，就是最后一张图片了，最后一次下载图片并保存到数据库中。</span></span><br><span class="line">        self.save(img_url)</span><br><span class="line">        post = &#123;  <span class="comment">##这是构造一个字典，里面有啥都是中文，很好理解吧！</span></span><br><span class="line">            <span class="string">'标题'</span>: self.title,</span><br><span class="line">            <span class="string">'主题页面'</span>: self.url,</span><br><span class="line">            <span class="string">'图片地址'</span>: self.img_urls,</span><br><span class="line">            <span class="string">'获取时间'</span>: datetime.datetime.now()</span><br><span class="line">        &#125;</span><br><span class="line">        self.meizitu_collection.save(post) <span class="comment">##将post中的内容写入数据库。</span></span><br><span class="line">        print(<span class="string">u'插入数据库成功'</span>)</span><br><span class="line">    <span class="keyword">else</span>:  <span class="comment">##max_span 不等于 page_num执行这下面</span></span><br><span class="line">        self.save(img_url)</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>self.meizitu_collection.save(post) 这个是怎么来的我要说一下，可能有点迷糊： def <strong>init</strong>(self): 函数中： client = MongoClient() db = client[‘meinvxiezhenji’] self.meizitu_collection = db[‘meizitu’] 所以意思就是：在 meizixiezhenji 这个数据库中的 meizitu 这个集合保存 post 这个字典里面的数据哦！这么解释懂了吧？ヾ(＠⌒ ー ⌒＠)ノ <a href="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/QQ图片20161021223818.jpg" target="_blank" rel="noopener"><img src="http://cdn.cuiqingcai.com/wp-content/uploads/2016/10/QQ图片20161021223818.jpg" alt="QQ图片20161021223818"></a> 好了、一个可以实现去重的爬虫就实现了！φ(゜ ▽ ゜*)♪ 是不是好简单 哈哈哈 顺带还存储了一堆信息（才不会告诉你们这才是我需要的呢） 好了 完整的代码贴上来了！ <strong>PS:需要先说一下 MongDB 是不需要先建数据库和集合的，会自动判断 存在则直接写入数据，不存在 则先创建需要的数据库和集合，再写入数据（是不是超爽？哈哈哈）</strong></p>
                  <figure class="highlight python">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> Download <span class="keyword">import</span> down <span class="comment">##导入模块变了一下</span></span><br><span class="line"><span class="keyword">from</span> pymongo <span class="keyword">import</span> MongoClient</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">mzitu</span><span class="params">()</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        client = MongoClient() <span class="comment">##与MongDB建立连接（这是默认连接本地MongDB数据库）</span></span><br><span class="line">        db = client[<span class="string">'meinvxiezhenji'</span>] <span class="comment">## 选择一个数据库</span></span><br><span class="line">        self.meizitu_collection = db[<span class="string">'meizitu'</span>] <span class="comment">##在meizixiezhenji这个数据库中，选择一个集合</span></span><br><span class="line">        self.title = <span class="string">''</span> <span class="comment">##用来保存页面主题</span></span><br><span class="line">        self.url = <span class="string">''</span> <span class="comment">##用来保存页面地址</span></span><br><span class="line">        self.img_urls = [] <span class="comment">##初始化一个 列表  用来保存图片地址</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">all_url</span><span class="params">(self, url)</span>:</span></span><br><span class="line">        html = down.get(url, <span class="number">3</span>)</span><br><span class="line">        all_a = BeautifulSoup(html.text, <span class="string">'lxml'</span>).find(<span class="string">'div'</span>, class_=<span class="string">'all'</span>).find_all(<span class="string">'a'</span>)</span><br><span class="line">        <span class="keyword">for</span> a <span class="keyword">in</span> all_a:</span><br><span class="line">            title = a.get_text()</span><br><span class="line">            self.title = title <span class="comment">##将主题保存到self.title中</span></span><br><span class="line">            print(<span class="string">u'开始保存：'</span>, title)</span><br><span class="line">            path = str(title).replace(<span class="string">"?"</span>, <span class="string">'_'</span>)</span><br><span class="line">            self.mkdir(path)</span><br><span class="line">            os.chdir(<span class="string">"D:\mzitu\\"</span>+path)</span><br><span class="line">            href = a[<span class="string">'href'</span>]</span><br><span class="line">            self.url = href <span class="comment">##将页面地址保存到self.url中</span></span><br><span class="line">            <span class="keyword">if</span> self.meizitu_collection.find_one(&#123;<span class="string">'主题页面'</span>: href&#125;):  <span class="comment">##判断这个主题是否已经在数据库中、不在就运行else下的内容，在则忽略。</span></span><br><span class="line">                print(<span class="string">u'这个页面已经爬取过了'</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.html(href)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">html</span><span class="params">(self, href)</span>:</span></span><br><span class="line">        html = down.get(href, <span class="number">3</span>)</span><br><span class="line">        max_span = BeautifulSoup(html.text, <span class="string">'lxml'</span>).find_all(<span class="string">'span'</span>)[<span class="number">10</span>].get_text()</span><br><span class="line">        page_num = <span class="number">0</span>  <span class="comment">##这个当作计数器用 （用来判断图片是否下载完毕）</span></span><br><span class="line">        <span class="keyword">for</span> page <span class="keyword">in</span> range(<span class="number">1</span>, int(max_span) + <span class="number">1</span>):</span><br><span class="line">            page_num = page_num + <span class="number">1</span> <span class="comment">##每for循环一次就+1  （当page_num等于max_span的时候，就证明我们的在下载最后一张图片了）</span></span><br><span class="line">            page_url = href + <span class="string">'/'</span> + str(page)</span><br><span class="line">            self.img(page_url, max_span, page_num)  <span class="comment">##把上面我们我们需要的两个变量，传递给下一个函数。</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">img</span><span class="params">(self, page_url, max_span, page_num)</span>:</span> <span class="comment">##添加上面传递的参数</span></span><br><span class="line">        img_html = down.get(page_url, <span class="number">3</span>)</span><br><span class="line">        img_url = BeautifulSoup(img_html.text, <span class="string">'lxml'</span>).find(<span class="string">'div'</span>, class_=<span class="string">'main-image'</span>).find(<span class="string">'img'</span>)[<span class="string">'src'</span>]</span><br><span class="line">        self.img_urls.append(img_url) <span class="comment">##每一次 for page in range(1, int(max_span) + 1)获取到的图片地址都会添加到 img_urls这个初始化的列表</span></span><br><span class="line">        <span class="keyword">if</span> int(max_span) == page_num: <span class="comment">##我们传递下来的两个参数用上了 当max_span和Page_num相等时，就是最后一张图片了，最后一次下载图片并保存到数据库中。</span></span><br><span class="line">            self.save(img_url)</span><br><span class="line">            post = &#123;  <span class="comment">##这是构造一个字典，里面有啥都是中文，很好理解吧！</span></span><br><span class="line">                <span class="string">'标题'</span>: self.title,</span><br><span class="line">                <span class="string">'主题页面'</span>: self.url,</span><br><span class="line">                <span class="string">'图片地址'</span>: self.img_urls,</span><br><span class="line">                <span class="string">'获取时间'</span>: datetime.datetime.now()</span><br><span class="line">            &#125;</span><br><span class="line">            self.meizitu_collection.save(post) <span class="comment">##将post中的内容写入数据库。</span></span><br><span class="line">            print(<span class="string">u'插入数据库成功'</span>)</span><br><span class="line">        <span class="keyword">else</span>:  <span class="comment">##max_span 不等于 page_num执行这下面</span></span><br><span class="line">            self.save(img_url)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">save</span><span class="params">(self, img_url)</span>:</span></span><br><span class="line">        name = img_url[<span class="number">-9</span>:<span class="number">-4</span>]</span><br><span class="line">        print(<span class="string">u'开始保存：'</span>, img_url)</span><br><span class="line">        img = down.get(img_url, <span class="number">3</span>)</span><br><span class="line">        f = open(name + <span class="string">'.jpg'</span>, <span class="string">'ab'</span>)</span><br><span class="line">        f.write(img.content)</span><br><span class="line">        f.close()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mkdir</span><span class="params">(self, path)</span>:</span></span><br><span class="line">        path = path.strip()</span><br><span class="line">        isExists = os.path.exists(os.path.join(<span class="string">"D:\mzitu"</span>, path))</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> isExists:</span><br><span class="line">            print(<span class="string">u'建了一个名字叫做'</span>, path, <span class="string">u'的文件夹！'</span>)</span><br><span class="line">            os.makedirs(os.path.join(<span class="string">"D:\mzitu"</span>, path))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(<span class="string">u'名字叫做'</span>, path, <span class="string">u'的文件夹已经存在了！'</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Mzitu = mzitu() <span class="comment">##实例化</span></span><br><span class="line">Mzitu.all_url(<span class="string">'http://www.mzitu.com/all'</span>) <span class="comment">##给函数all_url传入参数  你可以当作启动爬虫（就是入口）</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/哎哟卧槽" class="author" itemprop="url" rel="index">哎哟卧槽</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2016-11-06 01:22:09" itemprop="dateCreated datePublished" datetime="2016-11-06T01:22:09+08:00">2016-11-06</time>
                </span>
                <span id="/3314.html" class="post-meta-item leancloud_visitors" data-flag-title="小白爬虫第三弹之去重去重" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>5.5k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>5 分钟</span>
                </span>
              </div>
            </article>
            <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/3325.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="静觅丨崔庆才的个人站点专业为您提供爬虫教程,爬虫,Python,Python爬虫,Python爬虫教程,爬虫书的相关信息，想要了解更多详情，请联系我们。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h2 class="post-title" itemprop="name headline">
                  <a class="label"> Python <i class="label-arrow"></i>
                  </a>
                  <a href="/3325.html" class="post-title-link" itemprop="url">Python爬虫进阶五之多线程的用法</a>
                </h2>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="thumb">
                  <img itemprop="contentUrl" class="random">
                </div>
                <div class="excerpt">
                  <p>
                  <h2 id="2022-年最新-Python3-网络爬虫教程"><a href="#2022-年最新-Python3-网络爬虫教程" class="headerlink" title="2022 年最新 Python3 网络爬虫教程"></a>2022 年最新 Python3 网络爬虫教程</h2>
                  <p>大家好，我是崔庆才，由于爬虫技术不断迭代升级，一些旧的教程已经过时、案例已经过期，最前沿的爬虫技术比如异步、JavaScript 逆向、安卓逆向、智能解析、WebAssembly、大规模分布式、Kubernetes 等技术层出不穷，我最近新出了一套最新最全面的 Python3 网络爬虫系列教程。</p>
                  <blockquote>
                    <p>博主自荐：截止 2022 年，可以将最前沿最全面的爬虫技术都涵盖的教程，如异步、JavaScript 逆向、安卓逆向、智能解析、WebAssembly、大规模分布式、Kubernetes 等，市面上目前就这一套了。</p>
                  </blockquote>
                  <p>最新教程对旧的爬虫技术内容进行了全面更新，搭建了全新的案例平台进行全面讲解，保证案例稳定有效不过期。</p>
                  <p>教程请移步：</p>
                  <p><a href="https://cuiqingcai.com/17777.html">【2022 版】Python3 网络爬虫学习教程</a></p>
                  <p>如下为原文。</p>
                  <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2>
                  <p>我们之前写的爬虫都是单个线程的？这怎么够？一旦一个地方卡到不动了，那不就永远等待下去了？为此我们可以使用多线程或者多进程来处理。 首先声明一点！ 多线程和多进程是不一样的！一个是 thread 库，一个是 multiprocessing 库。而多线程 thread 在 Python 里面被称作鸡肋的存在！而没错！本节介绍的是就是这个库 thread。 不建议你用这个，不过还是介绍下了，如果想看可以看看下面，不想浪费时间直接看 <a href="http://cuiqingcai.com/3335.html">multiprocessing 多进程</a></p>
                  <h2 id="鸡肋点"><a href="#鸡肋点" class="headerlink" title="鸡肋点"></a>鸡肋点</h2>
                  <h3 id="名言："><a href="#名言：" class="headerlink" title="名言："></a>名言：</h3>
                  <blockquote>
                    <p>“Python下多线程是鸡肋，推荐使用多进程！”</p>
                  </blockquote>
                  <p>那当然有同学会问了，为啥？</p>
                  <h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3>
                  <p>1、GIL是什么？ GIL的全称是Global Interpreter Lock(全局解释器锁)，来源是python设计之初的考虑，为了数据安全所做的决定。 2、每个CPU在同一时间只能执行一个线程（在单核CPU下的多线程其实都只是并发，不是并行，并发和并行从宏观上来讲都是同时处理多路请求的概念。但并发和并行又有区别，并行是指两个或者多个事件在同一时刻发生；而并发是指两个或多个事件在同一时间间隔内发生。） 在Python多线程下，每个线程的执行方式：</p>
                  <ul>
                    <li>获取GIL</li>
                    <li>执行代码直到sleep或者是python虚拟机将其挂起。</li>
                    <li>释放GIL</li>
                  </ul>
                  <p>可见，某个线程想要执行，必须先拿到GIL，我们可以把GIL看作是“通行证”，并且在一个python进程中，GIL只有一个。拿不到通行证的线程，就不允许进入CPU执行。 在Python2.x里，GIL的释放逻辑是当前线程遇见IO操作或者ticks计数达到100（ticks可以看作是Python自身的一个计数器，专门做用于GIL，每次释放后归零，这个计数可以通过 sys.setcheckinterval 来调整），进行释放。 而每次释放GIL锁，线程进行锁竞争、切换线程，会消耗资源。并且由于GIL锁存在，python里一个进程永远只能同时执行一个线程(拿到GIL的线程才能执行)，这就是为什么在多核CPU上，python的多线程效率并不高。</p>
                  <h3 id="那么是不是python的多线程就完全没用了呢？"><a href="#那么是不是python的多线程就完全没用了呢？" class="headerlink" title="那么是不是python的多线程就完全没用了呢？"></a>那么是不是python的多线程就完全没用了呢？</h3>
                  <p>在这里我们进行分类讨论： 1、CPU密集型代码(各种循环处理、计数等等)，在这种情况下，由于计算工作多，ticks计数很快就会达到阈值，然后触发GIL的释放与再竞争（多个线程来回切换当然是需要消耗资源的），所以python下的多线程对CPU密集型代码并不友好。 2、IO密集型代码(文件处理、网络爬虫等)，多线程能够有效提升效率(单线程下有IO操作会进行IO等待，造成不必要的时间浪费，而开启多线程能在线程A等待时，自动切换到线程B，可以不浪费CPU的资源，从而能提升程序执行效率)。所以python的多线程对IO密集型代码比较友好。 而在python3.x中，GIL不使用ticks计数，改为使用计时器（执行时间达到阈值后，当前线程释放GIL），这样对CPU密集型程序更加友好，但依然没有解决GIL导致的同一时间只能执行一个线程的问题，所以效率依然不尽如人意。</p>
                  <h3 id="多核性能"><a href="#多核性能" class="headerlink" title="多核性能"></a>多核性能</h3>
                  <p>多核多线程比单核多线程更差，原因是单核下多线程，每次释放GIL，唤醒的那个线程都能获取到GIL锁，所以能够无缝执行，但多核下，CPU0释放GIL后，其他CPU上的线程都会进行竞争，但GIL可能会马上又被CPU0拿到，导致其他几个CPU上被唤醒后的线程会醒着等待到切换时间后又进入待调度状态，这样会造成线程颠簸(thrashing)，导致效率更低</p>
                  <h3 id="多进程为什么不会这样？"><a href="#多进程为什么不会这样？" class="headerlink" title="多进程为什么不会这样？"></a>多进程为什么不会这样？</h3>
                  <p>每个进程有各自独立的GIL，互不干扰，这样就可以真正意义上的并行执行，所以在python中，多进程的执行效率优于多线程(仅仅针对多核CPU而言)。 所以在这里说结论：多核下，想做并行提升效率，比较通用的方法是使用多进程，能够有效提高执行效率。 所以，如果不想浪费时间，可以直接看多进程。</p>
                  <h2 id="直接利用函数创建多线程"><a href="#直接利用函数创建多线程" class="headerlink" title="直接利用函数创建多线程"></a>直接利用函数创建多线程</h2>
                  <p>Python中使用线程有两种方式：函数或者用类来包装线程对象。</p>
                  <p>函数式：调用thread模块中的start_new_thread()函数来产生新线程。语法如下：</p>
                  <figure class="highlight reasonml">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">thread.start<span class="constructor">_new_thread(<span class="params">function</span>, <span class="params">args</span>[, <span class="params">kwargs</span>])</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>参数说明:</p>
                  <ul>
                    <li>function - 线程函数。</li>
                    <li>args - 传递给线程函数的参数,他必须是个tuple类型。</li>
                    <li>kwargs - 可选参数。</li>
                  </ul>
                  <p>先用一个实例感受一下：</p>
                  <figure class="highlight applescript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"></span><br><span class="line">import thread</span><br><span class="line">import <span class="built_in">time</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 为线程定义一个函数</span></span><br><span class="line">def print_time(threadName, <span class="built_in">delay</span>):</span><br><span class="line">    <span class="built_in">count</span> = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">count</span> &lt; <span class="number">5</span>:</span><br><span class="line">        <span class="built_in">time</span>.sleep(<span class="built_in">delay</span>)</span><br><span class="line">        <span class="built_in">count</span> += <span class="number">1</span></span><br><span class="line">        print <span class="string">"%s: %s"</span> % (threadName, <span class="built_in">time</span>.ctime(<span class="built_in">time</span>.<span class="built_in">time</span>()))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建两个线程</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    thread.start_new_thread(print_time, (<span class="string">"Thread-1"</span>, <span class="number">2</span>,))</span><br><span class="line">    thread.start_new_thread(print_time, (<span class="string">"Thread-2"</span>, <span class="number">4</span>,))</span><br><span class="line">except:</span><br><span class="line">    print <span class="string">"Error: unable to start thread"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">   pass</span><br><span class="line"></span><br><span class="line">print <span class="string">"Main Finished"</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">Thread<span class="number">-1</span>: Thu Nov  <span class="number">3</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">01</span> <span class="number">2016</span></span><br><span class="line">Thread<span class="number">-2</span>: Thu Nov  <span class="number">3</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">03</span> <span class="number">2016</span></span><br><span class="line">Thread<span class="number">-1</span>: Thu Nov  <span class="number">3</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">03</span> <span class="number">2016</span></span><br><span class="line">Thread<span class="number">-1</span>: Thu Nov  <span class="number">3</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">05</span> <span class="number">2016</span></span><br><span class="line">Thread<span class="number">-2</span>: Thu Nov  <span class="number">3</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">07</span> <span class="number">2016</span></span><br><span class="line">Thread<span class="number">-1</span>: Thu Nov  <span class="number">3</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">07</span> <span class="number">2016</span></span><br><span class="line">Thread<span class="number">-1</span>: Thu Nov  <span class="number">3</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">09</span> <span class="number">2016</span></span><br><span class="line">Thread<span class="number">-2</span>: Thu Nov  <span class="number">3</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">11</span> <span class="number">2016</span></span><br><span class="line">Thread<span class="number">-2</span>: Thu Nov  <span class="number">3</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">15</span> <span class="number">2016</span></span><br><span class="line">Thread<span class="number">-2</span>: Thu Nov  <span class="number">3</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">19</span> <span class="number">2016</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>可以发现，两个线程都在执行，睡眠2秒和4秒后打印输出一段话。 注意到，在主线程写了</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">   pass</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这是让主线程一直在等待 如果去掉上面两行，那就直接输出</p>
                  <figure class="highlight ebnf">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="attribute">Main Finished</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>程序执行结束。</p>
                  <h2 id="使用Threading模块创建线程"><a href="#使用Threading模块创建线程" class="headerlink" title="使用Threading模块创建线程"></a>使用Threading模块创建线程</h2>
                  <p>使用Threading模块创建线程，直接从threading.Thread继承，然后重写<strong>init</strong>方法和run方法：</p>
                  <figure class="highlight ruby">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"></span><br><span class="line">import threading</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line">import thread</span><br><span class="line"></span><br><span class="line">exitFlag = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myThread</span> (<span class="title">threading</span>.<span class="title">Thread</span>):   <span class="comment">#继承父类threading.Thread</span></span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(<span class="keyword">self</span>, threadID, name, counter)</span></span><span class="symbol">:</span></span><br><span class="line">        threading.Thread.__init_<span class="number">_</span>(<span class="keyword">self</span>)</span><br><span class="line">        <span class="keyword">self</span>.threadID = threadID</span><br><span class="line">        <span class="keyword">self</span>.name = name</span><br><span class="line">        <span class="keyword">self</span>.counter = counter</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(<span class="keyword">self</span>)</span></span>:                   <span class="comment">#把要执行的代码写到run函数里面 线程在创建后会直接运行run函数</span></span><br><span class="line">        print <span class="string">"Starting "</span> + <span class="keyword">self</span>.name</span><br><span class="line">        print_time(<span class="keyword">self</span>.name, <span class="keyword">self</span>.counter, <span class="number">5</span>)</span><br><span class="line">        print <span class="string">"Exiting "</span> + <span class="keyword">self</span>.name</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_time</span><span class="params">(threadName, delay, counter)</span></span><span class="symbol">:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="symbol">counter:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="symbol">exitFlag:</span></span><br><span class="line">            thread.exit()</span><br><span class="line">        time.sleep(delay)</span><br><span class="line">        print <span class="string">"%s: %s"</span> % (threadName, time.ctime(time.time()))</span><br><span class="line">        counter -= <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建新线程</span></span><br><span class="line">thread1 = myThread(<span class="number">1</span>, <span class="string">"Thread-1"</span>, <span class="number">1</span>)</span><br><span class="line">thread2 = myThread(<span class="number">2</span>, <span class="string">"Thread-2"</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开启线程</span></span><br><span class="line">thread1.start()</span><br><span class="line">thread2.start()</span><br><span class="line"></span><br><span class="line">print <span class="string">"Exiting Main Thread"</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">Starting Thread<span class="number">-1</span>Starting Thread<span class="number">-2</span></span><br><span class="line"> </span><br><span class="line">Exiting Main Thread</span><br><span class="line">Thread<span class="number">-1</span>: Thu Nov  <span class="number">3</span> <span class="number">18</span>:<span class="number">42</span>:<span class="number">19</span> <span class="number">2016</span></span><br><span class="line">Thread<span class="number">-2</span>: Thu Nov  <span class="number">3</span> <span class="number">18</span>:<span class="number">42</span>:<span class="number">20</span> <span class="number">2016</span></span><br><span class="line">Thread<span class="number">-1</span>: Thu Nov  <span class="number">3</span> <span class="number">18</span>:<span class="number">42</span>:<span class="number">20</span> <span class="number">2016</span></span><br><span class="line">Thread<span class="number">-1</span>: Thu Nov  <span class="number">3</span> <span class="number">18</span>:<span class="number">42</span>:<span class="number">21</span> <span class="number">2016</span></span><br><span class="line">Thread<span class="number">-2</span>: Thu Nov  <span class="number">3</span> <span class="number">18</span>:<span class="number">42</span>:<span class="number">22</span> <span class="number">2016</span></span><br><span class="line">Thread<span class="number">-1</span>: Thu Nov  <span class="number">3</span> <span class="number">18</span>:<span class="number">42</span>:<span class="number">22</span> <span class="number">2016</span></span><br><span class="line">Thread<span class="number">-1</span>: Thu Nov  <span class="number">3</span> <span class="number">18</span>:<span class="number">42</span>:<span class="number">23</span> <span class="number">2016</span></span><br><span class="line">Exiting Thread<span class="number">-1</span></span><br><span class="line">Thread<span class="number">-2</span>: Thu Nov  <span class="number">3</span> <span class="number">18</span>:<span class="number">42</span>:<span class="number">24</span> <span class="number">2016</span></span><br><span class="line">Thread<span class="number">-2</span>: Thu Nov  <span class="number">3</span> <span class="number">18</span>:<span class="number">42</span>:<span class="number">26</span> <span class="number">2016</span></span><br><span class="line">Thread<span class="number">-2</span>: Thu Nov  <span class="number">3</span> <span class="number">18</span>:<span class="number">42</span>:<span class="number">28</span> <span class="number">2016</span></span><br><span class="line">Exiting Thread<span class="number">-2</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>有没有发现什么奇怪的地方？打印的输出格式好奇怪。比如第一行之后应该是一个回车的，结果第二个进程就打印出来了。 那是因为什么？因为这几个线程没有设置同步。</p>
                  <h2 id="线程同步"><a href="#线程同步" class="headerlink" title="线程同步"></a>线程同步</h2>
                  <p>如果多个线程共同对某个数据修改，则可能出现不可预料的结果，为了保证数据的正确性，需要对多个线程进行同步。 使用Thread对象的Lock和Rlock可以实现简单的线程同步，这两个对象都有acquire方法和release方法，对于那些需要每次只允许一个线程操作的数据，可以将其操作放到acquire和release方法之间。如下： 多线程的优势在于可以同时运行多个任务（至少感觉起来是这样）。但是当线程需要共享数据时，可能存在数据不同步的问题。 考虑这样一种情况：一个列表里所有元素都是0，线程”set”从后向前把所有元素改成1，而线程”print”负责从前往后读取列表并打印。 那么，可能线程”set”开始改的时候，线程”print”便来打印列表了，输出就成了一半0一半1，这就是数据的不同步。为了避免这种情况，引入了锁的概念。 锁有两种状态——锁定和未锁定。每当一个线程比如”set”要访问共享数据时，必须先获得锁定；如果已经有别的线程比如”print”获得锁定了，那么就让线程”set”暂停，也就是同步阻塞；等到线程”print”访问完毕，释放锁以后，再让线程”set”继续。 经过这样的处理，打印列表时要么全部输出0，要么全部输出1，不会再出现一半0一半1的尴尬场面。 看下面的例子：</p>
                  <figure class="highlight ruby">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"></span><br><span class="line">import threading</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myThread</span> (<span class="title">threading</span>.<span class="title">Thread</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(<span class="keyword">self</span>, threadID, name, counter)</span></span><span class="symbol">:</span></span><br><span class="line">        threading.Thread.__init_<span class="number">_</span>(<span class="keyword">self</span>)</span><br><span class="line">        <span class="keyword">self</span>.threadID = threadID</span><br><span class="line">        <span class="keyword">self</span>.name = name</span><br><span class="line">        <span class="keyword">self</span>.counter = counter</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        print <span class="string">"Starting "</span> + <span class="keyword">self</span>.name</span><br><span class="line">       <span class="comment"># 获得锁，成功获得锁定后返回True</span></span><br><span class="line">       <span class="comment"># 可选的timeout参数不填时将一直阻塞直到获得锁定</span></span><br><span class="line">       <span class="comment"># 否则超时后将返回False</span></span><br><span class="line">        threadLock.acquire()</span><br><span class="line">        print_time(<span class="keyword">self</span>.name, <span class="keyword">self</span>.counter, <span class="number">3</span>)</span><br><span class="line">        <span class="comment"># 释放锁</span></span><br><span class="line">        threadLock.release()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_time</span><span class="params">(threadName, delay, counter)</span></span><span class="symbol">:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="symbol">counter:</span></span><br><span class="line">        time.sleep(delay)</span><br><span class="line">        print <span class="string">"%s: %s"</span> % (threadName, time.ctime(time.time()))</span><br><span class="line">        counter -= <span class="number">1</span></span><br><span class="line"></span><br><span class="line">threadLock = threading.Lock()</span><br><span class="line">threads = []</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建新线程</span></span><br><span class="line">thread1 = myThread(<span class="number">1</span>, <span class="string">"Thread-1"</span>, <span class="number">1</span>)</span><br><span class="line">thread2 = myThread(<span class="number">2</span>, <span class="string">"Thread-2"</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开启新线程</span></span><br><span class="line">thread1.start()</span><br><span class="line">thread2.start()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加线程到线程列表</span></span><br><span class="line">threads.append(thread1)</span><br><span class="line">threads.append(thread2)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 等待所有线程完成</span></span><br><span class="line"><span class="keyword">for</span> t <span class="keyword">in</span> <span class="symbol">threads:</span></span><br><span class="line">    t.join()</span><br><span class="line"></span><br><span class="line">print <span class="string">"Exiting Main Thread"</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>在上面的代码中运用了线程锁还有join等待。 运行结果如下：</p>
                  <figure class="highlight angelscript">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">Starting Thread<span class="number">-1</span></span><br><span class="line">Starting Thread<span class="number">-2</span></span><br><span class="line">Thread<span class="number">-1</span>: Thu Nov  <span class="number">3</span> <span class="number">18</span>:<span class="number">56</span>:<span class="number">49</span> <span class="number">2016</span></span><br><span class="line">Thread<span class="number">-1</span>: Thu Nov  <span class="number">3</span> <span class="number">18</span>:<span class="number">56</span>:<span class="number">50</span> <span class="number">2016</span></span><br><span class="line">Thread<span class="number">-1</span>: Thu Nov  <span class="number">3</span> <span class="number">18</span>:<span class="number">56</span>:<span class="number">51</span> <span class="number">2016</span></span><br><span class="line">Thread<span class="number">-2</span>: Thu Nov  <span class="number">3</span> <span class="number">18</span>:<span class="number">56</span>:<span class="number">53</span> <span class="number">2016</span></span><br><span class="line">Thread<span class="number">-2</span>: Thu Nov  <span class="number">3</span> <span class="number">18</span>:<span class="number">56</span>:<span class="number">55</span> <span class="number">2016</span></span><br><span class="line">Thread<span class="number">-2</span>: Thu Nov  <span class="number">3</span> <span class="number">18</span>:<span class="number">56</span>:<span class="number">57</span> <span class="number">2016</span></span><br><span class="line">Exiting Main Thread</span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>这样一来，你可以发现就不会出现刚才的输出混乱的结果了。</p>
                  <h2 id="线程优先级队列"><a href="#线程优先级队列" class="headerlink" title="线程优先级队列"></a>线程优先级队列</h2>
                  <p>Python的Queue模块中提供了同步的、线程安全的队列类，包括FIFO（先入先出)队列Queue，LIFO（后入先出）队列LifoQueue，和优先级队列PriorityQueue。这些队列都实现了锁原语，能够在多线程中直接使用。可以使用队列来实现线程间的同步。</p>
                  <p>Queue模块中的常用方法:</p>
                  <ul>
                    <li>Queue.qsize() 返回队列的大小</li>
                    <li>Queue.empty() 如果队列为空，返回True,反之False</li>
                    <li>Queue.full() 如果队列满了，返回True,反之False</li>
                    <li>Queue.full 与 maxsize 大小对应</li>
                    <li>Queue.get([block[, timeout]])获取队列，timeout等待时间</li>
                    <li>Queue.get_nowait() 相当Queue.get(False)</li>
                    <li>Queue.put(item) 写入队列，timeout等待时间</li>
                    <li>Queue.put_nowait(item) 相当Queue.put(item, False)</li>
                    <li>Queue.task_done() 在完成一项工作之后，Queue.task_done()函数向任务已经完成的队列发送一个信号</li>
                    <li>Queue.join() 实际上意味着等到队列为空，再执行别的操作</li>
                  </ul>
                  <p>用一个实例感受一下：</p>
                  <figure class="highlight routeros">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"></span><br><span class="line">import Queue</span><br><span class="line">import threading</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line">exitFlag = 0</span><br><span class="line"></span><br><span class="line">class myThread (threading.Thread):</span><br><span class="line">    def __init__(self, threadID, name, q):</span><br><span class="line">        threading.Thread.__init__(self)</span><br><span class="line">        self.threadID = threadID</span><br><span class="line">        self.name = name</span><br><span class="line">        self.q = q</span><br><span class="line">    def <span class="builtin-name">run</span>(self):</span><br><span class="line">        <span class="builtin-name">print</span> <span class="string">"Starting "</span> + self.name</span><br><span class="line">        process_data(self.name, self.q)</span><br><span class="line">        <span class="builtin-name">print</span> <span class="string">"Exiting "</span> + self.name</span><br><span class="line"></span><br><span class="line">def process_data(threadName, q):</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> exitFlag:</span><br><span class="line">        queueLock.acquire()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> workQueue.empty():</span><br><span class="line">            data = q.<span class="builtin-name">get</span>()</span><br><span class="line">            queueLock.release()</span><br><span class="line">            <span class="builtin-name">print</span> <span class="string">"%s processing %s"</span> % (threadName, data)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            queueLock.release()</span><br><span class="line">        time.sleep(1)</span><br><span class="line"></span><br><span class="line">threadList = [<span class="string">"Thread-1"</span>, <span class="string">"Thread-2"</span>, <span class="string">"Thread-3"</span>]</span><br><span class="line">nameList = [<span class="string">"One"</span>, <span class="string">"Two"</span>, <span class="string">"Three"</span>, <span class="string">"Four"</span>, <span class="string">"Five"</span>]</span><br><span class="line">queueLock = threading.Lock()</span><br><span class="line">workQueue = Queue.Queue(10)</span><br><span class="line">threads = []</span><br><span class="line">threadID = 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建新线程</span></span><br><span class="line"><span class="keyword">for</span> tName <span class="keyword">in</span> threadList:</span><br><span class="line">    thread = myThread(threadID, tName, workQueue)</span><br><span class="line">    thread.start()</span><br><span class="line">    threads.append(thread)</span><br><span class="line">    threadID += 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 填充队列</span></span><br><span class="line">queueLock.acquire()</span><br><span class="line"><span class="keyword">for</span> word <span class="keyword">in</span> nameList:</span><br><span class="line">    workQueue.put(word)</span><br><span class="line">queueLock.release()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 等待队列清空</span></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">not</span> workQueue.empty():</span><br><span class="line">    pass</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通知线程是时候退出</span></span><br><span class="line">exitFlag = 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 等待所有线程完成</span></span><br><span class="line"><span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">    t.join()</span><br><span class="line"><span class="builtin-name">print</span> <span class="string">"Exiting Main Thread"</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>运行结果：</p>
                  <figure class="highlight autohotkey">
                    <table>
                      <tr>
                        <td class="gutter">
                          <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre>
                        </td>
                        <td class="code">
                          <pre><span class="line">Starting <span class="keyword">Thread</span>-<span class="number">1</span></span><br><span class="line">Starting <span class="keyword">Thread</span>-<span class="number">2</span></span><br><span class="line">Starting <span class="keyword">Thread</span>-<span class="number">3</span></span><br><span class="line"><span class="keyword">Thread</span>-<span class="number">3</span> processing One</span><br><span class="line"><span class="keyword">Thread</span>-<span class="number">1</span> processing Two</span><br><span class="line"><span class="keyword">Thread</span>-<span class="number">2</span> processing Three</span><br><span class="line"><span class="keyword">Thread</span>-<span class="number">3</span> processing Four</span><br><span class="line"><span class="keyword">Thread</span>-<span class="number">2</span> processing Five</span><br><span class="line">Exiting <span class="keyword">Thread</span>-<span class="number">2</span></span><br><span class="line">Exiting <span class="keyword">Thread</span>-<span class="number">3</span></span><br><span class="line">Exiting <span class="keyword">Thread</span>-<span class="number">1</span></span><br><span class="line">Exiting Main <span class="keyword">Thread</span></span><br></pre>
                        </td>
                      </tr>
                    </table>
                  </figure>
                  <p>上面的例子用了FIFO队列。当然你也可以换成其他类型的队列。</p>
                  <h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2>
                  <ol>
                    <li>
                      <p><a href="http://bbs.51cto.com/thread-1349105-1.html" target="_blank" rel="noopener">http://bbs.51cto.com/thread-1349105-1.html</a></p>
                    </li>
                    <li>
                      <p><a href="http://www.runoob.com/python/python-multithreading.html" target="_blank" rel="noopener">http://www.runoob.com/python/python-multithreading.html</a></p>
                    </li>
                  </ol>
                  </p>
                </div>
              </div>
              <div class="post-meta">
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-user"></i>
                  </span>
                  <span class="post-meta-item-text">作者</span>
                  <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                </span>
                <span class="post-meta-item">
                  <span class="post-meta-item-icon">
                    <i class="far fa-calendar"></i>
                  </span>
                  <span class="post-meta-item-text">发表于</span>
                  <time title="创建时间：2016-11-03 19:34:26" itemprop="dateCreated datePublished" datetime="2016-11-03T19:34:26+08:00">2016-11-03</time>
                </span>
                <span id="/3325.html" class="post-meta-item leancloud_visitors" data-flag-title="Python爬虫进阶五之多线程的用法" title="阅读次数">
                  <span class="post-meta-item-icon">
                    <i class="fa fa-eye"></i>
                  </span>
                  <span class="post-meta-item-text">阅读次数：</span>
                  <span class="leancloud-visitors-count"></span>
                </span>
                <span class="post-meta-item" title="本文字数">
                  <span class="post-meta-item-icon">
                    <i class="far fa-file-word"></i>
                  </span>
                  <span class="post-meta-item-text">本文字数：</span>
                  <span>7.9k</span>
                </span>
                <span class="post-meta-item" title="阅读时长">
                  <span class="post-meta-item-icon">
                    <i class="far fa-clock"></i>
                  </span>
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                  <span>7 分钟</span>
                </span>
              </div>
            </article>
            <script>
              document.querySelectorAll('.random').forEach(item => item.src = "https://picsum.photos/id/" + Math.floor(Math.random() * Math.floor(300)) + "/200/133")

            </script>
            <nav class="pagination">
              <a class="extend prev" rel="prev" href="/page/12/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><span class="page-number current">13</span><a class="page-number" href="/page/14/">14</a><span class="space">&hellip;</span><a class="page-number" href="/page/18/">18</a><a class="extend next" rel="next" href="/page/14/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
            </nav>
          </div>
          <script>
            window.addEventListener('tabs:register', () =>
            {
              let
              {
                activeClass
              } = CONFIG.comments;
              if (CONFIG.comments.storage)
              {
                activeClass = localStorage.getItem('comments_active') || activeClass;
              }
              if (activeClass)
              {
                let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
                if (activeTab)
                {
                  activeTab.click();
                }
              }
            });
            if (CONFIG.comments.storage)
            {
              window.addEventListener('tabs:click', event =>
              {
                if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
                let commentClass = event.target.classList[1];
                localStorage.setItem('comments_active', commentClass);
              });
            }

          </script>
        </div>
        <div class="toggle sidebar-toggle">
          <span class="toggle-line toggle-line-first"></span>
          <span class="toggle-line toggle-line-middle"></span>
          <span class="toggle-line toggle-line-last"></span>
        </div>
        <aside class="sidebar">
          <div class="sidebar-inner">
            <ul class="sidebar-nav motion-element">
              <li class="sidebar-nav-toc"> 文章目录 </li>
              <li class="sidebar-nav-overview"> 站点概览 </li>
            </ul>
            <!--noindex-->
            <div class="post-toc-wrap sidebar-panel">
            </div>
            <!--/noindex-->
            <div class="site-overview-wrap sidebar-panel">
              <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
                <img class="site-author-image" itemprop="image" alt="崔庆才" src="/images/avatar.png">
                <p class="site-author-name" itemprop="name">崔庆才</p>
                <div class="site-description" itemprop="description">静觅丨崔庆才的个人站点专业为您提供爬虫教程,爬虫,Python,Python爬虫,Python爬虫教程,爬虫书的相关信息，想要了解更多详情，请联系我们。</div>
              </div>
              <div class="site-state-wrap motion-element">
                <nav class="site-state">
                  <div class="site-state-item site-state-posts">
                    <a href="/archives/">
                      <span class="site-state-item-count">685</span>
                      <span class="site-state-item-name">日志</span>
                    </a>
                  </div>
                  <div class="site-state-item site-state-categories">
                    <a href="/categories/">
                      <span class="site-state-item-count">32</span>
                      <span class="site-state-item-name">分类</span></a>
                  </div>
                  <div class="site-state-item site-state-tags">
                    <a href="/tags/">
                      <span class="site-state-item-count">246</span>
                      <span class="site-state-item-name">标签</span></a>
                  </div>
                </nav>
              </div>
              <div class="links-of-author motion-element">
                <span class="links-of-author-item">
                  <a href="https://github.com/Germey" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Germey" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
                </span>
                <span class="links-of-author-item">
                  <a href="mailto:cqc@cuiqingcai.com.com" title="邮件 → mailto:cqc@cuiqingcai.com.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>邮件</a>
                </span>
                <span class="links-of-author-item">
                  <a href="https://weibo.com/cuiqingcai" title="微博 → https:&#x2F;&#x2F;weibo.com&#x2F;cuiqingcai" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>微博</a>
                </span>
                <span class="links-of-author-item">
                  <a href="https://www.zhihu.com/people/Germey" title="知乎 → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;Germey" rel="noopener" target="_blank"><i class="fa fa-magic fa-fw"></i>知乎</a>
                </span>
              </div>
            </div>
            <div style=" width: 100%;" class="sidebar-panel sidebar-panel-image sidebar-panel-active">
              <a href="https://item.jd.com/13527222.html" target="_blank" rel="noopener">
                <img src="https://cdn.cuiqingcai.com/ei5og.jpg" style=" width: 100%;">
              </a>
            </div>
            <div class="sidebar-panel sidebar-panel-categories sidebar-panel-active">
              <h4 class="name"> 分类 </h4>
              <div class="content">
                <ul class="category-list">
                  <li class="category-list-item"><a class="category-list-link" href="/categories/API/">API</a><span class="category-list-count">5</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/C-C/">C/C++</a><span class="category-list-count">23</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/HTML/">HTML</a><span class="category-list-count">14</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">5</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/JavaScript/">JavaScript</a><span class="category-list-count">26</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">14</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/Luma/">Luma</a><span class="category-list-count">1</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/Markdown/">Markdown</a><span class="category-list-count">2</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/Net/">Net</a><span class="category-list-count">4</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/Nexior/">Nexior</a><span class="category-list-count">1</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/Other/">Other</a><span class="category-list-count">40</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/PHP/">PHP</a><span class="category-list-count">27</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/Paper/">Paper</a><span class="category-list-count">2</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">303</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/TypeScript/">TypeScript</a><span class="category-list-count">2</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B8%AA%E4%BA%BA%E5%B1%95%E7%A4%BA/">个人展示</a><span class="category-list-count">1</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B8%AA%E4%BA%BA%E6%97%A5%E8%AE%B0/">个人日记</a><span class="category-list-count">9</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B8%AA%E4%BA%BA%E8%AE%B0%E5%BD%95/">个人记录</a><span class="category-list-count">6</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B8%AA%E4%BA%BA%E9%9A%8F%E7%AC%94/">个人随笔</a><span class="category-list-count">21</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/">人工智能</a><span class="category-list-count">5</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE/">安装配置</a><span class="category-list-count">59</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E6%8A%80%E6%9C%AF%E6%9D%82%E8%B0%88/">技术杂谈</a><span class="category-list-count">96</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9C%AA%E5%88%86%E7%B1%BB/">未分类</a><span class="category-list-count">1</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/">深度学习</a><span class="category-list-count">1</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E7%88%AC%E8%99%AB/">爬虫</a><span class="category-list-count">4</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E7%94%9F%E6%B4%BB%E7%AC%94%E8%AE%B0/">生活笔记</a><span class="category-list-count">1</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E7%A6%8F%E5%88%A9%E4%B8%93%E5%8C%BA/">福利专区</a><span class="category-list-count">6</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E8%81%8C%E4%BD%8D%E6%8E%A8%E8%8D%90/">职位推荐</a><span class="category-list-count">1</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E8%89%BA%E6%9C%AF%E4%BA%8C%E7%BB%B4%E7%A0%81/">艺术二维码</a><span class="category-list-count">1</span></li>
                </ul>
              </div>
            </div>
            <div class="sidebar-panel sidebar-panel-friends sidebar-panel-active">
              <h4 class="name"> 友情链接 </h4>
              <ul class="friends">
                <li class="friend">
                  <span class="logo">
                    <img src="https://cdn.cuiqingcai.com/j2dub.jpg">
                  </span>
                  <span class="link">
                    <a href="https://www.findhao.net/" target="_blank" rel="noopener">FindHao</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://cdn.cuiqingcai.com/6apxu.jpg">
                  </span>
                  <span class="link">
                    <a href="https://www.51dev.com/" target="_blank" rel="noopener">IT技术社区</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://cdn.cuiqingcai.com/bqlbs.png">
                  </span>
                  <span class="link">
                    <a href="http://www.urselect.com/" target="_blank" rel="noopener">优社电商</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://cdn.cuiqingcai.com/8s88c.jpg">
                  </span>
                  <span class="link">
                    <a href="https://www.yuanrenxue.com/" target="_blank" rel="noopener">猿人学</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://cdn.cuiqingcai.com/2wgg5.jpg">
                  </span>
                  <span class="link">
                    <a href="https://www.yunlifang.cn/" target="_blank" rel="noopener">云立方</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="http://qianxunclub.com/favicon.png">
                  </span>
                  <span class="link">
                    <a href="http://qianxunclub.com/" target="_blank" rel="noopener">千寻啊千寻</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://cdn.cuiqingcai.com/0044u.jpg">
                  </span>
                  <span class="link">
                    <a href="http://kodcloud.com/" target="_blank" rel="noopener">可道云</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://cdn.cuiqingcai.com/ygnpn.jpg">
                  </span>
                  <span class="link">
                    <a href="http://www.kunkundashen.cn/" target="_blank" rel="noopener">坤坤大神</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://cdn.cuiqingcai.com/x714o.jpg">
                  </span>
                  <span class="link">
                    <a href="http://www.hubwiz.com/" target="_blank" rel="noopener">汇智网</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://cdn.cuiqingcai.com/44hxf.png">
                  </span>
                  <span class="link">
                    <a href="http://redstonewill.com/" target="_blank" rel="noopener">红色石头</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://cdn.cuiqingcai.com/wkaus.jpg">
                  </span>
                  <span class="link">
                    <a href="https://zhaoshuai.me/" target="_blank" rel="noopener">碎念</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://cdn.cuiqingcai.com/pgo0r.jpg">
                  </span>
                  <span class="link">
                    <a href="https://www.chenwenguan.com/" target="_blank" rel="noopener">陈文管的博客</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://cdn.cuiqingcai.com/kk82a.jpg">
                  </span>
                  <span class="link">
                    <a href="https://www.lxlinux.net/" target="_blank" rel="noopener">良许Linux教程网</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://cdn.cuiqingcai.com/lj0t2.jpg">
                  </span>
                  <span class="link">
                    <a href="https://tanqingbo.cn/" target="_blank" rel="noopener">IT码农</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://cdn.cuiqingcai.com/i8cdr.png">
                  </span>
                  <span class="link">
                    <a href="https://junyiseo.com/" target="_blank" rel="noopener">均益个人博客</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://cdn.cuiqingcai.com/chwv2.png">
                  </span>
                  <span class="link">
                    <a href="https://brucedone.com/" target="_blank" rel="noopener">大鱼的鱼塘</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://www.91vps.com/favicon.ico">
                  </span>
                  <span class="link">
                    <a href="http://www.91vps.com/" target="_blank" rel="noopener">91VPS</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://webpage.qidian.qq.com/qidian/chatv3-gray/favicon.ico">
                  </span>
                  <span class="link">
                    <a href="https://www.qg.net/" target="_blank" rel="noopener">青果网络</a>
                  </span>
                </li>
              </ul>
            </div>
            <div class="sidebar-panel sidebar-panel-tags sidebar-panel-active">
              <h4 class="name"> 标签云 </h4>
              <div class="content">
                <a href="/tags/2022/" style="font-size: 20px;">2022</a> <a href="/tags/2048/" style="font-size: 10px;">2048</a> <a href="/tags/ADSL/" style="font-size: 10px;">ADSL</a> <a href="/tags/API/" style="font-size: 16px;">API</a> <a href="/tags/Ajax/" style="font-size: 12px;">Ajax</a> <a href="/tags/Bootstrap/" style="font-size: 11px;">Bootstrap</a> <a href="/tags/Bug/" style="font-size: 10px;">Bug</a> <a href="/tags/CDN/" style="font-size: 10px;">CDN</a> <a href="/tags/CQC/" style="font-size: 10px;">CQC</a> <a href="/tags/CSS/" style="font-size: 10px;">CSS</a> <a href="/tags/CSS-%E5%8F%8D%E7%88%AC%E8%99%AB/" style="font-size: 10px;">CSS 反爬虫</a> <a href="/tags/CV/" style="font-size: 10px;">CV</a> <a href="/tags/ChatGPT/" style="font-size: 10px;">ChatGPT</a> <a href="/tags/Cookie/" style="font-size: 10px;">Cookie</a> <a href="/tags/Django/" style="font-size: 10px;">Django</a> <a href="/tags/Eclipse/" style="font-size: 11px;">Eclipse</a> <a href="/tags/Elasticsearch/" style="font-size: 10px;">Elasticsearch</a> <a href="/tags/FTP/" style="font-size: 10px;">FTP</a> <a href="/tags/Flux/" style="font-size: 10px;">Flux</a> <a href="/tags/Git/" style="font-size: 10px;">Git</a> <a href="/tags/GitHub/" style="font-size: 13px;">GitHub</a> <a href="/tags/HTML5/" style="font-size: 10px;">HTML5</a> <a href="/tags/HTTP/" style="font-size: 10px;">HTTP</a> <a href="/tags/Hailuo/" style="font-size: 10px;">Hailuo</a> <a href="/tags/Hexo/" style="font-size: 10px;">Hexo</a> <a href="/tags/Hook/" style="font-size: 10px;">Hook</a> <a href="/tags/IP/" style="font-size: 10px;">IP</a> <a href="/tags/IT/" style="font-size: 10px;">IT</a> <a href="/tags/JSON/" style="font-size: 10px;">JSON</a> <a href="/tags/JSP/" style="font-size: 10px;">JSP</a> <a href="/tags/JavaScript/" style="font-size: 14px;">JavaScript</a> <a href="/tags/K8s/" style="font-size: 10px;">K8s</a> <a href="/tags/LOGO/" style="font-size: 10px;">LOGO</a> <a href="/tags/Linux/" style="font-size: 10px;">Linux</a> <a href="/tags/Luma/" style="font-size: 10px;">Luma</a> <a href="/tags/MIUI/" style="font-size: 10px;">MIUI</a> <a href="/tags/Markdown/" style="font-size: 10px;">Markdown</a> <a href="/tags/Midjourney/" style="font-size: 11px;">Midjourney</a> <a href="/tags/MongoDB/" style="font-size: 11px;">MongoDB</a> <a href="/tags/MySQL/" style="font-size: 10px;">MySQL</a> <a href="/tags/Mysql/" style="font-size: 10px;">Mysql</a> <a href="/tags/NBA/" style="font-size: 10px;">NBA</a> <a href="/tags/Nexior/" style="font-size: 10px;">Nexior</a> <a href="/tags/OCR/" style="font-size: 10px;">OCR</a> <a href="/tags/OpenCV/" style="font-size: 10px;">OpenCV</a> <a href="/tags/PHP/" style="font-size: 11px;">PHP</a> <a href="/tags/PPT/" style="font-size: 10px;">PPT</a> <a href="/tags/PS/" style="font-size: 10px;">PS</a> <a href="/tags/Pathlib/" style="font-size: 10px;">Pathlib</a> <a href="/tags/PhantomJS/" style="font-size: 10px;">PhantomJS</a> <a href="/tags/Playwright/" style="font-size: 10px;">Playwright</a> <a href="/tags/Python/" style="font-size: 17px;">Python</a> <a href="/tags/Python-%E7%88%AC%E8%99%AB/" style="font-size: 18px;">Python 爬虫</a> <a href="/tags/Python3/" style="font-size: 11px;">Python3</a> <a href="/tags/Python3%E7%88%AC%E8%99%AB%E6%95%99%E7%A8%8B/" style="font-size: 12px;">Python3爬虫教程</a> <a href="/tags/Pythonic/" style="font-size: 10px;">Pythonic</a> <a href="/tags/Python%E7%88%AC%E8%99%AB/" style="font-size: 19px;">Python爬虫</a> <a href="/tags/Python%E7%88%AC%E8%99%AB%E4%B9%A6/" style="font-size: 12px;">Python爬虫书</a> <a href="/tags/Python%E7%88%AC%E8%99%AB%E6%95%99%E7%A8%8B/" style="font-size: 15px;">Python爬虫教程</a> <a href="/tags/QQ/" style="font-size: 10px;">QQ</a> <a href="/tags/RabbitMQ/" style="font-size: 10px;">RabbitMQ</a> <a href="/tags/ReCAPTCHA/" style="font-size: 10px;">ReCAPTCHA</a> <a href="/tags/Redis/" style="font-size: 10px;">Redis</a> <a href="/tags/Riffusion/" style="font-size: 10px;">Riffusion</a> <a href="/tags/SAE/" style="font-size: 10px;">SAE</a> <a href="/tags/SSH/" style="font-size: 10px;">SSH</a> <a href="/tags/SVG/" style="font-size: 10px;">SVG</a> <a href="/tags/Scrapy-redis/" style="font-size: 10px;">Scrapy-redis</a> <a href="/tags/Scrapy%E5%88%86%E5%B8%83%E5%BC%8F/" style="font-size: 10px;">Scrapy分布式</a> <a href="/tags/Selenium/" style="font-size: 11px;">Selenium</a> <a href="/tags/Session/" style="font-size: 10px;">Session</a> <a href="/tags/Shell/" style="font-size: 10px;">Shell</a> <a href="/tags/Suno/" style="font-size: 10px;">Suno</a> <a href="/tags/TKE/" style="font-size: 10px;">TKE</a> <a href="/tags/TXT/" style="font-size: 10px;">TXT</a> <a href="/tags/Terminal/" style="font-size: 10px;">Terminal</a> <a href="/tags/Ubuntu/" style="font-size: 11px;">Ubuntu</a> <a href="/tags/VS-Code/" style="font-size: 10px;">VS Code</a> <a href="/tags/Veo/" style="font-size: 10px;">Veo</a> <a href="/tags/Vercel/" style="font-size: 10px;">Vercel</a> <a href="/tags/Vs-Code/" style="font-size: 10px;">Vs Code</a> <a href="/tags/Vue/" style="font-size: 11px;">Vue</a> <a href="/tags/Web/" style="font-size: 10px;">Web</a> <a href="/tags/Webpack/" style="font-size: 10px;">Webpack</a> <a href="/tags/Web%E7%BD%91%E9%A1%B5/" style="font-size: 10px;">Web网页</a> <a href="/tags/Windows/" style="font-size: 10px;">Windows</a> <a href="/tags/Winpcap/" style="font-size: 10px;">Winpcap</a> <a href="/tags/WordPress/" style="font-size: 13px;">WordPress</a> <a href="/tags/XPath/" style="font-size: 12px;">XPath</a> <a href="/tags/Youtube/" style="font-size: 11px;">Youtube</a> <a href="/tags/acedata/" style="font-size: 12px;">acedata</a> <a href="/tags/aiohttp/" style="font-size: 10px;">aiohttp</a> <a href="/tags/android/" style="font-size: 10px;">android</a> <a href="/tags/ansible/" style="font-size: 10px;">ansible</a> <a href="/tags/api/" style="font-size: 13px;">api</a> <a href="/tags/chatgpt/" style="font-size: 10px;">chatgpt</a> <a href="/tags/cocos2d-x/" style="font-size: 10px;">cocos2d-x</a> <a href="/tags/dummy-change/" style="font-size: 10px;">dummy change</a> <a href="/tags/e6/" style="font-size: 10px;">e6</a> <a href="/tags/fitvids/" style="font-size: 10px;">fitvids</a>
              </div>
              <script>
                const tagsColors = ['#00a67c', '#5cb85c', '#d9534f', '#567e95', '#b37333', '#f4843d', '#15a287']
                const tagsElements = document.querySelectorAll('.sidebar-panel-tags .content a')
                tagsElements.forEach((item) =>
                {
                  item.style.backgroundColor = tagsColors[Math.floor(Math.random() * tagsColors.length)]
                })

              </script>
            </div>
          </div>
        </aside>
        <div id="sidebar-dimmer"></div>
      </div>
    </main>
    <footer class="footer">
      <div class="footer-inner">
        <div class="copyright">
          <span class="author" itemprop="copyrightHolder">崔庆才丨静觅</span> &copy; <span itemprop="copyrightYear">2025</span>
          <span class="with-love">
            <i class="fa fa-heart"></i>
          </span>
          <a href="https://cuiqingcai.com/sitemap.xml" style="display:none" title="爬虫教程" target="_blank"><strong>爬虫教程</strong></a>
          <a href="https://cuiqingcai.com/sitemap.html" style="display:none" title="爬虫教程" target="_blank"><strong>爬虫教程</strong></a>
          <span class="post-meta-divider">|</span>
          <span class="post-meta-item-icon">
            <i class="fa fa-chart-area"></i>
          </span>
          <span title="站点总字数">3.3m</span>
          <span class="post-meta-divider">|</span>
          <span class="post-meta-item-icon">
            <i class="fa fa-coffee"></i>
          </span>
          <span title="站点阅读时长">49:35</span>
        </div>
        <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动 </div>
        <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">京ICP备18015597号-1 </a>
        </div>
        <script>
          (function ()
          {
            function leancloudSelector(url)
            {
              url = encodeURI(url);
              return document.getElementById(url).querySelector('.leancloud-visitors-count');
            }

            function addCount(Counter)
            {
              var visitors = document.querySelector('.leancloud_visitors');
              var url = decodeURI(visitors.id);
              var title = visitors.dataset.flagTitle;
              Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify(
              {
                url
              }))).then(response => response.json()).then((
              {
                results
              }) =>
              {
                if (results.length > 0)
                {
                  var counter = results[0];
                  leancloudSelector(url).innerText = counter.time + 1;
                  Counter('put', '/classes/Counter/' + counter.objectId,
                  {
                    time:
                    {
                      '__op': 'Increment',
                      'amount': 1
                    }
                  }).catch(error =>
                  {
                    console.error('Failed to save visitor count', error);
                  });
                }
                else
                {
                  Counter('post', '/classes/Counter',
                  {
                    title,
                    url,
                    time: 1
                  }).then(response => response.json()).then(() =>
                  {
                    leancloudSelector(url).innerText = 1;
                  }).catch(error =>
                  {
                    console.error('Failed to create', error);
                  });
                }
              }).catch(error =>
              {
                console.error('LeanCloud Counter Error', error);
              });
            }

            function showTime(Counter)
            {
              var visitors = document.querySelectorAll('.leancloud_visitors');
              var entries = [...visitors].map(element =>
              {
                return decodeURI(element.id);
              });
              Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify(
              {
                url:
                {
                  '$in': entries
                }
              }))).then(response => response.json()).then((
              {
                results
              }) =>
              {
                for (let url of entries)
                {
                  let target = results.find(item => item.url === url);
                  leancloudSelector(url).innerText = target ? target.time : 0;
                }
              }).catch(error =>
              {
                console.error('LeanCloud Counter Error', error);
              });
            }
            let
            {
              app_id,
              app_key,
              server_url
            } = {
              "enable": true,
              "app_id": "6X5dRQ0pnPWJgYy8SXOg0uID-gzGzoHsz",
              "app_key": "ziLDVEy73ne5HtFTiGstzHMS",
              "server_url": "https://6x5drq0p.lc-cn-n1-shared.com",
              "security": false
            };

            function fetchData(api_server)
            {
              var Counter = (method, url, data) =>
              {
                return fetch(`${api_server}/1.1${url}`,
                {
                  method,
                  headers:
                  {
                    'X-LC-Id': app_id,
                    'X-LC-Key': app_key,
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify(data)
                });
              };
              if (CONFIG.page.isPost)
              {
                if (CONFIG.hostname !== location.hostname) return;
                addCount(Counter);
              }
              else if (document.querySelectorAll('.post-title-link').length >= 1)
              {
                showTime(Counter);
              }
            }
            let api_server = app_id.slice(-9) !== '-MdYXbMMI' ? server_url : `https://${app_id.slice(0, 8).toLowerCase()}.api.lncldglobal.com`;
            if (api_server)
            {
              fetchData(api_server);
            }
            else
            {
              fetch('https://app-router.leancloud.cn/2/route?appId=' + app_id).then(response => response.json()).then((
              {
                api_server
              }) =>
              {
                fetchData('https://' + api_server);
              });
            }
          })();

        </script>
      </div>
      <div class="footer-stat">
        <span id="cnzz_stat_icon_1279355174"></span>
        <script type="text/javascript">
          document.write(unescape("%3Cspan id='cnzz_stat_icon_1279355174'%3E%3C/span%3E%3Cscript src='https://v1.cnzz.com/z_stat.php%3Fid%3D1279355174%26online%3D1%26show%3Dline' type='text/javascript'%3E%3C/script%3E"));

        </script>
      </div>
    </footer>
  </div>
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/pangu@4/dist/browser/pangu.min.js"></script>
  <script src="/js/utils.js"></script>
  <script src="/.js"></script>
  <script src="/js/schemes/pisces.js"></script>
  <script src="/.js"></script>
  <script src="/js/next-boot.js"></script>
  <script src="/.js"></script>
  <script>
    (function ()
    {
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x = document.getElementsByTagName("link");
      //Find the last canonical URL
      if (x.length > 0)
      {
        for (i = 0; i < x.length; i++)
        {
          if (x[i].rel.toLowerCase() == 'canonical' && x[i].href)
          {
            canonicalURL = x[i].href;
          }
        }
      }
      //Get protocol
      if (!canonicalURL)
      {
        curProtocol = window.location.protocol.split(':')[0];
      }
      else
      {
        curProtocol = canonicalURL.split(':')[0];
      }
      //Get current URL if the canonical URL does not exist
      if (!canonicalURL) canonicalURL = window.location.href;
      //Assign script content. Replace current URL with the canonical URL
      ! function ()
      {
        var e = /([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,
          r = canonicalURL,
          t = document.referrer;
        if (!e.test(r))
        {
          var n = (String(curProtocol).toLowerCase() === 'https') ? "https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif" : "//api.share.baidu.com/s.gif";
          t ? (n += "?r=" + encodeURIComponent(document.referrer), r && (n += "&l=" + r)) : r && (n += "?l=" + r);
          var i = new Image;
          i.src = n
        }
      }(window);
    })();

  </script>
  <script src="/js/local-search.js"></script>
  <script src="/.js"></script>
</body>

</html>
