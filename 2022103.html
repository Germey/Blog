<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
  <meta name="theme-color" content="#222">
  <meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#222">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>
  <script id="hexo-configurations">
    var NexT = window.NexT ||
    {};
    var CONFIG = {
      "hostname": "cuiqingcai.com",
      "root": "/",
      "scheme": "Pisces",
      "version": "7.8.0",
      "exturl": false,
      "sidebar":
      {
        "position": "right",
        "width": 360,
        "display": "post",
        "padding": 18,
        "offset": 12,
        "onmobile": false,
        "widgets": [
          {
            "type": "image",
            "name": "阿布云",
            "enable": false,
            "url": "https://www.abuyun.com/http-proxy/introduce.html",
            "src": "https://cdn.cuiqingcai.com/88au8.jpg",
            "width": "100%"
      },
          {
            "type": "image",
            "name": "爬虫书",
            "url": "https://item.jd.com/13527222.html",
            "src": "https://cdn.cuiqingcai.com/ei5og.jpg",
            "width": "100%",
            "enable": true
      },
          {
            "type": "categories",
            "name": "分类",
            "enable": true
      },
          {
            "type": "image",
            "name": "IPIDEA",
            "url": "http://www.ipidea.net/?utm-source=cqc&utm-keyword=?cqc",
            "src": "https://cdn.cuiqingcai.com/0ywun.png",
            "width": "100%",
            "enable": false
      },
          {
            "type": "image",
            "name": "Storm Proxies",
            "src": "https://cdn.cuiqingcai.com/a2zad8.png",
            "url": "https://www.stormproxies.cn/?keyword=jingmi",
            "width": "100%",
            "enable": false
      },
          {
            "type": "friends",
            "name": "友情链接",
            "enable": true
      },
          {
            "type": "hot",
            "name": "猜你喜欢",
            "enable": true
      },
          {
            "type": "tags",
            "name": "标签云",
            "enable": true
      }]
      },
      "copycode":
      {
        "enable": true,
        "show_result": true,
        "style": "mac"
      },
      "back2top":
      {
        "enable": true,
        "sidebar": false,
        "scrollpercent": true
      },
      "bookmark":
      {
        "enable": false,
        "color": "#222",
        "save": "auto"
      },
      "fancybox": false,
      "mediumzoom": false,
      "lazyload": false,
      "pangu": true,
      "comments":
      {
        "style": "tabs",
        "active": "gitalk",
        "storage": true,
        "lazyload": false,
        "nav": null,
        "activeClass": "gitalk"
      },
      "algolia":
      {
        "hits":
        {
          "per_page": 10
        },
        "labels":
        {
          "input_placeholder": "Search for Posts",
          "hits_empty": "We didn't find any results for the search: ${query}",
          "hits_stats": "${hits} results found in ${time} ms"
        }
      },
      "localsearch":
      {
        "enable": true,
        "trigger": "auto",
        "top_n_per_article": 10,
        "unescape": false,
        "preload": false
      },
      "motion":
      {
        "enable": false,
        "async": false,
        "transition":
        {
          "post_block": "bounceDownIn",
          "post_header": "slideDownIn",
          "post_body": "slideDownIn",
          "coll_header": "slideLeftIn",
          "sidebar": "slideUpIn"
        }
      },
      "path": "search.xml"
    };

  </script>
  <meta name="keywords" content="爬虫,网络爬虫,2022,代理,Python 爬虫,代理池">
  <meta name="robots" content="index,follow">
  <meta name="GOOGLEBOT" content="index,follow">
  <meta name="author" content="静觅丨崔庆才的个人站点">
  <meta name="description" content="爬虫系列文章总目录：【2022 年】Python3 爬虫学习教程，本教程内容多数来自于《Python3 网络爬虫开发实战（第二版）》一书，目前截止 2022 年，可以将爬虫基本技术进行系统讲解，同时将最新前沿爬虫技术如异步、JavaScript 逆向、AST、安卓逆向、Hook、智能解析、群控技术、WebAssembly、大规模分布式、Docker、Kubernetes 等，市面上目前就仅有">
  <meta property="og:type" content="article">
  <meta property="og:title" content="【2022 年】Python3 爬虫教程 - 高效代理池的维护">
  <meta property="og:url" content="https://cuiqingcai.com/2022103.html">
  <meta property="og:site_name" content="静觅">
  <meta property="og:description" content="爬虫系列文章总目录：【2022 年】Python3 爬虫学习教程，本教程内容多数来自于《Python3 网络爬虫开发实战（第二版）》一书，目前截止 2022 年，可以将爬虫基本技术进行系统讲解，同时将最新前沿爬虫技术如异步、JavaScript 逆向、AST、安卓逆向、Hook、智能解析、群控技术、WebAssembly、大规模分布式、Docker、Kubernetes 等，市面上目前就仅有">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:image" content="https://cdn.cuiqingcai.com/v0xz8.jpg">
  <meta property="og:image" content="https://cdn.cuiqingcai.com/pxwew.png">
  <meta property="og:image" content="https://cdn.cuiqingcai.com/31i7g.jpg">
  <meta property="article:published_time" content="2022-03-04T05:11:13.000Z">
  <meta property="article:modified_time" content="2025-08-11T15:24:05.303Z">
  <meta property="article:author" content="崔庆才">
  <meta property="article:tag" content="爬虫">
  <meta property="article:tag" content="网络爬虫">
  <meta property="article:tag" content="2022">
  <meta property="article:tag" content="代理">
  <meta property="article:tag" content="Python 爬虫">
  <meta property="article:tag" content="代理池">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:image" content="https://cdn.cuiqingcai.com/v0xz8.jpg">
  <link rel="canonical" href="https://cuiqingcai.com/2022103.html">
  <script id="page-configurations">
    // https://hexo.io/docs/variables.html
    CONFIG.page = {
      sidebar: "",
      isHome: false,
      isPost: true,
      lang: 'zh-CN'
    };

  </script>
  <title>【2022 年】Python3 爬虫教程 - 高效代理池的维护 | 静觅</title>
  <meta name="google-site-verification" content="p_bIcnvirkFzG2dYKuNDivKD8-STet5W7D-01woA2fc" />
  <meta name="sogou_site_verification" content="kBOV53NQqT" />
  <noscript>
    <style>
      .use-motion .brand,
      .use-motion .menu-item,
      .sidebar-inner,
      .use-motion .post-block,
      .use-motion .pagination,
      .use-motion .comments,
      .use-motion .post-header,
      .use-motion .post-body,
      .use-motion .collection-header
      {
        opacity: initial;
      }

      .use-motion .site-title,
      .use-motion .site-subtitle
      {
        opacity: initial;
        top: initial;
      }

      .use-motion .logo-line-before i
      {
        left: initial;
      }

      .use-motion .logo-line-after i
      {
        right: initial;
      }

    </style>
  </noscript>
  <link rel="alternate" href="/atom.xml" title="静觅" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner">
        <div class="site-brand-container">
          <div class="site-nav-toggle">
            <div class="toggle" aria-label="切换导航栏">
              <span class="toggle-line toggle-line-first"></span>
              <span class="toggle-line toggle-line-middle"></span>
              <span class="toggle-line toggle-line-last"></span>
            </div>
          </div>
          <div class="site-meta">
            <a href="/" class="brand" rel="start">
              <span class="logo-line-before"><i></i></span>
              <h1 class="site-title">静觅 <span class="site-subtitle"> 崔庆才的个人站点 - Python爬虫教程 </span>
              </h1>
              <span class="logo-line-after"><i></i></span>
            </a>
          </div>
          <div class="site-nav-right">
            <div class="toggle popup-trigger">
              <i class="fa fa-search fa-fw fa-lg"></i>
            </div>
          </div>
        </div>
        <nav class="site-nav">
          <ul id="menu" class="main-menu menu">
            <li class="menu-item menu-item-home">
              <a href="/" rel="section">首页</a>
            </li>
            <li class="menu-item menu-item-archives">
              <a href="/archives/" rel="section">文章列表</a>
            </li>
            <li class="menu-item menu-item-tags">
              <a href="/tags/" rel="section">文章标签</a>
            </li>
            <li class="menu-item menu-item-categories">
              <a href="/categories/" rel="section">文章分类</a>
            </li>
            <li class="menu-item menu-item-about">
              <a href="/about/" rel="section">关于博主</a>
            </li>
            <li class="menu-item menu-item-message">
              <a href="/message/" rel="section">给我留言</a>
            </li>
            <li class="menu-item menu-item-search">
              <a role="button" class="popup-trigger">搜索 </a>
            </li>
          </ul>
        </nav>
        <div class="search-pop-overlay">
          <div class="popup search-popup">
            <div class="search-header">
              <span class="search-icon">
                <i class="fa fa-search"></i>
              </span>
              <div class="search-input-container">
                <input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input">
              </div>
              <span class="popup-btn-close">
                <i class="fa fa-times-circle"></i>
              </span>
            </div>
            <div id="search-result">
              <div id="no-result">
                <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>
    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
      <span>0%</span>
    </div>
    <div class="reading-progress-bar"></div>
    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div class="topbanner">
            <a href="https://item.jd.com/13527222.html" target="_blank">
              <img src="https://cdn.cuiqingcai.com/prwgs.png">
            </a>
          </div>
          <div class="content post posts-expand">
            <article itemscope itemtype="http://schema.org/Article" class="post-block single" lang="zh-CN">
              <link itemprop="mainEntityOfPage" href="https://cuiqingcai.com/2022103.html">
              <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                <meta itemprop="image" content="/images/avatar.png">
                <meta itemprop="name" content="崔庆才">
                <meta itemprop="description" content="静觅丨崔庆才的个人站点专业为您提供爬虫教程,爬虫,Python,Python爬虫,Python爬虫教程,爬虫书的相关信息，想要了解更多详情，请联系我们。">
              </span>
              <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                <meta itemprop="name" content="静觅">
              </span>
              <header class="post-header">
                <h1 class="post-title" itemprop="name headline"> 【2022 年】Python3 爬虫教程 - 高效代理池的维护 </h1>
                <div class="post-meta">
                  <span class="post-meta-item">
                    <span class="post-meta-item-icon">
                      <i class="far fa-user"></i>
                    </span>
                    <span class="post-meta-item-text">作者</span>
                    <span><a href="/authors/崔庆才" class="author" itemprop="url" rel="index">崔庆才</a></span>
                  </span>
                  <span class="post-meta-item">
                    <span class="post-meta-item-icon">
                      <i class="far fa-calendar"></i>
                    </span>
                    <span class="post-meta-item-text">发表于</span>
                    <time title="创建时间：2022-03-04 13:11:13" itemprop="dateCreated datePublished" datetime="2022-03-04T13:11:13+08:00">2022-03-04</time>
                  </span>
                  <span class="post-meta-item">
                    <span class="post-meta-item-icon">
                      <i class="far fa-folder"></i>
                    </span>
                    <span class="post-meta-item-text">分类于</span>
                    <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                      <a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
                    </span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                      <a href="/categories/Python/%E7%88%AC%E8%99%AB/" itemprop="url" rel="index"><span itemprop="name">爬虫</span></a>
                    </span>
                  </span>
                  <span id="/2022103.html" class="post-meta-item leancloud_visitors" data-flag-title="【2022 年】Python3 爬虫教程 - 高效代理池的维护" title="阅读次数">
                    <span class="post-meta-item-icon">
                      <i class="fa fa-eye"></i>
                    </span>
                    <span class="post-meta-item-text">阅读次数：</span>
                    <span class="leancloud-visitors-count"></span>
                  </span>
                  <span class="post-meta-item" title="本文字数">
                    <span class="post-meta-item-icon">
                      <i class="far fa-file-word"></i>
                    </span>
                    <span class="post-meta-item-text">本文字数：</span>
                    <span>20k</span>
                  </span>
                  <span class="post-meta-item" title="阅读时长">
                    <span class="post-meta-item-icon">
                      <i class="far fa-clock"></i>
                    </span>
                    <span class="post-meta-item-text">阅读时长 &asymp;</span>
                    <span>18 分钟</span>
                  </span>
                </div>
              </header>
              <div class="post-body" itemprop="articleBody">
                <div class="advertisements">
                </div>
                <blockquote>
                  <p>爬虫系列文章总目录：<a href="https://cuiqingcai.com/17777.html">【2022 年】Python3 爬虫学习教程</a>，本教程内容多数来自于《Python3 网络爬虫开发实战（第二版）》一书，目前截止 2022 年，可以将爬虫基本技术进行系统讲解，同时将最新前沿爬虫技术如异步、JavaScript 逆向、AST、安卓逆向、Hook、智能解析、群控技术、WebAssembly、大规模分布式、Docker、Kubernetes 等，市面上目前就仅有<a href="https://item.jd.com/13527222.html" target="_blank" rel="noopener">《Python3 网络爬虫开发实战（第二版）》</a>一书了，<a href="https://item.jd.com/13527222.html" target="_blank" rel="noopener">点击了解详情</a>。</p>
                </blockquote>
                <p>我们在上一节中了解了各个请求库设置代理的各个方法，但是如何实时高效地获取到大量可用的代理是一个问题。</p>
                <p>首先，在互联网上有大量公开的免费代理。当然，我们也可以购买付费的代理 IP，但是代理不论是免费的还是付费的，都不能保证是可用的，因为此 IP 可能被其他人用来爬取同样的目标站点而被封禁，或者代理服务器突然发生故障或网络繁忙。一旦我们选用了一个不可用的代理，这势必会影响爬虫的工作效率。</p>
                <p>所以，我们需要提前做筛选，将不可用的代理剔除掉，保留可用代理。</p>
                <p>那么，怎么实现呢？这就需要借助于一个叫作代理池的东西了。</p>
                <p>接下来，本节就来介绍一下如何搭建一个高效易用的代理池。</p>
                <h2 id="1-准备工作"><a href="#1-准备工作" class="headerlink" title="1.准备工作"></a>1.准备工作</h2>
                <p>这里代理池的存储需要借助于 Redis，因此需要额外安装它。总体来说，本节需要的环境如下：</p>
                <ul>
                  <li>
                    <p>需要安装并成功运行和连接一个 Redis 数据库，Redis 运行在本地或者远端服务器都可以，只要能正常连接就行，安装方式可以参考：<a href="https://setup.scrape.center/redis" target="_blank" rel="noopener">https://setup.scrape.center/redis</a></p>
                  </li>
                  <li>
                    <p>安装好一些必要的库，包括 aiohttp、requests、redis-py、pyquery、Flask、loguru 等，安装命令如下：</p>
                    <figure class="highlight cmake">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">pip3 <span class="keyword">install</span> aiohttp requests redis pyquery flask loguru</span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>
                  </li>
                </ul>
                <p>做好了如上准备工作，我们便可以开始实现或运行本节所讲的代理池了。</p>
                <h2 id="2-代理池的目标"><a href="#2-代理池的目标" class="headerlink" title="2.代理池的目标"></a>2.代理池的目标</h2>
                <p>我们需要做到下面几个目标来实现易用高效的代理池。</p>
                <p>代理池基本模块分为 4 部分：存储模块、获取模块、检测模块和接口模块，其功能如下：</p>
                <ul>
                  <li><strong>存储模块</strong>：负责存储抓取下来的代理。首先要保证代理不重复，要标识代理的可用情况，还要动态实时处理每个代理，所以一种比较高效和方便的存储方式就是使用 Redis 的 Sorted Set，即有序集合。</li>
                  <li><strong>获取模块</strong>：需要定时在各大代理网站抓取代理。代理既可以是免费公开代理，也可以是付费代理，代理的形式都是 IP 加端口。此模块尽量从不同来源获取，尽量抓取高匿代理，抓取成功之后将可用代理保存到数据库中。</li>
                  <li><strong>检测模块</strong>：需要定时检测数据库中的代理。这里需要设置一个检测链接，最好是爬取哪个网站就检测哪个网站，这样更加有针对性。如果要做一个通用型的代理，可以设置百度等链接来检测。另外，我们需要标识每一个代理的状态，如设置分数标识，100 分代表可用，分数越少代表越不可用。检测一次，如果代理可用，我们可以将分数标识立即设置为 100 满分，也可以在原基础上加 1 分；如果代理不可用，可以将分数标识减 1 分，当分数减到一定阈值后，代理就直接从数据库移除。通过这样标识分数，我们就可以辨别代理的可用情况，选用的时候会更有针对性。</li>
                  <li><strong>接口模块</strong>：需要用 API 来提供对外服务的接口。其实我们可以直接连接数据库来取对应的数据，但是这样就需要知道数据库的连接信息，并且要配置连接，而比较安全和方便的方式就是提供一个 Web API 接口，我们通过访问接口即可拿到可用代理。另外，由于可用代理可能有多个，所以我们可以设置一个随机返回某个可用代理的接口，这样就能保证每个可用代理都可以取到，实现负载均衡。</li>
                </ul>
                <p>以上内容是设计代理的一些基本思路。接下来，我们设计整体的架构，然后用代码实现代理池。</p>
                <h2 id="3-代理池的架构"><a href="#3-代理池的架构" class="headerlink" title="3. 代理池的架构"></a>3. 代理池的架构</h2>
                <p>根据上文的描述，代理池的架构如图所示。</p>
                <p><img src="https://cdn.cuiqingcai.com/v0xz8.jpg" alt=""></p>
                <p>图中所示的代理池分为 4 个模块：存储模块、获取模块、检测模块和接口模块：</p>
                <ul>
                  <li>存储模块使用 Redis 的有序集合，用来做代理的去重和状态标识，同时它也是中心模块和基础模块，用于将其他模块串联起来。</li>
                  <li>获取模块定时从代理网站获取代理，将获取的代理传递给存储模块，并保存到数据库。</li>
                  <li>检测模块定时通过存储模块获取所有代理，并对代理进行检测，根据不同的检测结果对代理设置不同的标识。</li>
                  <li>接口模块通过 Web API 提供服务接口，接口通过连接数据库并通过 Web 形式返回可用的代理。</li>
                </ul>
                <h2 id="4-代理池的实现"><a href="#4-代理池的实现" class="headerlink" title="4.代理池的实现"></a>4.代理池的实现</h2>
                <p>接下来，我们分别用代码来实现一下这 4 个模块。</p>
                <blockquote>
                  <p>注意：完整的代理池代码量较大，因此本节的代码我们不再一步步跟着编写，最后去了解源码即可，源码地址为：<a href="https://github.com/Python3WebSpider/ProxyPool" target="_blank" rel="noopener">https://github.com/Python3WebSpider/ProxyPool</a></p>
                </blockquote>
                <h3 id="存储模块"><a href="#存储模块" class="headerlink" title="存储模块"></a>存储模块</h3>
                <p>这里我们使用 Redis 的有序集合，集合中的每一个元素都是不重复的。对于代理池来说，集合中的元素就变成了一个个代理，也就是 IP 加端口的形式，如 <code>60.207.237.111:8888</code>。另外，有序集合的每一个元素都有一个分数字段，分数是可以重复的，既可以是浮点数类型，也可以是整数类型。该集合会根据每一个元素的分数对集合进行排序，数值小的排在前面，数值大的排在后面，这样就可以实现集合元素的排序了。</p>
                <p>对于代理池来说，这个分数可以作为判断一个代理是否可用的标志：100 为最高分，代表最可用；0 为最低分，代表最不可用。如果要获取可用代理，可以从代理池中随机获取分数最高的代理。注意这里是随机，这样可以保证每个可用代理都会被调用到。</p>
                <p>分数是我们判断代理稳定性的重要标准。设置分数的规则如下所示。</p>
                <ul>
                  <li>分数 100 为可用，检测器会定时循环检测每个代理的可用情况。一旦检测到有可用的代理，就立即置为 100；如果检测到不可用，就将分数减 1，分数减至 0 后代理移除。</li>
                  <li>新获取的代理的分数为 10，如果测试可行，分数立即置为 100，不可行则将分数减 1，分数减至 0 后代理移除。</li>
                </ul>
                <p>这只是一种解决方案，当然可能还有更合理的方案。之所以设置此方案，有如下几个原因。</p>
                <ul>
                  <li>在检测到代理可用时，分数立即置为 100，这样可以保证所有可用代理有更大的机会被获取到。你可能会问，为什么不将分数加 1 而是直接将其设为最高值 100 呢？设想一下，有的代理是从各大免费公开代理网站获取的，常常一个代理并没有那么稳定，平均 5 次请求可能有 2 次成功，3 次失败。如果按照这种方式来设置分数，那么这个代理几乎不可能达到一个高的分数，也就是说即便它有时是可用的，但是筛选的分数最高，那这样的代理几乎不可能被取到。如果想追求代理稳定性，可以用上述方法，这种方法可确保分数最高的代理一定是最稳定可用的。所以，这里我们采取 “可用即设置 100” 的方法，确保只要可用的代理都可以被获取到。</li>
                  <li>在检测到代理不可用时，分数减 1，分数减至 0 后，代理移除。这样一个有效代理如果被移除，需要连续不断失败 100 次。也就是说，当一个可用代理尝试了 100 次都失败了，就一直减分直到移除，一旦成功，就重新置回 100。尝试机会越多，这个代理拯救回来的机会越多，这样就不容易将曾经的一个可用代理丢弃，因为代理不可用的原因很可能是网络繁忙或者其他人用此代理请求太过频繁，所以这里将分数设为 100。</li>
                  <li>将新获取的代理的分数设置为 10，如果它不可用，分数就减 1，直到减到 0 就移除；如果代理可用，分数就置为 100。由于很多代理是从免费网站获取的，所以新获取的代理无效的比例非常高，可能可用的代理不足 10%。这里我们将分数设置为 10，检测的机会没有可用代理的 100 次那么多，这也可以适当减少开销。</li>
                </ul>
                <p>上述代理分数的设置思路不一定是最优思路，但据个人实测，它的实用性还是比较强的。</p>
                <p>这里首先给出存储模块的实现代码，见 <a href="https://github.com/Python3WebSpider/ProxyPool/tree/master/proxypool/storages，建议直接对照源码阅读。" target="_blank" rel="noopener">https://github.com/Python3WebSpider/ProxyPool/tree/master/proxypool/storages，建议直接对照源码阅读。</a></p>
                <p>在代码中，我们定义了一个类来操作数据库的有序集合，定义了一些方法来实现分数的设置、代理的获取等。其核心实现代码如下所示：</p>
                <figure class="highlight python">
                  <table>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">from</span> proxypool.exceptions <span class="keyword">import</span> PoolEmptyException</span><br><span class="line"><span class="keyword">from</span> proxypool.schemas.proxy <span class="keyword">import</span> Proxy</span><br><span class="line"><span class="keyword">from</span> proxypool.setting <span class="keyword">import</span> REDIS_HOST, REDIS_PORT, REDIS_PASSWORD, REDIS_KEY, PROXY_SCORE_MAX, PROXY_SCORE_MIN, \</span><br><span class="line">    PROXY_SCORE_INIT</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> choice</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> List</span><br><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"><span class="keyword">from</span> proxypool.utils.proxy <span class="keyword">import</span> is_valid_proxy, convert_proxy_or_proxies</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">REDIS_CLIENT_VERSION = redis.__version__</span><br><span class="line">IS_REDIS_VERSION_2 = REDIS_CLIENT_VERSION.startswith(<span class="string">'2.'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RedisClient</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    redis connection client of proxypool</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, host=REDIS_HOST, port=REDIS_PORT, password=REDIS_PASSWORD, **kwargs)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        init redis client</span></span><br><span class="line"><span class="string">        :param host: redis host</span></span><br><span class="line"><span class="string">        :param port: redis port</span></span><br><span class="line"><span class="string">        :param password: redis password</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self.db = redis.StrictRedis(host=host, port=port, password=password, decode_responses=<span class="literal">True</span>, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(self, proxy: Proxy, score=PROXY_SCORE_INIT)</span> -&gt; int:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        add proxy and set it to init score</span></span><br><span class="line"><span class="string">        :param proxy: proxy, ip:port, like 8.8.8.8:88</span></span><br><span class="line"><span class="string">        :param score: int score</span></span><br><span class="line"><span class="string">        :return: result</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> is_valid_proxy(<span class="string">f'<span class="subst">&#123;proxy.host&#125;</span>:<span class="subst">&#123;proxy.port&#125;</span>'</span>):</span><br><span class="line">            logger.info(<span class="string">f'invalid proxy <span class="subst">&#123;proxy&#125;</span>, throw it'</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.exists(proxy):</span><br><span class="line">            <span class="keyword">if</span> IS_REDIS_VERSION_2:</span><br><span class="line">                <span class="keyword">return</span> self.db.zadd(REDIS_KEY, score, proxy.string())</span><br><span class="line">            <span class="keyword">return</span> self.db.zadd(REDIS_KEY, &#123;proxy.string(): score&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">random</span><span class="params">(self)</span> -&gt; Proxy:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        get random proxy</span></span><br><span class="line"><span class="string">        firstly try to get proxy with max score</span></span><br><span class="line"><span class="string">        if not exists, try to get proxy by rank</span></span><br><span class="line"><span class="string">        if not exists, raise error</span></span><br><span class="line"><span class="string">        :return: proxy, like 8.8.8.8:8</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="comment"># try to get proxy with max score</span></span><br><span class="line">        proxies = self.db.zrangebyscore(REDIS_KEY, PROXY_SCORE_MAX, PROXY_SCORE_MAX)</span><br><span class="line">        <span class="keyword">if</span> len(proxies):</span><br><span class="line">            <span class="keyword">return</span> convert_proxy_or_proxies(choice(proxies))</span><br><span class="line">        <span class="comment"># else get proxy by rank</span></span><br><span class="line">        proxies = self.db.zrevrange(REDIS_KEY, PROXY_SCORE_MIN, PROXY_SCORE_MAX)</span><br><span class="line">        <span class="keyword">if</span> len(proxies):</span><br><span class="line">            <span class="keyword">return</span> convert_proxy_or_proxies(choice(proxies))</span><br><span class="line">        <span class="comment"># else raise error</span></span><br><span class="line">        <span class="keyword">raise</span> PoolEmptyException</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decrease</span><span class="params">(self, proxy: Proxy)</span> -&gt; int:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        decrease score of proxy, if small than PROXY_SCORE_MIN, delete it</span></span><br><span class="line"><span class="string">        :param proxy: proxy</span></span><br><span class="line"><span class="string">        :return: new score</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        score = self.db.zscore(REDIS_KEY, proxy.string())</span><br><span class="line">        <span class="comment"># current score is larger than PROXY_SCORE_MIN</span></span><br><span class="line">        <span class="keyword">if</span> score <span class="keyword">and</span> score &gt; PROXY_SCORE_MIN:</span><br><span class="line">            logger.info(<span class="string">f'<span class="subst">&#123;proxy.string()&#125;</span> current score <span class="subst">&#123;score&#125;</span>, decrease 1'</span>)</span><br><span class="line">            <span class="keyword">if</span> IS_REDIS_VERSION_2:</span><br><span class="line">                <span class="keyword">return</span> self.db.zincrby(REDIS_KEY, proxy.string(), <span class="number">-1</span>)</span><br><span class="line">            <span class="keyword">return</span> self.db.zincrby(REDIS_KEY, <span class="number">-1</span>, proxy.string())</span><br><span class="line">        <span class="comment"># otherwise delete proxy</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            logger.info(<span class="string">f'<span class="subst">&#123;proxy.string()&#125;</span> current score <span class="subst">&#123;score&#125;</span>, remove'</span>)</span><br><span class="line">            <span class="keyword">return</span> self.db.zrem(REDIS_KEY, proxy.string())</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">exists</span><span class="params">(self, proxy: Proxy)</span> -&gt; bool:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        if proxy exists</span></span><br><span class="line"><span class="string">        :param proxy: proxy</span></span><br><span class="line"><span class="string">        :return: if exists, bool</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">not</span> self.db.zscore(REDIS_KEY, proxy.string()) <span class="keyword">is</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">max</span><span class="params">(self, proxy: Proxy)</span> -&gt; int:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        set proxy to max score</span></span><br><span class="line"><span class="string">        :param proxy: proxy</span></span><br><span class="line"><span class="string">        :return: new score</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        logger.info(<span class="string">f'<span class="subst">&#123;proxy.string()&#125;</span> is valid, set to <span class="subst">&#123;PROXY_SCORE_MAX&#125;</span>'</span>)</span><br><span class="line">        <span class="keyword">if</span> IS_REDIS_VERSION_2:</span><br><span class="line">            <span class="keyword">return</span> self.db.zadd(REDIS_KEY, PROXY_SCORE_MAX, proxy.string())</span><br><span class="line">        <span class="keyword">return</span> self.db.zadd(REDIS_KEY, &#123;proxy.string(): PROXY_SCORE_MAX&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">count</span><span class="params">(self)</span> -&gt; int:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        get count of proxies</span></span><br><span class="line"><span class="string">        :return: count, int</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> self.db.zcard(REDIS_KEY)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">all</span><span class="params">(self)</span> -&gt; List[Proxy]:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        get all proxies</span></span><br><span class="line"><span class="string">        :return: list of proxies</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> convert_proxy_or_proxies(self.db.zrangebyscore(REDIS_KEY, PROXY_SCORE_MIN, PROXY_SCORE_MAX))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">batch</span><span class="params">(self, start, end)</span> -&gt; List[Proxy]:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        get batch of proxies</span></span><br><span class="line"><span class="string">        :param start: start index</span></span><br><span class="line"><span class="string">        :param end: end index</span></span><br><span class="line"><span class="string">        :return: list of proxies</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> convert_proxy_or_proxies(self.db.zrevrange(REDIS_KEY, start, end - <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    conn = RedisClient()</span><br><span class="line">    result = conn.random()</span><br><span class="line">    print(result)</span><br></pre>
                      </td>
                    </tr>
                  </table>
                </figure>
                <p>首先，我们定义了一些常量，如 <code>PROXY_SCORE_MAX</code>、<code>PROXY_SCORE_MIN</code>、<code>PROXY_SCORE_INIT</code> 分别代表最大分数、最小分数、初始分数。<code>REDIS_HOST</code>、<code>REDIS_PORT</code>、<code>REDIS_PASSWORD</code> 分别代表了 Redis 的连接信息，即地址、端口和密码。<code>REDIS_KEY</code> 是有序集合的键名，我们可以通过它来获取代理存储所使用的有序集合。</p>
                <p><code>RedisClient</code> 这个类可以用来操作 Redis 的有序集合，其中定义了一些方法来对集合中的元素进行处理，它的主要功能如下所示。</p>
                <ul>
                  <li><code>__init__</code> 方法是初始化的方法，其参数是 Redis 的连接信息，默认的连接信息已经定义为常量。我们在 <code>__init__</code> 方法中初始化了 <code>StrictRedis</code> 类，建立了 Redis 连接。</li>
                  <li><code>add</code> 方法用于向数据库添加代理并设置分数，默认的分数是 <code>PROXY_SCORE_INIT</code>，也就是 10，返回结果是添加的结果。</li>
                  <li><code>random</code> 方法是随机获取代理的方法。首先获取 100 分的代理，然后随机选择一个返回。如果不存在 100 分的代理，则此方法按照排名来获取，选取前 100 名，然后随机选择一个返回，否则抛出异常。</li>
                  <li><code>decrease</code> 方法是在代理检测无效的时候设置分数减 1 的方法，代理传入后，此方法将代理的分数减 1，如果分数达到最低值，那么代理就删除。</li>
                  <li><code>exists</code> 方法用于判断代理是否存在集合中。</li>
                  <li><code>max</code> 方法用于将代理的分数设置为 <code>PROXY_SCORE_MAX</code>，即 100，也就是代理有效时的设置。</li>
                  <li><code>count</code> 方法用于返回当前集合的元素个数。</li>
                  <li><code>all</code> 方法返回所有的代理列表，供检测使用。</li>
                </ul>
                <p>定义好这些方法后，我们可以在后续的模块中调用此类来连接和操作数据库。如果要获取随机可用的代理，只需要调用 <code>random</code> 方法即可，得到的就是随机的可用代理。</p>
                <h3 id="获取模块"><a href="#获取模块" class="headerlink" title="获取模块"></a>获取模块</h3>
                <p>获取模块主要是为了从各大网站抓取代理并调用存储模块进行保存，代码实现见 <a href="https://github.com/Python3WebSpider/ProxyPool/tree/master/proxypool/crawlers。" target="_blank" rel="noopener">https://github.com/Python3WebSpider/ProxyPool/tree/master/proxypool/crawlers。</a></p>
                <p>获取模块的逻辑相对简单，比如我们可以定义一些抓取代理的方法，示例如下：</p>
                <figure class="highlight python">
                  <table>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">from</span> proxypool.crawlers.base <span class="keyword">import</span> BaseCrawler</span><br><span class="line"><span class="keyword">from</span> proxypool.schemas.proxy <span class="keyword">import</span> Proxy</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">MAX_PAGE = <span class="number">5</span></span><br><span class="line">BASE_URL = <span class="string">'http://www.ip3366.net/free/?stype=1&amp;page=&#123;page&#125;'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IP3366Crawler</span><span class="params">(BaseCrawler)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    ip3366 crawler, http://www.ip3366.net/</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    urls = [BASE_URL.format(page=i) <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">8</span>)]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse</span><span class="params">(self, html)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        parse html file to get proxies</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        ip_address = re.compile(<span class="string">'&lt;tr&gt;\s*&lt;td&gt;(.*?)&lt;/td&gt;\s*&lt;td&gt;(.*?)&lt;/td&gt;'</span>)</span><br><span class="line">        <span class="comment"># \s * 匹配空格，起到换行作用</span></span><br><span class="line">        re_ip_address = ip_address.findall(html)</span><br><span class="line">        <span class="keyword">for</span> address, port <span class="keyword">in</span> re_ip_address:</span><br><span class="line">            proxy = Proxy(host=address.strip(), port=int(port.strip()))</span><br><span class="line">            <span class="keyword">yield</span> proxy</span><br></pre>
                      </td>
                    </tr>
                  </table>
                </figure>
                <p>这里定义了一个代理类 <code>Crawler</code>，用来抓取某一网站的代理，这里抓取的是 IP3366 的公开代理，通过 <code>parse</code> 方法来解析页面的源码并构造一个个 Proxy 对象返回即可。</p>
                <p>另外，在其父类 <code>BaseCrawler</code> 里面定义了通用的页面抓取方法，它可以读取子类里面定义的 <code>urls</code> 全局变量并进行爬取，然后调用子类的 <code>parse</code> 方法来解析页面，代码实现如下：</p>
                <figure class="highlight python">
                  <table>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">from</span> retrying <span class="keyword">import</span> retry</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseCrawler</span><span class="params">(object)</span>:</span></span><br><span class="line">    urls = []</span><br><span class="line"></span><br><span class="line"><span class="meta">    @retry(stop_max_attempt_number=3, retry_on_result=lambda x: x is None)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">fetch</span><span class="params">(self, url, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            response = requests.get(url, **kwargs)</span><br><span class="line">            <span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">                <span class="keyword">return</span> response.text</span><br><span class="line">        <span class="keyword">except</span> requests.ConnectionError:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @logger.catch</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">crawl</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        crawl main method</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">for</span> url <span class="keyword">in</span> self.urls:</span><br><span class="line">            logger.info(<span class="string">f'fetching <span class="subst">&#123;url&#125;</span>'</span>)</span><br><span class="line">            html = self.fetch(url)</span><br><span class="line">            <span class="keyword">for</span> proxy <span class="keyword">in</span> self.parse(html):</span><br><span class="line">                logger.info(<span class="string">f'fetched proxy <span class="subst">&#123;proxy.string()&#125;</span> from <span class="subst">&#123;url&#125;</span>'</span>)</span><br><span class="line">                <span class="keyword">yield</span> proxy</span><br></pre>
                      </td>
                    </tr>
                  </table>
                </figure>
                <p>如果要扩展一个代理的 <code>Crawler</code>，只需要集成 <code>BaseCrawler</code> 并实现 <code>parse</code> 方法即可，扩展性较好。</p>
                <p>因此，这一个个的 <code>Crawler</code> 就可以针对各个不同的代理网站进行代理的抓取。最后，有一个统一的方法将 <code>Crawler</code> 汇总起来，遍历调用即可。</p>
                <p>如何汇总呢？这里我们可以检测代码只要定义有 <code>BaseCrawler</code> 的子类就算一个有效的代理 <code>Crawler</code>，可以直接通过遍历 Python 文件包的方式来获取，代码实现如下：</p>
                <figure class="highlight python">
                  <table>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">import</span> pkgutil</span><br><span class="line"><span class="keyword">from</span> .base <span class="keyword">import</span> BaseCrawler</span><br><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"></span><br><span class="line"><span class="comment"># load classes subclass of BaseCrawler</span></span><br><span class="line">classes = []</span><br><span class="line"><span class="keyword">for</span> loader, name, is_pkg <span class="keyword">in</span> pkgutil.walk_packages(__path__):</span><br><span class="line">    module = loader.find_module(name).load_module(name)</span><br><span class="line">    <span class="keyword">for</span> name, value <span class="keyword">in</span> inspect.getmembers(module):</span><br><span class="line">        globals()[name] = value</span><br><span class="line">        <span class="keyword">if</span> inspect.isclass(value) <span class="keyword">and</span> issubclass(value, BaseCrawler) <span class="keyword">and</span> value <span class="keyword">is</span> <span class="keyword">not</span> BaseCrawler:</span><br><span class="line">            classes.append(value)</span><br><span class="line">__all__ = __ALL__ = classes</span><br></pre>
                      </td>
                    </tr>
                  </table>
                </figure>
                <p>这里我们调用了 <code>walk_packages</code> 方法，遍历了整个 crawlers 模块下的类，并判断它是 <code>BaseCrawler</code> 的子类，那就将其添加到结果中并返回。</p>
                <p>最后，只要将 <code>classes</code> 遍历并依次实例化，调用其 <code>crawl</code> 方法即可完成代理的爬取和提取，代码实现见 <a href="https://github.com/Python3WebSpider/ProxyPool/blob/master/proxypool/processors/getter.py。" target="_blank" rel="noopener">https://github.com/Python3WebSpider/ProxyPool/blob/master/proxypool/processors/getter.py。</a></p>
                <h3 id="检测模块"><a href="#检测模块" class="headerlink" title="检测模块"></a>检测模块</h3>
                <p>我们已经成功将各个网站的代理获取下来了，现在需要一个检测模块来对所有代理进行多轮检测。代理检测可用，分数就设置为 100，代理不可用，分数就减 1，这样可以实时改变每个代理的可用情况。如果要获取有效代理，只需要获取分数高的代理即可。</p>
                <p>由于代理的数量非常多，为了提高代理的检测效率，这里使用异步请求库 aiohttp 来检测。</p>
                <p>requests 作为一个同步请求库，我们在发出一个请求之后，程序需要等待网页加载完成之后才能继续执行。也就是这个过程会阻塞等待响应，如果服务器响应非常慢，比如一个请求等待十几秒，那么我们使用 requests 完成一个请求就会需要十几秒的时间，程序也不会继续往下执行，而在这十几秒的时间里，程序其实完全可以去做其他的事情，比如调度其他的请求或者进行网页解析等。</p>
                <p>对于响应速度比较快的网站来说，requests 同步请求和 aiohttp 异步请求的效果差距没那么大。可对于检测代理来说，检测一个代理一般需要十多秒甚至几十秒的时间，这时候使用 aiohttp 异步请求库的优势就大大体现出来了，效率可能会提高几十倍不止。</p>
                <p>所以，我们的代理检测使用异步请求库 aiohttp，实现示例如下所示：</p>
                <figure class="highlight python">
                  <table>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"><span class="keyword">from</span> proxypool.schemas <span class="keyword">import</span> Proxy</span><br><span class="line"><span class="keyword">from</span> proxypool.storages.redis <span class="keyword">import</span> RedisClient</span><br><span class="line"><span class="keyword">from</span> proxypool.setting <span class="keyword">import</span> TEST_TIMEOUT, TEST_BATCH, TEST_URL, TEST_VALID_STATUS</span><br><span class="line"><span class="keyword">from</span> aiohttp <span class="keyword">import</span> ClientProxyConnectionError, ServerDisconnectedError, ClientOSError, ClientHttpProxyError</span><br><span class="line"><span class="keyword">from</span> asyncio <span class="keyword">import</span> TimeoutError</span><br><span class="line"></span><br><span class="line">EXCEPTIONS = (</span><br><span class="line">    ClientProxyConnectionError,</span><br><span class="line">    ConnectionRefusedError,</span><br><span class="line">    TimeoutError,</span><br><span class="line">    ServerDisconnectedError,</span><br><span class="line">    ClientOSError,</span><br><span class="line">    ClientHttpProxyError</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tester</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    tester for testing proxies in queue</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        init redis</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self.redis = RedisClient()</span><br><span class="line">        self.loop = asyncio.get_event_loop()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">(self, proxy: Proxy)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        test single proxy</span></span><br><span class="line"><span class="string">        :param proxy: Proxy object</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession(connector=aiohttp.TCPConnector(ssl=<span class="literal">False</span>)) <span class="keyword">as</span> session:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                logger.debug(<span class="string">f'testing <span class="subst">&#123;proxy.string()&#125;</span>'</span>)</span><br><span class="line">                <span class="keyword">async</span> <span class="keyword">with</span> session.get(TEST_URL, proxy=<span class="string">f'http://<span class="subst">&#123;proxy.string()&#125;</span>'</span>, timeout=TEST_TIMEOUT,</span><br><span class="line">                                       allow_redirects=<span class="literal">False</span>) <span class="keyword">as</span> response:</span><br><span class="line">                    <span class="keyword">if</span> response.status <span class="keyword">in</span> TEST_VALID_STATUS:</span><br><span class="line">                        self.redis.max(proxy)</span><br><span class="line">                        logger.debug(<span class="string">f'proxy <span class="subst">&#123;proxy.string()&#125;</span> is valid, set max score'</span>)</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        self.redis.decrease(proxy)</span><br><span class="line">                        logger.debug(<span class="string">f'proxy <span class="subst">&#123;proxy.string()&#125;</span> is invalid, decrease score'</span>)</span><br><span class="line">            <span class="keyword">except</span> EXCEPTIONS:</span><br><span class="line">                self.redis.decrease(proxy)</span><br><span class="line">                logger.debug(<span class="string">f'proxy <span class="subst">&#123;proxy.string()&#125;</span> is invalid, decrease score'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @logger.catch</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        test main method</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="comment"># event loop of aiohttp</span></span><br><span class="line">        logger.info(<span class="string">'stating tester...'</span>)</span><br><span class="line">        count = self.redis.count()</span><br><span class="line">        logger.debug(<span class="string">f'<span class="subst">&#123;count&#125;</span> proxies to test'</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, count, TEST_BATCH):</span><br><span class="line">            <span class="comment"># start end end offset</span></span><br><span class="line">            start, end = i, min(i + TEST_BATCH, count)</span><br><span class="line">            logger.debug(<span class="string">f'testing proxies from <span class="subst">&#123;start&#125;</span> to <span class="subst">&#123;end&#125;</span> indices'</span>)</span><br><span class="line">            proxies = self.redis.batch(start, end)</span><br><span class="line">            tasks = [self.test(proxy) <span class="keyword">for</span> proxy <span class="keyword">in</span> proxies]</span><br><span class="line">            <span class="comment"># run tasks using event loop</span></span><br><span class="line">            self.loop.run_until_complete(asyncio.wait(tasks))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    tester = Tester()</span><br><span class="line">    tester.run()</span><br></pre>
                      </td>
                    </tr>
                  </table>
                </figure>
                <p>这里定义了一个类 <code>Tester</code>，<code>__init__</code> 方法中建立了一个 <code>RedisClient</code> 对象，供该对象中其他方法使用。接下来，定义了一个 <code>test</code> 方法，这个方法用来检测单个代理的可用情况，其参数就是被检测的代理。注意，<code>test</code> 方法前面加了 <code>async</code> 关键词，这代表这个方法是异步的。方法内部首先创建了 aiohttp 的 <code>ClientSession</code> 对象，可以直接调用该对象的 <code>get</code> 方法来访问页面。</p>
                <p>测试链接在这里定义为常量 <code>TEST_URL</code>。如果针对某个网站有抓取需求，建议将 <code>TEST_URL</code> 设置为目标网站的地址，因为在抓取过程中，代理本身可能是可用的，但是该代理的 IP 已经被目标网站封掉了。例如，某些代理可以正常访问百度等页面，但是对知乎来说可能就被封了，所以我们可以将 <code>TEST_URL</code> 设置为知乎的某个页面的链接。当请求失败、代理被封时，分数自然会减下来，失效的代理就不会被取到了。</p>
                <p>如果想做一个通用的代理池，则不需要专门设置 <code>TEST_URL</code>，既可以将其设置为一个不会封 IP 的网站，也可以设置为百度这类响应稳定的网站。</p>
                <p>我们还定义了 <code>TEST_VALID_STATUS</code> 变量，这个变量是一个列表形式，包含了正常的状态码，如可以定义成 <code>[200]</code>。当然，某些目标网站可能会出现其他的状态码，可以自行配置。</p>
                <p>程序在获取响应后需要判断响应的状态，如果状态码在 <code>TEST_VALID_STATUS</code> 列表里，则代表代理可用，可以调用 <code>RedisClient</code> 的 <code>max</code> 方法将代理分数设为 100，否则调用 <code>decrease</code> 方法将代理分数减 1，如果出现异常，也同样将代理分数减 1。</p>
                <p>另外，我们设置了批量测试的最大值 <code>TEST_BATCH</code>，也就是一批测试最多 <code>TEST_BATCH</code> 个，这可以避免代理池过大时一次性测试全部代理导致内存开销过大的问题。当然，也可以用信号量来实现并发控制。</p>
                <p>随后，在 <code>run</code> 方法里面获取了所有的代理列表，使用 aiohttp 分配任务，启动运行。这样在不断的运行过程中，代理池中无效代理的分数会一直被减 1，直至被清除，有效的代理则会一直保持 100 分，供随时取用。</p>
                <p>这样测试模块的逻辑就完成了。</p>
                <h3 id="接口模块"><a href="#接口模块" class="headerlink" title="接口模块"></a>接口模块</h3>
                <p>通过上述 3 个模块，我们已经可以做到代理的获取、检测和更新，数据库就会以有序集合的形式存储各个代理及其对应的分数，分数 100 代表可用，分数越小代表越不可用。</p>
                <p>但是我们怎样方便地获取可用代理呢？可以用 <code>RedisClient</code> 类直接连接 Redis，然后调用 <code>random</code> 方法。这样做没问题，效率很高，但是会有几个弊端。</p>
                <ul>
                  <li>如果其他人使用这个代理池，他需要知道 Redis 连接的用户名和密码信息，这样很不安全。</li>
                  <li>如果代理池需要部署在远程服务器上运行，而远程服务器的 Redis 只允许本地连接，那么我们就不能远程直连 Redis 来获取代理。</li>
                  <li>如果爬虫所在的主机没有连接 Redis 模块，或者爬虫不是由 Python 语言编写的，那么我们就无法使用 <code>RedisClient</code> 来获取代理。</li>
                  <li>如果 <code>RedisClient</code> 类或者数据库结构有更新，那么爬虫端必须同步这些更新，这样非常麻烦。</li>
                </ul>
                <p>综上考虑，为了使代理池可以作为一个独立服务运行，我们最好增加一个接口模块，并以 Web API 的形式暴露可用代理。</p>
                <p>这样一来，获取代理只需要请求接口即可，以上的几个缺点也可以避免。</p>
                <p>我们使用一个比较轻量级的库 Flask 来实现这个接口模块，实现示例如下所示：</p>
                <figure class="highlight python">
                  <table>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, g</span><br><span class="line"><span class="keyword">from</span> proxypool.storages.redis <span class="keyword">import</span> RedisClient</span><br><span class="line"><span class="keyword">from</span> proxypool.setting <span class="keyword">import</span> API_HOST, API_PORT, API_THREADED</span><br><span class="line"></span><br><span class="line">__all__ = [<span class="string">'app'</span>]</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_conn</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    get redis client object</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> hasattr(g, <span class="string">'redis'</span>):</span><br><span class="line">        g.redis = RedisClient()</span><br><span class="line">    <span class="keyword">return</span> g.redis</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    get home page, you can define your own templates</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;h2&gt;Welcome to Proxy Pool System&lt;/h2&gt;'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/random')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_proxy</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    get a random proxy</span></span><br><span class="line"><span class="string">    :return: get a random proxy</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    conn = get_conn()</span><br><span class="line">    <span class="keyword">return</span> conn.random().string()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/count')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_count</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    get the count of proxies</span></span><br><span class="line"><span class="string">    :return: count, int</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    conn = get_conn()</span><br><span class="line">    <span class="keyword">return</span> str(conn.count())</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(host=API_HOST, port=API_PORT, threaded=API_THREADED)</span><br></pre>
                      </td>
                    </tr>
                  </table>
                </figure>
                <p>这里我们声明了一个 Flask 对象，定义了 3 个接口，分别是首页、随机代理页和获取数量页。</p>
                <p>运行之后，Flask 会启动一个 Web 服务，我们只需要访问对应的接口即可获取到可用代理。</p>
                <h3 id="调度模块"><a href="#调度模块" class="headerlink" title="调度模块"></a>调度模块</h3>
                <p>调度模块就是调用上面所定义的 3 个模块，将这 3 个模块通过多进程的形式运行起来，示例如下所示：</p>
                <figure class="highlight python">
                  <table>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"><span class="keyword">from</span> proxypool.processors.server <span class="keyword">import</span> app</span><br><span class="line"><span class="keyword">from</span> proxypool.processors.getter <span class="keyword">import</span> Getter</span><br><span class="line"><span class="keyword">from</span> proxypool.processors.tester <span class="keyword">import</span> Tester</span><br><span class="line"><span class="keyword">from</span> proxypool.setting <span class="keyword">import</span> CYCLE_GETTER, CYCLE_TESTER, API_HOST, API_THREADED, API_PORT, ENABLE_SERVER, \</span><br><span class="line">    ENABLE_GETTER, ENABLE_TESTER, IS_WINDOWS</span><br><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> IS_WINDOWS:</span><br><span class="line">    multiprocessing.freeze_support()</span><br><span class="line"></span><br><span class="line">tester_process, getter_process, server_process = <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Scheduler</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    scheduler</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run_tester</span><span class="params">(self, cycle=CYCLE_TESTER)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        run tester</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> ENABLE_TESTER:</span><br><span class="line">            logger.info(<span class="string">'tester not enabled, exit'</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        tester = Tester()</span><br><span class="line">        loop = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            logger.debug(<span class="string">f'tester loop <span class="subst">&#123;loop&#125;</span> start...'</span>)</span><br><span class="line">            tester.run()</span><br><span class="line">            loop += <span class="number">1</span></span><br><span class="line">            time.sleep(cycle)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run_getter</span><span class="params">(self, cycle=CYCLE_GETTER)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        run getter</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> ENABLE_GETTER:</span><br><span class="line">            logger.info(<span class="string">'getter not enabled, exit'</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        getter = Getter()</span><br><span class="line">        loop = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            logger.debug(<span class="string">f'getter loop <span class="subst">&#123;loop&#125;</span> start...'</span>)</span><br><span class="line">            getter.run()</span><br><span class="line">            loop += <span class="number">1</span></span><br><span class="line">            time.sleep(cycle)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run_server</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        run server for api</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> ENABLE_SERVER:</span><br><span class="line">            logger.info(<span class="string">'server not enabled, exit'</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        app.run(host=API_HOST, port=API_PORT, threaded=API_THREADED)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">global</span> tester_process, getter_process, server_process</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            logger.info(<span class="string">'starting proxypool...'</span>)</span><br><span class="line">            <span class="keyword">if</span> ENABLE_TESTER:</span><br><span class="line">                tester_process = multiprocessing.Process(target=self.run_tester)</span><br><span class="line">                logger.info(<span class="string">f'starting tester, pid <span class="subst">&#123;tester_process.pid&#125;</span>...'</span>)</span><br><span class="line">                tester_process.start()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ENABLE_GETTER:</span><br><span class="line">                getter_process = multiprocessing.Process(target=self.run_getter)</span><br><span class="line">                logger.info(<span class="string">f'starting getter, pid<span class="subst">&#123;getter_process.pid&#125;</span>...'</span>)</span><br><span class="line">                getter_process.start()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ENABLE_SERVER:</span><br><span class="line">                server_process = multiprocessing.Process(target=self.run_server)</span><br><span class="line">                logger.info(<span class="string">f'starting server, pid<span class="subst">&#123;server_process.pid&#125;</span>...'</span>)</span><br><span class="line">                server_process.start()</span><br><span class="line"></span><br><span class="line">            tester_process.join()</span><br><span class="line">            getter_process.join()</span><br><span class="line">            server_process.join()</span><br><span class="line">        <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">            logger.info(<span class="string">'received keyboard interrupt signal'</span>)</span><br><span class="line">            tester_process.terminate()</span><br><span class="line">            getter_process.terminate()</span><br><span class="line">            server_process.terminate()</span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            <span class="comment"># must call join method before calling is_alive</span></span><br><span class="line">            tester_process.join()</span><br><span class="line">            getter_process.join()</span><br><span class="line">            server_process.join()</span><br><span class="line">            logger.info(<span class="string">f'tester is <span class="subst">&#123;<span class="string">"alive"</span> <span class="keyword">if</span> tester_process.is_alive() <span class="keyword">else</span> <span class="string">"dead"</span>&#125;</span>'</span>)</span><br><span class="line">            logger.info(<span class="string">f'getter is <span class="subst">&#123;<span class="string">"alive"</span> <span class="keyword">if</span> getter_process.is_alive() <span class="keyword">else</span> <span class="string">"dead"</span>&#125;</span>'</span>)</span><br><span class="line">            logger.info(<span class="string">f'server is <span class="subst">&#123;<span class="string">"alive"</span> <span class="keyword">if</span> server_process.is_alive() <span class="keyword">else</span> <span class="string">"dead"</span>&#125;</span>'</span>)</span><br><span class="line">            logger.info(<span class="string">'proxy terminated'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    scheduler = Scheduler()</span><br><span class="line">    scheduler.run()</span><br></pre>
                      </td>
                    </tr>
                  </table>
                </figure>
                <p>3 个常量 <code>ENABLE_TESTER</code>、<code>ENABLE_GETTER</code> 和 <code>ENABLE_SERVER</code> 都是布尔类型，表示测试模块、获取模块和接口模块的开关，如果都为 <code>True</code>，则代表模块开启。</p>
                <p>启动入口是 <code>run</code> 方法，这个方法分别判断 3 个模块的开关。如果开关开启，启动时程序就新建一个 Process 进程，设置好启动目标，然后调用 <code>start</code> 方法运行，这样 3 个进程就可以并行执行，互不干扰。</p>
                <p>3 个调度方法的结构也非常清晰。比如，<code>run_tester</code> 方法用来调度测试模块。首先声明一个 Tester 对象，然后进入死循环不断循环调用其 <code>run</code> 方法，执行完一轮之后就休眠一段时间，休眠结束之后重新再执行。这里休眠时间也定义为一个常量，如 20 秒，即每隔 20 秒进行一次代理检测。</p>
                <p>最后，只需要调用 <code>Scheduler</code> 的 <code>run</code> 方法即可启动整个代理池。</p>
                <p>以上内容便是整个代理池的架构和相应实现逻辑。</p>
                <h2 id="5-运行"><a href="#5-运行" class="headerlink" title="5.运行"></a>5.运行</h2>
                <p>接下来，我们将代码整合一下，将代理运行起来，运行之后的输出结果如下所示：</p>
                <figure class="highlight python">
                  <table>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="number">2020</span><span class="number">-04</span><span class="number">-13</span> <span class="number">02</span>:<span class="number">52</span>:<span class="number">06.510</span> | INFO     | proxypool.storages.redis:decrease:<span class="number">73</span> - <span class="number">60.186</span><span class="number">.146</span><span class="number">.193</span>:<span class="number">9000</span> current score <span class="number">10.0</span>, decrease <span class="number">1</span></span><br><span class="line"><span class="number">2020</span><span class="number">-04</span><span class="number">-13</span> <span class="number">02</span>:<span class="number">52</span>:<span class="number">06.517</span> | DEBUG    | proxypool.processors.tester:test:<span class="number">52</span> - proxy <span class="number">60.186</span><span class="number">.146</span><span class="number">.193</span>:<span class="number">9000</span> <span class="keyword">is</span> invalid, decrease score</span><br><span class="line"><span class="number">2020</span><span class="number">-04</span><span class="number">-13</span> <span class="number">02</span>:<span class="number">52</span>:<span class="number">06.524</span> | INFO     | proxypool.storages.redis:decrease:<span class="number">73</span> - <span class="number">60.186</span><span class="number">.151</span><span class="number">.147</span>:<span class="number">9000</span> current score <span class="number">10.0</span>, decrease <span class="number">1</span></span><br><span class="line"><span class="number">2020</span><span class="number">-04</span><span class="number">-13</span> <span class="number">02</span>:<span class="number">52</span>:<span class="number">06.532</span> | DEBUG    | proxypool.processors.tester:test:<span class="number">52</span> - proxy <span class="number">60.186</span><span class="number">.151</span><span class="number">.147</span>:<span class="number">9000</span> <span class="keyword">is</span> invalid, decrease score</span><br><span class="line"><span class="number">2020</span><span class="number">-04</span><span class="number">-13</span> <span class="number">02</span>:<span class="number">52</span>:<span class="number">07.159</span> | INFO     | proxypool.storages.redis:max:<span class="number">96</span> - <span class="number">60.191</span><span class="number">.11</span><span class="number">.246</span>:<span class="number">3128</span> <span class="keyword">is</span> valid, set to <span class="number">100</span></span><br><span class="line"><span class="number">2020</span><span class="number">-04</span><span class="number">-13</span> <span class="number">02</span>:<span class="number">52</span>:<span class="number">07.167</span> | DEBUG    | proxypool.processors.tester:test:<span class="number">46</span> - proxy <span class="number">60.191</span><span class="number">.11</span><span class="number">.246</span>:<span class="number">3128</span> <span class="keyword">is</span> valid, set max score</span><br><span class="line"><span class="number">2020</span><span class="number">-04</span><span class="number">-13</span> <span class="number">02</span>:<span class="number">52</span>:<span class="number">17.271</span> | INFO     | proxypool.storages.redis:decrease:<span class="number">73</span> - <span class="number">59.62</span><span class="number">.7</span><span class="number">.130</span>:<span class="number">9000</span> current score <span class="number">10.0</span>, decrease <span class="number">1</span></span><br><span class="line"><span class="number">2020</span><span class="number">-04</span><span class="number">-13</span> <span class="number">02</span>:<span class="number">52</span>:<span class="number">17.280</span> | DEBUG    | proxypool.processors.tester:test:<span class="number">52</span> - proxy <span class="number">59.62</span><span class="number">.7</span><span class="number">.130</span>:<span class="number">9000</span> <span class="keyword">is</span> invalid, decrease score</span><br><span class="line"><span class="number">2020</span><span class="number">-04</span><span class="number">-13</span> <span class="number">02</span>:<span class="number">52</span>:<span class="number">17.288</span> | INFO     | proxypool.storages.redis:decrease:<span class="number">73</span> - <span class="number">60.167</span><span class="number">.103</span><span class="number">.74</span>:<span class="number">1133</span> current score <span class="number">10.0</span>, decrease <span class="number">1</span></span><br><span class="line"><span class="number">2020</span><span class="number">-04</span><span class="number">-13</span> <span class="number">02</span>:<span class="number">52</span>:<span class="number">17.295</span> | DEBUG    | proxypool.processors.tester:test:<span class="number">52</span> - proxy <span class="number">60.167</span><span class="number">.103</span><span class="number">.74</span>:<span class="number">1133</span> <span class="keyword">is</span> invalid, decrease score</span><br><span class="line"><span class="number">2020</span><span class="number">-04</span><span class="number">-13</span> <span class="number">02</span>:<span class="number">52</span>:<span class="number">17.302</span> | INFO     | proxypool.storages.redis:decrease:<span class="number">73</span> - <span class="number">60.162</span><span class="number">.71</span><span class="number">.113</span>:<span class="number">9000</span> current score <span class="number">10.0</span>, decrease <span class="number">1</span></span><br><span class="line"><span class="number">2020</span><span class="number">-04</span><span class="number">-13</span> <span class="number">02</span>:<span class="number">52</span>:<span class="number">17.309</span> | DEBUG    | proxypool.processors.tester:test:<span class="number">52</span> - proxy <span class="number">60.162</span><span class="number">.71</span><span class="number">.113</span>:<span class="number">9000</span> <span class="keyword">is</span> invalid, decrease score</span><br></pre>
                      </td>
                    </tr>
                  </table>
                </figure>
                <p>以上是代理池的控制台输出，可以看到这里将可用代理设置为 100，不可用代理分数减 1。</p>
                <p>接下来，我们再打开浏览器，当前配置运行在 5555 端口，所以打开 <a href="http://127.0.0.1:5555" target="_blank" rel="noopener">http://127.0.0.1:5555</a> 即可看到其首页，如图所示。</p>
                <p><img src="https://cdn.cuiqingcai.com/pxwew.png" alt="image-20210711001154883"><br>图 9-2 首页</p>
                <p>再访问 <a href="http://127.0.0.1:5555/random" target="_blank" rel="noopener">http://127.0.0.1:5555/random</a>，即可获取随机可用代理，如图 9-3 所示。</p>
                <p><img src="https://cdn.cuiqingcai.com/31i7g.jpg" alt=""><br>图 9-3 获取随机可用代理</p>
                <p>只需要访问此接口，即可获取一个随机可用代理，这非常方便。</p>
                <p>获取代理的代码如下所示：</p>
                <figure class="highlight python">
                  <table>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">PROXY_POOL_URL = <span class="string">'http://localhost:5555/random'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_proxy</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        response = requests.get(PROXY_POOL_URL)</span><br><span class="line">        <span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">            <span class="keyword">return</span> response.text</span><br><span class="line">    <span class="keyword">except</span> ConnectionError:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br></pre>
                      </td>
                    </tr>
                  </table>
                </figure>
                <p>这样便可以获取到一个随机代理了。它是字符串类型，此代理可以按照上一节所示的方法设置，如 requests 的使用方法如下所示：</p>
                <figure class="highlight python">
                  <table>
                    <tr>
                      <td class="gutter">
                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre>
                      </td>
                      <td class="code">
                        <pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">proxy = get_proxy()</span><br><span class="line">proxies = &#123;</span><br><span class="line">    <span class="string">'http'</span>: <span class="string">'http://'</span> + proxy,</span><br><span class="line">    <span class="string">'https'</span>: <span class="string">'https://'</span> + proxy,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    response = requests.get(<span class="string">'http://httpbin.org/get'</span>, proxies=proxies)</span><br><span class="line">    print(response.text)</span><br><span class="line"><span class="keyword">except</span> requests.exceptions.ConnectionError <span class="keyword">as</span> e:</span><br><span class="line">    print(<span class="string">'Error'</span>, e.args)</span><br></pre>
                      </td>
                    </tr>
                  </table>
                </figure>
                <p>有了代理池之后，再取出代理即可有效防止 IP 被封禁的情况。</p>
                <h2 id="6-总结"><a href="#6-总结" class="headerlink" title="6.总结"></a>6.总结</h2>
                <p>本节我们学习了一个代理池的设计思路和实现方案，有了这个代理池，我们就可以实时获取一些可用的代理了。相对之前的实战案例来说，整个代理池的代码量和逻辑复杂了比较多，建议可以好好理解和消化一下。</p>
                <p>本节的代码地址为 <a href="https://github.com/Python3WebSpider/ProxyPool" target="_blank" rel="noopener">https://github.com/Python3WebSpider/ProxyPool</a>，代码库中还提供了基于 Docker 和 Kubernetes 的运行和部署操作，可以帮助我们更加快捷地运行代理池，同时本书后文也会介绍代理池的部署方法。</p>
              </div>
              <div class="popular-posts-header">相关文章</div>
              <ul class="popular-posts">
                <li class="popular-posts-item">
                  <div class="popular-posts-title"><a href="/2022104.html" rel="bookmark">【2022 年】Python3 爬虫教程 - ADSL 拨号代理的使用</a></div>
                </li>
                <li class="popular-posts-item">
                  <div class="popular-posts-title"><a href="/2022102.html" rel="bookmark">【2022 年】Python3 爬虫教程 - 代理的使用方法</a></div>
                </li>
                <li class="popular-posts-item">
                  <div class="popular-posts-title"><a href="/2022113.html" rel="bookmark">【2022 年】Python3 爬虫教程 - JavaScript Hook 的用法</a></div>
                </li>
                <li class="popular-posts-item">
                  <div class="popular-posts-title"><a href="/2022111.html" rel="bookmark">【2022 年】Python3 爬虫教程 - JavaScript 网站加密和混淆技术简介</a></div>
                </li>
                <li class="popular-posts-item">
                  <div class="popular-posts-title"><a href="/2022112.html" rel="bookmark">【2022 年】Python3 爬虫教程 - JavaScript 逆向调试常用技巧</a></div>
                </li>
              </ul>
              <div class="reward-container">
                <div></div>
                <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';"> 打赏 </button>
                <div id="qr" style="display: none;">
                  <div style="display: inline-block;">
                    <img src="/images/wechatpay.jpg" alt="崔庆才 微信支付">
                    <p>微信支付</p>
                  </div>
                  <div style="display: inline-block;">
                    <img src="/images/alipay.jpg" alt="崔庆才 支付宝">
                    <p>支付宝</p>
                  </div>
                </div>
              </div>
              <footer class="post-footer">
                <div class="post-tags">
                  <a href="/tags/%E7%88%AC%E8%99%AB/" rel="tag"><i class="fa fa-tag"></i> 爬虫</a>
                  <a href="/tags/%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB/" rel="tag"><i class="fa fa-tag"></i> 网络爬虫</a>
                  <a href="/tags/2022/" rel="tag"><i class="fa fa-tag"></i> 2022</a>
                  <a href="/tags/%E4%BB%A3%E7%90%86/" rel="tag"><i class="fa fa-tag"></i> 代理</a>
                  <a href="/tags/Python-%E7%88%AC%E8%99%AB/" rel="tag"><i class="fa fa-tag"></i> Python 爬虫</a>
                  <a href="/tags/%E4%BB%A3%E7%90%86%E6%B1%A0/" rel="tag"><i class="fa fa-tag"></i> 代理池</a>
                </div>
                <div class="post-nav">
                  <div class="post-nav-item">
                    <a href="/2022102.html" rel="prev" title="【2022 年】Python3 爬虫教程 - 代理的使用方法">
                      <i class="fa fa-chevron-left"></i> 【2022 年】Python3 爬虫教程 - 代理的使用方法 </a>
                  </div>
                  <div class="post-nav-item">
                    <a href="/2022104.html" rel="next" title="【2022 年】Python3 爬虫教程 - ADSL 拨号代理的使用"> 【2022 年】Python3 爬虫教程 - ADSL 拨号代理的使用 <i class="fa fa-chevron-right"></i>
                    </a>
                  </div>
                </div>
              </footer>
            </article>
          </div>
          <div class="comments" id="gitalk-container"></div>
          <script>
            window.addEventListener('tabs:register', () =>
            {
              let
              {
                activeClass
              } = CONFIG.comments;
              if (CONFIG.comments.storage)
              {
                activeClass = localStorage.getItem('comments_active') || activeClass;
              }
              if (activeClass)
              {
                let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
                if (activeTab)
                {
                  activeTab.click();
                }
              }
            });
            if (CONFIG.comments.storage)
            {
              window.addEventListener('tabs:click', event =>
              {
                if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
                let commentClass = event.target.classList[1];
                localStorage.setItem('comments_active', commentClass);
              });
            }

          </script>
        </div>
        <div class="toggle sidebar-toggle">
          <span class="toggle-line toggle-line-first"></span>
          <span class="toggle-line toggle-line-middle"></span>
          <span class="toggle-line toggle-line-last"></span>
        </div>
        <aside class="sidebar">
          <div class="sidebar-inner">
            <ul class="sidebar-nav motion-element">
              <li class="sidebar-nav-toc"> 文章目录 </li>
              <li class="sidebar-nav-overview"> 站点概览 </li>
            </ul>
            <!--noindex-->
            <div class="post-toc-wrap sidebar-panel">
              <div class="post-toc motion-element">
                <ol class="nav">
                  <li class="nav-item nav-level-2"><a class="nav-link" href="#1-准备工作"><span class="nav-number">1.</span> <span class="nav-text">1.准备工作</span></a></li>
                  <li class="nav-item nav-level-2"><a class="nav-link" href="#2-代理池的目标"><span class="nav-number">2.</span> <span class="nav-text">2.代理池的目标</span></a></li>
                  <li class="nav-item nav-level-2"><a class="nav-link" href="#3-代理池的架构"><span class="nav-number">3.</span> <span class="nav-text">3. 代理池的架构</span></a></li>
                  <li class="nav-item nav-level-2"><a class="nav-link" href="#4-代理池的实现"><span class="nav-number">4.</span> <span class="nav-text">4.代理池的实现</span></a>
                    <ol class="nav-child">
                      <li class="nav-item nav-level-3"><a class="nav-link" href="#存储模块"><span class="nav-number">4.1.</span> <span class="nav-text">存储模块</span></a></li>
                      <li class="nav-item nav-level-3"><a class="nav-link" href="#获取模块"><span class="nav-number">4.2.</span> <span class="nav-text">获取模块</span></a></li>
                      <li class="nav-item nav-level-3"><a class="nav-link" href="#检测模块"><span class="nav-number">4.3.</span> <span class="nav-text">检测模块</span></a></li>
                      <li class="nav-item nav-level-3"><a class="nav-link" href="#接口模块"><span class="nav-number">4.4.</span> <span class="nav-text">接口模块</span></a></li>
                      <li class="nav-item nav-level-3"><a class="nav-link" href="#调度模块"><span class="nav-number">4.5.</span> <span class="nav-text">调度模块</span></a></li>
                    </ol>
                  </li>
                  <li class="nav-item nav-level-2"><a class="nav-link" href="#5-运行"><span class="nav-number">5.</span> <span class="nav-text">5.运行</span></a></li>
                  <li class="nav-item nav-level-2"><a class="nav-link" href="#6-总结"><span class="nav-number">6.</span> <span class="nav-text">6.总结</span></a></li>
                </ol>
              </div>
            </div>
            <!--/noindex-->
            <div class="site-overview-wrap sidebar-panel">
              <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
                <img class="site-author-image" itemprop="image" alt="崔庆才" src="/images/avatar.png">
                <p class="site-author-name" itemprop="name">崔庆才</p>
                <div class="site-description" itemprop="description">静觅丨崔庆才的个人站点专业为您提供爬虫教程,爬虫,Python,Python爬虫,Python爬虫教程,爬虫书的相关信息，想要了解更多详情，请联系我们。</div>
              </div>
              <div class="site-state-wrap motion-element">
                <nav class="site-state">
                  <div class="site-state-item site-state-posts">
                    <a href="/archives/">
                      <span class="site-state-item-count">685</span>
                      <span class="site-state-item-name">日志</span>
                    </a>
                  </div>
                  <div class="site-state-item site-state-categories">
                    <a href="/categories/">
                      <span class="site-state-item-count">32</span>
                      <span class="site-state-item-name">分类</span></a>
                  </div>
                  <div class="site-state-item site-state-tags">
                    <a href="/tags/">
                      <span class="site-state-item-count">246</span>
                      <span class="site-state-item-name">标签</span></a>
                  </div>
                </nav>
              </div>
              <div class="links-of-author motion-element">
                <span class="links-of-author-item">
                  <a href="https://github.com/Germey" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Germey" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
                </span>
                <span class="links-of-author-item">
                  <a href="mailto:cqc@cuiqingcai.com.com" title="邮件 → mailto:cqc@cuiqingcai.com.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>邮件</a>
                </span>
                <span class="links-of-author-item">
                  <a href="https://weibo.com/cuiqingcai" title="微博 → https:&#x2F;&#x2F;weibo.com&#x2F;cuiqingcai" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>微博</a>
                </span>
                <span class="links-of-author-item">
                  <a href="https://www.zhihu.com/people/Germey" title="知乎 → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;Germey" rel="noopener" target="_blank"><i class="fa fa-magic fa-fw"></i>知乎</a>
                </span>
              </div>
            </div>
            <div style=" width: 100%;" class="sidebar-panel sidebar-panel-image sidebar-panel-active">
              <a href="https://item.jd.com/13527222.html" target="_blank" rel="noopener">
                <img src="https://cdn.cuiqingcai.com/ei5og.jpg" style=" width: 100%;">
              </a>
            </div>
            <div class="sidebar-panel sidebar-panel-categories sidebar-panel-active">
              <h4 class="name"> 分类 </h4>
              <div class="content">
                <ul class="category-list">
                  <li class="category-list-item"><a class="category-list-link" href="/categories/API/">API</a><span class="category-list-count">5</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/C-C/">C/C++</a><span class="category-list-count">23</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/HTML/">HTML</a><span class="category-list-count">14</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">5</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/JavaScript/">JavaScript</a><span class="category-list-count">26</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">14</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/Luma/">Luma</a><span class="category-list-count">1</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/Markdown/">Markdown</a><span class="category-list-count">2</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/Net/">Net</a><span class="category-list-count">4</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/Nexior/">Nexior</a><span class="category-list-count">1</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/Other/">Other</a><span class="category-list-count">40</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/PHP/">PHP</a><span class="category-list-count">27</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/Paper/">Paper</a><span class="category-list-count">2</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">303</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/TypeScript/">TypeScript</a><span class="category-list-count">2</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B8%AA%E4%BA%BA%E5%B1%95%E7%A4%BA/">个人展示</a><span class="category-list-count">1</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B8%AA%E4%BA%BA%E6%97%A5%E8%AE%B0/">个人日记</a><span class="category-list-count">9</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B8%AA%E4%BA%BA%E8%AE%B0%E5%BD%95/">个人记录</a><span class="category-list-count">6</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B8%AA%E4%BA%BA%E9%9A%8F%E7%AC%94/">个人随笔</a><span class="category-list-count">21</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/">人工智能</a><span class="category-list-count">5</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE/">安装配置</a><span class="category-list-count">59</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E6%8A%80%E6%9C%AF%E6%9D%82%E8%B0%88/">技术杂谈</a><span class="category-list-count">96</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9C%AA%E5%88%86%E7%B1%BB/">未分类</a><span class="category-list-count">1</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/">深度学习</a><span class="category-list-count">1</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E7%88%AC%E8%99%AB/">爬虫</a><span class="category-list-count">4</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E7%94%9F%E6%B4%BB%E7%AC%94%E8%AE%B0/">生活笔记</a><span class="category-list-count">1</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E7%A6%8F%E5%88%A9%E4%B8%93%E5%8C%BA/">福利专区</a><span class="category-list-count">6</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E8%81%8C%E4%BD%8D%E6%8E%A8%E8%8D%90/">职位推荐</a><span class="category-list-count">1</span></li>
                  <li class="category-list-item"><a class="category-list-link" href="/categories/%E8%89%BA%E6%9C%AF%E4%BA%8C%E7%BB%B4%E7%A0%81/">艺术二维码</a><span class="category-list-count">1</span></li>
                </ul>
              </div>
            </div>
            <div class="sidebar-panel sidebar-panel-friends sidebar-panel-active">
              <h4 class="name"> 友情链接 </h4>
              <ul class="friends">
                <li class="friend">
                  <span class="logo">
                    <img src="https://cdn.cuiqingcai.com/j2dub.jpg">
                  </span>
                  <span class="link">
                    <a href="https://www.findhao.net/" target="_blank" rel="noopener">FindHao</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://cdn.cuiqingcai.com/6apxu.jpg">
                  </span>
                  <span class="link">
                    <a href="https://www.51dev.com/" target="_blank" rel="noopener">IT技术社区</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://cdn.cuiqingcai.com/bqlbs.png">
                  </span>
                  <span class="link">
                    <a href="http://www.urselect.com/" target="_blank" rel="noopener">优社电商</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://cdn.cuiqingcai.com/8s88c.jpg">
                  </span>
                  <span class="link">
                    <a href="https://www.yuanrenxue.com/" target="_blank" rel="noopener">猿人学</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://cdn.cuiqingcai.com/2wgg5.jpg">
                  </span>
                  <span class="link">
                    <a href="https://www.yunlifang.cn/" target="_blank" rel="noopener">云立方</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="http://qianxunclub.com/favicon.png">
                  </span>
                  <span class="link">
                    <a href="http://qianxunclub.com/" target="_blank" rel="noopener">千寻啊千寻</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://cdn.cuiqingcai.com/0044u.jpg">
                  </span>
                  <span class="link">
                    <a href="http://kodcloud.com/" target="_blank" rel="noopener">可道云</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://cdn.cuiqingcai.com/ygnpn.jpg">
                  </span>
                  <span class="link">
                    <a href="http://www.kunkundashen.cn/" target="_blank" rel="noopener">坤坤大神</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://cdn.cuiqingcai.com/x714o.jpg">
                  </span>
                  <span class="link">
                    <a href="http://www.hubwiz.com/" target="_blank" rel="noopener">汇智网</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://cdn.cuiqingcai.com/44hxf.png">
                  </span>
                  <span class="link">
                    <a href="http://redstonewill.com/" target="_blank" rel="noopener">红色石头</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://cdn.cuiqingcai.com/wkaus.jpg">
                  </span>
                  <span class="link">
                    <a href="https://zhaoshuai.me/" target="_blank" rel="noopener">碎念</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://cdn.cuiqingcai.com/pgo0r.jpg">
                  </span>
                  <span class="link">
                    <a href="https://www.chenwenguan.com/" target="_blank" rel="noopener">陈文管的博客</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://cdn.cuiqingcai.com/kk82a.jpg">
                  </span>
                  <span class="link">
                    <a href="https://www.lxlinux.net/" target="_blank" rel="noopener">良许Linux教程网</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://cdn.cuiqingcai.com/lj0t2.jpg">
                  </span>
                  <span class="link">
                    <a href="https://tanqingbo.cn/" target="_blank" rel="noopener">IT码农</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://cdn.cuiqingcai.com/i8cdr.png">
                  </span>
                  <span class="link">
                    <a href="https://junyiseo.com/" target="_blank" rel="noopener">均益个人博客</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://cdn.cuiqingcai.com/chwv2.png">
                  </span>
                  <span class="link">
                    <a href="https://brucedone.com/" target="_blank" rel="noopener">大鱼的鱼塘</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://www.91vps.com/favicon.ico">
                  </span>
                  <span class="link">
                    <a href="http://www.91vps.com/" target="_blank" rel="noopener">91VPS</a>
                  </span>
                </li>
                <li class="friend">
                  <span class="logo">
                    <img src="https://webpage.qidian.qq.com/qidian/chatv3-gray/favicon.ico">
                  </span>
                  <span class="link">
                    <a href="https://www.qg.net/" target="_blank" rel="noopener">青果网络</a>
                  </span>
                </li>
              </ul>
            </div>
            <div class="sidebar-panel sidebar-panel-tags sidebar-panel-active">
              <h4 class="name"> 标签云 </h4>
              <div class="content">
                <a href="/tags/2022/" style="font-size: 20px;">2022</a> <a href="/tags/2048/" style="font-size: 10px;">2048</a> <a href="/tags/ADSL/" style="font-size: 10px;">ADSL</a> <a href="/tags/API/" style="font-size: 16px;">API</a> <a href="/tags/Ajax/" style="font-size: 12px;">Ajax</a> <a href="/tags/Bootstrap/" style="font-size: 11px;">Bootstrap</a> <a href="/tags/Bug/" style="font-size: 10px;">Bug</a> <a href="/tags/CDN/" style="font-size: 10px;">CDN</a> <a href="/tags/CQC/" style="font-size: 10px;">CQC</a> <a href="/tags/CSS/" style="font-size: 10px;">CSS</a> <a href="/tags/CSS-%E5%8F%8D%E7%88%AC%E8%99%AB/" style="font-size: 10px;">CSS 反爬虫</a> <a href="/tags/CV/" style="font-size: 10px;">CV</a> <a href="/tags/ChatGPT/" style="font-size: 10px;">ChatGPT</a> <a href="/tags/Cookie/" style="font-size: 10px;">Cookie</a> <a href="/tags/Django/" style="font-size: 10px;">Django</a> <a href="/tags/Eclipse/" style="font-size: 11px;">Eclipse</a> <a href="/tags/Elasticsearch/" style="font-size: 10px;">Elasticsearch</a> <a href="/tags/FTP/" style="font-size: 10px;">FTP</a> <a href="/tags/Flux/" style="font-size: 10px;">Flux</a> <a href="/tags/Git/" style="font-size: 10px;">Git</a> <a href="/tags/GitHub/" style="font-size: 13px;">GitHub</a> <a href="/tags/HTML5/" style="font-size: 10px;">HTML5</a> <a href="/tags/HTTP/" style="font-size: 10px;">HTTP</a> <a href="/tags/Hailuo/" style="font-size: 10px;">Hailuo</a> <a href="/tags/Hexo/" style="font-size: 10px;">Hexo</a> <a href="/tags/Hook/" style="font-size: 10px;">Hook</a> <a href="/tags/IP/" style="font-size: 10px;">IP</a> <a href="/tags/IT/" style="font-size: 10px;">IT</a> <a href="/tags/JSON/" style="font-size: 10px;">JSON</a> <a href="/tags/JSP/" style="font-size: 10px;">JSP</a> <a href="/tags/JavaScript/" style="font-size: 14px;">JavaScript</a> <a href="/tags/K8s/" style="font-size: 10px;">K8s</a> <a href="/tags/LOGO/" style="font-size: 10px;">LOGO</a> <a href="/tags/Linux/" style="font-size: 10px;">Linux</a> <a href="/tags/Luma/" style="font-size: 10px;">Luma</a> <a href="/tags/MIUI/" style="font-size: 10px;">MIUI</a> <a href="/tags/Markdown/" style="font-size: 10px;">Markdown</a> <a href="/tags/Midjourney/" style="font-size: 11px;">Midjourney</a> <a href="/tags/MongoDB/" style="font-size: 11px;">MongoDB</a> <a href="/tags/MySQL/" style="font-size: 10px;">MySQL</a> <a href="/tags/Mysql/" style="font-size: 10px;">Mysql</a> <a href="/tags/NBA/" style="font-size: 10px;">NBA</a> <a href="/tags/Nexior/" style="font-size: 10px;">Nexior</a> <a href="/tags/OCR/" style="font-size: 10px;">OCR</a> <a href="/tags/OpenCV/" style="font-size: 10px;">OpenCV</a> <a href="/tags/PHP/" style="font-size: 11px;">PHP</a> <a href="/tags/PPT/" style="font-size: 10px;">PPT</a> <a href="/tags/PS/" style="font-size: 10px;">PS</a> <a href="/tags/Pathlib/" style="font-size: 10px;">Pathlib</a> <a href="/tags/PhantomJS/" style="font-size: 10px;">PhantomJS</a> <a href="/tags/Playwright/" style="font-size: 10px;">Playwright</a> <a href="/tags/Python/" style="font-size: 17px;">Python</a> <a href="/tags/Python-%E7%88%AC%E8%99%AB/" style="font-size: 18px;">Python 爬虫</a> <a href="/tags/Python3/" style="font-size: 11px;">Python3</a> <a href="/tags/Python3%E7%88%AC%E8%99%AB%E6%95%99%E7%A8%8B/" style="font-size: 12px;">Python3爬虫教程</a> <a href="/tags/Pythonic/" style="font-size: 10px;">Pythonic</a> <a href="/tags/Python%E7%88%AC%E8%99%AB/" style="font-size: 19px;">Python爬虫</a> <a href="/tags/Python%E7%88%AC%E8%99%AB%E4%B9%A6/" style="font-size: 12px;">Python爬虫书</a> <a href="/tags/Python%E7%88%AC%E8%99%AB%E6%95%99%E7%A8%8B/" style="font-size: 15px;">Python爬虫教程</a> <a href="/tags/QQ/" style="font-size: 10px;">QQ</a> <a href="/tags/RabbitMQ/" style="font-size: 10px;">RabbitMQ</a> <a href="/tags/ReCAPTCHA/" style="font-size: 10px;">ReCAPTCHA</a> <a href="/tags/Redis/" style="font-size: 10px;">Redis</a> <a href="/tags/Riffusion/" style="font-size: 10px;">Riffusion</a> <a href="/tags/SAE/" style="font-size: 10px;">SAE</a> <a href="/tags/SSH/" style="font-size: 10px;">SSH</a> <a href="/tags/SVG/" style="font-size: 10px;">SVG</a> <a href="/tags/Scrapy-redis/" style="font-size: 10px;">Scrapy-redis</a> <a href="/tags/Scrapy%E5%88%86%E5%B8%83%E5%BC%8F/" style="font-size: 10px;">Scrapy分布式</a> <a href="/tags/Selenium/" style="font-size: 11px;">Selenium</a> <a href="/tags/Session/" style="font-size: 10px;">Session</a> <a href="/tags/Shell/" style="font-size: 10px;">Shell</a> <a href="/tags/Suno/" style="font-size: 10px;">Suno</a> <a href="/tags/TKE/" style="font-size: 10px;">TKE</a> <a href="/tags/TXT/" style="font-size: 10px;">TXT</a> <a href="/tags/Terminal/" style="font-size: 10px;">Terminal</a> <a href="/tags/Ubuntu/" style="font-size: 11px;">Ubuntu</a> <a href="/tags/VS-Code/" style="font-size: 10px;">VS Code</a> <a href="/tags/Veo/" style="font-size: 10px;">Veo</a> <a href="/tags/Vercel/" style="font-size: 10px;">Vercel</a> <a href="/tags/Vs-Code/" style="font-size: 10px;">Vs Code</a> <a href="/tags/Vue/" style="font-size: 11px;">Vue</a> <a href="/tags/Web/" style="font-size: 10px;">Web</a> <a href="/tags/Webpack/" style="font-size: 10px;">Webpack</a> <a href="/tags/Web%E7%BD%91%E9%A1%B5/" style="font-size: 10px;">Web网页</a> <a href="/tags/Windows/" style="font-size: 10px;">Windows</a> <a href="/tags/Winpcap/" style="font-size: 10px;">Winpcap</a> <a href="/tags/WordPress/" style="font-size: 13px;">WordPress</a> <a href="/tags/XPath/" style="font-size: 12px;">XPath</a> <a href="/tags/Youtube/" style="font-size: 11px;">Youtube</a> <a href="/tags/acedata/" style="font-size: 12px;">acedata</a> <a href="/tags/aiohttp/" style="font-size: 10px;">aiohttp</a> <a href="/tags/android/" style="font-size: 10px;">android</a> <a href="/tags/ansible/" style="font-size: 10px;">ansible</a> <a href="/tags/api/" style="font-size: 13px;">api</a> <a href="/tags/chatgpt/" style="font-size: 10px;">chatgpt</a> <a href="/tags/cocos2d-x/" style="font-size: 10px;">cocos2d-x</a> <a href="/tags/dummy-change/" style="font-size: 10px;">dummy change</a> <a href="/tags/e6/" style="font-size: 10px;">e6</a> <a href="/tags/fitvids/" style="font-size: 10px;">fitvids</a>
              </div>
              <script>
                const tagsColors = ['#00a67c', '#5cb85c', '#d9534f', '#567e95', '#b37333', '#f4843d', '#15a287']
                const tagsElements = document.querySelectorAll('.sidebar-panel-tags .content a')
                tagsElements.forEach((item) =>
                {
                  item.style.backgroundColor = tagsColors[Math.floor(Math.random() * tagsColors.length)]
                })

              </script>
            </div>
          </div>
        </aside>
        <div id="sidebar-dimmer"></div>
      </div>
    </main>
    <footer class="footer">
      <div class="footer-inner">
        <div class="copyright">
          <span class="author" itemprop="copyrightHolder">崔庆才丨静觅</span> &copy; <span itemprop="copyrightYear">2025</span>
          <span class="with-love">
            <i class="fa fa-heart"></i>
          </span>
          <a href="https://cuiqingcai.com/sitemap.xml" style="display:none" title="爬虫教程" target="_blank"><strong>爬虫教程</strong></a>
          <a href="https://cuiqingcai.com/sitemap.html" style="display:none" title="爬虫教程" target="_blank"><strong>爬虫教程</strong></a>
          <span class="post-meta-divider">|</span>
          <span class="post-meta-item-icon">
            <i class="fa fa-chart-area"></i>
          </span>
          <span title="站点总字数">3.3m</span>
          <span class="post-meta-divider">|</span>
          <span class="post-meta-item-icon">
            <i class="fa fa-coffee"></i>
          </span>
          <span title="站点阅读时长">49:35</span>
        </div>
        <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动 </div>
        <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">京ICP备18015597号-1 </a>
        </div>
        <script>
          (function ()
          {
            function leancloudSelector(url)
            {
              url = encodeURI(url);
              return document.getElementById(url).querySelector('.leancloud-visitors-count');
            }

            function addCount(Counter)
            {
              var visitors = document.querySelector('.leancloud_visitors');
              var url = decodeURI(visitors.id);
              var title = visitors.dataset.flagTitle;
              Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify(
              {
                url
              }))).then(response => response.json()).then((
              {
                results
              }) =>
              {
                if (results.length > 0)
                {
                  var counter = results[0];
                  leancloudSelector(url).innerText = counter.time + 1;
                  Counter('put', '/classes/Counter/' + counter.objectId,
                  {
                    time:
                    {
                      '__op': 'Increment',
                      'amount': 1
                    }
                  }).catch(error =>
                  {
                    console.error('Failed to save visitor count', error);
                  });
                }
                else
                {
                  Counter('post', '/classes/Counter',
                  {
                    title,
                    url,
                    time: 1
                  }).then(response => response.json()).then(() =>
                  {
                    leancloudSelector(url).innerText = 1;
                  }).catch(error =>
                  {
                    console.error('Failed to create', error);
                  });
                }
              }).catch(error =>
              {
                console.error('LeanCloud Counter Error', error);
              });
            }

            function showTime(Counter)
            {
              var visitors = document.querySelectorAll('.leancloud_visitors');
              var entries = [...visitors].map(element =>
              {
                return decodeURI(element.id);
              });
              Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify(
              {
                url:
                {
                  '$in': entries
                }
              }))).then(response => response.json()).then((
              {
                results
              }) =>
              {
                for (let url of entries)
                {
                  let target = results.find(item => item.url === url);
                  leancloudSelector(url).innerText = target ? target.time : 0;
                }
              }).catch(error =>
              {
                console.error('LeanCloud Counter Error', error);
              });
            }
            let
            {
              app_id,
              app_key,
              server_url
            } = {
              "enable": true,
              "app_id": "6X5dRQ0pnPWJgYy8SXOg0uID-gzGzoHsz",
              "app_key": "ziLDVEy73ne5HtFTiGstzHMS",
              "server_url": "https://6x5drq0p.lc-cn-n1-shared.com",
              "security": false
            };

            function fetchData(api_server)
            {
              var Counter = (method, url, data) =>
              {
                return fetch(`${api_server}/1.1${url}`,
                {
                  method,
                  headers:
                  {
                    'X-LC-Id': app_id,
                    'X-LC-Key': app_key,
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify(data)
                });
              };
              if (CONFIG.page.isPost)
              {
                if (CONFIG.hostname !== location.hostname) return;
                addCount(Counter);
              }
              else if (document.querySelectorAll('.post-title-link').length >= 1)
              {
                showTime(Counter);
              }
            }
            let api_server = app_id.slice(-9) !== '-MdYXbMMI' ? server_url : `https://${app_id.slice(0, 8).toLowerCase()}.api.lncldglobal.com`;
            if (api_server)
            {
              fetchData(api_server);
            }
            else
            {
              fetch('https://app-router.leancloud.cn/2/route?appId=' + app_id).then(response => response.json()).then((
              {
                api_server
              }) =>
              {
                fetchData('https://' + api_server);
              });
            }
          })();

        </script>
      </div>
      <div class="footer-stat">
        <span id="cnzz_stat_icon_1279355174"></span>
        <script type="text/javascript">
          document.write(unescape("%3Cspan id='cnzz_stat_icon_1279355174'%3E%3C/span%3E%3Cscript src='https://v1.cnzz.com/z_stat.php%3Fid%3D1279355174%26online%3D1%26show%3Dline' type='text/javascript'%3E%3C/script%3E"));

        </script>
      </div>
    </footer>
  </div>
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/pangu@4/dist/browser/pangu.min.js"></script>
  <script src="/js/utils.js"></script>
  <script src="/.js"></script>
  <script src="/js/schemes/pisces.js"></script>
  <script src="/.js"></script>
  <script src="/js/next-boot.js"></script>
  <script src="/.js"></script>
  <script>
    (function ()
    {
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x = document.getElementsByTagName("link");
      //Find the last canonical URL
      if (x.length > 0)
      {
        for (i = 0; i < x.length; i++)
        {
          if (x[i].rel.toLowerCase() == 'canonical' && x[i].href)
          {
            canonicalURL = x[i].href;
          }
        }
      }
      //Get protocol
      if (!canonicalURL)
      {
        curProtocol = window.location.protocol.split(':')[0];
      }
      else
      {
        curProtocol = canonicalURL.split(':')[0];
      }
      //Get current URL if the canonical URL does not exist
      if (!canonicalURL) canonicalURL = window.location.href;
      //Assign script content. Replace current URL with the canonical URL
      ! function ()
      {
        var e = /([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,
          r = canonicalURL,
          t = document.referrer;
        if (!e.test(r))
        {
          var n = (String(curProtocol).toLowerCase() === 'https') ? "https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif" : "//api.share.baidu.com/s.gif";
          t ? (n += "?r=" + encodeURIComponent(document.referrer), r && (n += "&l=" + r)) : r && (n += "?l=" + r);
          var i = new Image;
          i.src = n
        }
      }(window);
    })();

  </script>
  <script src="/js/local-search.js"></script>
  <script src="/.js"></script>
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">
  <script>
    NexT.utils.loadComments(document.querySelector('#gitalk-container'), () =>
    {
      NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () =>
      {
        var gitalk = new Gitalk(
        {
          perPage: : 100,
          clientID: '4c86ce1d7c4fbb3b277c',
          clientSecret: '4927beb0f90e2c07e66c99d9d2529cf3eb8ac8e4',
          repo: 'Blog',
          owner: 'germey',
          admin: ['germey'],
          id: '7298ba9839fced544e0c74cb990a9e06',
          language: 'zh-CN',
          distractionFreeMode: true
        });
        gitalk.render('gitalk-container');
      }, window.Gitalk);
    });

  </script>
</body>

</html>
